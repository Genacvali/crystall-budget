# –ú–∏–≥—Ä–∞—Ü–∏–∏ - –ë—ã—Å—Ç—Ä–∞—è —Å–ø—Ä–∞–≤–∫–∞

## üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –°—Ç–∞—Ç—É—Å –∏ –∏—Å—Ç–æ—Ä–∏—è
flask db current        # –¢–µ–∫—É—â–∞—è —Ä–µ–≤–∏–∑–∏—è
flask db history        # –ò—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
flask db migrate -m "Add user field"  # –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
flask db upgrade                      # –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
flask db downgrade -1                 # –û—Ç–∫–∞—Ç–∏—Ç—å –Ω–∞ 1 —à–∞–≥

# Production
./scripts/prod_migrate.sh    # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –ø—Ä–æ–¥–µ
./scripts/backup_db.sh        # –ë—ç–∫–∞–ø –ë–î
```

## üìã –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1Ô∏è‚É£ –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ (–µ—Å—Ç—å –ë–î, –Ω–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–π)

```bash
# –û–¥–∏–Ω —Ä–∞–∑!
./scripts/prod_baseline.sh

# –î–∞–ª–µ–µ –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—ã—á–Ω—ã–π workflow
```

### 2Ô∏è‚É£ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è –≤ –º–æ–¥–µ–ª—å

```bash
# 1. –ò–∑–º–µ–Ω–∏—Ç—å –º–æ–¥–µ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, app/modules/auth/models.py)
class User(db.Model):
    # ...
    avatar_url = db.Column(db.String(500))  # –Ω–æ–≤–æ–µ –ø–æ–ª–µ

# 2. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
flask db migrate -m "Add avatar_url to users"

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ migrations/versions/

# 4. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
flask db upgrade

# 5. –¢–µ—Å—Ç
python app.py

# 6. –ö–æ–º–º–∏—Ç
git add migrations/versions/
git commit -m "Add avatar_url field"
git push
```

### 3Ô∏è‚É£ –î–µ–ø–ª–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –ø—Ä–æ–¥

```bash
# –ù–∞ –ø—Ä–æ–¥–µ
cd /opt/crystalbudget/crystall-budget
git pull
./scripts/prod_migrate.sh  # –í—Å–µ —Å–¥–µ–ª–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
                            # - –±—ç–∫–∞–ø
                            # - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
                            # - –º–∏–≥—Ä–∞—Ü–∏—è
                            # - –∑–∞–ø—É—Å–∫
```

### 4Ô∏è‚É£ Data Migration (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö)

```bash
# 1. –°–æ–∑–¥–∞—Ç—å –ø—É—Å—Ç—É—é –º–∏–≥—Ä–∞—Ü–∏—é
flask db revision -m "recalculate balances"

# 2. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏
# migrations/versions/XXXXXX_recalculate_balances.py

def upgrade():
    from app.core.extensions import db
    from app.modules.auth.models import User

    bind = op.get_bind()
    session = db.Session(bind=bind)

    # –¢–≤–æ—è –ª–æ–≥–∏–∫–∞
    users = session.query(User).all()
    for user in users:
        user.balance = calculate_balance(user)

    session.commit()

def downgrade():
    pass  # –∏–ª–∏ –ª–æ–≥–∏–∫–∞ –æ—Ç–∫–∞—Ç–∞

# 3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å
flask db upgrade
```

### 5Ô∏è‚É£ –û—Ç–∫–∞—Ç –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

```bash
# –ù–∞ –ø—Ä–æ–¥–µ
sudo systemctl stop crystalbudget

# –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
flask db downgrade -1

# –ò–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞
cp backups/budget_backup_20241004_120000.db instance/budget.db

sudo systemctl start crystalbudget
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

1. **–í—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä—É–π –º–∏–≥—Ä–∞—Ü–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ** –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–º
2. **–ë—ç–∫–∞–ø –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω** - —Å–∫—Ä–∏–ø—Ç—ã –¥–µ–ª–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
3. **–ü—Ä–æ–≤–µ—Ä—è–π –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏** - Alembic –Ω–µ –∏–¥–µ–∞–ª–µ–Ω
4. **–ö–æ–º–º–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ git** - —ç—Ç–æ —á–∞—Å—Ç—å –∫–æ–¥–∞
5. **–ù–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏** - —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ
6. **–ü–∏—à–∏ downgrade()** - –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–∫–∞—Ç–∞

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞

–ü—Ä–æ–µ–∫—Ç —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è SQLite:

- ‚úÖ `render_as_batch=True` - –¥–ª—è ALTER –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ `compare_type=True` - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤
- ‚úÖ `compare_server_default=True` - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ defaults
- ‚úÖ Timestamp –≤ –∏–º–µ–Ω–∞—Ö —Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö

## üìö –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–º. `docs/MIGRATIONS.md` –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞.

## üÜò –ü–æ–º–æ—â—å

```bash
flask db --help           # –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
flask db migrate --help   # –°–ø—Ä–∞–≤–∫–∞ –ø–æ migrate
flask db upgrade --help   # –°–ø—Ä–∞–≤–∫–∞ –ø–æ upgrade
```

## üéØ –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è production –º–∏–≥—Ä–∞—Ü–∏–∏

- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ git
- [ ] –ï—Å—Ç—å —Å–≤–µ–∂–∏–π –±—ç–∫–∞–ø –ë–î (—Å–∫—Ä–∏–ø—Ç —Å–¥–µ–ª–∞–µ—Ç)
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —á—Ç–æ downgrade() —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ downtime (–µ—Å–ª–∏ –µ—Å—Ç—å)
- [ ] –ó–∞–ø—É—â–µ–Ω `./scripts/prod_migrate.sh`
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –ª–æ–≥–∏ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
