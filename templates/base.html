<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="color-scheme" content="light dark">
  <title>{% block title %}üíé CrystalBudget - Modern Finance{% endblock %}</title>

  <!-- Favicon -->
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
  <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png') }}">

  <!-- PWA: –ú–∞–Ω–∏—Ñ–µ—Å—Ç -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.webmanifest') }}">
  <meta name="theme-color" content="#4fb3d9">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CrystalBudget">
  <link rel="apple-touch-icon" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
  <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png') }}">
  <meta name="format-detection" content="telephone=no">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Theme -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/clean-theme.css') }}" rel="stylesheet">

  <!-- Instant theme application to prevent flash -->
  <script>
    (function() {
      const savedTheme = localStorage.getItem('theme') || 
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-bs-theme', savedTheme);
      
      // Update theme-color meta tag
      const themeColorMeta = document.querySelector('meta[name="theme-color"]');
      if (themeColorMeta) {
        themeColorMeta.content = savedTheme === 'dark' ? '#212529' : '#4fb3d9';
      }
    })();
  </script>

  <style>
    /* iOS Safe Area */
    :root {
      --safe-area-inset-top: env(safe-area-inset-top, 0px);
      --safe-area-inset-right: env(safe-area-inset-right, 0px);
      --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
      --safe-area-inset-left: env(safe-area-inset-left, 0px);
    }

    body {
      padding-top: var(--safe-area-inset-top);
      padding-bottom: var(--safe-area-inset-bottom);
      padding-left: var(--safe-area-inset-left);
      padding-right: var(--safe-area-inset-right);
    }

    .container-fluid {
      padding-left: max(15px, var(--safe-area-inset-left));
      padding-right: max(15px, var(--safe-area-inset-right));
    }

    /* NAV FIXES */
    .navbar-modern {
      position: relative;
    }
    
    .navbar-modern .container-fluid {
      display: flex;
      align-items: center;
      gap: .5rem;
      flex-wrap: nowrap;
      position: relative;
    }

    .navbar-brand-modern {
      margin-right: auto;
      white-space: nowrap;
    }

    .navbar-modern .navbar-nav .nav-link-modern,
    .navbar-modern .btn,
    .navbar-modern .currency-selector {
      white-space: nowrap;
    }

    @media (max-width: 992px) {
      .navbar-modern .navbar-nav .nav-link-modern,
      .navbar-modern .btn {
        padding: .4rem .6rem;
        font-size: .95rem;
      }
      .currency-selector .currency-option {
        padding: .25rem .5rem;
        min-width: 2.25rem;
      }
      
      /* –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é (—Å–∞–π–¥–±–∞—Ä) */
      .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1040;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }
      
      .sidebar-overlay.show {
        opacity: 1;
        visibility: visible;
      }
      
      .sidebar {
        position: fixed;
        top: 0;
        left: -280px;
        width: 280px;
        height: 100%;
        background: var(--bs-body-bg);
        border-right: 1px solid var(--bs-border-color);
        box-shadow: 4px 0 12px rgba(0,0,0,0.15);
        z-index: 1050;
        transition: left 0.3s ease;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }
      
      .sidebar.show {
        left: 0;
      }
      
      .sidebar-header {
        padding: 1rem;
        border-bottom: 1px solid var(--bs-border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      
      .sidebar-brand {
        font-weight: 700;
        font-size: 1.25rem;
        color: var(--bs-primary);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .sidebar-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--bs-secondary);
        cursor: pointer;
        padding: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .sidebar-nav {
        flex: 1;
        padding: 1rem 0;
      }
      
      .sidebar-nav .nav-item {
        margin: 0.25rem 0;
      }
      
      .sidebar-nav .nav-link-modern {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem 1rem;
        margin: 0 0.5rem;
        border-radius: 0.5rem;
        color: var(--bs-body-color);
        text-decoration: none;
        font-weight: 500;
        transition: all 0.2s ease;
        border: 1px solid transparent;
      }
      
      .sidebar-nav .nav-link-modern:hover {
        background: var(--bs-primary-bg-subtle);
        color: var(--bs-primary);
        transform: translateX(4px);
      }
      
      .sidebar-nav .nav-link-modern.active {
        background: var(--bs-primary);
        color: white;
        font-weight: 600;
        border-color: var(--bs-primary);
      }
      
      .sidebar-nav .nav-link-modern i {
        width: 20px;
        text-align: center;
      }
      
      .sidebar-footer {
        padding: 1rem;
        border-top: 1px solid var(--bs-border-color);
        background: var(--bs-secondary-bg);
      }
      
      .sidebar-controls {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      
      .sidebar-section {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .sidebar-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--bs-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
      }
      
      .currency-selector {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 0.25rem;
      }
      
      .currency-option {
        padding: 0.5rem 0.25rem;
        text-align: center;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.375rem;
        background: var(--bs-body-bg);
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .currency-option:hover {
        background: var(--bs-secondary-bg);
      }
      
      .currency-option.active {
        background: var(--bs-primary);
        color: white;
        border-color: var(--bs-primary);
      }
      
      .theme-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.75rem;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        background: var(--bs-body-bg);
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .theme-toggle:hover {
        background: var(--bs-secondary-bg);
      }
      
      .user-profile {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        background: var(--bs-body-bg);
        text-decoration: none;
        color: var(--bs-body-color);
        transition: all 0.2s ease;
        margin-bottom: 0.5rem;
      }
      
      .user-profile:hover {
        background: var(--bs-secondary-bg);
        color: var(--bs-body-color);
      }
      
      .user-info {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      
      .user-name {
        font-weight: 600;
        font-size: 0.875rem;
        line-height: 1.2;
      }
      
      .user-email {
        font-size: 0.75rem;
        color: var(--bs-secondary);
        line-height: 1.2;
      }
      
      .logout-btn {
        background: var(--bs-danger);
        color: white;
        border: none;
        border-radius: 0.375rem;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }
      
      .logout-btn:hover {
        background: var(--bs-danger-dark, #c82333);
        color: white;
        transform: translateY(-1px);
      }
      
      /* –°–∫—Ä—ã—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –º–µ–Ω—é –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
      .navbar-collapse {
        display: none !important;
      }
      
      /* –û–±—â–∏–µ –º–æ–±–∏–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è */
      .table-responsive {
        font-size: 0.9rem;
      }
      
      .btn-group .btn-sm {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
      }
      
      .card {
        margin-bottom: 1rem;
      }
      
      /* –°–∫—Ä—ã—Ç–∏–µ –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
      .mobile-hide {
        display: none;
      }
    }
    
    @media (min-width: 768px) {
      .mobile-hide {
        display: inline;
      }
    }
  </style>
</head>
<body>
  {% if session.user_id %}
  <nav class="navbar navbar-expand-lg navbar-modern">
    <div class="container-fluid">
      <a class="navbar-brand-modern" href="{{ url_for('dashboard') }}">
        <svg class="ff-crystal" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="crystalGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#60A5FA;stop-opacity:1" />
              <stop offset="25%" style="stop-color:#3B82F6;stop-opacity:1" />
              <stop offset="50%" style="stop-color:#1D4ED8;stop-opacity:1" />
              <stop offset="75%" style="stop-color:#1E40AF;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#1E3A8A;stop-opacity:1" />
            </linearGradient>
            <linearGradient id="crystalHighlight" x1="0%" y1="0%" x2="100%" y2="50%">
              <stop offset="0%" style="stop-color:#FFFFFF;stop-opacity:0.8" />
              <stop offset="100%" style="stop-color:#FFFFFF;stop-opacity:0.1" />
            </linearGradient>
            <filter id="crystalGlow">
              <feGaussianBlur stdDeviation="1" result="coloredBlur"/>
              <feMerge> 
                <feMergeNode in="coloredBlur"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>
          
          <!-- Main crystal body -->
          <path d="M12 2L16 6L20 10L16 18L12 22L8 18L4 10L8 6L12 2Z" 
                fill="url(#crystalGradient)" 
                stroke="url(#crystalGradient)" 
                stroke-width="0.5" 
                filter="url(#crystalGlow)"/>
          
          <!-- Crystal facets -->
          <path d="M12 2L16 6L12 10L8 6Z" fill="url(#crystalHighlight)" opacity="0.4"/>
          <path d="M8 6L12 10L4 10Z" fill="#1E40AF" opacity="0.6"/>
          <path d="M16 6L20 10L12 10Z" fill="#1E40AF" opacity="0.6"/>
          <path d="M12 10L16 18L12 22Z" fill="#1E3A8A" opacity="0.8"/>
          <path d="M12 10L8 18L12 22Z" fill="#1E3A8A" opacity="0.8"/>
          
          <!-- Highlight lines -->
          <path d="M12 2L12 22" stroke="#60A5FA" stroke-width="0.5" opacity="0.6"/>
          <path d="M8 6L16 18" stroke="#3B82F6" stroke-width="0.3" opacity="0.4"/>
          <path d="M16 6L8 18" stroke="#3B82F6" stroke-width="0.3" opacity="0.4"/>
        </svg>
        CrystalBudget
      </a>

      <button class="navbar-toggler" type="button" onclick="toggleSidebar()">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="d-none d-lg-flex collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link-modern {% if request.endpoint == 'dashboard' %}active{% endif %}" href="{{ url_for('dashboard') }}">
              <i class="bi bi-house-door"></i> –î–∞—à–±–æ—Ä–¥
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link-modern {% if request.endpoint == 'expenses' %}active{% endif %}" href="{{ url_for('expenses') }}">
              <i class="bi bi-wallet2"></i> –†–∞—Å—Ö–æ–¥—ã
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link-modern {% if request.endpoint == 'categories' %}active{% endif %}" href="{{ url_for('categories') }}">
              <i class="bi bi-tags"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link-modern {% if request.endpoint in ['income_page','edit_income','sources_page'] %}active{% endif %}" href="{{ url_for('income_page') }}">
              <i class="bi bi-cash-coin"></i> –î–æ—Ö–æ–¥—ã
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link-modern {% if request.endpoint == 'goals' %}active{% endif %}" href="{{ url_for('goals') }}">
              <i class="bi bi-target"></i> –¶–µ–ª–∏
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link-modern {% if request.endpoint in ['shared_budgets', 'shared_budget_detail'] %}active{% endif %}" href="{{ url_for('shared_budgets') }}">
              <i class="bi bi-people"></i> –°–µ–º—å—è
            </a>
          </li>
        </ul>

        <ul class="navbar-nav">
          <li class="nav-item me-3">
            <div class="currency-selector">
              <button class="currency-option active rub" onclick="setCurrency('RUB')" id="curr-rub">‚ÇΩ</button>
              <button class="currency-option usd" onclick="setCurrency('USD')" id="curr-usd">$</button>
              <button class="currency-option eur" onclick="setCurrency('EUR')" id="curr-eur">‚Ç¨</button>
              <button class="currency-option amd" onclick="setCurrency('AMD')" id="curr-amd">÷è</button>
              <button class="currency-option gel" onclick="setCurrency('GEL')" id="curr-gel">‚Çæ</button>
            </div>
          </li>
          <li class="nav-item me-3">
            <div class="theme-toggle" onclick="toggleTheme()">
              <i class="bi bi-sun-fill" id="light-icon"></i>
              <div class="theme-switch" id="theme-switch"></div>
              <i class="bi bi-moon-fill" id="dark-icon"></i>
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link-modern dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
              <i class="bi bi-person-circle"></i> {{ session.name or session.email }}
            </a>
            <ul class="dropdown-menu dropdown-menu-end modern-card" style="border:none;">
              <li>
                <a class="dropdown-item nav-link-modern" href="{{ url_for('logout') }}">
                  <i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏
                </a>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  
  <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö -->
  <div class="sidebar-overlay d-lg-none" id="sidebarOverlay" onclick="closeSidebar()"></div>
  <div class="sidebar d-lg-none" id="sidebar">
    <div class="sidebar-header">
      <a class="sidebar-brand" href="{{ url_for('dashboard') }}">
        <svg class="ff-crystal" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="crystalGradientSidebar" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#60A5FA;stop-opacity:1" />
              <stop offset="25%" style="stop-color:#3B82F6;stop-opacity:1" />
              <stop offset="50%" style="stop-color:#1D4ED8;stop-opacity:1" />
              <stop offset="75%" style="stop-color:#1E40AF;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#1E3A8A;stop-opacity:1" />
            </linearGradient>
            <linearGradient id="crystalHighlightSidebar" x1="0%" y1="0%" x2="100%" y2="50%">
              <stop offset="0%" style="stop-color:#FFFFFF;stop-opacity:0.8" />
              <stop offset="100%" style="stop-color:#FFFFFF;stop-opacity:0.1" />
            </linearGradient>
          </defs>
          
          <path d="M12 2L16 6L20 10L16 18L12 22L8 18L4 10L8 6L12 2Z" 
                fill="url(#crystalGradientSidebar)" 
                stroke="url(#crystalGradientSidebar)" 
                stroke-width="0.5"/>
          
          <path d="M12 2L16 6L12 10L8 6Z" fill="url(#crystalHighlightSidebar)" opacity="0.4"/>
          <path d="M8 6L12 10L4 10Z" fill="#1E40AF" opacity="0.6"/>
          <path d="M16 6L20 10L12 10Z" fill="#1E40AF" opacity="0.6"/>
          <path d="M12 10L16 18L12 22Z" fill="#1E3A8A" opacity="0.8"/>
          <path d="M12 10L8 18L12 22Z" fill="#1E3A8A" opacity="0.8"/>
          
          <path d="M12 2L12 22" stroke="#60A5FA" stroke-width="0.5" opacity="0.6"/>
          <path d="M8 6L16 18" stroke="#3B82F6" stroke-width="0.3" opacity="0.4"/>
          <path d="M16 6L8 18" stroke="#3B82F6" stroke-width="0.3" opacity="0.4"/>
        </svg>
        CrystalBudget
      </a>
      <button class="sidebar-close" onclick="closeSidebar()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    
    <nav class="sidebar-nav">
      <div class="nav-item">
        <a class="nav-link-modern {% if request.endpoint == 'dashboard' %}active{% endif %}" href="{{ url_for('dashboard') }}" onclick="closeSidebar()">
          <i class="bi bi-house-door"></i> –î–∞—à–±–æ—Ä–¥
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link-modern {% if request.endpoint == 'expenses' %}active{% endif %}" href="{{ url_for('expenses') }}" onclick="closeSidebar()">
          <i class="bi bi-wallet2"></i> –†–∞—Å—Ö–æ–¥—ã
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link-modern {% if request.endpoint == 'categories' %}active{% endif %}" href="{{ url_for('categories') }}" onclick="closeSidebar()">
          <i class="bi bi-tags"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link-modern {% if request.endpoint in ['income_page','edit_income','sources_page'] %}active{% endif %}" href="{{ url_for('income_page') }}" onclick="closeSidebar()">
          <i class="bi bi-cash-coin"></i> –î–æ—Ö–æ–¥—ã
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link-modern {% if request.endpoint == 'goals' %}active{% endif %}" href="{{ url_for('goals') }}" onclick="closeSidebar()">
          <i class="bi bi-target"></i> –¶–µ–ª–∏
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link-modern {% if request.endpoint in ['shared_budgets', 'shared_budget_detail'] %}active{% endif %}" href="{{ url_for('shared_budgets') }}" onclick="closeSidebar()">
          <i class="bi bi-people"></i> –°–µ–º—å—è
        </a>
      </div>
    </nav>
    
    <div class="sidebar-footer">
      <a class="user-profile" href="#">
        <i class="bi bi-person-circle" style="font-size: 1.5rem;"></i>
        <div class="user-info">
          <div class="user-name">{{ session.name or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}</div>
          <div class="user-email">{{ session.email }}</div>
        </div>
      </a>
      
      <div class="sidebar-controls">
        <div class="sidebar-section">
          <div class="sidebar-section-title">–í–∞–ª—é—Ç–∞</div>
          <div class="currency-selector">
            <button class="currency-option active rub" onclick="setCurrency('RUB')" id="curr-rub-sidebar">‚ÇΩ</button>
            <button class="currency-option usd" onclick="setCurrency('USD')" id="curr-usd-sidebar">$</button>
            <button class="currency-option eur" onclick="setCurrency('EUR')" id="curr-eur-sidebar">‚Ç¨</button>
            <button class="currency-option amd" onclick="setCurrency('AMD')" id="curr-amd-sidebar">÷è</button>
            <button class="currency-option gel" onclick="setCurrency('GEL')" id="curr-gel-sidebar">‚Çæ</button>
          </div>
        </div>
        
        <div class="sidebar-section">
          <div class="sidebar-section-title">–¢–µ–º–∞</div>
          <div class="theme-toggle" onclick="toggleTheme()">
            <i class="bi bi-sun-fill" id="light-icon-sidebar"></i>
            <div class="theme-switch" id="theme-switch-sidebar"></div>
            <i class="bi bi-moon-fill" id="dark-icon-sidebar"></i>
          </div>
        </div>
      </div>
      
      <a class="logout-btn" href="{{ url_for('logout') }}">
        <i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏
      </a>
    </div>
  </div>
  {% endif %}

  <div class="container-modern py-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
    
    <!-- Toast container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer">
      <!-- Toasts will be inserted here -->
    </div>
  </div>

  <!-- Bootstrap JS with fallback -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" 
          integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" 
          crossorigin="anonymous" 
          onerror="loadBootstrapFallback()"></script>
  
  <script>
    function loadBootstrapFallback() {
      console.warn('Primary Bootstrap CDN failed, trying fallback...');
      
      // Try alternative CDN first
      const fallbackScript = document.createElement('script');
      fallbackScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js';
      fallbackScript.onerror = function() {
        console.warn('Alternative CDN also failed, using local fallback...');
        
        // Use local copy as final fallback
        const localScript = document.createElement('script');
        localScript.src = '{{ url_for("static", filename="js/bootstrap.bundle.min.js") }}';
        localScript.onerror = function() {
          console.error('All Bootstrap JS sources failed to load!');
          showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å.', 'danger');
        };
        document.head.appendChild(localScript);
      };
      document.head.appendChild(fallbackScript);
    }
    
    // Check if Bootstrap loaded after a short delay
    setTimeout(function() {
      if (typeof bootstrap === 'undefined') {
        console.warn('Bootstrap not detected, attempting to load fallback...');
        loadBootstrapFallback();
      }
    }, 1000);
  </script>

  <!-- PWA Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/static/sw.js').catch(console.error);
      });
    }
  </script>

  <!-- Theme & Currency -->
  <script>
    let currentCurrency = 'RUB';
    const currencySymbols = {
      'RUB':'‚ÇΩ', 'USD':'$', 'EUR':'‚Ç¨', 'AMD':'÷è', 'GEL':'‚Çæ'
    };

    async function setCurrency(currency){
      currentCurrency = currency;
      localStorage.setItem('currency', currency);
      // Update desktop currency selector
      document.querySelectorAll('.currency-option').forEach(o=>o.classList.remove('active'));
      const desktopBtn = document.getElementById('curr-'+currency.toLowerCase());
      if(desktopBtn) desktopBtn.classList.add('active');
      
      // Update sidebar currency selector
      document.querySelectorAll('.sidebar .currency-option').forEach(o=>o.classList.remove('active'));
      const sidebarBtn = document.getElementById('curr-'+currency.toLowerCase()+'-sidebar');
      if(sidebarBtn) sidebarBtn.classList.add('active');
      updateCurrencyDisplays();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ –±—ç–∫–µ–Ω–¥–µ
      try {
        await fetch('/set-currency', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ currency })
        });
      } catch (e) {
        console.log('Currency update failed:', e);
      }
    }

    function updateCurrencyDisplays(){
      const symbol = currencySymbols[currentCurrency] || '‚ÇΩ';
      document.querySelectorAll('.currency-display').forEach(el=>{
        el.textContent = symbol;
      });
    }

    function toggleTheme(){
      const cur=document.documentElement.getAttribute('data-bs-theme');
      const next=cur==='dark'?'light':'dark';
      document.documentElement.setAttribute('data-bs-theme',next);
      localStorage.setItem('theme',next);
      updateThemeToggle(next);
      
      // Update theme-color meta tag
      const themeColorMeta = document.querySelector('meta[name="theme-color"]');
      if (themeColorMeta) {
        themeColorMeta.content = next === 'dark' ? '#212529' : '#4fb3d9';
      }
    }

    function updateThemeToggle(theme){
      // Desktop theme toggle
      const light=document.getElementById('light-icon');
      const dark=document.getElementById('dark-icon');
      if(light) light.style.opacity = theme==='dark' ? '0.5' : '1';
      if(dark) dark.style.opacity  = theme==='dark' ? '1' : '0.5';
      
      // Sidebar theme toggle
      const lightSidebar=document.getElementById('light-icon-sidebar');
      const darkSidebar=document.getElementById('dark-icon-sidebar');
      if(lightSidebar) lightSidebar.style.opacity = theme==='dark' ? '0.5' : '1';
      if(darkSidebar) darkSidebar.style.opacity  = theme==='dark' ? '1' : '0.5';
    }
    
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.add('show');
      overlay.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    
    function closeSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.remove('show');
      overlay.classList.remove('show');
      document.body.style.overflow = '';
    }
    
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      if (!toastContainer) return;
      
      const toastId = 'toast-' + Date.now();
      const toastHtml = `
        <div id="${toastId}" class="toast" role="alert" data-bs-autohide="true" data-bs-delay="5000">
          <div class="toast-header">
            <i class="bi bi-${type === 'danger' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'} text-${type} me-2"></i>
            <strong class="me-auto">CrystalBudget</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
          </div>
          <div class="toast-body">
            ${message}
          </div>
        </div>
      `;
      
      toastContainer.insertAdjacentHTML('afterbegin', toastHtml);
      const toastElement = document.getElementById(toastId);
      
      if (typeof bootstrap !== 'undefined') {
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
      } else {
        // Fallback display without Bootstrap
        toastElement.style.display = 'block';
        setTimeout(() => toastElement.remove(), 5000);
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // Theme is already applied, just update UI
      const currentTheme = document.documentElement.getAttribute('data-bs-theme') || 'light';
      updateThemeToggle(currentTheme);

      const savedCurrency = localStorage.getItem('currency') || 'RUB';
      setCurrency(savedCurrency);
    });
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>