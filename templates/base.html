<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="color-scheme" content="light dark">
  <title>{% block title %}üíé CrystalBudget - Modern Finance{% endblock %}</title>

  <!-- Favicon -->
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
  <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png') }}">

  <!-- PWA -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.webmanifest') }}">
  <meta name="theme-color" content="#4fb3d9">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CrystalBudget">
  <link rel="apple-touch-icon" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
  <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png') }}">
  <meta name="format-detection" content="telephone=no">

  <!-- –õ–û–ö–ê–õ–¨–ù–´–ï —Å—Ç–∏–ª–∏ (–±–µ–∑ CDN) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/bootstrap/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/bootstrap-icons/bootstrap-icons.css') }}">
  <!-- –í–ê–®–∏ —Å—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/clean-theme.css') }}">

  <!-- –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã -->
  <script>
    (function() {
      const savedTheme = localStorage.getItem('theme') ||
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-bs-theme', savedTheme);
      const meta = document.querySelector('meta[name="theme-color"]');
      if (meta) meta.content = savedTheme === 'dark' ? '#212529' : '#4fb3d9';
    })();
  </script>

  <style>
    :root{
      --safe-area-inset-top: env(safe-area-inset-top, 0px);
      --safe-area-inset-right: env(safe-area-inset-right, 0px);
      --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
      --safe-area-inset-left: env(safe-area-inset-left, 0px);
    }
    body{padding:var(--safe-area-inset-top) var(--safe-area-inset-right) var(--safe-area-inset-bottom) var(--safe-area-inset-left)}
    .container-fluid{padding-left:max(15px,var(--safe-area-inset-left));padding-right:max(15px,var(--safe-area-inset-right))}
    .navbar-modern{position:relative}
    .navbar-modern .container-fluid{display:flex;align-items:center;gap:.5rem;flex-wrap:nowrap;position:relative}
    .navbar-brand-modern{margin-right:auto;white-space:nowrap}
    .navbar-modern .navbar-nav .nav-link-modern,.navbar-modern .btn,.navbar-modern .currency-selector{white-space:nowrap}
    @media (max-width: 992px){
      .navbar-modern .navbar-nav .nav-link-modern,.navbar-modern .btn{padding:.4rem .6rem;font-size:.95rem}
      .currency-selector .currency-option{padding:.25rem .5rem;min-width:2.25rem}
      .sidebar-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1040;opacity:0;visibility:hidden;transition:.3s}
      .sidebar-overlay.show{opacity:1;visibility:visible}
      .sidebar{position:fixed;top:0;left:-280px;width:280px;height:100%;background:var(--bs-body-bg);border-right:1px solid var(--bs-border-color);box-shadow:4px 0 12px rgba(0,0,0,.15);z-index:1050;transition:left .3s;display:flex;flex-direction:column;overflow-y:auto}
      .sidebar.show{left:0}
      .sidebar-header{padding:1rem;border-bottom:1px solid var(--bs-border-color);display:flex;align-items:center;justify-content:space-between}
      .sidebar-brand{font-weight:700;font-size:1.25rem;color:var(--bs-primary);text-decoration:none;display:flex;align-items:center;gap:8px}
      .sidebar-close{background:none;border:none;font-size:1.5rem;color:var(--bs-secondary);cursor:pointer;padding:.25rem;display:flex;align-items:center;justify-content:center}
      .sidebar-nav{flex:1;padding:1rem 0}
      .sidebar-nav .nav-item{margin:.25rem 0}
      .sidebar-nav .nav-link-modern{display:flex;align-items:center;gap:.75rem;padding:.875rem 1rem;margin:0 .5rem;border-radius:.5rem;color:var(--bs-body-color);text-decoration:none;font-weight:500;transition:.2s;border:1px solid transparent}
      .sidebar-nav .nav-link-modern:hover{background:var(--bs-primary-bg-subtle);color:var(--bs-primary);transform:translateX(4px)}
      .sidebar-nav .nav-link-modern.active{background:var(--bs-primary);color:#fff;font-weight:600;border-color:var(--bs-primary)}
      .sidebar-nav .nav-link-modern i{width:20px;text-align:center}
      .sidebar-footer{padding:1rem;border-top:1px solid var(--bs-border-color);background:var(--bs-secondary-bg)}
      .sidebar-controls{display:flex;flex-direction:column;gap:1rem}
      .sidebar-section{display:flex;flex-direction:column;gap:.5rem}
      .sidebar-section-title{font-size:.75rem;font-weight:600;color:var(--bs-secondary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:.25rem}
      .currency-selector{display:grid;grid-template-columns:repeat(5,1fr);gap:.25rem}
      .currency-option{padding:.5rem .25rem;text-align:center;border:1px solid var(--bs-border-color);border-radius:.375rem;background:var(--bs-body-bg);font-size:.875rem;cursor:pointer;transition:.2s}
      .currency-option:hover{background:var(--bs-secondary-bg)}
      .currency-option.active{background:var(--bs-primary);color:#fff;border-color:var(--bs-primary)}
      .theme-toggle{display:flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem;border:1px solid var(--bs-border-color);border-radius:.5rem;background:var(--bs-body-bg);cursor:pointer;transition:.2s}
      .theme-toggle:hover{background:var(--bs-secondary-bg)}
      .user-profile{display:flex;align-items:center;gap:.75rem;padding:.75rem;border:1px solid var(--bs-border-color);border-radius:.5rem;background:var(--bs-body-bg);text-decoration:none;color:var(--bs-body-color);transition:.2s;margin-bottom:.5rem}
      .user-profile:hover{background:var(--bs-secondary-bg)}
      .user-info{flex:1;display:flex;flex-direction:column}
      .user-name{font-weight:600;font-size:.875rem;line-height:1.2}
      .user-email{font-size:.75rem;color:var(--bs-secondary);line-height:1.2}
      .logout-btn{background:var(--bs-danger);color:#fff;border:none;border-radius:.375rem;padding:.5rem 1rem;font-size:.875rem;font-weight:500;cursor:pointer;transition:.2s;text-decoration:none;display:flex;align-items:center;justify-content:center;gap:.5rem}
      .logout-btn:hover{background:var(--bs-danger-dark,#c82333);color:#fff;transform:translateY(-1px)}
      .navbar-collapse{display:none!important}
      .table-responsive{font-size:.9rem}
      .btn-group .btn-sm{font-size:.8rem;padding:.25rem .5rem}
      .card{margin-bottom:1rem}
      .mobile-hide{display:none}
    }
    @media (min-width:768px){.mobile-hide{display:inline}}
  </style>
</head>
<body>
  {% if session.user_id %}
  <nav class="navbar navbar-expand-lg navbar-modern">
    <div class="container-fluid">
      <a class="navbar-brand-modern" href="{{ url_for('dashboard') }}">
        <!-- –ª–æ–≥–æ—Ç–∏–ø -->
        <svg class="ff-crystal" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="crystalGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#60A5FA;stop-opacity:1"/><stop offset="25%" style="stop-color:#3B82F6;stop-opacity:1"/><stop offset="50%" style="stop-color:#1D4ED8;stop-opacity:1"/><stop offset="75%" style="stop-color:#1E40AF;stop-opacity:1"/><stop offset="100%" style="stop-color:#1E3A8A;stop-opacity:1"/>
            </linearGradient>
          </defs>
          <path d="M12 2L16 6L20 10L16 18L12 22L8 18L4 10L8 6L12 2Z" fill="url(#crystalGradient)"/>
        </svg>
        CrystalBudget
      </a>

      <button class="navbar-toggler" type="button" onclick="toggleSidebar()">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="d-none d-lg-flex collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link-modern {% if request.endpoint == 'dashboard' %}active{% endif %}" href="{{ url_for('dashboard') }}">
              <i class="bi bi-house-door"></i> –î–∞—à–±–æ—Ä–¥
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link-modern {% if request.endpoint == 'expenses' %}active{% endif %}" href="{{ url_for('expenses') }}">
              <i class="bi bi-wallet2"></i> –†–∞—Å—Ö–æ–¥—ã
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link-modern {% if request.endpoint == 'categories' %}active{% endif %}" href="{{ url_for('categories') }}">
              <i class="bi bi-tags"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link-modern {% if request.endpoint in ['income_page','edit_income','sources_page'] %}active{% endif %}" href="{{ url_for('income_page') }}">
              <i class="bi bi-cash-coin"></i> –î–æ—Ö–æ–¥—ã
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link-modern {% if request.endpoint == 'goals' %}active{% endif %}" href="{{ url_for('goals') }}">
              <i class="bi bi-bullseye"></i> –¶–µ–ª–∏
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link-modern {% if request.endpoint in ['shared_budgets','shared_budget_detail'] %}active{% endif %}" href="{{ url_for('shared_budgets') }}">
              <i class="bi bi-people"></i> –°–µ–º—å—è
            </a>
          </li>
        </ul>

        <ul class="navbar-nav">
          <li class="nav-item me-3">
            <div class="currency-selector">
              <button class="currency-option active rub" onclick="setCurrency('RUB')" id="curr-rub">‚ÇΩ</button>
              <button class="currency-option usd" onclick="setCurrency('USD')" id="curr-usd">$</button>
              <button class="currency-option eur" onclick="setCurrency('EUR')" id="curr-eur">‚Ç¨</button>
              <button class="currency-option amd" onclick="setCurrency('AMD')" id="curr-amd">÷è</button>
              <button class="currency-option gel" onclick="setCurrency('GEL')" id="curr-gel">‚Çæ</button>
            </div>
          </li>
          <li class="nav-item me-3">
            <div class="theme-toggle" onclick="toggleTheme()">
              <i class="bi bi-sun-fill" id="light-icon"></i>
              <div class="theme-switch" id="theme-switch"></div>
              <i class="bi bi-moon-fill" id="dark-icon"></i>
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link-modern dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
              <i class="bi bi-person-circle"></i> {{ session.name or session.email }}
            </a>
            <ul class="dropdown-menu dropdown-menu-end modern-card" style="border:none;">
              <li>
                <a class="dropdown-item nav-link-modern" href="{{ url_for('logout') }}">
                  <i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏
                </a>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- –ú–æ–±–∏–ª—å–Ω—ã–π —Å–∞–π–¥–±–∞—Ä -->
  <div class="sidebar-overlay d-lg-none" id="sidebarOverlay" onclick="closeSidebar()"></div>
  <div class="sidebar d-lg-none" id="sidebar">
    <div class="sidebar-header">
      <a class="sidebar-brand" href="{{ url_for('dashboard') }}">CrystalBudget</a>
      <button class="sidebar-close" onclick="closeSidebar()"><i class="bi bi-x-lg"></i></button>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item"><a class="nav-link-modern {% if request.endpoint == 'dashboard' %}active{% endif %}" href="{{ url_for('dashboard') }}" onclick="closeSidebar()"><i class="bi bi-house-door"></i> –î–∞—à–±–æ—Ä–¥</a></div>
      <div class="nav-item"><a class="nav-link-modern {% if request.endpoint == 'expenses' %}active{% endif %}" href="{{ url_for('expenses') }}" onclick="closeSidebar()"><i class="bi bi-wallet2"></i> –†–∞—Å—Ö–æ–¥—ã</a></div>
      <div class="nav-item"><a class="nav-link-modern {% if request.endpoint == 'categories' %}active{% endif %}" href="{{ url_for('categories') }}" onclick="closeSidebar()"><i class="bi bi-tags"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a></div>
      <div class="nav-item"><a class="nav-link-modern {% if request.endpoint in ['income_page','edit_income','sources_page'] %}active{% endif %}" href="{{ url_for('income_page') }}" onclick="closeSidebar()"><i class="bi bi-cash-coin"></i> –î–æ—Ö–æ–¥—ã</a></div>
      <div class="nav-item"><a class="nav-link-modern {% if request.endpoint == 'goals' %}active{% endif %}" href="{{ url_for('goals') }}" onclick="closeSidebar()"><i class="bi bi-bullseye"></i> –¶–µ–ª–∏</a></div>
      <div class="nav-item"><a class="nav-link-modern {% if request.endpoint in ['shared_budgets','shared_budget_detail'] %}active{% endif %}" href="{{ url_for('shared_budgets') }}" onclick="closeSidebar()"><i class="bi bi-people"></i> –°–µ–º—å—è</a></div>
    </nav>
    <div class="sidebar-footer">
      <a class="user-profile" href="#"><i class="bi bi-person-circle" style="font-size:1.5rem;"></i>
        <div class="user-info">
          <div class="user-name">{{ session.name or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}</div>
          <div class="user-email">{{ session.email }}</div>
        </div>
      </a>
      <div class="sidebar-controls">
        <div class="sidebar-section">
          <div class="sidebar-section-title">–í–∞–ª—é—Ç–∞</div>
          <div class="currency-selector">
            <button class="currency-option active rub" onclick="setCurrency('RUB')" id="curr-rub-sidebar">‚ÇΩ</button>
            <button class="currency-option usd" onclick="setCurrency('USD')" id="curr-usd-sidebar">$</button>
            <button class="currency-option eur" onclick="setCurrency('EUR')" id="curr-eur-sidebar">‚Ç¨</button>
            <button class="currency-option amd" onclick="setCurrency('AMD')" id="curr-amd-sidebar">÷è</button>
            <button class="currency-option gel" onclick="setCurrency('GEL')" id="curr-gel-sidebar">‚Çæ</button>
          </div>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">–¢–µ–º–∞</div>
          <div class="theme-toggle" onclick="toggleTheme()">
            <i class="bi bi-sun-fill" id="light-icon-sidebar"></i>
            <div class="theme-switch" id="theme-switch-sidebar"></div>
            <i class="bi bi-moon-fill" id="dark-icon-sidebar"></i>
          </div>
        </div>
      </div>
      <a class="logout-btn" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏</a>
    </div>
  </div>
  {% endif %}

  <div class="container-modern py-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}

    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>
  </div>

  <!-- –õ–û–ö–ê–õ–¨–ù–´–ô Bootstrap JS (bundle —Å Popper) -->
  <script defer src="{{ url_for('static', filename='vendor/bootstrap/bootstrap.bundle.min.js') }}"></script>

  <!-- PWA SW -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/static/sw.js').catch(console.error);
      });
    }
  </script>

  <!-- –¢–µ–º–∞ –∏ –í–∞–ª—é—Ç–∞ -->
  <script>
    let currentCurrency = 'RUB';
    const currencySymbols = {RUB:'‚ÇΩ', USD:'$', EUR:'‚Ç¨', AMD:'÷è', GEL:'‚Çæ'};

    async function setCurrency(currency){
      currentCurrency = currency;
      localStorage.setItem('currency', currency);

      document.querySelectorAll('.currency-option').forEach(o=>o.classList.remove('active'));
      const desktopBtn = document.getElementById('curr-'+currency.toLowerCase());
      if(desktopBtn) desktopBtn.classList.add('active');
      document.querySelectorAll('.sidebar .currency-option').forEach(o=>o.classList.remove('active'));
      const sidebarBtn = document.getElementById('curr-'+currency.toLowerCase()+'-sidebar');
      if(sidebarBtn) sidebarBtn.classList.add('active');

      updateCurrencyDisplays();

      try {
        await fetch('/set-currency', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({currency})
        });
      } catch(e){ console.log('Currency update failed:', e); }
    }

    function updateCurrencyDisplays(){
      const symbol = currencySymbols[currentCurrency] || '‚ÇΩ';
      document.querySelectorAll('.currency-display').forEach(el=>{ el.textContent = symbol; });
    }

    function toggleTheme(){
      const cur=document.documentElement.getAttribute('data-bs-theme');
      const next=cur==='dark'?'light':'dark';
      document.documentElement.setAttribute('data-bs-theme',next);
      localStorage.setItem('theme',next);
      const meta=document.querySelector('meta[name="theme-color"]');
      if(meta) meta.content = next==='dark' ? '#212529' : '#4fb3d9';
      updateThemeToggle(next);
    }

    function updateThemeToggle(theme){
      const light=document.getElementById('light-icon'); const dark=document.getElementById('dark-icon');
      if(light) light.style.opacity = theme==='dark' ? '0.5' : '1';
      if(dark)  dark.style.opacity  = theme==='dark' ? '1' : '0.5';
      const ls=document.getElementById('light-icon-sidebar'); const ds=document.getElementById('dark-icon-sidebar');
      if(ls) ls.style.opacity = theme==='dark' ? '0.5' : '1';
      if(ds) ds.style.opacity  = theme==='dark' ? '1' : '0.5';
    }

    function toggleSidebar(){
      const s=document.getElementById('sidebar'); const o=document.getElementById('sidebarOverlay');
      s.classList.add('show'); o.classList.add('show'); document.body.style.overflow='hidden';
    }
    function closeSidebar(){
      const s=document.getElementById('sidebar'); const o=document.getElementById('sidebarOverlay');
      s.classList.remove('show'); o.classList.remove('show'); document.body.style.overflow='';
    }
    function showToast(message,type='info'){
      const c=document.getElementById('toastContainer'); if(!c) return;
      const id='toast-'+Date.now();
      c.insertAdjacentHTML('afterbegin',`
        <div id="${id}" class="toast" role="alert" data-bs-autohide="true" data-bs-delay="5000">
          <div class="toast-header">
            <i class="bi bi-${type==='danger'?'exclamation-triangle':type==='success'?'check-circle':'info-circle'} text-${type} me-2"></i>
            <strong class="me-auto">CrystalBudget</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
          </div>
          <div class="toast-body">${message}</div>
        </div>`);
      const el=document.getElementById(id);
      if (typeof bootstrap!=='undefined') new bootstrap.Toast(el).show();
      else { el.style.display='block'; setTimeout(()=>el.remove(),5000); }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const theme=document.documentElement.getAttribute('data-bs-theme')||'light';
      updateThemeToggle(theme);
      const savedCurrency=localStorage.getItem('currency')||'RUB';
      setCurrency(savedCurrency);
    });
  </script>

  {% block scripts %}{% endblock %}
<script>
const currencySymbols = {
    RUB: "‚ÇΩ",
    USD: "$",
    EUR: "‚Ç¨",
    AMD: "÷è",
    GEL: "‚Çæ"
};

async function setCurrency(currency) {
    localStorage.setItem("currency", currency);

    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
    document.querySelectorAll(".currency-option").forEach(btn => btn.classList.remove("active"));
    document.querySelector(`#curr-${currency.toLowerCase()}`)?.classList.add("active");

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∞–ª—é—Ç—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    await fetch("/set-currency", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ currency })
    });

    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ —Å—É–º–º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    convertAllAmounts(currency);
}

async function convertAllAmounts(targetCurrency) {
    const amounts = document.querySelectorAll("[data-amount]");
    for (const el of amounts) {
        const original = parseFloat(el.dataset.amount);
        const fromCurrency = el.dataset.currency || "RUB";

        try {
            const res = await fetch(`/api/convert?from=${fromCurrency}&to=${targetCurrency}&amount=${original}`);
            const data = await res.json();

            if (data.success) {
                el.textContent = data.converted.toLocaleString("ru-RU", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }) + " " + currencySymbols[targetCurrency];
            }
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:", e);
        }
    }
}

document.addEventListener("DOMContentLoaded", () => {
    const savedCurrency = localStorage.getItem("currency") || "RUB";
    setCurrency(savedCurrency);
});
</script>
</body>
</html>