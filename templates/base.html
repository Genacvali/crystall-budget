<!doctype html>
<html lang="ru" data-bs-theme="{{ session.get('theme','light') }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}CrystalBudget{% endblock %}</title>

  <!-- Bootstrap –ª–æ–∫–∞–ª—å–Ω–æ -->
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/bootstrap/bootstrap.min.css') }}">

  <!-- Bootstrap Icons –ª–æ–∫–∞–ª—å–Ω–æ -->
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/bootstrap-icons/bootstrap-icons.css') }}">

  <!-- –¢–≤–æ–∏ –±–∞–∑–æ–≤—ã–µ —Ç–µ–º—ã/—Ç–æ–∫–µ–Ω—ã –∏ —Ç—É–º–±–ª–µ—Ä -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/clean-theme.css') }}?v=20250921-9">

  <!-- –°—Ç–∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
  {% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}?v=20250921-9">
  {% endblock %}
  
  <style>
  /* ======= –ù–æ–≤–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è ======= */
  :root{
    --radius-xl:16px; --radius-lg:12px;
    --shadow:0 10px 30px rgba(0,0,0,.12);
    --blur:saturate(130%) blur(10px);
    --primary:#6366f1; --accent:#0ea5e9; --line:rgba(0,0,0,.12);
  }

  /* —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞ */
  [data-bs-theme="dark"]{
    --line:rgba(255,255,255,.14);
  }

  .nav{
    position:sticky; top:0; z-index:20;
    padding:10px 20px;
    backdrop-filter:var(--blur);
    background: color-mix(in srgb, var(--surface) 86%, transparent);
    border-bottom:1px solid var(--line);
  }
  .nav .row{
    max-width:1200px; margin:0 auto;
    display:flex; align-items:center; gap:18px;
  }
  .brand{
    display:flex; align-items:center; gap:10px;
    font-weight:800; letter-spacing:.2px; color:var(--ink); text-decoration:none;
  }
  .brand .logo{
    inline-size:24px; block-size:24px; display:grid; place-items:center; border-radius:8px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    box-shadow:0 6px 16px color-mix(in srgb, var(--primary) 35%, transparent);
  }
  .brand .logo svg{ width:14px; height:14px; fill:#fff; }

  .tabs{
    display:flex; align-items:center; gap:6px;
    background: color-mix(in srgb, var(--surface) 70%, transparent);
    border:1px solid var(--line); border-radius:999px;
    padding:4px; box-shadow:var(--shadow);
  }
  .tab{
    --pad:.55rem .9rem;
    position:relative; display:inline-flex; align-items:center; gap:.45rem;
    color:var(--ink); opacity:.88; padding:var(--pad); border-radius:999px;
    text-decoration:none; transition:.15s ease;
  }
  .tab:hover{ opacity:1; }
  .tab svg{ width:16px; height:16px; fill:currentColor; opacity:.9 }
  .tab.active{ color:#fff; }
  .tab.active::before{
    content:""; position:absolute; inset:0; border-radius:inherit;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    box-shadow: 0 8px 24px color-mix(in srgb, var(--accent) 40%, transparent);
    z-index:-1;
  }

  .right{ margin-left:auto; display:flex; align-items:center; gap:10px; }

  /* –î—Ä–æ–ø-–∫–∞–ª–µ–Ω–¥–∞—Ä—å */
  .date-picker{ position:relative; display:inline-block; }
  .dp-btn{
    display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border-radius:999px;
    background: color-mix(in srgb, var(--surface) 80%, transparent); border:1px solid var(--line);
    color:var(--ink); cursor:pointer; user-select:none;
  }
  .dp-btn svg{ width:16px; height:16px; fill:currentColor; opacity:.9 }

  .dp-pop{
    position:absolute; inset:calc(100% + 8px) auto auto 0;
    width:292px; background:var(--surface); border:1px solid var(--line); border-radius:16px;
    box-shadow:var(--shadow); padding:10px; z-index:40;
    transform-origin:top left; opacity:0; visibility:hidden; transform:translateY(-6px) scale(.98); transition:.18s ease;
  }
  .date-picker.open .dp-pop{ opacity:1; visibility:visible; transform:translateY(0) scale(1); }

  .dp-head{ display:flex; align-items:center; gap:6px; margin-bottom:8px; }
  .dp-title{ font-weight:800; letter-spacing:.2px }
  .dp-spacer{ margin-left:auto }
  .dp-icon{ display:grid; place-items:center; width:28px; height:28px; border-radius:10px; border:1px solid var(--line);
    background: color-mix(in srgb, var(--surface) 85%, transparent); cursor:pointer; }
  .dp-icon:hover{ background: color-mix(in srgb, var(--surface) 95%, transparent) }

  .dp-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
  .dp-dow{ text-align:center; color:var(--muted); font-size:.78rem; padding:.25rem 0 }
  .dp-day{
    height:32px; display:grid; place-items:center; border-radius:10px; cursor:pointer;
    background: color-mix(in srgb, var(--surface) 90%, transparent);
    border:1px solid var(--line); color:var(--ink);
    transition: transform .1s ease, background .15s ease, border-color .15s ease;
  }
  .dp-day:hover{ transform:translateY(-1px) }
  .dp-out{ opacity:.45 }
  .dp-today{ border-color: color-mix(in srgb, var(--accent) 50%, transparent) }
  .dp-sel{
    background: color-mix(in srgb, var(--accent) 18%, var(--surface));
    border-color: color-mix(in srgb, var(--accent) 40%, var(--line));
    box-shadow: 0 6px 16px color-mix(in srgb, var(--accent) 26%, transparent);
  }

  /* –¢—É–º–±–ª–µ—Ä —Ç–µ–º—ã */
  .theme{
    display:inline-grid; grid-template-columns:auto 48px auto; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px; background: color-mix(in srgb, var(--surface) 70%, transparent);
    border:1px solid var(--line);
  }
  .theme .sun,.theme .moon{ opacity:.65 }
  #theme:checked ~ .nav .theme .sun{ opacity:.45 }
  #theme:not(:checked) ~ .nav .theme .moon{ opacity:.45 }
  .switch{
    position:relative; width:48px; height:24px; border-radius:999px; overflow:hidden;
    background: color-mix(in srgb, var(--accent) 22%, transparent);
    border:1px solid color-mix(in srgb, var(--ink) 14%, transparent);
  }
  .switch::after{
    content:""; position:absolute; top:2px; left:2px; width:20px; height:20px; border-radius:50%;
    background:#fff; box-shadow:0 2px 6px rgba(0,0,0,.25); transition: transform .22s ease;
  }
  #theme:checked ~ .nav .switch::after{ transform: translateX(24px); }

  /* –†–µ—Å–ø–æ–Ω—Å–∏–≤ */
  @media (max-width:980px){
    .tabs{ display:none; }
  }
  </style>
</head>
<body>

<!-- —á–µ–∫–±–æ–∫—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–º–æ–π -->
<input id="theme" type="checkbox" hidden {{ 'checked' if session.get('theme') == 'dark' else '' }} />

<!-- ======= –ù–∞–≤–∏–≥–∞—Ü–∏—è ======= -->
<header class="nav" role="navigation" aria-label="–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
  <div class="row">
    <a class="brand" href="{{ url_for('dashboard') }}">
      <span class="logo" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M12 2l6 6-6 14-6-14 6-6zm0 4l-3.5 3.5L12 18l3.5-8.5L12 6z"/></svg>
      </span>
      CrystalBudget
    </a>

    <nav class="tabs" aria-label="–†–∞–∑–¥–µ–ª—ã">
      <a class="tab {{ 'active' if request.endpoint == 'dashboard' else '' }}" href="{{ url_for('dashboard') }}">
        <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm10 8h8v-6h-8v6zM3 21h8v-6H3v6zm10-8h8V3h-8v10z"/></svg>
        –î–∞—à–±–æ—Ä–¥
      </a>
      <a class="tab {{ 'active' if request.endpoint == 'expenses' else '' }}" href="{{ url_for('expenses') if url_for else '#' }}">
        <svg viewBox="0 0 24 24"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h10v2H4z"/></svg>
        –†–∞—Å—Ö–æ–¥—ã
      </a>
      <a class="tab {{ 'active' if request.endpoint == 'categories' else '' }}" href="{{ url_for('categories') if url_for else '#' }}">
        <svg viewBox="0 0 24 24"><path d="M12 2l4 4-8 8-4-4 8-8zm-3 14l-1 4 4-1 8-8-3-3-8 8z"/></svg>
        –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
      </a>
      <a class="tab" href="#">
        <svg viewBox="0 0 24 24"><path d="M12 3l4 7H8l4-7zm-7 9h14l-7 9-7-9z"/></svg>
        –î–æ—Ö–æ–¥—ã
      </a>
    </nav>

    <div class="right">
      <!-- –î—Ä–æ–ø-–∫–∞–ª–µ–Ω–¥–∞—Ä—å -->
      <div class="date-picker" id="datePicker">
        <button class="dp-btn" type="button" id="dpBtn" title="–í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É">
          <svg viewBox="0 0 24 24"><path d="M7 2h2v2h6V2h2v2h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h3V2zm14 8H3v10a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1V10zM4 9h16V6a1 1 0 0 0-1-1h-3v2h-2V5H9v2H7V5H4a1 1 0 0 0-1 1v3z"/></svg>
          <span id="dpLabel">–°–µ–≥–æ–¥–Ω—è</span>
        </button>
        <div class="dp-pop" role="dialog" aria-modal="true" aria-label="–í—ã–±–æ—Ä –¥–∞—Ç—ã">
          <div class="dp-head">
            <button class="dp-icon" id="dpPrev" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü">‚óÄ</button>
            <div class="dp-title" id="dpTitle">–ú–µ—Å—è—Ü</div>
            <div class="dp-spacer"></div>
            <button class="dp-icon" id="dpToday" title="–°–µ–≥–æ–¥–Ω—è">‚óè</button>
            <button class="dp-icon" id="dpNext" aria-label="–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü">‚ñ∂</button>
          </div>
          <div class="dp-grid" id="dpGrid" role="grid" aria-labelledby="dpTitle"></div>
        </div>
      </div>

      <!-- –¢—É–º–±–ª–µ—Ä —Ç–µ–º—ã -->
      <label class="theme" for="theme" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
        <span class="sun" aria-hidden="true">‚òÄÔ∏è</span>
        <span class="switch" aria-hidden="true"></span>
        <span class="moon" aria-hidden="true">üåô</span>
      </label>
    </div>
  </div>
</header>

<main class="page-wrap py-4">
  <div class="container-xl">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="toast-container">
          {% for category, message in messages %}
            <div class="alert alert-{{ 'warning' if category=='error' else category }} shadow-sm">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </div>
</main>

<!-- Scripts -->
<script src="{{ url_for('static', filename='vendor/bootstrap/bootstrap.bundle.min.js') }}"></script>
{% block scripts %}{% endblock %}

<script>
/* === –õ–æ–≥–∏–∫–∞ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ –¥—Ä–æ–ø-–∫–∞–ª–µ–Ω–¥–∞—Ä—è === */
(() => {
  const root  = document.getElementById('datePicker');
  const btn   = document.getElementById('dpBtn');
  const grid  = document.getElementById('dpGrid');
  const title = document.getElementById('dpTitle');
  const label = document.getElementById('dpLabel');

  if (!root || !btn || !grid || !title || !label) return;

  const months = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
  const dows   = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];

  const targets = ['#expenseDate','#incomeDate']; // –µ—Å–ª–∏ –µ—Å—Ç—å –∏–Ω–ø—É—Ç—ã ‚Äî –∑–∞–ø–æ–ª–Ω–∏–º
  let current = new Date(); current.setDate(1);
  let selected = new Date();

  const ymd = d => d.toISOString().slice(0,10);
  const fmt = d => d.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit',year:'numeric'});

  function render(){
    const y=current.getFullYear(), m=current.getMonth();
    title.textContent = `${months[m]} ${y}`;

    const first = new Date(y,m,1);
    const firstDow = (first.getDay()+6)%7; // –ü–Ω=0
    const dim = new Date(y,m+1,0).getDate();
    const total = 42;
    const today = ymd(new Date());
    const frag = document.createDocumentFragment();

    // –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π
    dows.forEach(d => {
      const el = document.createElement('div');
      el.className = 'dp-dow'; el.textContent = d;
      frag.appendChild(el);
    });

    // —è—á–µ–π–∫–∏
    for (let i=0;i<total;i++){
      const dayNum = i - firstDow + 1;
      const date = new Date(y,m,dayNum);
      const out = dayNum < 1 || dayNum > dim;

      const cell = document.createElement('div');
      cell.className = 'dp-day';
      if (out) cell.classList.add('dp-out');

      const ds = ymd(date);
      if (ds === today) cell.classList.add('dp-today');
      if (ymd(selected) === ds) cell.classList.add('dp-sel');

      cell.textContent = String(date.getDate());
      cell.addEventListener('click', () => {
        selected = date; label.textContent = fmt(date);
        targets.forEach(sel => { const i = document.querySelector(sel); if (i) i.value = ds; });
        close();
      });

      frag.appendChild(cell);
    }
    grid.replaceChildren(frag);
  }

  function open(){ root.classList.add('open'); render(); trap=true; }
  function close(){ root.classList.remove('open'); trap=false; }

  btn.addEventListener('click', (e)=>{ e.stopPropagation(); root.classList.contains('open') ? close() : open(); });
  document.getElementById('dpPrev').onclick = ()=>{ current.setMonth(current.getMonth()-1); render(); };
  document.getElementById('dpNext').onclick = ()=>{ current.setMonth(current.getMonth()+1); render(); };
  document.getElementById('dpToday').onclick= ()=>{ current=new Date(); current.setDate(1); selected=new Date(); render(); };

  // –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∏ –ø–æ Esc
  let trap=false;
  document.addEventListener('click', (e)=>{ if (!root.contains(e.target) && trap) close(); });
  document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && trap) close(); });

  label.textContent = fmt(selected);
})();

/* === –õ–æ–≥–∏–∫–∞ —Ç–µ–º—ã === */
(() => {
  const root = document.documentElement;
  const themeCheckbox = document.getElementById('theme');

  function applyTheme(theme){
    root.setAttribute('data-bs-theme', theme);
    if (themeCheckbox) {
      themeCheckbox.checked = theme === 'dark';
    }
  }

  function currentTheme(){
    return root.getAttribute('data-bs-theme') || 'light';
  }

  async function saveTheme(theme){
    try {
      await fetch('/set-theme', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({theme})
      });
    } catch(e){}
  }

  if (themeCheckbox){
    themeCheckbox.addEventListener('change', () => {
      const next = themeCheckbox.checked ? 'dark' : 'light';
      applyTheme(next);
      saveTheme(next);
    });
  }

  // –ø–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è
  applyTheme(currentTheme());
})();
</script>
</body>
</html>