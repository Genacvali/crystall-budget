<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <title>{% block title %}üíé CrystalBudget ‚Äî Modern Finance{% endblock %}</title>

  <!-- Favicon -->
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" />
  <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}" />
  <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png') }}" />

  <!-- PWA -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.webmanifest') }}" />
  <meta name="theme-color" content="#4fb3d9" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="CrystalBudget" />
  <link rel="apple-touch-icon" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}" />
  <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png') }}" />
  <meta name="format-detection" content="telephone=no" />

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- App styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/clean-theme.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/improved-visual-hierarchy.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/zen-style.css') }}" />

  <!-- Instant theme apply (no flash) -->
  <script>
    (function () {
      const serverTheme = '{{ session.get("theme", "light") }}';
      const stored = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = stored || serverTheme || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-bs-theme', theme);
      const meta = document.querySelector('meta[name="theme-color"]');
      if (meta) meta.content = theme === 'dark' ? '#212529' : '#4fb3d9';
    })();
  </script>

  <style>
    :root {
      --safe-area-inset-top: env(safe-area-inset-top, 0px);
      --safe-area-inset-right: env(safe-area-inset-right, 0px);
      --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
      --safe-area-inset-left: env(safe-area-inset-left, 0px);
    }
    body { padding: var(--safe-area-inset-top) var(--safe-area-inset-right) var(--safe-area-inset-bottom) var(--safe-area-inset-left); }

    /* Skip link for a11y */
    .skip-link { position: absolute; left: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden; }
    .skip-link:focus { position: fixed; left: 1rem; top: 1rem; width: auto; height: auto; padding: .5rem .75rem; z-index: 1080; background: var(--bs-primary); color: #fff; border-radius: .5rem; box-shadow: 0 4px 12px rgba(0,0,0,.25); }

    .container-fluid { padding-left: max(15px, var(--safe-area-inset-left)); padding-right: max(15px, var(--safe-area-inset-right)); }

    .navbar-modern { position: relative; }
    .navbar-modern .container-fluid { display: flex; align-items: center; gap: .5rem; flex-wrap: nowrap; position: relative; }
    .navbar-brand-modern { margin-right: auto; white-space: nowrap; display: inline-flex; align-items: center; gap: .5rem; font-weight: 700; }
    .nav-link-modern { display: inline-flex; align-items: center; gap: .5rem; }

    /* Desktop currency/theme */
    .currency-selector { display: inline-flex; gap: .25rem; }
    .currency-option { padding: .5rem .5rem; min-width: 2.25rem; border: 1px solid var(--bs-border-color); background: var(--bs-body-bg); border-radius: .375rem; cursor: pointer; line-height: 1; }
    .currency-option.active, .currency-option[aria-pressed="true"] { background: var(--bs-primary); color: #fff; border-color: var(--bs-primary); }
    .theme-toggle-btn { display: inline-flex; align-items: center; gap: .5rem; padding: .5rem .75rem; border: 1px solid var(--bs-border-color); border-radius: .5rem; background: var(--bs-body-bg); }

    /* Mobile sidebar */
    @media (max-width: 992px) {
      .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.45); z-index: 1040; opacity: 0; visibility: hidden; transition: .25s; }
      .sidebar-overlay.show { opacity: 1; visibility: visible; }
      .sidebar { position: fixed; top: 0; left: -300px; width: 300px; height: 100%; background: var(--bs-body-bg); border-right: 1px solid var(--bs-border-color); box-shadow: 4px 0 16px rgba(0,0,0,.2); z-index: 1050; transition: left .25s; display: flex; flex-direction: column; overflow-y: auto; }
      .sidebar.show { left: 0; }
      .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--bs-border-color); display: flex; align-items: center; justify-content: space-between; }
      .sidebar-brand { font-weight: 700; font-size: 1.125rem; color: var(--bs-primary); text-decoration: none; display: inline-flex; align-items: center; gap: .5rem; }
      .sidebar-close { background: none; border: none; font-size: 1.25rem; color: var(--bs-secondary); cursor: pointer; padding: .25rem; }
      .sidebar-nav { flex: 1; padding: .5rem 0; }
      .sidebar-nav .nav-item { margin: .25rem 0; }
      .sidebar-nav .nav-link-modern { display: flex; align-items: center; gap: .75rem; padding: .875rem 1rem; margin: 0 .5rem; border-radius: .5rem; color: var(--bs-body-color); text-decoration: none; font-weight: 500; transition: .15s; border: 1px solid transparent; }
      .sidebar-nav .nav-link-modern:hover { background: var(--bs-primary-bg-subtle); color: var(--bs-primary); transform: translateX(4px); }
      .sidebar-nav .nav-link-modern.active { background: var(--bs-primary); color: #fff; font-weight: 600; border-color: var(--bs-primary); }
      .sidebar-footer { padding: 1rem; border-top: 1px solid var(--bs-border-color); background: var(--bs-secondary-bg); }
      .user-profile { display: flex; align-items: center; gap: .75rem; padding: .75rem; border: 1px solid var(--bs-border-color); border-radius: .5rem; background: var(--bs-body-bg); text-decoration: none; color: var(--bs-body-color); margin-bottom: .5rem; }
      .user-info { line-height: 1.15; }
      .currency-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: .25rem; }
      .mobile-hide { display: none; }
    }
    @media (min-width: 768px) { .mobile-hide { display: inline; } }

    /* Motion reduced */
    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation: none !important; }
    }
  </style>
</head>
<body data-auth="{{ '1' if session.user_id else '0' }}">
  <a class="skip-link" href="#main">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É</a>

  {% if session.user_id %}
  <nav class="navbar navbar-expand-lg navbar-light navbar-zen" aria-label="–ì–ª–∞–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
    <div class="container-fluid">
      <a class="navbar-brand-modern" href="{{ url_for('dashboard') }}" aria-label="CrystalBudget ‚Äî –Ω–∞ –¥–∞—à–±–æ—Ä–¥">
        <svg class="ff-crystal" width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="crystalGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#60A5FA"/><stop offset="25%" style="stop-color:#3B82F6"/>
              <stop offset="50%" style="stop-color:#1D4ED8"/><stop offset="75%" style="stop-color:#1E40AF"/>
              <stop offset="100%" style="stop-color:#1E3A8A"/>
            </linearGradient>
          </defs>
          <path d="M12 2L16 6L20 10L16 18L12 22L8 18L4 10L8 6L12 2Z" fill="url(#crystalGradient)"/>
        </svg>
        CrystalBudget
      </a>

      <button class="navbar-toggler" type="button" aria-controls="mobileSidebar" aria-expanded="false" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é" onclick="toggleSidebar()">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="d-none d-lg-flex collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link-zen {% if request.endpoint == 'dashboard' %}active{% endif %}" href="{{ url_for('dashboard') }}"><i class="bi bi-house-door-fill"></i> –ì–ª–∞–≤–Ω–∞—è</a></li>
          <li class="nav-item"><a class="nav-link-zen {% if request.endpoint == 'expenses' %}active{% endif %}" href="{{ url_for('expenses') }}"><i class="bi bi-arrow-down-circle zen-text-expense"></i> –†–∞—Å—Ö–æ–¥—ã</a></li>
          <li class="nav-item"><a class="nav-link-zen {% if request.endpoint == 'categories' %}active{% endif %}" href="{{ url_for('categories') }}"><i class="bi bi-grid-3x3-gap-fill"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a></li>
          <li class="nav-item"><a class="nav-link-zen {% if request.endpoint in ['income_page','edit_income','sources_page'] %}active{% endif %}" href="{{ url_for('income_page') }}"><i class="bi bi-arrow-up-circle zen-text-income"></i> –î–æ—Ö–æ–¥—ã</a></li>
        </ul>

        <ul class="navbar-nav align-items-center">
          <li class="nav-item me-2" aria-label="–í—ã–±–æ—Ä –≤–∞–ª—é—Ç—ã">
            <div class="currency-selector" role="group" aria-label="–í–∞–ª—é—Ç–∞">
              <button class="currency-option" id="curr-rub"  onclick="setCurrency('RUB')" type="button" aria-pressed="true">‚ÇΩ</button>
              <button class="currency-option" id="curr-usd"  onclick="setCurrency('USD')" type="button" aria-pressed="false">$</button>
              <button class="currency-option" id="curr-eur"  onclick="setCurrency('EUR')" type="button" aria-pressed="false">‚Ç¨</button>
              <button class="currency-option" id="curr-amd"  onclick="setCurrency('AMD')" type="button" aria-pressed="false">÷è</button>
              <button class="currency-option" id="curr-gel"  onclick="setCurrency('GEL')" type="button" aria-pressed="false">‚Çæ</button>
            </div>
          </li>
          <li class="nav-item me-2">
            <button class="theme-toggle-btn" type="button" onclick="toggleTheme()" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
              <i class="bi bi-sun-fill" id="light-icon"></i>
              <span class="visually-hidden">–¢–µ–º–∞</span>
              <i class="bi bi-moon-fill" id="dark-icon"></i>
            </button>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link-modern dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-person-circle"></i> {{ session.name or session.email }}
            </a>
            <ul class="dropdown-menu dropdown-menu-end" style="border:none;">
              <li><a class="dropdown-item" href="{{ url_for('account') }}"><i class="bi bi-gear"></i> –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a></li>
              <li><hr class="dropdown-divider" /></li>
              <li><a class="dropdown-item" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Mobile sidebar -->
  <div class="sidebar-overlay d-lg-none" id="sidebarOverlay" onclick="closeSidebar()"></div>
  <aside class="sidebar d-lg-none" id="mobileSidebar" aria-label="–ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sidebar-header">
      <a class="sidebar-brand" href="{{ url_for('dashboard') }}">CrystalBudget</a>
      <button class="sidebar-close" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é" onclick="closeSidebar()"><i class="bi bi-x-lg"></i></button>
    </div>
    <nav class="sidebar-nav" id="sidebarNav">
      <div class="nav-item"><a class="nav-link-modern {% if request.endpoint == 'dashboard' %}active{% endif %}" href="{{ url_for('dashboard') }}" onclick="closeSidebar()"><i class="bi bi-house-door"></i> –î–∞—à–±–æ—Ä–¥</a></div>
      <div class="nav-item"><a class="nav-link-modern {% if request.endpoint == 'expenses' %}active{% endif %}" href="{{ url_for('expenses') }}" onclick="closeSidebar()"><i class="bi bi-wallet2"></i> –†–∞—Å—Ö–æ–¥—ã</a></div>
      <div class="nav-item"><a class="nav-link-modern {% if request.endpoint == 'categories' %}active{% endif %}" href="{{ url_for('categories') }}" onclick="closeSidebar()"><i class="bi bi-tags"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a></div>
      <div class="nav-item"><a class="nav-link-modern {% if request.endpoint in ['income_page','edit_income','sources_page'] %}active{% endif %}" href="{{ url_for('income_page') }}" onclick="closeSidebar()"><i class="bi bi-cash-coin"></i> –î–æ—Ö–æ–¥—ã</a></div>
      <div class="nav-item"><a class="nav-link-modern {% if request.endpoint == 'account' %}active{% endif %}" href="{{ url_for('account') }}" onclick="closeSidebar()"><i class="bi bi-gear"></i> –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a></div>
    </nav>
    <div class="sidebar-footer">
      <a class="user-profile" href="#">
        <i class="bi bi-person-circle" style="font-size:1.5rem;"></i>
        <div class="user-info">
          <div class="fw-semibold small">{{ session.name or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}</div>
          <div class="text-secondary small">{{ session.email }}</div>
        </div>
      </a>
      <div class="mb-3">
        <div class="text-uppercase text-secondary small mb-1">–í–∞–ª—é—Ç–∞</div>
        <div class="currency-grid" role="group" aria-label="–í–∞–ª—é—Ç–∞ (–º–æ–±–∏–ª—å–Ω–∞—è)">
          <button class="currency-option" id="curr-rub-sidebar" onclick="setCurrency('RUB')" type="button">‚ÇΩ</button>
          <button class="currency-option" id="curr-usd-sidebar" onclick="setCurrency('USD')" type="button">$</button>
          <button class="currency-option" id="curr-eur-sidebar" onclick="setCurrency('EUR')" type="button">‚Ç¨</button>
          <button class="currency-option" id="curr-amd-sidebar" onclick="setCurrency('AMD')" type="button">÷è</button>
          <button class="currency-option" id="curr-gel-sidebar" onclick="setCurrency('GEL')" type="button">‚Çæ</button>
        </div>
      </div>
      <div class="mb-3">
        <div class="text-uppercase text-secondary small mb-1">–¢–µ–º–∞</div>
        <button class="theme-toggle-btn w-100" type="button" onclick="toggleTheme()" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É (–º–æ–±–∏–ª—å–Ω–∞—è)">
          <i class="bi bi-sun-fill" id="light-icon-sidebar"></i>
          <span class="flex-grow-1 text-center">–¢–µ–º–∞</span>
          <i class="bi bi-moon-fill" id="dark-icon-sidebar"></i>
        </button>
      </div>
      <a class="btn btn-danger w-100" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏</a>
    </div>
  </aside>
  {% endif %}

  <main id="main" class="container-modern py-4" tabindex="-1">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}

    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer" aria-live="polite" aria-atomic="true"></div>
  </main>

  <!-- Bootstrap Bundle (with Popper) -->
  <script defer src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>

  <!-- PWA SW -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/static/sw.js').catch(console.error);
      });
    }
  </script>

  <!-- Theme & Currency & Sidebar -->
  <script>
    // Theme
    function toggleTheme() {
      const cur = document.documentElement.getAttribute('data-bs-theme') || 'light';
      const next = cur === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-bs-theme', next);
      localStorage.setItem('theme', next);
      const meta = document.querySelector('meta[name="theme-color"]');
      if (meta) meta.content = next === 'dark' ? '#212529' : '#4fb3d9';
      updateThemeToggle(next);
    }
    function updateThemeToggle(theme) {
      const setOpacity = (id, on) => { const el = document.getElementById(id); if (el) el.style.opacity = on ? '1' : '0.5'; };
      setOpacity('light-icon', theme !== 'dark');
      setOpacity('dark-icon', theme === 'dark');
      setOpacity('light-icon-sidebar', theme !== 'dark');
      setOpacity('dark-icon-sidebar', theme === 'dark');
    }

    // Sidebar
    const sidebar = document.getElementById('mobileSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    let lastFocus;
    function toggleSidebar() { openSidebar(); }
    function openSidebar() {
      if (!sidebar || !overlay) return;
      lastFocus = document.activeElement;
      sidebar.classList.add('show');
      overlay.classList.add('show');
      sidebar.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      // focus first link
      setTimeout(() => { const link = sidebar.querySelector('a, button'); if (link) link.focus(); }, 0);
      document.addEventListener('keydown', onEscClose);
    }
    function closeSidebar() {
      if (!sidebar || !overlay) return;
      sidebar.classList.remove('show');
      overlay.classList.remove('show');
      sidebar.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      if (lastFocus) lastFocus.focus();
      document.removeEventListener('keydown', onEscClose);
    }
    function onEscClose(e) { if (e.key === 'Escape') closeSidebar(); }

    /* Currency */
    const currencySymbols = { RUB: '‚ÇΩ', USD: '$', EUR: '‚Ç¨', AMD: '÷è', GEL: '‚Çæ' };
    let currentRates = {};
    const baseCurrency = 'RUB';
    async function loadRates() {
      try {
        const res = await fetch('/api/exchange-rates');
        const data = await res.json();
        if (data.ok) {
          currentRates = data.rates || {};
          if (data.warning || Object.keys(currentRates).length === 0) {
            console.warn('–ö—É—Ä—Å—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–∏—Ñ—Ä—ã –±–µ–∑ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏');
            // –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ–¥–∏–Ω —Ä–∞–∑
            if (!window.__fxWarnShown) {
              window.__fxWarnShown = true;
              const el = document.createElement('div');
              el.className = 'alert alert-warning alert-dismissible fade show mt-2';
              el.innerHTML = `
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –°—É–º–º—ã –ø–æ–∫–∞–∑–∞–Ω—ã –≤ –∏—Å—Ö–æ–¥–Ω–æ–π –≤–∞–ª—é—Ç–µ.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              `;
              // –≤—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ navbar
              const navbar = document.querySelector('nav.navbar');
              if (navbar && navbar.nextSibling) {
                navbar.parentNode.insertBefore(el, navbar.nextSibling);
              } else {
                document.querySelector('.container-fluid')?.prepend(el);
              }
            }
          }
        }
      } catch (e) {
        console.warn('Failed to load exchange rates', e);
      }
    }
    // Convert using local rates with base bridging
    function convertAmountLocal(amount, fromCurrency, toCurrency) {
      if (!Number.isFinite(amount)) return amount;
      const from = (fromCurrency || baseCurrency).toUpperCase();
      const to = (toCurrency || baseCurrency).toUpperCase();
      if (from === to) return amount;
      
      // –µ—Å–ª–∏ –Ω–µ—Ç –∫—É—Ä—Å–æ–≤ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω—É—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–µ –±–µ–∑ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
      if (!currentRates || Object.keys(currentRates).length === 0) return amount;
      
      // Try direct
      const directKey = `${from}_${to}`;
      if (currentRates[directKey]) {
        return amount * currentRates[directKey];
      }
      // Bridge via base currency
      let inBase = amount;
      if (from !== baseCurrency) {
        const k = `${from}_${baseCurrency}`;
        if (!currentRates[k]) return amount; // no rate, fallback original
        inBase = amount * currentRates[k];
      }
      if (to === baseCurrency) return inBase;
      const k2 = `${baseCurrency}_${to}`;
      if (!currentRates[k2]) return amount; // no rate, fallback original
      return inBase * currentRates[k2];
    }
    async function setCurrency(currency) {
      localStorage.setItem('currency', currency);
      // Toggle pressed state for both desktop and sidebar groups
      document.querySelectorAll('.currency-option').forEach(btn => {
        const isActive = btn.id.includes(currency.toLowerCase());
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
      // Notify backend (server-side formatting)
      try {
        await fetch('/set-currency', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ currency })
        });
      } catch (e) {
        console.warn('Set currency failed', e);
      }
      // Refresh rates and update amounts
      await loadRates();
      await convertAllAmounts(currency);
    }
    async function convertAllAmounts(targetCurrency) {
      const nodes = document.querySelectorAll('[data-amount]');
      if (!nodes.length) return;
      for (const el of nodes) {
        const original = parseFloat(el.dataset.amount);
        const fromCurr = (el.dataset.currency || baseCurrency).toUpperCase();
        if (!Number.isFinite(original)) continue;
        const converted = convertAmountLocal(original, fromCurr, targetCurrency);
        paintAmount(el, converted, targetCurrency);
      }
    }
    function paintAmount(el, value, currency) {
      const text = Number(value).toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const symbol = currencySymbols[currency] || '';
      const symHolder = el.parentElement?.querySelector?.('.currency-display');
      if (symHolder) { el.textContent = text; symHolder.textContent = symbol; }
      else { el.textContent = `${text} ${symbol}`; }
    }

    // Toast —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º
    function showToast(message, type = 'info') {
      const c = document.getElementById('toastContainer'); if (!c) return;
      const id = 'toast-' + Date.now();
      
      const typeConfig = {
        success: { icon: 'check-circle-fill', class: 'cb-toast-success' },
        error: { icon: 'exclamation-circle-fill', class: 'cb-toast-error' },
        danger: { icon: 'exclamation-circle-fill', class: 'cb-toast-error' },
        warning: { icon: 'exclamation-triangle-fill', class: 'cb-toast-warning' },
        info: { icon: 'info-circle-fill', class: 'cb-toast-info' }
      };
      
      const config = typeConfig[type] || typeConfig.info;
      
      c.insertAdjacentHTML('afterbegin', `
        <div id="${id}" class="toast cb-toast ${config.class} cb-scale-in" role="status" data-bs-autohide="true" data-bs-delay="5000">
          <div class="toast-header cb-toast-header">
            <i class="bi bi-${config.icon} me-2"></i>
            <strong class="me-auto">CrystalBudget</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <div class="toast-body cb-toast-body">${message}</div>
        </div>`);
      
      const el = document.getElementById(id);
      if (typeof bootstrap !== 'undefined') {
        const toast = new bootstrap.Toast(el);
        el.addEventListener('hidden.bs.toast', () => el.remove());
        toast.show();
      } else { 
        el.style.display = 'block'; 
        setTimeout(() => el.remove(), 5000); 
      }
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      const theme = document.documentElement.getAttribute('data-bs-theme') || 'light';
      updateThemeToggle(theme);
      const saved = localStorage.getItem('currency') || 'RUB';
      const isAuth = (document.body && document.body.dataset && document.body.dataset.auth === '1');
      if (isAuth) {
        setCurrency(saved);
      } else {
        // Guest session: do not POST to /set-currency
        localStorage.setItem('currency', saved);
      }
    });
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
