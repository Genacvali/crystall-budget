{% extends "base.html" %}
{% block title %}üéØ –¶–µ–ª–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π ‚Äî CrystalBudget{% endblock %}

{% block content %}
<style>
  .goal-card{border:none;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
  .goal-title{display:flex;align-items:center;gap:.5rem}
  .goal-title .status{margin-left:auto}
  .goal-meta{color:var(--bs-secondary)}
  .progress{height:8px;background:var(--bs-secondary-bg)}
  .goal-actions .btn{white-space:nowrap}
  .badge-soft{border-radius:999px;padding:.25rem .5rem;font-weight:600}
  .badge-soft-success{background:#e8f6ee;color:#198754}
  .badge-soft-warning{background:#fff3cd;color:#946200}
  .badge-soft-danger{background:#fde2e2;color:#c03a3a}
  .quick-add .btn{padding:.25rem .5rem}
  .currency-display{white-space:nowrap}
</style>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">

      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h1 class="h4 m-0"><i class="bi bi-bullseye text-primary me-2" aria-hidden="true"></i> –¶–µ–ª–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π</h1>
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addGoalModal">
          <i class="bi bi-plus-lg"></i> –ù–æ–≤–∞—è —Ü–µ–ª—å
        </button>
      </div>

      <!-- Flash (–±—É–¥–µ—Ç –ø—Ä–µ–≤—Ä–∞—â—ë–Ω –≤ toast –±–∞–∑–æ–≤—ã–º —Å–∫—Ä–∏–ø—Ç–æ–º) -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      {% if goals and goals|length %}
      <div class="row g-3 g-md-4">
        {% for goal in goals %}
        {% set progress_percent = (goal.target_amount and (goal.current_amount / goal.target_amount * 100) or 0) | round(1) %}
        {% set progress_width = 100 if progress_percent > 100 else progress_percent %}
        {% set remaining = (goal.target_amount - goal.current_amount) if goal.target_amount else 0 %}
        {% set danger = progress_percent >= 100 %}
        {% set due = goal.target_date %}
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card goal-card h-100">
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-start gap-2 mb-2">
                <h2 class="h6 goal-title mb-0">{{ goal.name }}</h2>
                <div class="ms-auto d-flex align-items-center gap-2">
                  {% if goal.completed_at %}
                    <span class="badge bg-success">–î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ</span>
                  {% elif remaining <= 0 and goal.target_amount %}
                    <span class="badge bg-success">–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞</span>
                  {% endif %}
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown" aria-label="–î–µ–π—Å—Ç–≤–∏—è –ø–æ —Ü–µ–ª–∏">
                      <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editGoalModal{{ goal.id }}"><i class="bi bi-pencil me-2"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a></li>
                      <li><button class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#deleteGoalModal" data-action="{{ url_for('delete_goal', goal_id=goal.id) if url_for else '#' }}" data-name="{{ goal.name }}"><i class="bi bi-trash me-2"></i>–£–¥–∞–ª–∏—Ç—å</button></li>
                    </ul>
                  </div>
                </div>
              </div>

              {% if goal.description %}
                <p class="text-muted small mb-2">{{ goal.description }}</p>
              {% endif %}

              <div class="mb-2">
                <div class="d-flex justify-content-between mb-1 goal-meta">
                  <small>–ü—Ä–æ–≥—Ä–µ—Å—Å</small>
                  <small>{{ progress_percent }}%</small>
                </div>
                <div class="progress" role="progressbar" aria-valuenow="{{ progress_percent }}" aria-valuemin="0" aria-valuemax="100">
                  <div class="progress-bar {{ 'bg-success' if (goal.completed_at or progress_percent>=100) else 'bg-primary' }}" style="width: {{ progress_width }}%"></div>
                </div>
              </div>

              <div class="row text-center mb-2">
                <div class="col-6">
                  <div class="text-muted small">–ù–∞–∫–æ–ø–ª–µ–Ω–æ</div>
                  <div class="fw-bold">{{ goal.current_amount|format_amount }} <span class="currency-display">{{ currency_symbol|default('‚ÇΩ') }}</span></div>
                </div>
                <div class="col-6">
                  <div class="text-muted small">–¶–µ–ª—å</div>
                  <div class="fw-bold">{{ goal.target_amount|format_amount }} <span class="currency-display">{{ currency_symbol|default('‚ÇΩ') }}</span></div>
                </div>
              </div>

              <div class="d-flex justify-content-between align-items-center mb-3 goal-meta">
                {% if due %}
                  <small><i class="bi bi-calendar me-1"></i>–î–æ: {{ due|format_date_with_day }}</small>
                {% else %}
                  <small class="text-muted"><i class="bi bi-calendar me-1"></i>–ë–µ–∑ —Å—Ä–æ–∫–∞</small>
                {% endif %}
                {% if goal.target_amount %}
                  <small class="text-nowrap">
                    –û—Å—Ç–∞–ª–æ—Å—å: 
                    <span class="fw-semibold {{ 'text-success' if remaining <= 0 else '' }}">{{ [remaining, 0]|max|format_amount }} <span class="currency-display">{{ currency_symbol|default('‚ÇΩ') }}</span></span>
                  </small>
                {% endif %}
              </div>

              {% if not goal.completed_at %}
              <form method="POST" action="{{ url_for('update_goal_progress', goal_id=goal.id) }}" class="mt-auto">
                <div class="row g-2 align-items-end">
                  <div class="col-7">
                    <label class="form-label small">–î–æ–±–∞–≤–∏—Ç—å –≤–∑–Ω–æ—Å</label>
                    <div class="input-group">
                      <input type="number" name="amount" class="form-control" placeholder="–°—É–º–º–∞" step="0.01" min="0.01" required>
                      <span class="input-group-text currency-display">{{ currency_symbol|default('‚ÇΩ') }}</span>
                    </div>
                  </div>
                  <div class="col-5 d-grid">
                    <label class="form-label d-none d-md-block small" aria-hidden="true">&nbsp;</label>
                    <button type="submit" class="btn btn-outline-primary"><i class="bi bi-plus-lg"></i> –î–æ–±–∞–≤–∏—Ç—å</button>
                  </div>
                </div>
                <div class="quick-add mt-2 d-flex gap-2 flex-wrap">
                  {% set quicks = [1000, 5000, 10000] %}
                  {% for q in quicks %}
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-quick-amount="{{ q }}">+{{ q|format_amount }}</button>
                  {% endfor %}
                  {% if goal.target_amount %}
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-quick-percent="10">+10%</button>
                  {% endif %}
                </div>
              </form>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Edit modal per goal -->
        <div class="modal fade" id="editGoalModal{{ goal.id }}" tabindex="-1" aria-labelledby="editGoalLabel{{ goal.id }}" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editGoalLabel{{ goal.id }}"><i class="bi bi-pencil-square me-2"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª—å</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <form method="POST" action="{{ url_for('edit_goal', goal_id=goal.id) if url_for else '#' }}">
                <div class="modal-body">
                  <div class="mb-3"><label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" name="name" class="form-control" value="{{ goal.name }}" required></div>
                  <div class="mb-3"><label class="form-label">–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞</label><div class="input-group"><input type="number" name="target_amount" step="0.01" min="0.01" class="form-control" value="{{ goal.target_amount }}" required><span class="input-group-text currency-display">{{ currency_symbol|default('‚ÇΩ') }}</span></div></div>
                  <div class="mb-3"><label class="form-label">–ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞</label><input type="date" name="target_date" class="form-control" value="{{ goal.target_date }}"></div>
                  <div class="mb-3"><label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea name="description" class="form-control" rows="3" maxlength="500">{{ goal.description or '' }}</textarea></div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                  <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      {% else %}
      <!-- Empty state -->
      <div class="text-center py-5">
        <div class="mb-4"><i class="bi bi-bullseye display-1 text-muted" aria-hidden="true"></i></div>
        <h2 class="h5 text-muted">–ü–æ–∫–∞ –Ω–µ—Ç —Ü–µ–ª–µ–π –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π</h2>
        <p class="text-muted mb-4">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é —Ü–µ–ª—å –∏ –Ω–∞—á–Ω–∏—Ç–µ –∫–æ–ø–∏—Ç—å –Ω–∞ –º–µ—á—Ç—É!</p>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addGoalModal"><i class="bi bi-plus-lg"></i> –°–æ–∑–¥–∞—Ç—å —Ü–µ–ª—å</button>
      </div>
      {% endif %}

    </div>
  </div>
</div>

<!-- Add Goal Modal -->
<div class="modal fade" id="addGoalModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-bullseye me-2 text-primary"></i> –ù–æ–≤–∞—è —Ü–µ–ª—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('add_goal') }}" id="add-goal-form" novalidate>
        <div class="modal-body">
          <div class="mb-3">
            <label for="goalName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏ <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="goalName" name="name" placeholder="–ù–æ–≤—ã–π iPhone" required maxlength="100" autocomplete="off">
            <div class="invalid-feedback">–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏.</div>
          </div>
          <div class="mb-3">
            <label for="goalAmount" class="form-label">–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞ <span class="text-danger">*</span></label>
            <div class="input-group">
              <input type="number" class="form-control" id="goalAmount" name="target_amount" placeholder="50000" step="0.01" min="0.01" required inputmode="decimal">
              <span class="input-group-text currency-display">{{ currency_symbol|default('‚ÇΩ') }}</span>
              <div class="invalid-feedback">–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –±–æ–ª—å—à–µ 0.</div>
            </div>
          </div>
          <div class="mb-3">
            <label for="goalDate" class="form-label">–ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <input type="date" class="form-control" id="goalDate" name="target_date">
          </div>
          <div class="mb-3">
            <label for="goalDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <textarea class="form-control" id="goalDescription" name="description" rows="3" maxlength="500" placeholder="–ó–∞—á–µ–º –≤–∞–º —ç—Ç–∞ —Ü–µ–ª—å?"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-primary" id="createGoalBtn">–°–æ–∑–¥–∞—Ç—å —Ü–µ–ª—å</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Goal Modal (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è) -->
<div class="modal fade" id="deleteGoalModal" tabindex="-1" aria-labelledby="deleteGoalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteGoalLabel">–£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <form id="deleteGoalForm" method="POST" action="#">
        <div class="modal-body">
          <p class="mb-0">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å <strong id="deleteGoalName"></strong>?
            <br><small class="text-muted">–í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –≤–∑–Ω–æ—Å—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏, –Ω–æ —Ü–µ–ª—å –∏—Å—á–µ–∑–Ω–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞.</small>
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-danger"><i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –ë—ã—Å—Ç—Ä—ã–µ —Å—É–º–º—ã –¥–ª—è –≤–∑–Ω–æ—Å–æ–≤ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
(function(){
  // –ë—ã—Å—Ç—Ä—ã–µ —Å—É–º–º—ã/–ø—Ä–æ—Ü–µ–Ω—Ç—ã
  document.querySelectorAll('.quick-add').forEach(section=>{
    const form = section.closest('form');
    const input = form?.querySelector('input[name="amount"]');
    if(!input) return;
    section.querySelectorAll('[data-quick-amount]').forEach(btn=>{
      btn.addEventListener('click',()=>{ input.value = (parseFloat(input.value||0) + parseFloat(btn.dataset.quickAmount)).toFixed(2); input.dispatchEvent(new Event('input')); });
    });
    section.querySelectorAll('[data-quick-percent]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const card = form.closest('.goal-card');
        // –∏–∑–≤–ª–µ–∫–∞–µ–º —Ü–µ–ª–µ–≤—É—é —Å—É–º–º—É –∏–∑ —Å–æ—Å–µ–¥–Ω–µ–≥–æ –±–ª–æ–∫–∞ (–Ω–∞–¥—ë–∂–Ω–µ–µ –±—ã–ª–æ –±—ã –≤ data-attr)
        const targetText = card.querySelector('.fw-bold:nth-child(2)')?.textContent || '';
        const raw = (form.querySelector('input[name="target_amount"]')?.value) || '';
        const percent = parseFloat(btn.dataset.quickPercent||0);
        // –ü—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –ø—Ä–∏–±–∞–≤–ª—è–µ–º % –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª—è input, –µ—Å–ª–∏ target –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        let target = parseFloat((card.dataset.target)||0);
        if(!target){
          // –ø–æ–ø—Ä–æ–±—É–µ–º –¥–æ—Å—Ç–∞—Ç—å –∏–∑ DOM —á–∏—Å–µ–ª–∫–∏
          const tEl = card.querySelectorAll('.fw-bold');
          if(tEl?.[1]){
            const digits = tEl[1].textContent.replace(/[^0-9.,]/g,'').replace(',','.');
            target = parseFloat(digits)||0;
          }
        }
        if(target>0){
          input.value = (parseFloat(input.value||0) + (target*percent/100)).toFixed(2);
          input.dispatchEvent(new Event('input'));
        }
      });
    });
  });

  // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
  const delModal = document.getElementById('deleteGoalModal');
  if(delModal){
    delModal.addEventListener('show.bs.modal', (e)=>{
      const btn = e.relatedTarget;
      const action = btn?.getAttribute('data-action');
      const name = btn?.getAttribute('data-name');
      const form = document.getElementById('deleteGoalForm');
      const holder = document.getElementById('deleteGoalName');
      if(form && action) form.setAttribute('action', action);
      if(holder) holder.textContent = '¬´'+(name||'')+'¬ª';
    });
  }

  // –í–∞–ª–∏–¥–∞—Ü–∏—è –º–æ–¥–∞–ª–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è
  const addForm = document.getElementById('add-goal-form');
  const amount = document.getElementById('goalAmount');
  amount?.addEventListener('wheel', e=>{ e.preventDefault(); }, {passive:false});
  addForm?.addEventListener('submit', (e)=>{
    if(!addForm.checkValidity()){
      e.preventDefault(); e.stopPropagation(); addForm.classList.add('was-validated');
    }
  });
})();
</script>
{% endblock %}
