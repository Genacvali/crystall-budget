{% extends "base.html" %}
{% block title %}✏️ Редактирование траты — CrystalBudget{% endblock %}

{% block content %}
<style>
  .page-actions .btn{white-space:nowrap}
  .card-modern{border:none; box-shadow:0 6px 18px rgba(0,0,0,.06); border-radius:12px}
  .help-text{color:var(--bs-secondary); font-size:.875rem}
  .input-group-lg .input-group-text{min-width:2.5rem; justify-content:center}
</style>

<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2 page-actions">
  <h1 class="h4 m-0 d-flex align-items-center gap-2"><i class="bi bi-pencil-square" aria-hidden="true"></i> Редактирование траты</h1>
  <div class="d-flex gap-2">
    <a href="{{ url_for('expenses') }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> <span class="d-none d-md-inline">Назад</span></a>
    {% if expense_delete_url %}
    <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteExpenseModal"><i class="bi bi-trash3"></i> Удалить</button>
    {% endif %}
  </div>
</div>

<div class="card card-modern">
  <div class="card-body">
    <form method="POST" novalidate id="edit-expense-form">
      <div class="row g-3">
        <div class="col-md-4">
          <label for="date" class="form-label"><i class="bi bi-calendar"></i> Дата</label>
          <input type="date" id="date" name="date" value="{{ expense.date }}" class="form-control" required>
          <div class="invalid-feedback">Укажите дату операции.</div>
        </div>

        <div class="col-md-4">
          <label for="category_id" class="form-label"><i class="bi bi-tag"></i> Категория</label>
          <select id="category_id" name="category_id" class="form-select" required>
            <option value="">Выберите категорию</option>
            {% for cat in categories %}
            <option value="{{ cat.id }}" {% if cat.id == expense.category_id %}selected{% endif %}>{{ cat.name }}</option>
            {% endfor %}
          </select>
          <div class="invalid-feedback">Выберите категорию траты.</div>
        </div>

        <div class="col-md-4">
          <label for="amount" class="form-label"><i class="bi bi-currency-exchange"></i> Сумма</label>
          <div class="input-group input-group-lg">
            <span class="input-group-text currency-display">{{ currency_symbol|default('₽') }}</span>
            <input type="number" id="amount" name="amount" step="0.01" min="0.01" inputmode="decimal" value="{{ expense.amount }}" class="form-control" required>
          </div>
          <div class="help-text mt-1">Используйте точку для копеек: 1234.56</div>
          <div class="invalid-feedback">Введите сумму больше нуля.</div>
        </div>

        <div class="col-12">
          <label for="note" class="form-label"><i class="bi bi-chat-text"></i> Комментарий <span class="text-muted">(необязательно)</span></label>
          <input type="text" id="note" name="note" value="{{ expense.note or '' }}" class="form-control" placeholder="Описание траты">
        </div>
      </div>

      <div class="d-flex gap-2 mt-4 flex-wrap">
        <button type="submit" class="btn btn-success flex-fill" id="save-btn">
          <i class="bi bi-check-lg"></i> Сохранить изменения
        </button>
        <a href="{{ url_for('expenses') }}" class="btn btn-outline-secondary flex-fill">
          <i class="bi bi-x-lg"></i> Отмена
        </a>
      </div>
    </form>
  </div>
</div>

{% if expense_delete_url %}
<!-- modal: delete confirm -->
<div class="modal fade" id="deleteExpenseModal" tabindex="-1" aria-labelledby="deleteExpenseLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteExpenseLabel">Удалить трату</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <form method="POST" action="{{ expense_delete_url }}">
        <div class="modal-body">
          <p class="mb-0">Вы уверены, что хотите удалить трату на сумму <strong>{{ expense.amount|format_amount }} <span class="currency-display">{{ currency_symbol|default('₽') }}</span></strong>?
          <br><small class="text-muted">Действие необратимо.</small></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-danger"><i class="bi bi-trash3"></i> Удалить</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  // Классическая Bootstrap-валидация + мелкие UX-штучки
  (function(){
    const form = document.getElementById('edit-expense-form');
    const amount = document.getElementById('amount');
    const category = document.getElementById('category_id');
    const date = document.getElementById('date');
    const saveBtn = document.getElementById('save-btn');

    // Установить сегодняшнюю дату, если пусто
    if (date && !date.value) {
      date.value = new Date().toISOString().slice(0,10);
    }

    // Предотвратить прокрутку числового инпута колесом
    amount?.addEventListener('wheel', e => { e.preventDefault(); }, { passive:false });

    // Валидация в реальном времени
    function validate(){
      const ok = !!(date?.value && category?.value && parseFloat(amount?.value) > 0);
      saveBtn.disabled = !ok;
      if (!ok) return;
    }
    ['input','change'].forEach(ev => {
      [amount, category, date].forEach(el => el && el.addEventListener(ev, validate));
    });
    validate();

    // Submit
    form?.addEventListener('submit', function(e){
      if (!form.checkValidity()) { e.preventDefault(); e.stopPropagation(); }
      form.classList.add('was-validated');
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Сохраняем...';
    });

    // Enter по сумме отправляет форму
    amount?.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !saveBtn.disabled) { e.preventDefault(); form.requestSubmit(); }
    });
  })();
</script>
{% endblock %}
