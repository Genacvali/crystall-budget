{% extends "auth_base.html" %}
{% block title %}–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è - CrystalBudget{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
{% endblock %}

{% block content %}
<main id="main-content" class="auth-page" role="main">
  <div class="container-xl">
    <div class="row justify-content-center">
      <div class="col-12 col-sm-10 col-md-8 col-lg-5 col-xl-4">
        <div class="ff-auth-card">
          
          <!-- Header with Crystal -->
          <div class="ff-auth-header">
            <span class="ff-crystal-icon" aria-hidden="true">üíé</span>
            <h1 class="ff-auth-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
            <p class="ff-auth-subtitle">–°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç CrystalBudget</p>
          </div>

          <!-- System Messages -->
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                <div class="ff-auth-alert alert-{{ 'danger' if category == 'error' else category }}" role="alert">
                  {{ message }}
                </div>
              {% endfor %}
            {% endif %}
          {% endwith %}

          <!-- Telegram Registration -->
          <div class="ff-telegram-container">
            <div id="telegram-widget-container">
              <script async src="https://telegram.org/js/telegram-widget.js?22"
                data-telegram-login="crystalbudget_bot"
                data-size="large"
                data-userpic="false"
                data-request-access="write" 
                data-auth-url="{{ request.url_root }}auth/telegram?next={{ url_for('budget.dashboard') }}">
              </script>
            </div>
            
            <div id="telegram-fallback" class="ff-telegram-fallback ff-auth-alert alert-warning d-none">
              <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
              Telegram-–≤–∏–¥–∂–µ—Ç –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
              <ul>
                <li>–î–æ–º–µ–Ω –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ @BotFather</li>
                <li>–¢—Ä–µ–±—É–µ—Ç—Å—è HTTPS</li>
                <li>–ë–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫ —Å–∫—Ä–∏–ø—Ç–æ–≤</li>
              </ul>
            </div>
          </div>

          <!-- Divider -->
          <div class="ff-auth-divider">
            <span>–∏–ª–∏</span>
          </div>

          <!-- Email Registration Form -->
          <form method="POST" action="{{ url_for('auth.register') }}" novalidate>
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <!-- Name Field -->
            <div class="ff-input-group">
              <label for="name" class="form-label">–ò–º—è</label>
              <div class="ff-input-wrapper">
                <i class="bi bi-person ff-input-icon" aria-hidden="true"></i>
                <input 
                  type="text" 
                  class="ff-input" 
                  id="name" 
                  name="name" 
                  required 
                  autocomplete="name"
                  aria-describedby="name-help"
                  value="{{ request.form.get('name', '') if request.method == 'POST' else '' }}"
                  minlength="2"
                  maxlength="50"
                >
              </div>
              <div id="name-help" class="ff-input-help">–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?</div>
            </div>
            
            <!-- Email Field -->
            <div class="ff-input-group">
              <label for="email" class="form-label">Email</label>
              <div class="ff-input-wrapper">
                <i class="bi bi-envelope ff-input-icon" aria-hidden="true"></i>
                <input 
                  type="email" 
                  class="ff-input" 
                  id="email" 
                  name="email" 
                  required 
                  autocomplete="username"
                  aria-describedby="email-help"
                  value="{{ request.form.get('email', '') if request.method == 'POST' else '' }}"
                >
              </div>
              <div id="email-help" class="ff-input-help">–í–∞—à email –∞–¥—Ä–µ—Å</div>
            </div>

            <!-- Password Field -->
            <div class="ff-input-group">
              <label for="password" class="form-label">–ü–∞—Ä–æ–ª—å</label>
              <div class="ff-input-wrapper">
                <i class="bi bi-lock ff-input-icon" aria-hidden="true"></i>
                <input 
                  type="password" 
                  class="ff-input" 
                  id="password" 
                  name="password" 
                  required 
                  autocomplete="new-password"
                  aria-describedby="password-help"
                  minlength="8"
                >
                <button 
                  type="button" 
                  class="ff-password-toggle" 
                  aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å"
                  title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å"
                  onclick="togglePassword('password', this)"
                >
                  <i class="bi bi-eye" aria-hidden="true"></i>
                </button>
              </div>
              <div id="password-help" class="ff-input-help">–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤</div>
            </div>

            <!-- Confirm Password Field -->
            <div class="ff-input-group">
              <label for="password_confirm" class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
              <div class="ff-input-wrapper">
                <i class="bi bi-shield-lock ff-input-icon" aria-hidden="true"></i>
                <input
                  type="password"
                  class="ff-input"
                  id="password_confirm"
                  name="password_confirm" 
                  required 
                  autocomplete="new-password"
                  aria-describedby="confirm-password-help"
                  minlength="8"
                >
                <button
                  type="button"
                  class="ff-password-toggle"
                  aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å"
                  title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å"
                  onclick="togglePassword('password_confirm', this)"
                >
                  <i class="bi bi-eye" aria-hidden="true"></i>
                </button>
              </div>
              <div id="confirm-password-help" class="ff-input-help">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å</div>
              <div id="confirm-password-error" class="invalid-feedback d-none">
                –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç
              </div>
            </div>

            <!-- Terms Agreement -->
            <div class="ff-input-group">
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  id="terms" 
                  name="terms" 
                  required
                  aria-describedby="terms-help"
                >
                <label class="form-check-label" for="terms">
                  –Ø —Å–æ–≥–ª–∞—Å–µ–Ω —Å <a href="#" target="_blank" rel="noopener">—É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a> –∏ 
                  <a href="#" target="_blank" rel="noopener">–ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
                </label>
              </div>
              <div id="terms-help" class="ff-input-help">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="ff-auth-btn">
              <span>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span>
            </button>
          </form>

          <!-- Footer Links -->
          <div class="ff-auth-footer">
            <small class="text-muted">
              –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?
              <a href="{{ url_for('auth.login') }}">–í–æ–π—Ç–∏</a>
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
// Telegram widget fallback
setTimeout(function () {
  const container = document.getElementById('telegram-widget-container');
  const fallback = document.getElementById('telegram-fallback');
  if (container && !container.querySelector('iframe')) {
    fallback?.classList.remove('d-none');
  }
}, 3000);

// Password visibility toggle
function togglePassword(inputId, button) {
  const input = document.getElementById(inputId);
  const icon = button.querySelector('i');
  
  if (input.type === 'password') {
    input.type = 'text';
    icon.className = 'bi bi-eye-slash';
    button.setAttribute('aria-label', '–°–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å');
    button.setAttribute('title', '–°–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å');
  } else {
    input.type = 'password';
    icon.className = 'bi bi-eye';
    button.setAttribute('aria-label', '–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å');
    button.setAttribute('title', '–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å');
  }
  
  // Return focus to input
  input.focus();
}

// Form validation enhancement
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form');
  const nameInput = document.getElementById('name');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const confirmPasswordInput = document.getElementById('password_confirm');
  const termsInput = document.getElementById('terms');
  const confirmPasswordError = document.getElementById('confirm-password-error');
  
  // Password confirmation validation
  function validatePasswordConfirmation() {
    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    const matches = password === confirmPassword;
    
    if (confirmPassword && !matches) {
      confirmPasswordInput.classList.add('is-invalid');
      confirmPasswordError.classList.remove('d-none');
    } else {
      confirmPasswordInput.classList.remove('is-invalid');
      confirmPasswordError.classList.add('d-none');
      if (confirmPassword && matches) {
        confirmPasswordInput.classList.add('is-valid');
      }
    }
    
    return matches;
  }
  
  // Real-time validation
  function validateField(field) {
    const isValid = field.checkValidity();
    field.classList.toggle('is-invalid', !isValid && field.value !== '');
    field.classList.toggle('is-valid', isValid && field.value !== '');
    return isValid;
  }
  
  // Event listeners for validation
  nameInput.addEventListener('blur', () => validateField(nameInput));
  emailInput.addEventListener('blur', () => validateField(emailInput));
  passwordInput.addEventListener('blur', () => validateField(passwordInput));
  confirmPasswordInput.addEventListener('blur', validatePasswordConfirmation);
  passwordInput.addEventListener('input', validatePasswordConfirmation);
  confirmPasswordInput.addEventListener('input', validatePasswordConfirmation);
  
  // Clear validation state on input
  [nameInput, emailInput, passwordInput, confirmPasswordInput].forEach(field => {
    field.addEventListener('input', () => {
      if (field !== confirmPasswordInput) {
        field.classList.remove('is-invalid', 'is-valid');
      }
    });
  });
  
  // Form submission validation
  form.addEventListener('submit', function(e) {
    const isNameValid = validateField(nameInput);
    const isEmailValid = validateField(emailInput);
    const isPasswordValid = validateField(passwordInput);
    const isConfirmPasswordValid = validatePasswordConfirmation();
    const isTermsValid = termsInput.checked;
    
    if (!isTermsValid) {
      termsInput.classList.add('is-invalid');
      termsInput.focus();
    }
    
    if (!isNameValid || !isEmailValid || !isPasswordValid || !isConfirmPasswordValid || !isTermsValid) {
      e.preventDefault();
      // Focus first invalid field
      const firstInvalid = form.querySelector('.is-invalid');
      if (firstInvalid) {
        firstInvalid.focus();
      }
    }
  });
  
  // Terms checkbox validation
  termsInput.addEventListener('change', function() {
    this.classList.toggle('is-invalid', !this.checked);
  });
  
  // Auto-focus first field
  nameInput.focus();
});
</script>
{% endblock %}