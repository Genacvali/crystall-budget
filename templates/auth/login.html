{% extends "auth_base.html" %}
{% block title %}–í—Ö–æ–¥ - CrystalBudget{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
{% endblock %}

{% block content %}
<main id="main-content" class="auth-page" role="main">
  <div class="container-xl">
    <div class="row justify-content-center">
      <div class="col-12 col-sm-10 col-md-8 col-lg-5 col-xl-4">
        <div class="ff-auth-card">
          
          <!-- Header with Crystal -->
          <div class="ff-auth-header">
            <span class="ff-crystal-icon" aria-hidden="true">üíé</span>
            <h1 class="ff-auth-title">–í—Ö–æ–¥</h1>
            <p class="ff-auth-subtitle">–í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç CrystalBudget</p>
          </div>

          <!-- System Messages -->
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                <div class="ff-auth-alert alert-{{ 'danger' if category == 'error' else category }}" role="alert">
                  {{ message }}
                </div>
              {% endfor %}
            {% endif %}
          {% endwith %}

          <!-- Telegram Login -->
          {% if config.TELEGRAM_LOGIN_ENABLED %}
          <div class="ff-telegram-container">
            <div id="telegram-widget-container">
              <script async src="https://telegram.org/js/telegram-widget.js?22"
                data-telegram-login="crystalbudget_bot"
                data-size="large"
                data-userpic="false"
                data-request-access="write"
                data-auth-url="{{ url_for('auth.telegram_auth', _external=True, next=request.args.get('next', url_for('budget.dashboard'))) }}">
              </script>
            </div>

            <div id="telegram-fallback" class="ff-telegram-fallback ff-auth-alert alert-warning d-none">
              <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
              Telegram-–≤–∏–¥–∂–µ—Ç –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
              <ul>
                <li>–î–æ–º–µ–Ω –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ @BotFather</li>
                <li>–ù—É–∂–µ–Ω HTTPS</li>
                <li>–ë–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫ —Å–∫—Ä–∏–ø—Ç–æ–≤</li>
              </ul>
            </div>
          </div>

          <!-- Divider -->
          <div class="ff-auth-divider">
            <span>–∏–ª–∏</span>
          </div>
          {% endif %}

          <!-- Email Login Form -->
          <form method="POST" action="{{ url_for('auth.login') }}" novalidate>
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <!-- Email Field -->
            <div class="ff-input-group">
              <label for="email" class="form-label">Email</label>
              <div class="ff-input-wrapper">
                <i class="bi bi-envelope ff-input-icon" aria-hidden="true"></i>
                <input 
                  type="email" 
                  class="ff-input" 
                  id="email" 
                  name="email" 
                  required 
                  autocomplete="username"
                  aria-describedby="email-help"
                  value="{{ request.form.get('email', '') if request.method == 'POST' else '' }}"
                >
              </div>
              <div id="email-help" class="ff-input-help">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email –∞–¥—Ä–µ—Å</div>
            </div>

            <!-- Password Field -->
            <div class="ff-input-group">
              <label for="password" class="form-label">–ü–∞—Ä–æ–ª—å</label>
              <div class="ff-input-wrapper">
                <i class="bi bi-lock ff-input-icon" aria-hidden="true"></i>
                <input 
                  type="password" 
                  class="ff-input" 
                  id="password" 
                  name="password" 
                  required 
                  autocomplete="current-password"
                  aria-describedby="password-help"
                >
                <button 
                  type="button" 
                  class="ff-password-toggle" 
                  aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å"
                  title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å"
                  onclick="togglePassword('password', this)"
                >
                  <i class="bi bi-eye" aria-hidden="true"></i>
                </button>
              </div>
              <div id="password-help" class="ff-input-help">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å</div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="ff-auth-btn">
              <span>–í–æ–π—Ç–∏</span>
            </button>
          </form>

          <!-- Footer Links -->
          <div class="ff-auth-footer">
            <small class="text-muted">
              –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?
              <a href="{{ url_for('auth.register') }}">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
// Telegram widget fallback
setTimeout(function () {
  const container = document.getElementById('telegram-widget-container');
  const fallback = document.getElementById('telegram-fallback');
  if (container && !container.querySelector('iframe')) {
    fallback?.classList.remove('d-none');
  }
}, 2500);

// Password visibility toggle
function togglePassword(inputId, button) {
  const input = document.getElementById(inputId);
  const icon = button.querySelector('i');
  
  if (input.type === 'password') {
    input.type = 'text';
    icon.className = 'bi bi-eye-slash';
    button.setAttribute('aria-label', '–°–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å');
    button.setAttribute('title', '–°–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å');
  } else {
    input.type = 'password';
    icon.className = 'bi bi-eye';
    button.setAttribute('aria-label', '–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å');
    button.setAttribute('title', '–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å');
  }
  
  // Return focus to input
  input.focus();
}

// Form validation enhancement
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  
  // Add real-time validation feedback
  function validateField(field) {
    const isValid = field.checkValidity();
    field.classList.toggle('is-invalid', !isValid && field.value !== '');
    field.classList.toggle('is-valid', isValid && field.value !== '');
  }
  
  emailInput.addEventListener('blur', () => validateField(emailInput));
  passwordInput.addEventListener('blur', () => validateField(passwordInput));
  
  // Clear validation state on input
  [emailInput, passwordInput].forEach(field => {
    field.addEventListener('input', () => {
      field.classList.remove('is-invalid', 'is-valid');
    });
  });
  
  // Auto-focus first field
  emailInput.focus();
});
</script>
{% endblock %}