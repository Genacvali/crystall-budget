{# templates/components/_progress_bars.html #}
<section class="ff-progress-card mb-4" aria-label="Прогресс по категориям">
  <div class="ff-progress-card-inner">
    <div class="ff-header">
    <i class="bi bi-graph-up-arrow"></i>
    Прогресс
    
    <div class="ms-auto">
      <div class="segmented">
        <button class="seg-btn" id="sortDirBtn" data-dir="asc" title="Направление">
          <i class="bi bi-arrow-down-up"></i>
        </button>
        <div class="seg-divider"></div>
        <div class="dropdown">
          <button class="seg-btn dropdown-toggle" id="sortKeyBtn" data-bs-toggle="dropdown" aria-expanded="false">
            <span id="sortKeyLabel">По названию</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow-soft" aria-labelledby="sortKeyBtn">
            <li><button class="dropdown-item sort-opt" data-key="name">По названию</button></li>
            <li><button class="dropdown-item sort-opt" data-key="progress">По прогрессу (%)</button></li>
            <li><button class="dropdown-item sort-opt" data-key="remaining">По остатку</button></li>
            <li><button class="dropdown-item sort-opt" data-key="spent">По тратам</button></li>
            <li><button class="dropdown-item sort-opt" data-key="limit">По лимиту</button></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="ff-list" id="catList">
    {% for cat_summary in budget_data %}
      {% set category = cat_summary.category %}
      {% set spent_money = cat_summary.spent %}
      {% set limit_money = cat_summary.limit %}
      {% set effective_limit_money = cat_summary.effective_limit %}
      {% set remaining_money = cat_summary.remaining %}
      {% set carryover_info = cat_summary.carryover %}
      
      {% set base_limit = limit_money.amount|float %}
      {% set spent = spent_money.amount|float %}
      {% set avail_limit = effective_limit_money.amount|float %}
      {% set rest = remaining_money.amount|float %}

      {% if avail_limit > 0 %}
        {% set progress_raw = spent / avail_limit * 100 %}
      {% elif avail_limit < 0 %}
        {# Negative effective limit due to carryover debt #}
        {% set progress_raw = 100 + (spent / abs(avail_limit) * 100) %}
      {% else %}
        {% set progress_raw = (spent > 0) and 100 or 0 %}
      {% endif %}

      {% set progress = progress_raw|round(1) %}
      {% set bar_width = [progress_raw, 150]|min|round(1) %} {# Allow bar to exceed 100% for overspent categories #}

      <article class="cat ff-item"
               data-id="{{ category.id }}"
               data-name="{{ category.name }}"
               data-progress="{{ progress }}"
               data-remaining="{{ rest }}"
               data-spent="{{ spent }}"
               data-limit="{{ avail_limit }}"
               data-order="{{ loop.index0 }}"
               data-limit-type="{{ category.limit_type }}"
               data-value="{{ category.value }}">
        
        <div class="ff-left">
          <div class="cat-title ff-title">{{ category.name }}</div>
          <div class="cat-meta ff-meta">
            {% if category.is_multi_source %}
              {% set cat_sources = multi_source_links.get(category.id, []) %}
              {% if cat_sources and cat_sources|length > 0 %}
                Мультиисточник
                <br><small class="text-muted">
                  {% for source_info in cat_sources %}
                    {{ source_info.source_name }}: {{ source_info.percentage }}%
                    {% if not loop.last %}, {% endif %}
                  {% endfor %}
                </small>
              {% else %}
                <span class="text-warning">Мультиисточник (не настроен)</span>
              {% endif %}
            {% elif category.limit_type == 'percent' %}
              Процент {{ category.value }}%
            {% else %}
              Фикс <span class="limit">{{ base_limit|format_amount }}</span> ₽
            {% endif %}
            {% if carryover_info.has_carryover %}
              <br><small class="carryover-info text-muted">
                Остаток из
                {% for detail in carryover_info.details %}
                  {{ detail.from_month }}
                  {% if detail.type == 'remaining' %}
                    <span class="text-success">+{{ detail.amount|format_amount }} ₽</span>
                  {% else %}
                    <span class="text-danger">{{ detail.amount|format_amount }} ₽</span>
                  {% endif %}
                  {% if not loop.last %}, {% endif %}
                {% endfor %}
              </small>
            {% endif %}
          </div>
        </div>

        <div class="ff-middle">
          <div class="ff-row">
            <strong class="spent">{{ spent|format_amount }}</strong> ₽
            <span class="slash">/</span>
            <span class="cat-right">
              <span class="limit muted mono">{{ avail_limit|format_amount }}</span> ₽
              {% if carryover_info.has_carryover %}
                <sup><i class="bi bi-arrow-left-right text-muted" title="Учтен перенос остатка"></i></sup>
              {% endif %}
            </span>
          </div>
          <div class="ff-track" role="meter" aria-valuemin="0" aria-valuenow="{{ progress|round }}" aria-valuemax="100">
            <div class="ff-bar" style="width: {{ bar_width }}%; --bar-color: {% if avail_limit < 0 %}var(--danger){% elif progress_raw >= 100 %}var(--bad){% elif progress_raw >= 85 %}var(--warn){% elif progress_raw >= 50 %}var(--caution){% else %}var(--ok){% endif %}"></div>
          </div>
          <div class="ff-meta">
            Остаток: <span class="rest {% if rest < 0 %}text-danger{% elif rest > 0 %}text-success{% endif %}">{{ rest|format_amount }}</span> ₽
            {% if carryover_info.has_carryover %}
              <small class="text-muted"> · с учетом переноса</small>
            {% endif %}
          </div>
        </div>

      </article>
    {% else %}
      <div class="text-muted p-3">Нет категорий бюджета на выбранный месяц.</div>
    {% endfor %}
    </div>
  </div>
</section>