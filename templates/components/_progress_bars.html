{# templates/components/_progress_bars.html #}
<section class="card-soft mb-4">
  <div class="p-3 pb-2 d-flex align-items-center justify-content-between flex-wrap gap-2">
    <h5 class="m-0"><i class="bi bi-graph-up-arrow me-2"></i>Прогресс по категориям</h5>

    <div class="segmented">
      <button class="seg-btn" id="sortDirBtn" data-dir="asc" title="Направление">
        <i class="bi bi-arrow-down-up"></i>
      </button>
      <div class="seg-divider"></div>
      <div class="dropdown">
        <button class="seg-btn dropdown-toggle" id="sortKeyBtn" data-bs-toggle="dropdown" aria-expanded="false">
          <span id="sortKeyLabel">Ручной порядок</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow-soft" aria-labelledby="sortKeyBtn">
          <li><button class="dropdown-item sort-opt" data-key="manual">Ручной порядок</button></li>
          <li><hr class="dropdown-divider"></li>
          <li><button class="dropdown-item sort-opt" data-key="name">По названию</button></li>
          <li><button class="dropdown-item sort-opt" data-key="progress">По прогрессу (%)</button></li>
          <li><button class="dropdown-item sort-opt" data-key="remaining">По остатку</button></li>
          <li><button class="dropdown-item sort-opt" data-key="spent">По тратам</button></li>
          <li><button class="dropdown-item sort-opt" data-key="limit">По лимиту</button></li>
        </ul>
      </div>
    </div>
  </div>

  <div id="catList" class="d-flex flex-column gap-2 p-3 pt-0">
    {% for cat in budget_data %}
      {% set base_limit = (cat.limit or 0)|float %}
      {% set spent       = (cat.spent or 0)|float %}
      {% set avail_limit = base_limit %}
      {% set rest        = (avail_limit - spent)|round(2, 'floor') %}

      {% if avail_limit > 0 %}
        {% set progress_raw = spent / avail_limit * 100 %}
      {% else %}
        {% set progress_raw = (spent > 0) and 100 or 0 %}
      {% endif %}

      {% set progress  = progress_raw|round(1) %}
      {% set bar_width = [progress_raw, 100]|min|round(1) %}
      {% set bar_class = 'pill-ok' if progress_raw < 70 else ('pill-warn' if progress_raw < 100 else 'pill-danger') %}

      <article class="cat card-soft"
               data-id="{{ cat.id if cat.id is defined else loop.index }}"
               data-name="{{ (cat.name or '')|trim }}"
               data-progress="{{ progress }}"
               data-remaining="{{ rest }}"
               data-spent="{{ spent }}"
               data-limit="{{ avail_limit }}"
               data-order="{{ cat.sort_order if cat.sort_order is defined else loop.index0 }}">
        <div class="cat-row">
          <div class="cat-left">
            <div class="cat-title">{{ cat.name }}</div>
            <div class="cat-meta">Фикс {{ base_limit|format_amount }} ₽</div>
          </div>

          <div class="cat-middle">
            <div class="ff-bar">
              {# вычисляем класс по проценту #}
              {% set pct = (bar_width|float) %}
              {% set fill_class = 'ok' if pct < 70 else ('warn' if pct < 100 else 'danger') %}
              <span class="ff-fill {{ fill_class }}" style="width: {{ [pct, 100]|min }}%"></span>
            </div>
          </div>

          <div class="cat-right">
            <div class="num">
              <b class="mono">{{ spent|format_amount }} ₽</b>
              /
              <span class="muted mono">{{ avail_limit|format_amount }} ₽</span>
            </div>
            <div class="small muted">
              Остаток:
              <span class="mono {% if rest < 0 %}text-danger{% elif rest > 0 %}text-success{% endif %}">
                {{ rest|format_amount }} ₽
              </span>
            </div>
          </div>

          <div class="cat-actions">
            <button class="ghost-icon" title="Редактировать" data-action="edit" data-id="{{ cat.id }}"><i class="bi bi-pencil"></i></button>
            <button class="ghost-icon" title="Удалить" data-action="delete" data-id="{{ cat.id }}"><i class="bi bi-trash"></i></button>
          </div>
        </div>
      </article>
    {% else %}
      <div class="text-muted">Нет категорий бюджета на выбранный месяц.</div>
    {% endfor %}
  </div>
</section>