{# templates/components/_progress_bars.html #}
<section class="ff-progress-card mb-4" aria-label="Прогресс по категориям">
  <div class="ff-header">
    <i class="bi bi-graph-up-arrow"></i>
    Прогресс по категориям
    
    <div class="ms-auto">
      <div class="segmented">
        <button class="seg-btn" id="sortDirBtn" data-dir="asc" title="Направление">
          <i class="bi bi-arrow-down-up"></i>
        </button>
        <div class="seg-divider"></div>
        <div class="dropdown">
          <button class="seg-btn dropdown-toggle" id="sortKeyBtn" data-bs-toggle="dropdown" aria-expanded="false">
            <span id="sortKeyLabel">По названию</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow-soft" aria-labelledby="sortKeyBtn">
            <li><button class="dropdown-item sort-opt" data-key="name">По названию</button></li>
            <li><button class="dropdown-item sort-opt" data-key="progress">По прогрессу (%)</button></li>
            <li><button class="dropdown-item sort-opt" data-key="remaining">По остатку</button></li>
            <li><button class="dropdown-item sort-opt" data-key="spent">По тратам</button></li>
            <li><button class="dropdown-item sort-opt" data-key="limit">По лимиту</button></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="ff-list" id="catList">
    {% for cat in budget_data %}
      {% set base_limit = (cat.limit or 0)|float %}
      {% set spent       = (cat.spent or 0)|float %}
      {% set avail_limit = base_limit %}
      {% set rest        = (avail_limit - spent)|round(2, 'floor') %}

      {% if avail_limit > 0 %}
        {% set progress_raw = spent / avail_limit * 100 %}
      {% else %}
        {% set progress_raw = (spent > 0) and 100 or 0 %}
      {% endif %}

      {% set progress  = progress_raw|round(1) %}
      {% set bar_width = [progress_raw, 100]|min|round(1) %}

      <article class="cat ff-item"
               data-id="{{ cat.id if cat.id is defined else loop.index }}"
               data-name="{{ (cat.name or '')|trim }}"
               data-progress="{{ progress }}"
               data-remaining="{{ rest }}"
               data-spent="{{ spent }}"
               data-limit="{{ avail_limit }}"
               data-order="{{ cat.sort_order if cat.sort_order is defined else loop.index0 }}"
               data-limit-type="{{ cat.limit_type or 'fixed' }}"
               data-value="{{ cat.value or avail_limit }}">
        
        <div class="ff-left">
          <div class="cat-title ff-title">{{ cat.name }}</div>
          <div class="cat-meta ff-meta">
            {% if cat.limit_type == 'percent' %}
              Процент {{ cat.value }}%
            {% else %}
              Фикс <span class="limit">{{ base_limit|format_amount }}</span> ₽
            {% endif %}
          </div>
        </div>

        <div class="ff-middle">
          <div class="ff-row">
            <strong class="spent">{{ spent|format_amount }}</strong> ₽
            <span class="slash">/</span>
            <span class="cat-right"><span class="limit muted mono">{{ avail_limit|format_amount }}</span> ₽</span>
          </div>
          <div class="ff-track" role="meter" aria-valuemin="0" aria-valuenow="{{ progress|round }}" aria-valuemax="100">
            <div class="ff-bar" style="width: {{ [bar_width, 100]|min }}%; --bar-color: {% if progress_raw < 50 %}var(--ok){% elif progress_raw < 85 %}var(--warn){% else %}var(--bad){% endif %}"></div>
          </div>
          <div class="ff-meta">Остаток: <span class="rest {% if rest < 0 %}text-danger{% elif rest > 0 %}text-success{% endif %}">{{ rest|format_amount }}</span> ₽</div>
        </div>

        <div class="ff-actions">
          <button class="icon-btn icon-primary icon-faded" title="Редактировать" aria-label="Редактировать"
                  data-action="edit"
                  data-id="{{ cat.id }}">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="icon-btn icon-danger icon-faded" title="Удалить" aria-label="Удалить" data-action="delete" data-id="{{ cat.id }}">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </article>
    {% else %}
      <div class="text-muted p-3">Нет категорий бюджета на выбранный месяц.</div>
    {% endfor %}
  </div>
</section>