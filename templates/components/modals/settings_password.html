<!-- Шаблон модальной формы изменения пароля -->
<!-- Используется для GET /modals/settings/password -->

<form method="POST" action="{{ url_for('auth.change_password') }}" 
      data-form="settings-password" role="form" aria-label="Форма изменения пароля" novalidate>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    
    <!-- Предупреждение для Telegram пользователей -->
    {% if user.auth_type == 'telegram' %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Telegram авторизация:</strong> 
        Вы вошли через Telegram. Изменение пароля недоступно.
    </div>
    {% else %}
    
    <div class="row g-3">
        <div class="col-12">
            <label class="form-label">Текущий пароль <span class="text-danger">*</span></label>
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-key" aria-hidden="true"></i></span>
                <input type="password" class="form-control" name="current_password" id="current_password"
                       placeholder="Введите текущий пароль" required minlength="6">
                <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword">
                    <i class="bi bi-eye" aria-hidden="true"></i>
                </button>
            </div>
        </div>

        <div class="col-12">
            <label class="form-label">Новый пароль <span class="text-danger">*</span></label>
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-shield-lock" aria-hidden="true"></i></span>
                <input type="password" class="form-control" name="new_password" id="new_password"
                       placeholder="Введите новый пароль" required minlength="6">
                <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                    <i class="bi bi-eye" aria-hidden="true"></i>
                </button>
            </div>
            <div class="form-text">Минимум 6 символов</div>
        </div>

        <div class="col-12">
            <label class="form-label">Повторите новый пароль <span class="text-danger">*</span></label>
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-shield-check" aria-hidden="true"></i></span>
                <input type="password" class="form-control" name="confirm_password" id="confirm_password"
                       placeholder="Повторите новый пароль" required minlength="6">
                <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                    <i class="bi bi-eye" aria-hidden="true"></i>
                </button>
            </div>
        </div>

        <!-- Индикатор надёжности пароля -->
        <div class="col-12">
            <div class="password-strength d-none">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted">Надёжность пароля:</small>
                    <small class="strength-text text-muted">Слабый</small>
                </div>
                <div class="progress" style="height: 4px;">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Советы по безопасности -->
        <div class="col-12">
            <div class="card bg-light border-0">
                <div class="card-body py-3">
                    <h6 class="card-title mb-2">
                        <i class="bi bi-lightbulb text-warning me-1"></i>Советы по безопасности
                    </h6>
                    <ul class="list-unstyled mb-0 small text-muted">
                        <li><i class="bi bi-check2 text-success me-1"></i>Используйте уникальный пароль</li>
                        <li><i class="bi bi-check2 text-success me-1"></i>Включите цифры и специальные символы</li>
                        <li><i class="bi bi-check2 text-success me-1"></i>Не используйте личную информацию</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    {% endif %}
    
    <!-- Область для отображения общих ошибок формы -->
    <div class="mt-3 d-none" role="alert" aria-live="assertive" aria-atomic="true" id="form-errors">
        <div class="alert alert-danger">
            <strong>Ошибка:</strong> <span id="form-error-text"></span>
        </div>
    </div>
    
    <!-- Индикатор загрузки -->
    <div class="mt-3 text-center d-none" id="form-loading" role="status" aria-live="polite">
        <span class="loading-spinner" aria-hidden="true"></span>
        <span class="visually-hidden">Изменение пароля…</span>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form[data-form="settings-password"]');
  if (!form) return;

  const currentPassword = form.querySelector('#current_password');
  const newPassword = form.querySelector('#new_password');
  const confirmPassword = form.querySelector('#confirm_password');
  const strengthIndicator = form.querySelector('.password-strength');
  const strengthText = form.querySelector('.strength-text');
  const strengthBar = form.querySelector('.progress-bar');
  const errBox = form.querySelector('#form-errors');
  const errText = form.querySelector('#form-error-text');
  const loading = form.querySelector('#form-loading');

  // отмечаем поля как "dirty" после первого ввода/blur
  form.querySelectorAll('input, select, textarea').forEach(el => {
    el.addEventListener('input', () => el.classList.add('dirty'));
    el.addEventListener('blur',  () => el.classList.add('dirty'));
  });

  // Auto-focus current password field
  if (currentPassword) {
    setTimeout(() => currentPassword.focus(), 100);
  }

  // Password visibility toggles
  const toggles = [
    { button: '#toggleCurrentPassword', input: '#current_password' },
    { button: '#toggleNewPassword', input: '#new_password' },
    { button: '#toggleConfirmPassword', input: '#confirm_password' }
  ];

  toggles.forEach(toggle => {
    const button = form.querySelector(toggle.button);
    const input = form.querySelector(toggle.input);
    if (button && input) {
      button.addEventListener('click', () => {
        const icon = button.querySelector('i');
        if (input.type === 'password') {
          input.type = 'text';
          icon.className = 'bi bi-eye-slash';
        } else {
          input.type = 'password';
          icon.className = 'bi bi-eye';
        }
      });
    }
  });

  // Password strength indicator
  if (newPassword && strengthIndicator) {
    newPassword.addEventListener('input', function() {
      const password = this.value;
      const strength = calculatePasswordStrength(password);
      
      if (password.length > 0) {
        strengthIndicator.classList.remove('d-none');
        strengthText.textContent = strength.text;
        strengthText.className = `strength-text ${strength.class}`;
        strengthBar.style.width = strength.percentage + '%';
        strengthBar.className = `progress-bar ${strength.bgClass}`;
      } else {
        strengthIndicator.classList.add('d-none');
      }
    });
  }

  // Password confirmation validation
  if (confirmPassword && newPassword) {
    confirmPassword.addEventListener('input', function() {
      if (this.value && this.value !== newPassword.value) {
        this.setCustomValidity('Пароли не совпадают');
      } else {
        this.setCustomValidity('');
      }
    });

    newPassword.addEventListener('input', function() {
      if (confirmPassword.value) {
        confirmPassword.dispatchEvent(new Event('input'));
      }
    });
  }

  form.addEventListener('submit', (e) => {
    if (!form.checkValidity()) {
      e.preventDefault();
      e.stopPropagation();
      form.classList.add('was-validated');
      return;
    }

    // показать лоадер и скрыть ошибку
    loading?.classList.remove('d-none');
    errBox?.classList.add('d-none');
  });

  function calculatePasswordStrength(password) {
    let score = 0;
    
    if (password.length >= 8) score += 1;
    if (password.length >= 12) score += 1;
    if (/[a-z]/.test(password)) score += 1;
    if (/[A-Z]/.test(password)) score += 1;
    if (/[0-9]/.test(password)) score += 1;
    if (/[^a-zA-Z0-9]/.test(password)) score += 1;
    
    const variants = [
      { text: 'Очень слабый', class: 'text-danger', bgClass: 'bg-danger', percentage: 10 },
      { text: 'Слабый', class: 'text-danger', bgClass: 'bg-danger', percentage: 25 },
      { text: 'Средний', class: 'text-warning', bgClass: 'bg-warning', percentage: 50 },
      { text: 'Хороший', class: 'text-info', bgClass: 'bg-info', percentage: 75 },
      { text: 'Отличный', class: 'text-success', bgClass: 'bg-success', percentage: 100 }
    ];
    
    const index = Math.min(Math.max(score - 1, 0), variants.length - 1);
    return variants[index];
  }
});
</script>