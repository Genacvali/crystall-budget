<!-- Шаблон модальной формы удаления аккаунта -->
<!-- Используется для GET /modals/settings/delete-account -->

<form method="POST" action="{{ url_for('settings_delete_account') }}" 
      data-form="settings-delete-account" role="form" aria-label="Форма удаления аккаунта" novalidate>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    
    <div class="row g-4">
        <!-- Критическое предупреждение -->
        <div class="col-12">
            <div class="alert alert-danger border-danger">
                <div class="d-flex align-items-start">
                    <i class="bi bi-exclamation-triangle-fill me-3 mt-1" style="font-size: 1.5rem;"></i>
                    <div>
                        <h5 class="alert-heading mb-2">Критическое предупреждение!</h5>
                        <p class="mb-2">
                            <strong>Удаление аккаунта приведёт к полной и безвозвратной потере:</strong>
                        </p>
                        <ul class="mb-0">
                            <li>Всех ваших расходов и доходов</li>
                            <li>Настроек категорий и целей накоплений</li>
                            <li>История и статистика</li>
                            <li>Профиль и настройки</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Статистика аккаунта -->
        <div class="col-12">
            <div class="card bg-light border-0">
                <div class="card-body">
                    <h6 class="card-title mb-3">
                        <i class="bi bi-person-circle me-2"></i>Информация об аккаунте
                    </h6>
                    <div class="row text-center">
                        <div class="col-6 col-md-3">
                            <div class="text-muted small">Зарегистрирован</div>
                            <div class="fw-bold">{{ user.created_at.strftime('%d.%m.%Y') if user.created_at else 'Неизвестно' }}</div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="text-muted small">Расходов</div>
                            <div class="fw-bold">{{ stats.expenses_count or 0 }}</div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="text-muted small">Доходов</div>
                            <div class="fw-bold">{{ stats.income_count or 0 }}</div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="text-muted small">Целей</div>
                            <div class="fw-bold">{{ stats.goals_count or 0 }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Альтернативные варианты -->
        <div class="col-12">
            <div class="card border-info">
                <div class="card-body">
                    <h6 class="card-title text-info mb-3">
                        <i class="bi bi-lightbulb me-2"></i>Рассмотрите альтернативы
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-download text-primary me-2 mt-1"></i>
                                <div>
                                    <strong>Экспорт данных</strong>
                                    <small class="d-block text-muted">Сохраните данные перед удалением</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-trash text-warning me-2 mt-1"></i>
                                <div>
                                    <strong>Очистка данных</strong>
                                    <small class="d-block text-muted">Удалите данные, оставив аккаунт</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Причина удаления -->
        <div class="col-12">
            <h6 class="mb-3">
                <i class="bi bi-chat-square-text me-2"></i>Причина удаления (необязательно)
            </h6>
            <div class="row g-2 mb-3">
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="reason" value="not_useful" id="reason-not-useful">
                        <label class="form-check-label" for="reason-not-useful">
                            Приложение не полезно
                        </label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="reason" value="too_complex" id="reason-complex">
                        <label class="form-check-label" for="reason-complex">
                            Слишком сложное
                        </label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="reason" value="privacy" id="reason-privacy">
                        <label class="form-check-label" for="reason-privacy">
                            Вопросы приватности
                        </label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="reason" value="other" id="reason-other">
                        <label class="form-check-label" for="reason-other">
                            Другая причина
                        </label>
                    </div>
                </div>
            </div>
            <textarea class="form-control" name="reason_comment" id="reason_comment" rows="2" 
                      placeholder="Дополнительные комментарии (помогут улучшить сервис)"></textarea>
        </div>

        <!-- Резервная копия -->
        <div class="col-12">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="create_backup" id="create_backup" checked>
                <label class="form-check-label" for="create_backup">
                    <i class="bi bi-shield-check me-2 text-success"></i>
                    <strong>Создать резервную копию перед удалением</strong>
                    <small class="d-block text-muted">Автоматически создать и отправить архив ваших данных</small>
                </label>
            </div>
        </div>

        <!-- Подтверждение удаления -->
        <div class="col-12">
            <div class="card bg-danger bg-opacity-10 border-danger">
                <div class="card-body">
                    <h6 class="text-danger mb-3">
                        <i class="bi bi-shield-exclamation me-2"></i>Финальное подтверждение
                    </h6>
                    
                    <div class="mb-3">
                        <label class="form-label">
                            Введите ваше имя <strong>"{{ user.name }}"</strong> для подтверждения:
                        </label>
                        <input type="text" class="form-control" name="name_confirmation" id="name_confirmation"
                               placeholder="Введите ваше имя" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            Введите <code>УДАЛИТЬ АККАУНТ</code> для окончательного подтверждения:
                        </label>
                        <input type="text" class="form-control" name="deletion_confirmation" id="deletion_confirmation"
                               placeholder="Введите УДАЛИТЬ АККАУНТ" required 
                               pattern="УДАЛИТЬ АККАУНТ" title="Введите точно фразу УДАЛИТЬ АККАУНТ">
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="understand_irreversible" id="understand_irreversible" required>
                        <label class="form-check-label text-danger" for="understand_irreversible">
                            <strong>Я понимаю, что это действие НЕОБРАТИМО</strong>
                        </label>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="data_loss_acknowledged" id="data_loss_acknowledged" required>
                        <label class="form-check-label text-danger" for="data_loss_acknowledged">
                            <strong>Я принимаю полную потерю всех данных</strong>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        {% if user.auth_type == 'email' %}
        <!-- Подтверждение пароля для email пользователей -->
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-body">
                    <h6 class="text-warning mb-3">
                        <i class="bi bi-key me-2"></i>Подтверждение пароля
                    </h6>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-shield-lock"></i></span>
                        <input type="password" class="form-control" name="password_confirmation" id="password_confirmation"
                               placeholder="Введите ваш пароль" required>
                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    <small class="form-text text-muted">Для безопасности требуется подтверждение пароля</small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Область для отображения общих ошибок формы -->
    <div class="mt-3 d-none" role="alert" aria-live="assertive" aria-atomic="true" id="form-errors">
        <div class="alert alert-danger">
            <strong>Ошибка:</strong> <span id="form-error-text"></span>
        </div>
    </div>
    
    <!-- Индикатор загрузки -->
    <div class="mt-3 text-center d-none" id="form-loading" role="status" aria-live="polite">
        <span class="loading-spinner" aria-hidden="true"></span>
        <span class="visually-hidden">Удаление аккаунта…</span>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form[data-form="settings-delete-account"]');
  if (!form) return;

  const nameConfirmation = form.querySelector('#name_confirmation');
  const deletionConfirmation = form.querySelector('#deletion_confirmation');
  const passwordConfirmation = form.querySelector('#password_confirmation');
  const togglePassword = form.querySelector('#togglePassword');
  const understoodIrreversible = form.querySelector('#understand_irreversible');
  const dataLossAcknowledged = form.querySelector('#data_loss_acknowledged');
  const errBox = form.querySelector('#form-errors');
  const errText = form.querySelector('#form-error-text');
  const loading = form.querySelector('#form-loading');

  const expectedName = "{{ user.name }}";

  // отмечаем поля как "dirty" после первого ввода/blur
  form.querySelectorAll('input, select, textarea').forEach(el => {
    el.addEventListener('input', () => el.classList.add('dirty'));
    el.addEventListener('blur',  () => el.classList.add('dirty'));
  });

  // Auto-focus name confirmation field
  if (nameConfirmation) {
    setTimeout(() => nameConfirmation.focus(), 100);
  }

  // Password visibility toggle
  if (togglePassword && passwordConfirmation) {
    togglePassword.addEventListener('click', () => {
      const icon = togglePassword.querySelector('i');
      if (passwordConfirmation.type === 'password') {
        passwordConfirmation.type = 'text';
        icon.className = 'bi bi-eye-slash';
      } else {
        passwordConfirmation.type = 'password';
        icon.className = 'bi bi-eye';
      }
    });
  }

  // Name confirmation validation
  if (nameConfirmation) {
    nameConfirmation.addEventListener('input', function() {
      if (this.value === expectedName) {
        this.classList.add('is-valid');
        this.classList.remove('is-invalid');
      } else {
        this.classList.add('is-invalid');
        this.classList.remove('is-valid');
      }
    });
  }

  // Deletion confirmation validation
  if (deletionConfirmation) {
    deletionConfirmation.addEventListener('input', function() {
      if (this.value === 'УДАЛИТЬ АККАУНТ') {
        this.classList.add('is-valid');
        this.classList.remove('is-invalid');
      } else {
        this.classList.add('is-invalid');
        this.classList.remove('is-valid');
      }
    });
  }

  form.addEventListener('submit', (e) => {
    // Validate name confirmation
    if (nameConfirmation && nameConfirmation.value !== expectedName) {
      e.preventDefault();
      e.stopPropagation();
      showError(`Введите точно ваше имя: "${expectedName}"`);
      nameConfirmation.focus();
      return;
    }

    // Validate deletion confirmation
    if (deletionConfirmation && deletionConfirmation.value !== 'УДАЛИТЬ АККАУНТ') {
      e.preventDefault();
      e.stopPropagation();
      showError('Для подтверждения введите точно фразу "УДАЛИТЬ АККАУНТ"');
      deletionConfirmation.focus();
      return;
    }

    // Validate checkboxes
    if (!understoodIrreversible?.checked) {
      e.preventDefault();
      e.stopPropagation();
      showError('Подтвердите, что понимаете необратимость действия');
      return;
    }

    if (!dataLossAcknowledged?.checked) {
      e.preventDefault();
      e.stopPropagation();
      showError('Подтвердите, что принимаете потерю данных');
      return;
    }

    if (!form.checkValidity()) {
      e.preventDefault();
      e.stopPropagation();
      form.classList.add('was-validated');
      return;
    }

    // Final confirmation dialog
    const confirmed = confirm(
      '🚨 ПОСЛЕДНЕЕ ПРЕДУПРЕЖДЕНИЕ! 🚨\n\n' +
      'Вы действительно хотите НАВСЕГДА удалить ваш аккаунт?\n\n' +
      '• Все данные будут потеряны безвозвратно\n' +
      '• Восстановление будет невозможно\n' +
      '• Это последний шанс передумать\n\n' +
      'Нажмите ОК только если на 100% уверены!'
    );

    if (!confirmed) {
      e.preventDefault();
      return;
    }

    // показать лоадер и скрыть ошибку
    loading?.classList.remove('d-none');
    errBox?.classList.add('d-none');
  });

  function showError(message) {
    errText.textContent = message;
    errBox.classList.remove('d-none');
  }
});
</script>