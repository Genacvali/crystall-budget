<!-- –®–∞–±–ª–æ–Ω –º–æ–¥–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º—ã —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ -->
<!-- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è GET /modals/settings/delete-account -->

<form method="POST" action="{{ url_for('settings_delete_account') }}" 
      data-form="settings-delete-account" role="form" aria-label="–§–æ—Ä–º–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞" novalidate>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    
    <div class="row g-4">
        <!-- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ -->
        <div class="col-12">
            <div class="alert alert-danger border-danger">
                <div class="d-flex align-items-start">
                    <i class="bi bi-exclamation-triangle-fill me-3 mt-1" style="font-size: 1.5rem;"></i>
                    <div>
                        <h5 class="alert-heading mb-2">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!</h5>
                        <p class="mb-2">
                            <strong>–£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ –ø–æ–ª–Ω–æ–π –∏ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ–π –ø–æ—Ç–µ—Ä–µ:</strong>
                        </p>
                        <ul class="mb-0">
                            <li>–í—Å–µ—Ö –≤–∞—à–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ –¥–æ—Ö–æ–¥–æ–≤</li>
                            <li>–ù–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ —Ü–µ–ª–µ–π –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π</li>
                            <li>–ò—Å—Ç–æ—Ä–∏—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</li>
                            <li>–ü—Ä–æ—Ñ–∏–ª—å –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ -->
        <div class="col-12">
            <div class="card bg-light border-0">
                <div class="card-body">
                    <h6 class="card-title mb-3">
                        <i class="bi bi-person-circle me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ
                    </h6>
                    <div class="row text-center">
                        <div class="col-6 col-md-3">
                            <div class="text-muted small">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</div>
                            <div class="fw-bold">{{ user.created_at.strftime('%d.%m.%Y') if user.created_at else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="text-muted small">–†–∞—Å—Ö–æ–¥–æ–≤</div>
                            <div class="fw-bold">{{ stats.expenses_count or 0 }}</div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="text-muted small">–î–æ—Ö–æ–¥–æ–≤</div>
                            <div class="fw-bold">{{ stats.income_count or 0 }}</div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="text-muted small">–¶–µ–ª–µ–π</div>
                            <div class="fw-bold">{{ stats.goals_count or 0 }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã -->
        <div class="col-12">
            <div class="card border-info">
                <div class="card-body">
                    <h6 class="card-title text-info mb-3">
                        <i class="bi bi-lightbulb me-2"></i>–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-download text-primary me-2 mt-1"></i>
                                <div>
                                    <strong>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</strong>
                                    <small class="d-block text-muted">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-trash text-warning me-2 mt-1"></i>
                                <div>
                                    <strong>–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö</strong>
                                    <small class="d-block text-muted">–£–¥–∞–ª–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ, –æ—Å—Ç–∞–≤–∏–≤ –∞–∫–∫–∞—É–Ω—Ç</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∏—á–∏–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
        <div class="col-12">
            <h6 class="mb-3">
                <i class="bi bi-chat-square-text me-2"></i>–ü—Ä–∏—á–∏–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
            </h6>
            <div class="row g-2 mb-3">
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="reason" value="not_useful" id="reason-not-useful">
                        <label class="form-check-label" for="reason-not-useful">
                            –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –ø–æ–ª–µ–∑–Ω–æ
                        </label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="reason" value="too_complex" id="reason-complex">
                        <label class="form-check-label" for="reason-complex">
                            –°–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–æ–µ
                        </label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="reason" value="privacy" id="reason-privacy">
                        <label class="form-check-label" for="reason-privacy">
                            –í–æ–ø—Ä–æ—Å—ã –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
                        </label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="reason" value="other" id="reason-other">
                        <label class="form-check-label" for="reason-other">
                            –î—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞
                        </label>
                    </div>
                </div>
            </div>
            <textarea class="form-control" name="reason_comment" id="reason_comment" rows="2" 
                      placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–ø–æ–º–æ–≥—É—Ç —É–ª—É—á—à–∏—Ç—å —Å–µ—Ä–≤–∏—Å)"></textarea>
        </div>

        <!-- –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è -->
        <div class="col-12">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="create_backup" id="create_backup" checked>
                <label class="form-check-label" for="create_backup">
                    <i class="bi bi-shield-check me-2 text-success"></i>
                    <strong>–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º</strong>
                    <small class="d-block text-muted">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞—Ä—Ö–∏–≤ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö</small>
                </label>
            </div>
        </div>

        <!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è -->
        <div class="col-12">
            <div class="card bg-danger bg-opacity-10 border-danger">
                <div class="card-body">
                    <h6 class="text-danger mb-3">
                        <i class="bi bi-shield-exclamation me-2"></i>–§–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                    </h6>
                    
                    <div class="mb-3">
                        <label class="form-label">
                            –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è <strong>"{{ user.name }}"</strong> –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:
                        </label>
                        <input type="text" class="form-control" name="name_confirmation" id="name_confirmation"
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            –í–≤–µ–¥–∏—Ç–µ <code>–£–î–ê–õ–ò–¢–¨ –ê–ö–ö–ê–£–ù–¢</code> –¥–ª—è –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:
                        </label>
                        <input type="text" class="form-control" name="deletion_confirmation" id="deletion_confirmation"
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –£–î–ê–õ–ò–¢–¨ –ê–ö–ö–ê–£–ù–¢" required 
                               pattern="–£–î–ê–õ–ò–¢–¨ –ê–ö–ö–ê–£–ù–¢" title="–í–≤–µ–¥–∏—Ç–µ —Ç–æ—á–Ω–æ —Ñ—Ä–∞–∑—É –£–î–ê–õ–ò–¢–¨ –ê–ö–ö–ê–£–ù–¢">
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="understand_irreversible" id="understand_irreversible" required>
                        <label class="form-check-label text-danger" for="understand_irreversible">
                            <strong>–Ø –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û</strong>
                        </label>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="data_loss_acknowledged" id="data_loss_acknowledged" required>
                        <label class="form-check-label text-danger" for="data_loss_acknowledged">
                            <strong>–Ø –ø—Ä–∏–Ω–∏–º–∞—é –ø–æ–ª–Ω—É—é –ø–æ—Ç–µ—Ä—é –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö</strong>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        {% if user.auth_type == 'email' %}
        <!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –¥–ª—è email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-body">
                    <h6 class="text-warning mb-3">
                        <i class="bi bi-key me-2"></i>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
                    </h6>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-shield-lock"></i></span>
                        <input type="password" class="form-control" name="password_confirmation" id="password_confirmation"
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å" required>
                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    <small class="form-text text-muted">–î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±—â–∏—Ö –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º—ã -->
    <div class="mt-3 d-none" role="alert" aria-live="assertive" aria-atomic="true" id="form-errors">
        <div class="alert alert-danger">
            <strong>–û—à–∏–±–∫–∞:</strong> <span id="form-error-text"></span>
        </div>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="mt-3 text-center d-none" id="form-loading" role="status" aria-live="polite">
        <span class="loading-spinner" aria-hidden="true"></span>
        <span class="visually-hidden">–£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞‚Ä¶</span>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form[data-form="settings-delete-account"]');
  if (!form) return;

  const nameConfirmation = form.querySelector('#name_confirmation');
  const deletionConfirmation = form.querySelector('#deletion_confirmation');
  const passwordConfirmation = form.querySelector('#password_confirmation');
  const togglePassword = form.querySelector('#togglePassword');
  const understoodIrreversible = form.querySelector('#understand_irreversible');
  const dataLossAcknowledged = form.querySelector('#data_loss_acknowledged');
  const errBox = form.querySelector('#form-errors');
  const errText = form.querySelector('#form-error-text');
  const loading = form.querySelector('#form-loading');

  const expectedName = "{{ user.name }}";

  // –æ—Ç–º–µ—á–∞–µ–º –ø–æ–ª—è –∫–∞–∫ "dirty" –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤–≤–æ–¥–∞/blur
  form.querySelectorAll('input, select, textarea').forEach(el => {
    el.addEventListener('input', () => el.classList.add('dirty'));
    el.addEventListener('blur',  () => el.classList.add('dirty'));
  });

  // Auto-focus name confirmation field
  if (nameConfirmation) {
    setTimeout(() => nameConfirmation.focus(), 100);
  }

  // Password visibility toggle
  if (togglePassword && passwordConfirmation) {
    togglePassword.addEventListener('click', () => {
      const icon = togglePassword.querySelector('i');
      if (passwordConfirmation.type === 'password') {
        passwordConfirmation.type = 'text';
        icon.className = 'bi bi-eye-slash';
      } else {
        passwordConfirmation.type = 'password';
        icon.className = 'bi bi-eye';
      }
    });
  }

  // Name confirmation validation
  if (nameConfirmation) {
    nameConfirmation.addEventListener('input', function() {
      if (this.value === expectedName) {
        this.classList.add('is-valid');
        this.classList.remove('is-invalid');
      } else {
        this.classList.add('is-invalid');
        this.classList.remove('is-valid');
      }
    });
  }

  // Deletion confirmation validation
  if (deletionConfirmation) {
    deletionConfirmation.addEventListener('input', function() {
      if (this.value === '–£–î–ê–õ–ò–¢–¨ –ê–ö–ö–ê–£–ù–¢') {
        this.classList.add('is-valid');
        this.classList.remove('is-invalid');
      } else {
        this.classList.add('is-invalid');
        this.classList.remove('is-valid');
      }
    });
  }

  form.addEventListener('submit', (e) => {
    // Validate name confirmation
    if (nameConfirmation && nameConfirmation.value !== expectedName) {
      e.preventDefault();
      e.stopPropagation();
      showError(`–í–≤–µ–¥–∏—Ç–µ —Ç–æ—á–Ω–æ –≤–∞—à–µ –∏–º—è: "${expectedName}"`);
      nameConfirmation.focus();
      return;
    }

    // Validate deletion confirmation
    if (deletionConfirmation && deletionConfirmation.value !== '–£–î–ê–õ–ò–¢–¨ –ê–ö–ö–ê–£–ù–¢') {
      e.preventDefault();
      e.stopPropagation();
      showError('–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ —Ç–æ—á–Ω–æ —Ñ—Ä–∞–∑—É "–£–î–ê–õ–ò–¢–¨ –ê–ö–ö–ê–£–ù–¢"');
      deletionConfirmation.focus();
      return;
    }

    // Validate checkboxes
    if (!understoodIrreversible?.checked) {
      e.preventDefault();
      e.stopPropagation();
      showError('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —á—Ç–æ –ø–æ–Ω–∏–º–∞–µ—Ç–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏—è');
      return;
    }

    if (!dataLossAcknowledged?.checked) {
      e.preventDefault();
      e.stopPropagation();
      showError('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —á—Ç–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ø–æ—Ç–µ—Ä—é –¥–∞–Ω–Ω—ã—Ö');
      return;
    }

    if (!form.checkValidity()) {
      e.preventDefault();
      e.stopPropagation();
      form.classList.add('was-validated');
      return;
    }

    // Final confirmation dialog
    const confirmed = confirm(
      'üö® –ü–û–°–õ–ï–î–ù–ï–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï! üö®\n\n' +
      '–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –ù–ê–í–°–ï–ì–î–ê —É–¥–∞–ª–∏—Ç—å –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç?\n\n' +
      '‚Ä¢ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ\n' +
      '‚Ä¢ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ\n' +
      '‚Ä¢ –≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–Ω—Å –ø–µ—Ä–µ–¥—É–º–∞—Ç—å\n\n' +
      '–ù–∞–∂–º–∏—Ç–µ –û–ö —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞ 100% —É–≤–µ—Ä–µ–Ω—ã!'
    );

    if (!confirmed) {
      e.preventDefault();
      return;
    }

    // –ø–æ–∫–∞–∑–∞—Ç—å –ª–æ–∞–¥–µ—Ä –∏ —Å–∫—Ä—ã—Ç—å –æ—à–∏–±–∫—É
    loading?.classList.remove('d-none');
    errBox?.classList.add('d-none');
  });

  function showError(message) {
    errText.textContent = message;
    errBox.classList.remove('d-none');
  }
});
</script>