<!-- –®–∞–±–ª–æ–Ω –º–æ–¥–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
<!-- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è GET /modals/settings/profile -->

<form method="POST" action="{{ url_for('auth.profile') }}" 
      data-form="settings-profile" role="form" aria-label="–§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è" novalidate>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    
    <div class="row g-3">
        <div class="col-12">
            <label class="form-label">–ò–º—è <span class="text-danger">*</span></label>
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-person" aria-hidden="true"></i></span>
                <input type="text" class="form-control" name="name" id="name"
                       value="{{ user.name or '' }}" placeholder="–í–∞—à–µ –∏–º—è" 
                       required maxlength="100">
            </div>
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label">–í–∞–ª—é—Ç–∞</label>
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-currency-exchange" aria-hidden="true"></i></span>
                <select class="form-select" name="currency" id="currency">
                    <option value="RUB" {{ 'selected' if user.currency == 'RUB' else '' }}>üá∑üá∫ –†—É–±–ª—å (RUB)</option>
                    <option value="USD" {{ 'selected' if user.currency == 'USD' else '' }}>üá∫üá∏ –î–æ–ª–ª–∞—Ä (USD)</option>
                    <option value="EUR" {{ 'selected' if user.currency == 'EUR' else '' }}>üá™üá∫ –ï–≤—Ä–æ (EUR)</option>
                    <option value="KZT" {{ 'selected' if user.currency == 'KZT' else '' }}>üá∞üáø –¢–µ–Ω–≥–µ (KZT)</option>
                    <option value="BYN" {{ 'selected' if user.currency == 'BYN' else '' }}>üáßüáæ –ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —Ä—É–±–ª—å (BYN)</option>
                </select>
            </div>
            <div class="form-text">–û—Å–Ω–æ–≤–Ω–∞—è –≤–∞–ª—é—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</label>
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-clock" aria-hidden="true"></i></span>
                <select class="form-select" name="timezone" id="timezone">
                    <option value="Europe/Moscow" {{ 'selected' if user.timezone == 'Europe/Moscow' else '' }}>–ú–æ—Å–∫–≤–∞ (UTC+3)</option>
                    <option value="Europe/Kiev" {{ 'selected' if user.timezone == 'Europe/Kiev' else '' }}>–ö–∏–µ–≤ (UTC+2)</option>
                    <option value="Europe/Minsk" {{ 'selected' if user.timezone == 'Europe/Minsk' else '' }}>–ú–∏–Ω—Å–∫ (UTC+3)</option>
                    <option value="Asia/Almaty" {{ 'selected' if user.timezone == 'Asia/Almaty' else '' }}>–ê–ª–º–∞—Ç—ã (UTC+6)</option>
                    <option value="Asia/Tashkent" {{ 'selected' if user.timezone == 'Asia/Tashkent' else '' }}>–¢–∞—à–∫–µ–Ω—Ç (UTC+5)</option>
                    <option value="UTC" {{ 'selected' if user.timezone == 'UTC' else '' }}>UTC</option>
                </select>
            </div>
            <div class="form-text">–î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏</div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ -->
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body py-2">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="text-muted small">–¢–∏–ø –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</div>
                            <div class="fw-bold">
                                {% if user.auth_type == 'telegram' %}
                                    <i class="bi bi-telegram text-primary"></i> Telegram
                                {% else %}
                                    <i class="bi bi-envelope text-secondary"></i> Email
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-muted small">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
                            <div class="fw-bold">{{ user.created_at.strftime('%d.%m.%Y') if user.created_at else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</div>
                        </div>
                        <div class="col-4">
                            <div class="text-muted small">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                            <div class="fw-bold">#{{ user.id }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±—â–∏—Ö –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º—ã -->
    <div class="mt-3 d-none" role="alert" aria-live="assertive" aria-atomic="true" id="form-errors">
        <div class="alert alert-danger">
            <strong>–û—à–∏–±–∫–∞:</strong> <span id="form-error-text"></span>
        </div>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="mt-3 text-center d-none" id="form-loading" role="status" aria-live="polite">
        <span class="loading-spinner" aria-hidden="true"></span>
        <span class="visually-hidden">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è‚Ä¶</span>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form[data-form="settings-profile"]');
  if (!form) return;

  const nameInput = form.querySelector('#name');
  const currencySelect = form.querySelector('#currency');
  const errBox = form.querySelector('#form-errors');
  const errText = form.querySelector('#form-error-text');
  const loading = form.querySelector('#form-loading');

  // –æ—Ç–º–µ—á–∞–µ–º –ø–æ–ª—è –∫–∞–∫ "dirty" –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤–≤–æ–¥–∞/blur
  form.querySelectorAll('input, select, textarea').forEach(el => {
    el.addEventListener('input', () => el.classList.add('dirty'));
    el.addEventListener('blur',  () => el.classList.add('dirty'));
  });

  // Auto-focus name field
  if (nameInput) {
    setTimeout(() => nameInput.focus(), 100);
  }

  // Auto-focus currency after name entry
  if (nameInput && currencySelect) {
    nameInput.addEventListener('blur', function() {
      if (this.value.trim()) {
        setTimeout(() => currencySelect.focus(), 100);
      }
    });
  }

  form.addEventListener('submit', (e) => {
    if (!form.checkValidity()) {
      e.preventDefault();
      e.stopPropagation();
      form.classList.add('was-validated');
      return;
    }

    // –ø–æ–∫–∞–∑–∞—Ç—å –ª–æ–∞–¥–µ—Ä –∏ —Å–∫—Ä—ã—Ç—å –æ—à–∏–±–∫—É
    loading?.classList.remove('d-none');
    errBox?.classList.add('d-none');
  });
});
</script>