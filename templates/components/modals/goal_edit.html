<!-- Шаблон модальной формы редактирования цели -->
<!-- Используется для GET /modals/goal/<id>/edit -->

<form method="POST" action="{{ url_for('goals.edit_goal', goal_id=goal.id) }}" 
      data-form="goal-edit" role="form" aria-label="Форма редактирования цели накопления" novalidate>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    
    <div class="row g-3">
        <div class="col-12">
            <label class="form-label">Название цели <span class="text-danger">*</span></label>
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-bullseye" aria-hidden="true"></i></span>
                <input type="text" class="form-control" name="name" id="name"
                       value="{{ goal.name or '' }}" placeholder="Новый iPhone" required maxlength="100">
            </div>
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label">Целевая сумма <span class="text-danger">*</span></label>
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-cash-coin" aria-hidden="true"></i></span>
                <input type="text" class="form-control" name="target_amount" id="target_amount"
                       inputmode="decimal" value="{{ goal.target_amount }}"
                       pattern="^\s*\d+([,\.]\d{1,2})?\s*$" required>
                <span class="input-group-text">{{ currency_symbol|default('₽') }}</span>
            </div>
            <div class="form-text">Запятая или точка, 2 знака после.</div>
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label">Желаемая дата</label>
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-calendar-event" aria-hidden="true"></i></span>
                <input type="date" class="form-control" name="target_date" id="target_date"
                       value="{{ goal.target_date.strftime('%Y-%m-%d') if goal.target_date else '' }}">
            </div>
            <div class="form-text">Необязательно</div>
        </div>

        <div class="col-12">
            <label class="form-label">Описание</label>
            <textarea class="form-control" name="description" id="description" rows="3" maxlength="500"
                      placeholder="Зачем вам эта цель?">{{ goal.description or '' }}</textarea>
            <div class="form-text">Необязательно</div>
        </div>

        {% if goal.current_amount > 0 %}
        <div class="col-12">
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Накоплено:</strong> {{ goal.current_amount|format_amount }} {{ currency_symbol|default('₽') }}
                <br>
                <small>При изменении целевой суммы прогресс будет пересчитан автоматически.</small>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Область для отображения общих ошибок формы -->
    <div class="mt-3 d-none" role="alert" aria-live="assertive" aria-atomic="true" id="form-errors">
        <div class="alert alert-danger">
            <strong>Ошибка:</strong> <span id="form-error-text"></span>
        </div>
    </div>
    
    <!-- Индикатор загрузки -->
    <div class="mt-3 text-center d-none" id="form-loading" role="status" aria-live="polite">
        <span class="loading-spinner" aria-hidden="true"></span>
        <span class="visually-hidden">Сохранение изменений…</span>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form[data-form="goal-edit"]');
  if (!form) return;

  const targetAmount = form.querySelector('input[name="target_amount"]');
  const nameInput = form.querySelector('#name');
  const errBox = form.querySelector('#form-errors');
  const errText = form.querySelector('#form-error-text');
  const loading = form.querySelector('#form-loading');

  // отмечаем поля как "dirty" после первого ввода/blur
  form.querySelectorAll('input, select, textarea').forEach(el => {
    el.addEventListener('input', () => el.classList.add('dirty'));
    el.addEventListener('blur',  () => el.classList.add('dirty'));
  });

  // Auto-focus target amount after name change (only if amount is empty)
  if (nameInput && targetAmount) {
    nameInput.addEventListener('change', function() {
      if (this.value && !targetAmount.value.trim()) {
        setTimeout(() => targetAmount.focus(), 100);
      }
    });
  }

  form.addEventListener('submit', (e) => {
    // нормализуем сумму
    if (targetAmount && targetAmount.value) {
      const v = targetAmount.value.replace(',', '.').trim();
      if (/^\d+(\.\d{1,2})?$/.test(v)) {
        targetAmount.value = (Math.round(parseFloat(v)*100)/100).toFixed(2);
      }
    }

    if (!form.checkValidity()) {
      e.preventDefault();
      e.stopPropagation();
      form.classList.add('was-validated');
      return;
    }

    // показать лоадер и скрыть ошибку
    loading?.classList.remove('d-none');
    errBox?.classList.add('d-none');
  });
});
</script>