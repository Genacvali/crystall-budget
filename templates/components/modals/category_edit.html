<!-- Шаблон модальной формы редактирования категории -->
<!-- Используется для GET /modals/category/<id>/edit -->

<div class="cb-modal__header">
    <h5 class="cb-modal__title">
        <i class="bi bi-pencil-square me-2"></i>Редактировать категорию
    </h5>
    <button type="button" class="cb-modal__close" data-modal-close aria-label="Закрыть">
        <i class="bi bi-x-lg"></i>
    </button>
</div>

<div class="cb-modal__body">
<form method="POST" action="{{ url_for('budget.edit_category', category_id=category.id) }}"
      data-form="category-edit" role="form" aria-label="Форма редактирования категории" novalidate id="categoryEditFormInner">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <input type="hidden" name="is_multi_source" value="{{ '1' if category.is_multi_source else '0' }}" id="isMultiSourceHidden">

    <!-- Основная информация -->
    <div class="mb-4">
        <div class="row g-3">
            <div class="col-12">
                <label class="form-label">Название <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="name" value="{{ category.name }}" required autofocus>
            </div>

            <!-- Тумблер мультиисточниковости -->
            <div class="col-12">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="multiSourceSwitch"
                           {% if category.is_multi_source %}checked{% endif %}>
                    <label class="form-check-label" for="multiSourceSwitch">
                        Несколько источников дохода
                    </label>
                </div>
                <small class="text-muted">Лимит будет формироваться из нескольких источников</small>
            </div>
        </div>
    </div>

    <!-- Поля для обычной категории (один источник) -->
    <div id="singleSourceFields" {% if category.is_multi_source %}style="display:none;"{% endif %}>
        <div class="mb-4">
            <div class="row g-3">
                <div class="col-12">
                    <label class="form-label">Источник дохода</label>
                    <select class="form-select" name="source_id" id="sourceSelectEdit{{ category.id }}">
                        <option value="">Все источники (весь доход)</option>
                        {% for source in income_sources %}
                        <option value="{{ source.id }}" {% if category.source_id == source.id %}selected{% endif %}>
                            {{ source.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Можно выбрать конкретный источник или использовать весь доход</small>
                </div>

                <div class="col-12 col-md-6">
                    <label class="form-label">Тип лимита <span class="text-danger">*</span></label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" name="limit_type" id="fixedEdit{{ category.id }}" value="fixed" class="btn-check" {% if category.limit_type == 'fixed' %}checked{% endif %}>
                        <label for="fixedEdit{{ category.id }}" class="btn btn-outline-primary">Фикс. сумма</label>
                        <input type="radio" name="limit_type" id="percentEdit{{ category.id }}" value="percent" class="btn-check" {% if category.limit_type == 'percent' %}checked{% endif %}>
                        <label for="percentEdit{{ category.id }}" class="btn btn-outline-primary">% от дохода</label>
                    </div>
                </div>

                <div class="col-12 col-md-6">
                    <label class="form-label">Значение <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <input type="number" name="value"
                               {% if category.limit_type == 'percent' %}step="any" max="100" min="0"{% else %}step="0.01" min="0.01" max="999999"{% endif %}
                               class="form-control"
                               value="{{ category.value }}" id="valueInputEdit{{ category.id }}" required>
                        <span class="input-group-text" id="valueSuffixEdit{{ category.id }}">
                            {% if category.limit_type == 'percent' %}%{% else %}₽{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Управление источниками для мультиисточниковых категорий -->
    <div id="multiSourceFields" {% if not category.is_multi_source %}style="display:none;"{% endif %}>
        <div class="mb-4">
            <h6 class="mb-3">
                <i class="bi bi-layers me-2"></i>Источники дохода
            </h6>

            <!-- Текущие источники -->
            <div id="currentSourcesList" class="mb-3">
                {% if rules_map %}
                    {% for source in income_sources %}
                        {% set rule = rules_map.get(source.name) %}
                        {% if rule %}
                        <div class="card border mb-2">
                            <div class="card-body py-2 px-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ source.name }}</strong>
                                        <span class="text-muted ms-2">{{ rule.percentage }}{% if rule.is_fixed %}₽{% else %}%{% endif %}</span>
                                    </div>
                                    <form method="POST" action="{{ url_for('budget.delete_category_rule', rule_id=rule.id) }}" class="d-inline delete-rule-form">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <input type="hidden" name="category_id" value="{{ category.id }}"/>
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <p class="text-muted small mb-0">Источники не настроены</p>
                {% endif %}
            </div>

            <!-- Форма добавления источника -->
            <div class="card bg-light border-0">
                <div class="card-body">
                    <h6 class="card-title mb-3">Добавить источник</h6>
                    <form id="addSourceFormEdit" action="{{ url_for('budget.add_source_to_category', cat_id=category.id) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="row g-3">
                            <div class="col-12 col-md-5">
                                <label class="form-label small">Источник дохода</label>
                                <select class="form-select" name="source_id" required>
                                    <option value="">Выберите источник...</option>
                                    {% for source in income_sources %}
                                    <option value="{{ source.id }}">{{ source.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12 col-md-3">
                                <label class="form-label small">Тип</label>
                                <select class="form-select" name="limit_type" id="sourceTypeSelectEdit">
                                    <option value="percent">%</option>
                                    <option value="fixed">₽</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-4">
                                <label class="form-label small">Значение</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="value" id="sourceValueInputEdit" placeholder="0" step="0.01" min="0.01" required>
                                    <span class="input-group-text" id="sourceValueSuffixEdit">%</span>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">
                            <i class="bi bi-plus-lg me-1"></i>Добавить источник
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Область для отображения общих ошибок формы -->
    <div class="mt-3 d-none" role="alert" aria-live="assertive" aria-atomic="true" id="form-errors">
        <div class="alert alert-danger">
            <strong>Ошибка:</strong> <span id="form-error-text"></span>
        </div>
    </div>

    <!-- Индикатор загрузки -->
    <div class="mt-3 text-center d-none" id="form-loading" role="status" aria-live="polite">
        <span class="loading-spinner" aria-hidden="true"></span>
        <span class="visually-hidden">Сохранение изменений…</span>
    </div>
</form>
</div>

<div class="cb-modal__footer">
    <div class="cb-modal__actions cb-modal__actions--full">
        <button type="button" class="cb-modal__btn cb-modal__btn--outline" data-modal-close>
            Отмена
        </button>
        <button type="submit" form="categoryEditFormInner" class="cb-modal__btn cb-modal__btn--primary">
            <i class="bi bi-check-lg me-1"></i>Сохранить
        </button>
    </div>
</div>

<script>
// Initialize immediately when script runs
(function() {
  console.log('[CategoryEdit] Script running');

  // Check if this is the edit form (not add form)
  const form = document.querySelector('form[data-form="category-edit"]');
  if (!form) {
    console.log('[CategoryEdit] Not an edit form, skipping');
    return;
  }

  // Find elements
  const multiSourceSwitch = document.getElementById('multiSourceSwitch');
  const singleSourceFields = document.getElementById('singleSourceFields');
  const multiSourceFields = document.getElementById('multiSourceFields');
  const isMultiSourceHidden = document.getElementById('isMultiSourceHidden');

  console.log('[CategoryEdit] Elements found:', {
    multiSourceSwitch,
    singleSourceFields,
    multiSourceFields,
    isMultiSourceHidden
  });

  // Attach toggle handler directly
  if (multiSourceSwitch) {
    console.log('[CategoryEdit] Attaching click handler to switch');

    multiSourceSwitch.addEventListener('click', function(e) {
      console.log('[CategoryEdit] Switch clicked!', this.checked);

      const isMulti = this.checked;
      const valueInput = document.querySelector('[id^="valueInputEdit"]');

      if (isMulti) {
        console.log('[CategoryEdit] Showing multi-source fields');
        if (singleSourceFields) singleSourceFields.style.display = 'none';
        if (multiSourceFields) multiSourceFields.style.display = 'block';
        if (isMultiSourceHidden) isMultiSourceHidden.value = '1';
        if (valueInput) valueInput.removeAttribute('required');
      } else {
        console.log('[CategoryEdit] Showing single-source fields');
        if (singleSourceFields) singleSourceFields.style.display = 'block';
        if (multiSourceFields) multiSourceFields.style.display = 'none';
        if (isMultiSourceHidden) isMultiSourceHidden.value = '0';
        if (valueInput) valueInput.setAttribute('required', 'required');
      }
    });
  } else {
    console.error('[CategoryEdit] multiSourceSwitch NOT FOUND!');
  }

  // Handle limit type change
  const limitTypeInputs = document.querySelectorAll('input[name="limit_type"]');
  const valueSuffix = document.querySelector('[id^="valueSuffixEdit"]');
  const valueInput = document.querySelector('[id^="valueInputEdit"]');

  if (limitTypeInputs.length > 0 && valueSuffix && valueInput) {
    // Function to update constraints
    function updateConstraints(isPercent) {
      valueSuffix.textContent = isPercent ? '%' : '₽';

      // Update input constraints for percent vs fixed
      if (isPercent) {
        valueInput.setAttribute('max', '100');
        valueInput.setAttribute('step', 'any');
        valueInput.setAttribute('min', '0');
        valueInput.setAttribute('placeholder', '10');
      } else {
        valueInput.setAttribute('max', '999999');
        valueInput.setAttribute('step', '0.01');
        valueInput.setAttribute('min', '0.01');
        valueInput.setAttribute('placeholder', '15000');
      }
    }

    // Initialize on load
    const checkedInput = document.querySelector('input[name="limit_type"]:checked');
    if (checkedInput) {
      updateConstraints(checkedInput.value === 'percent');
    }

    // Listen for changes
    limitTypeInputs.forEach(input => {
      input.addEventListener('change', function() {
        updateConstraints(this.value === 'percent');
      });
    });
  }

  // Handle source type change in add source form
  const sourceTypeSelectEdit = document.getElementById('sourceTypeSelectEdit');
  const sourceValueSuffixEdit = document.getElementById('sourceValueSuffixEdit');

  if (sourceTypeSelectEdit && sourceValueSuffixEdit) {
    sourceTypeSelectEdit.addEventListener('change', function() {
      sourceValueSuffixEdit.textContent = this.value === 'percent' ? '%' : '₽';
    });
  }

  const errBox = form.querySelector('#form-errors');
  const loading = form.querySelector('#form-loading');

  // Note: Add/delete source forms are now handled by category-edit.js module

  // Отмечаем поля как "dirty" после первого ввода/blur
  form.querySelectorAll('input, select, textarea').forEach(el => {
    el.addEventListener('input', () => el.classList.add('dirty'));
    el.addEventListener('blur',  () => el.classList.add('dirty'));
  });

  form.addEventListener('submit', (e) => {
    e.preventDefault();

    if (!form.checkValidity()) {
      e.stopPropagation();
      form.classList.add('was-validated');
      return;
    }

    // Показать лоадер и скрыть ошибку
    loading?.classList.remove('d-none');
    errBox?.classList.add('d-none');

    const formData = new FormData(form);

    fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => {
      if (response.redirected) {
        // Закрыть модалку и перезагрузить страницу для отображения обновленных данных
        const modal = document.querySelector('.cb-modal--show');
        if (modal && window.ModalManager) {
          window.ModalManager.close(modal.id);
        }
        window.location.reload();
      } else {
        return response.json();
      }
    })
    .then(data => {
      if (data && data.success) {
        // Закрыть модалку и перезагрузить страницу
        const modal = document.querySelector('.cb-modal--show');
        if (modal && window.ModalManager) {
          window.ModalManager.close(modal.id);
        }
        window.location.reload();
      } else if (data && data.error) {
        loading?.classList.add('d-none');
        errBox?.classList.remove('d-none');
        const errorText = errBox?.querySelector('#form-error-text');
        if (errorText) errorText.textContent = data.error;
      }
    })
    .catch(error => {
      console.error('Error submitting form:', error);
      loading?.classList.add('d-none');
      errBox?.classList.remove('d-none');
      const errorText = errBox?.querySelector('#form-error-text');
      if (errorText) errorText.textContent = 'Произошла ошибка при сохранении';
    });
  });
})();
</script>