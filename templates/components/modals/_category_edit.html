{#
  Edit Category Modal Partial
  Used for editing existing expense categories
#}
{% from 'components/_modal.html' import form_section, toggle_group %}

<div class="cb-modal__header cb-modal__header--sticky">
  <h5 class="cb-modal__title">
    <i class="bi bi-pencil-square text-primary me-2"></i>{{ category.name }}
  </h5>
  <button type="button" class="cb-modal__close" data-modal-close></button>
</div>

<form method="POST" action="{{ url_for('budget.categories_update', cat_id=category.id) }}" class="cb-modal__form">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <input type="hidden" name="is_multi_source" value="{{ '1' if category.is_multi_source else '0' }}">
  
  <div class="cb-modal__form-body">
    
    {{ form_section('Основное', '
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="mb-3">
            <label class="form-label">Название</label>
            <input type="text" name="name" class="form-control" value="' + category.name + '" required>
          </div>
          
          <div class="mb-3" id="limitTypeField" ' + ('style="display: none;"' if category.is_multi_source else '') + '>
            <label class="form-label">Тип</label>
            ' + toggle_group('limit_type', [
              {'value': 'fixed', 'label': 'Фикс. сумма', 'checked': category.limit_type == 'fixed'},
              {'value': 'percent', 'label': '% от дохода', 'checked': category.limit_type == 'percent'}
            ]) + '
          </div>
        </div>
        
        <div class="col-lg-6">
          <div class="mb-3" id="valueField" ' + ('style="display: none;"' if category.is_multi_source else '') + '>
            <label class="form-label">Значение</label>
            <div class="input-group">
              <input type="number" name="value" step="0.01" min="0.01" class="form-control" 
                     value="' + (category.value|string) + '" ' + ('required' if not category.is_multi_source else 'disabled') + ' id="valueInput">
              <span class="input-group-text" id="valueSuffix">
                ' + ('%' if category.limit_type == 'percent' else '₽') + '
              </span>
            </div>
          </div>
          
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="multiSourceSwitch" 
                     ' + ('checked' if category.is_multi_source else '') + '>
              <label class="form-check-label" for="multiSourceSwitch">
                Несколько источников
              </label>
            </div>
          </div>
        </div>
      </div>
    ') }}
    
    {{ form_section('Источники', '
      <div id="singleSourceField" ' + ('style="display: none;"' if category.is_multi_source else '') + '>
        <div class="mb-3">
          <label class="form-label">Источник дохода</label>
          <select name="source_id" class="form-select" ' + ('disabled' if category.is_multi_source else '') + '>
            <option value="">— Не привязан —</option>
            ' + income_sources_options + '
          </select>
        </div>
      </div>
      
      <div id="multiSourceInfo" ' + ('style="display: none;"' if not category.is_multi_source else '') + '>
        ' + (multi_source_table if category.is_multi_source else '') + '
      </div>
    ') }}
    
  </div>
  
  <div class="cb-modal__footer cb-modal__footer--sticky">
    <div class="cb-modal__actions">
      <button type="button" class="cb-modal__btn cb-modal__btn--outline" data-modal-close>
        Отмена
      </button>
      <button type="submit" class="cb-modal__btn cb-modal__btn--primary">
        <i class="bi bi-check me-1"></i>Сохранить
      </button>
    </div>
  </div>
</form>

<script>
// Edit category modal logic
document.addEventListener('DOMContentLoaded', function() {
  const categoryId = {{ category.id }};
  const limitTypeRadios = document.querySelectorAll('input[name="limit_type"]');
  const valueInput = document.getElementById('valueInput');
  const valueSuffix = document.getElementById('valueSuffix');
  const multiSourceSwitch = document.getElementById('multiSourceSwitch');
  const singleSourceField = document.getElementById('singleSourceField');
  const multiSourceInfo = document.getElementById('multiSourceInfo');
  const limitTypeField = document.getElementById('limitTypeField');
  const valueField = document.getElementById('valueField');
  const hiddenModeField = document.querySelector('input[name="is_multi_source"]');

  // Toggle between fixed/percent
  limitTypeRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      if (valueSuffix) {
        valueSuffix.textContent = this.value === 'percent' ? '%' : '₽';
      }
      if (valueInput) {
        valueInput.placeholder = this.value === 'percent' ? '15.0' : '15000';
        valueInput.step = this.value === 'percent' ? '0.1' : '0.01';
        if (this.value === 'percent') {
          valueInput.setAttribute('max', '100');
        } else {
          valueInput.removeAttribute('max');
        }
      }
    });
  });

  // Toggle multi-source mode
  multiSourceSwitch.addEventListener('change', function() {
    const isMulti = this.checked;
    
    if (isMulti) {
      singleSourceField.style.display = 'none';
      multiSourceInfo.style.display = 'block';
      limitTypeField.style.display = 'none';
      valueField.style.display = 'none';
      
      // Disable validation for hidden fields
      valueInput.removeAttribute('required');
      valueInput.disabled = true;
      document.querySelector('select[name="source_id"]').disabled = true;
    } else {
      singleSourceField.style.display = 'block';
      multiSourceInfo.style.display = 'none';
      limitTypeField.style.display = 'block';
      valueField.style.display = 'block';
      
      // Re-enable validation
      valueInput.setAttribute('required', 'required');
      valueInput.disabled = false;
      document.querySelector('select[name="source_id"]').disabled = false;
    }
    
    // Update hidden field
    if (hiddenModeField) {
      hiddenModeField.value = isMulti ? '1' : '0';
    }
  });
});
</script>