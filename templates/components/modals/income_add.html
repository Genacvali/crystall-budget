<!-- –®–∞–±–ª–æ–Ω –º–æ–¥–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ—Ö–æ–¥–∞ -->
<!-- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è GET /modals/income/add -->

<div class="cb-modal__header">
    <h5 class="cb-modal__title">
        <i class="bi bi-arrow-up-circle me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥
    </h5>
    <button type="button" class="cb-modal__close" data-modal-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">
        <i class="bi bi-x-lg"></i>
    </button>
</div>

<div class="cb-modal__body">
<form method="POST" action="{{ url_for('budget.income') }}"
      data-form="income" role="form" aria-label="–§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ—Ö–æ–¥–∞" novalidate id="incomeFormInner">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    
    <div class="row g-3">
        <div class="col-12 col-md-6">
            <label class="form-label">–î–∞—Ç–∞ <span class="text-danger">*</span></label>
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-calendar-event" aria-hidden="true"></i></span>
                <input type="date" class="form-control" name="date" value="{{ today }}" required>
            </div>
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label">–°—É–º–º–∞ <span class="text-danger">*</span></label>
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-cash-coin" aria-hidden="true"></i></span>
                <input type="text" class="form-control" name="amount" id="amount"
                       inputmode="decimal" placeholder="50000.00"
                       pattern="^\s*\d+([,\.]\d{1,2})?\s*$" required
                       autocomplete="off" tabindex="2">
                <span class="input-group-text">‚ÇΩ</span>
            </div>
            <div class="form-text">–ó–∞–ø—è—Ç–∞—è –∏–ª–∏ —Ç–æ—á–∫–∞, 2 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ. –ù–∞–ø—Ä–∏–º–µ—Ä: 65000,00</div>
        </div>

        <div class="col-12">
            <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Ö–æ–¥–∞ <span class="text-danger">*</span></label>
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-briefcase" aria-hidden="true"></i></span>
                <input type="text" class="form-control" name="source_name" id="source_name"
                       placeholder="üíº –ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞—Ä–ø–ª–∞—Ç–∞, –§—Ä–∏–ª–∞–Ω—Å, –ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞" required
                       tabindex="1" autofocus maxlength="100">
            </div>
            <div class="form-text">–£–∫–∞–∂–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤</div>
        </div>
    </div>
    
    <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±—â–∏—Ö –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º—ã -->
    <div class="mt-3 d-none" role="alert" aria-live="assertive" aria-atomic="true" id="form-errors">
        <div class="alert alert-danger">
            <strong>–û—à–∏–±–∫–∞:</strong> <span id="form-error-text"></span>
        </div>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="mt-3 text-center d-none" id="form-loading" role="status" aria-live="polite">
        <span class="loading-spinner" aria-hidden="true"></span>
        <span class="visually-hidden">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–∞‚Ä¶</span>
    </div>
</form>
</div>

<div class="cb-modal__footer">
    <div class="cb-modal__actions cb-modal__actions--full">
        <button type="button" class="cb-modal__btn cb-modal__btn--outline" data-modal-close>
            –û—Ç–º–µ–Ω–∞
        </button>
        <button type="submit" form="incomeFormInner" class="cb-modal__btn cb-modal__btn--success">
            <i class="bi bi-check-lg me-1"></i>–î–æ–±–∞–≤–∏—Ç—å
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form[data-form="income"]');
  if (!form) return;

  const amount = form.querySelector('input[name="amount"]');
  const sourceInput = form.querySelector('#source_name');
  const errBox = form.querySelector('#form-errors');
  const errText = form.querySelector('#form-error-text');
  const loading = form.querySelector('#form-loading');

  // –æ—Ç–º–µ—á–∞–µ–º –ø–æ–ª—è –∫–∞–∫ "dirty" –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤–≤–æ–¥–∞/blur
  form.querySelectorAll('input, select, textarea').forEach(el => {
    el.addEventListener('input', () => el.classList.add('dirty'));
    el.addEventListener('blur',  () => el.classList.add('dirty'));
  });

  // Auto-focus amount input after source name entry
  if (sourceInput && amount) {
    sourceInput.addEventListener('blur', function() {
      if (this.value.trim()) {
        setTimeout(() => {
          amount.focus();
          amount.select(); // –í—ã–¥–µ–ª–∏—Ç—å –≤–µ—Å—å —Ç–µ–∫—Å—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–º–µ–Ω—ã
        }, 100);
      }
    });
  }

  // –ë—ã—Å—Ç—Ä—ã–µ –∫–ª–∞–≤–∏—à–∏ –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å—É–º–º –¥–æ—Ö–æ–¥–∞
  if (amount) {
    amount.addEventListener('keydown', function(e) {
      // Ctrl+1-5 –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —Å—É–º–º –¥–æ—Ö–æ–¥–∞
      if (e.ctrlKey && e.key >= '1' && e.key <= '5') {
        e.preventDefault();
        const quickAmounts = ['30000', '50000', '75000', '100000', '150000'];
        this.value = quickAmounts[parseInt(e.key) - 1];
        this.focus();
      }
    });
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ .00 –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
    amount.addEventListener('blur', function() {
      if (this.value && /^\d+$/.test(this.value)) {
        this.value = this.value + '.00';
      }
    });
  }

  // –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–æ—Ö–æ–¥–∞
  if (sourceInput) {
    const commonSources = ['–ó–∞—Ä–ø–ª–∞—Ç–∞', '–§—Ä–∏–ª–∞–Ω—Å', '–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞', '–ü—Ä–µ–º–∏—è', '–ü–æ—Å–æ–±–∏–µ', '–î–∏–≤–∏–¥–µ–Ω–¥—ã', '–ê—Ä–µ–Ω–¥–∞', '–ü—Ä–æ–¥–∞–∂–∞'];
    
    sourceInput.addEventListener('input', function() {
      const value = this.value.toLowerCase();
      // –ü—Ä–æ—Å—Ç–∞—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
      for (let source of commonSources) {
        if (source.toLowerCase().startsWith(value) && value.length > 1) {
          // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è, –Ω–æ –ø–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ –µ—Å—Ç—å
          break;
        }
      }
    });
  }

  form.addEventListener('submit', (e) => {
    // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—É–º–º—É
    if (amount && amount.value) {
      const v = amount.value.replace(',', '.').trim();
      if (/^\d+(\.\d{1,2})?$/.test(v)) {
        amount.value = (Math.round(parseFloat(v)*100)/100).toFixed(2);
      }
    }

    if (!form.checkValidity()) {
      e.preventDefault();
      e.stopPropagation();
      form.classList.add('was-validated');
      return;
    }

    // –ø–æ–∫–∞–∑–∞—Ç—å –ª–æ–∞–¥–µ—Ä –∏ —Å–∫—Ä—ã—Ç—å –æ—à–∏–±–∫—É
    loading?.classList.remove('d-none');
    errBox?.classList.add('d-none');
  });
});
</script>