{# expects: budget_data: list[{id, name}], today: 'YYYY-MM-DD' #}
<div class="modal fade" id="expenseModal" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="expenseModalLabel">Добавить расход</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>

      <form id="expenseForm" data-form="expense" autocomplete="off">
        <div class="modal-body">
          <div class="mb-3">
            <label for="expenseAmount" class="form-label">Сумма</label>
            <input
              type="text"
              class="form-control"
              id="expenseAmount"
              name="amount"
              inputmode="decimal"
              pattern="^\s*\d+([,\.]\d{1,2})?\s*$"
              placeholder="Например, 1 250,00"
              required
            >
            <div class="form-text">Запятая или точка — обе подходят. 2 знака после разделителя.</div>
          </div>

          <div class="mb-3">
            <label for="expenseCategory" class="form-label">Категория</label>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="multiCategory">
              <label class="form-check-label" for="multiCategory">
                Разделить между несколькими категориями
              </label>
            </div>
            
            <!-- Одиночная категория -->
            <div id="singleCategoryGroup">
              <select class="form-select" id="expenseCategory" name="category_id" required>
                <option value="">Выберите категорию</option>
                {% for cat in categories %}
                  <option value="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
              </select>
            </div>
            
            <!-- Мультикатегории -->
            <div id="multiCategoryGroup" style="display: none;">
              <div class="mb-2">
                <small class="text-muted">Выберите категории и укажите сумму для каждой:</small>
              </div>
              <div id="categoryList">
                {% for cat in categories %}
                <div class="category-item mb-2" style="display: none;">
                  <div class="row align-items-center">
                    <div class="col-1">
                      <input type="checkbox" class="form-check-input category-checkbox" 
                             value="{{ cat.id }}" 
                             data-category-id="{{ cat.id }}">
                    </div>
                    <div class="col-5">
                      <label class="form-label mb-0">{{ cat.name }}</label>
                    </div>
                    <div class="col-6">
                      <input type="text" 
                             class="form-control category-amount" 
                             id="amount_{{ cat.id }}" 
                             name="amounts[{{ cat.id }}]"
                             placeholder="0,00" 
                             disabled
                             inputmode="decimal"
                             pattern="^\s*\d+([,\.]\d{1,2})?\s*$">
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              <div class="mt-2">
                <small class="text-muted">Остаток: <span id="remainingAmount">0,00</span> ₽</small>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="expenseDate" class="form-label">Дата</label>
            <input
              type="date"
              class="form-control"
              id="expenseDate"
              name="date"
              value="{{ today }}"
              required
            >
          </div>

          <div class="mb-3">
            <label for="expenseNote" class="form-label">Примечание</label>
            <input type="text" class="form-control" id="expenseNote" name="note" maxlength="500" placeholder="Необязательно">
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-danger" data-loading-text="Сохраняем…">Сохранить</button>
        </div>
      </form>
    </div>
  </div>
</div>
