<div class="collapse mb-3" id="addExpenseForm" role="region" aria-labelledby="addExpenseButton">
    <div class="ff-progress-card">
        <form method="POST" action="{{ url_for('budget.expenses', month=month_data.month if month_data else None) }}" 
              data-form="expense" role="form" aria-label="Форма добавления расхода" novalidate>
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="row g-2 g-md-3 align-items-end">
                <div class="col-6 col-md-3">
                    <label for="date" class="form-label">Дата <span aria-hidden="true">*</span></label>
                    <input type="date" id="date" name="date" value="{{ today }}" 
                           class="form-control" required 
                           aria-describedby="date-help" 
                           aria-invalid="false">
                    <div id="date-help" class="visually-hidden">Выберите дату расхода</div>
                    <div class="invalid-feedback" role="alert" aria-live="polite"></div>
                </div>
                <div class="col-6 col-md-2">
                    <label for="amount" class="form-label">Сумма <span aria-hidden="true">*</span></label>
                    <input type="number" id="amount" name="amount" step="0.01" min="0.01"
                           inputmode="decimal" class="form-control" required
                           aria-describedby="amount-help"
                           aria-invalid="false"
                           placeholder="0.00">
                    <div id="amount-help" class="visually-hidden">Введите сумму расхода в рублях</div>
                    <div class="invalid-feedback" role="alert" aria-live="polite"></div>
                </div>
                <div class="col-12 col-md-3">
                    <label for="category_id" class="form-label">Категория <span aria-hidden="true">*</span></label>
                    <select id="category_id" name="category_id" class="form-select" required
                            aria-describedby="category-help"
                            aria-invalid="false">
                        <option value="">Выберите категорию</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                    <div id="category-help" class="visually-hidden">Выберите категорию для классификации расхода</div>
                    <div class="invalid-feedback" role="alert" aria-live="polite"></div>
                </div>
                <div class="col-12 col-md-3">
                    <label for="note" class="form-label">Комментарий</label>
                    <input type="text" id="note" name="note" class="form-control" 
                           placeholder="Необязательно"
                           aria-describedby="note-help"
                           aria-invalid="false"
                           maxlength="255">
                    <div id="note-help" class="visually-hidden">Дополнительное описание расхода (необязательно)</div>
                </div>
                <div class="col-12 col-md-auto d-grid btn-col">
                    <label class="form-label d-none d-md-block" aria-hidden="true">&nbsp;</label>
                    <button type="submit" class="btn btn-primary" 
                            aria-describedby="submit-help">
                        <i class="bi bi-plus-lg me-1" aria-hidden="true"></i>
                        <span>Добавить</span>
                        <span class="visually-hidden">расход</span>
                    </button>
                    <div id="submit-help" class="visually-hidden">Нажмите для сохранения расхода</div>
                </div>
            </div>
            
            <!-- Область для отображения общих ошибок формы -->
            <div class="mt-3" role="alert" aria-live="assertive" aria-atomic="true" id="form-errors" style="display: none;">
                <div class="alert alert-danger">
                    <strong>Ошибка:</strong> <span id="form-error-text"></span>
                </div>
            </div>
            
            <!-- Индикатор загрузки -->
            <div class="mt-2 text-center" id="form-loading" style="display: none;" role="status" aria-live="polite">
                <span class="loading-spinner" aria-hidden="true"></span>
                <span class="visually-hidden">Сохранение расхода...</span>
            </div>
        </form>
    </div>
</div>