{# templates/components/_nav.html - ЕДИНЫЙ ИСТОЧНИК НАВИГАЦИИ #}
{% set ep = request.endpoint %}

<header class="cb-nav navbar navbar-expand-lg" role="banner" aria-label="Главная навигация">
  <div class="container-xl d-flex align-items-center cb-nav-inner">
    {# БРЕНД - order-1 #}
    <a href="{{ url_for('budget.dashboard') }}" class="navbar-brand d-flex align-items-center gap-2 order-1" aria-label="CrystalBudget — на главную">
      <span class="ff-gem" aria-hidden="true"></span>
      <span class="ff-logo fw-bold">CrystalBudget</span>
    </a>

    {# ДЕСКТОПНАЯ НАВИГАЦИЯ - order-2, скрыта на мобилке #}
    <nav class="d-none d-lg-flex ff-tabs-wrap order-2" role="navigation" aria-label="Основная навигация">
      <ul class="ff-tabs nav nav-pills p-1">
        <li class="nav-item">
          <a class="ff-pill nav-link {{ 'is-active' if ep=='budget.dashboard' else '' }}" 
             href="{{ url_for('budget.dashboard') }}" 
             {{ 'aria-current="page"' if ep=='budget.dashboard' else '' }}>
            <i class="bi bi-house-door" aria-hidden="true"></i>Дашборд
          </a>
        </li>
        <li class="nav-item">
          <a class="ff-pill nav-link {{ 'is-active' if ep=='budget.expenses' else '' }}" 
             href="{{ url_for('budget.expenses') }}"
             {{ 'aria-current="page"' if ep=='budget.expenses' else '' }}>
            <i class="bi bi-wallet2" aria-hidden="true"></i>Расходы
          </a>
        </li>
        <li class="nav-item">
          <a class="ff-pill nav-link {{ 'is-active' if ep=='budget.categories' else '' }}" 
             href="{{ url_for('budget.categories') }}"
             {{ 'aria-current="page"' if ep=='budget.categories' else '' }}>
            <i class="bi bi-tags" aria-hidden="true"></i>Категории
          </a>
        </li>
        <li class="nav-item">
          <a class="ff-pill nav-link {{ 'is-active' if ep=='budget.income' else '' }}" 
             href="{{ url_for('budget.income') }}"
             {{ 'aria-current="page"' if ep=='budget.income' else '' }}>
            <i class="bi bi-graph-up-arrow" aria-hidden="true"></i>Доходы
          </a>
        </li>
      </ul>
    </nav>

    {# ПРАВЫЙ БЛОК - order-3 ms-auto (справа) #}
    <div class="d-flex align-items-center gap-2 order-3 ms-auto">
      {# МОБИЛЬНАЯ КНОПКА МЕНЮ - только на мобилке #}
      <button class="btn cb-btn btn-outline-secondary d-lg-none px-3" id="navToggle"
              type="button" aria-label="Открыть меню" aria-controls="mobileDrawer" aria-expanded="false">
        <i class="bi bi-list" aria-hidden="true"></i>
      </button>
      
      {# КАЛЕНДАРЬ - месяц и год (скрыт на мобилке) #}
      <div class="ff-month-picker d-none d-md-inline-flex" id="monthPicker">
        <button type="button" class="ff-month-btn" aria-label="Выбрать месяц и год">
          <i class="bi bi-calendar3" aria-hidden="true"></i>
          <span id="currentMonthLabel">{{ current_month.month_name if current_month else 'Декабрь 2024' }}</span>
          <i class="bi bi-chevron-down" aria-hidden="true"></i>
        </button>
      </div>
      
      <!-- Переключатель темы скрыт на мобилке, показывается от md -->
      <label class="ff-switch mb-0 d-none d-md-inline-flex" aria-label="Переключить тему" role="switch" aria-checked="{{ 'true' if session.get('theme') == 'dark' else 'false' }}">
        <input type="checkbox" id="themeToggle" class="visually-hidden" {{ 'checked' if session.get('theme') == 'dark' else '' }}/>
        <span class="ff-track d-inline-flex align-items-center justify-content-between">
          <i class="bi bi-sun-fill" aria-hidden="true"></i>
          <i class="bi bi-moon-stars-fill" aria-hidden="true"></i>
          <span class="ff-thumb" aria-hidden="true"></span>
        </span>
      </label>

      {% if session.user_id %}
      <div class="dropdown">
        <button class="ff-pill ff-user d-none d-sm-inline-flex" aria-label="Открыть меню профиля" role="button" 
                data-bs-toggle="dropdown" aria-expanded="false" id="userDropdown">
          <i class="bi bi-person-circle" aria-hidden="true"></i>
          <span class="d-none d-xl-inline">{{ session.user_name or 'Пользователь' }}</span>
          <i class="bi bi-caret-down-fill ms-1" aria-hidden="true"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow-soft" aria-labelledby="userDropdown">
          <li><a class="dropdown-item" href="{{ url_for('auth.profile') }}">
            <i class="bi bi-person me-2" aria-hidden="true"></i>Профиль
          </a></li>
          <li><a class="dropdown-item" href="{{ url_for('auth.settings') }}">
            <i class="bi bi-gear me-2" aria-hidden="true"></i>Настройки
          </a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">
            <i class="bi bi-box-arrow-right me-2" aria-hidden="true"></i>Выйти
          </a></li>
        </ul>
      </div>
      {% endif %}
    </div>
  </div>
</header>

<!-- МОБИЛЬНЫЙ ДРОВЕР ВЫНЕСЕН ИЗ HEADER для избежания наследования стилей -->
<div id="mobileDrawer" class="offcanvas-backdrop" hidden></div>
<aside class="offcanvas-panel" role="dialog" aria-modal="true" aria-label="Меню" hidden>
    <div class="p-3 d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <span class="ff-gem" aria-hidden="true"></span>
        <span class="fw-bold">CrystalBudget</span>
      </div>
      <button class="btn cb-btn btn-outline-secondary" id="navClose" aria-label="Закрыть меню">
        <i class="bi bi-x-lg" aria-hidden="true"></i>
      </button>
    </div>
    <nav class="px-2 pb-3" role="navigation">
      <a class="list-group-item list-group-item-action py-3 {{ 'active' if ep == 'budget.dashboard' else '' }}" 
         href="{{ url_for('budget.dashboard') }}"
         {{ 'aria-current="page"' if ep == 'budget.dashboard' else '' }}>
        <i class="bi bi-house-door me-2" aria-hidden="true"></i>Дашборд
      </a>
      <a class="list-group-item list-group-item-action py-3 {{ 'active' if ep == 'budget.expenses' else '' }}" 
         href="{{ url_for('budget.expenses') }}"
         {{ 'aria-current="page"' if ep == 'budget.expenses' else '' }}>
        <i class="bi bi-wallet2 me-2" aria-hidden="true"></i>Расходы
      </a>
      <a class="list-group-item list-group-item-action py-3 {{ 'active' if ep == 'budget.categories' else '' }}" 
         href="{{ url_for('budget.categories') }}"
         {{ 'aria-current="page"' if ep == 'budget.categories' else '' }}>
        <i class="bi bi-tags me-2" aria-hidden="true"></i>Категории
      </a>
      <a class="list-group-item list-group-item-action py-3 {{ 'active' if ep == 'budget.income' else '' }}" 
         href="{{ url_for('budget.income') }}"
         {{ 'aria-current="page"' if ep == 'budget.income' else '' }}>
        <i class="bi bi-graph-up-arrow me-2" aria-hidden="true"></i>Доходы
      </a>
    </nav>

    {# Календарь в мобильном меню #}
    <div class="px-3 py-2 d-flex d-md-none border-top">
      <div class="d-flex align-items-center w-100">
        <span class="me-3">
          <i class="bi bi-calendar3 me-2" aria-hidden="true"></i>Период
        </span>
        <div class="ms-auto">
          <button type="button" class="ff-month-btn" id="mobileMonthPicker" aria-label="Выбрать месяц и год">
            <span id="mobileMonthLabel">{{ current_month.month_name if current_month else 'Декабрь 2024' }}</span>
            <i class="bi bi-chevron-down" aria-hidden="true"></i>
          </button>
        </div>
      </div>
    </div>

    {# Переключатель темы в мобильном меню #}
    <div class="px-3 py-2 d-flex d-md-none border-top">
      <label class="ff-switch mb-0 d-flex align-items-center w-100" aria-label="Переключить тему" role="switch" aria-checked="{{ 'true' if session.get('theme') == 'dark' else 'false' }}">
        <span class="me-3">
          <i class="bi bi-palette me-2" aria-hidden="true"></i>Тема
        </span>
        <div class="ms-auto">
          <input type="checkbox" id="themeToggleMobile" class="visually-hidden" {{ 'checked' if session.get('theme') == 'dark' else '' }}/>
          <span class="ff-track d-inline-flex align-items-center justify-content-between">
            <i class="bi bi-sun-fill" aria-hidden="true"></i>
            <i class="bi bi-moon-stars-fill" aria-hidden="true"></i>
            <span class="ff-thumb" aria-hidden="true"></span>
          </span>
        </div>
      </label>
    </div>

    {% if session.user_id %}
    <div class="border-top p-3">
      <div class="d-flex align-items-center gap-2 mb-3">
        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
             style="width: 40px; height: 40px;">
          {% if session.user_name %}
            {{ session.user_name[0].upper() }}
          {% else %}
            ?
          {% endif %}
        </div>
        <div>
          <div class="fw-semibold">{{ session.user_name or 'Пользователь' }}</div>
          <div class="small text-muted">Личный аккаунт</div>
        </div>
      </div>
      <a class="btn btn-outline-secondary w-100" href="{{ url_for('auth.logout') }}">
        <i class="bi bi-box-arrow-right me-2" aria-hidden="true"></i>Выйти
      </a>
    </div>
    {% endif %}
  </aside>