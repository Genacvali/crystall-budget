{% extends "base.html" %}
{% block title %}üìä –î–∞—à–±–æ—Ä–¥ ‚Äî CrystalBudget{% endblock %}

{% block content %}
<style>
/* –æ–±—â–∏–π */
select.form-select,.form-modern{position:relative;overflow:hidden;z-index:1}
select.form-select option,.form-modern option{position:relative;z-index:9999}

/* —à–∞–ø–∫–∞ */
.header-row{row-gap:.5rem}

/* quickbar */
.quickbar{border:1px solid var(--bs-border-color);border-radius:12px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.03)}
.q-input{position:relative}
.q-input .bi{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.6;pointer-events:none}
.q-input input.form-control,.q-input select.form-select{padding-left:2rem;height:44px}
.btn-add{height:44px;display:inline-flex;align-items:center;gap:.5rem;justify-content:center}
.btn-col{min-width:170px}           /* –Ω–µ –¥–∞—ë–º –∫–Ω–æ–ø–∫–µ —Å—ä–µ—Ö–∞—Ç—å */
</style>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
<div class="row align-items-center justify-content-between header-row mb-4">
  <div class="col-auto">
    <h1 class="m-0 d-flex align-items-center gap-2">
      <i class="bi bi-speedometer2"></i> –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∞—à–±–æ—Ä–¥
    </h1>
  </div>

  <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –º–µ—Å—è—Ü–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –ø–∏–∫–µ—Ä) -->
  <div class="col-auto">
    <form method="get" class="d-flex align-items-center gap-2 flex-wrap">
      <div class="input-group input-group-sm" style="max-width: 190px;">
        <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
        <input type="month" name="month" value="{{ current_month }}" class="form-control">
      </div>
      <button class="btn btn-outline-primary btn-sm">–ü–æ–∫–∞–∑–∞—Ç—å</button>
    </form>
  </div>
</div>

<!-- –ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ -->
<div class="quickbar p-3 mb-4">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="fw-semibold text-primary d-flex align-items-center gap-2">
      <i class="bi bi-lightning-charge-fill"></i> –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞
    </div>
  </div>

  <form id="quick-expense-form" method="POST" action="/quick-expense">
    <input type="hidden" name="return_month" value="{{ current_month }}">
    <div class="row g-2 align-items-stretch">
      <!-- –¥–∞—Ç–∞ -->
      <div class="col-12 col-md-3 q-input">
        <i class="bi bi-calendar3"></i>
        <input type="date" name="date" id="qe-date" value="{{ today }}" class="form-control" required>
      </div>
      <!-- –∫–∞—Ç–µ–≥–æ—Ä–∏—è -->
      <div class="col-12 col-md-4 q-input">
        <i class="bi bi-tag"></i>
        <select name="category_id" id="qe-category" class="form-select" required>
          <option value="">–ö–∞—Ç–µ–≥–æ—Ä–∏—è‚Ä¶</option>
          {% for cat in categories %}
            <option value="{{ cat.id }}">{{ cat.name }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- —Å—É–º–º–∞ -->
      <div class="col-6 col-md-2 q-input">
        <i class="bi bi-123"></i>
        <input type="number" name="amount" id="qe-amount" step="0.01" min="0.01" placeholder="0.00"
               inputmode="decimal" class="form-control" required>
      </div>
      <!-- –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
      <div class="col-6 col-md-2 q-input">
        <i class="bi bi-chat-dots"></i>
        <input type="text" name="note" id="qe-note" class="form-control" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
      </div>
      <!-- –∫–Ω–æ–ø–∫–∞ -->
      <div class="col-12 col-md-1 btn-col d-grid">
        <button type="submit" id="qe-submit" class="btn btn-success btn-add" disabled>
          <i class="bi bi-plus-lg"></i><span class="d-none d-md-inline">–î–æ–±–∞–≤–∏—Ç—å</span>
        </button>
      </div>
    </div>
  </form>
</div>

{# ‚Ä¶–¥–∞–ª—å—à–µ –æ—Å—Ç–∞–≤—å –±–ª–æ–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ —Ç–∞–±–ª–∏—Ü—É –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏‚Ä¶ #}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const f = document.getElementById('quick-expense-form');
  const dateEl = document.getElementById('qe-date');
  const catEl  = document.getElementById('qe-category');
  const amtEl  = document.getElementById('qe-amount');
  const noteEl = document.getElementById('qe-note');
  const btn    = document.getElementById('qe-submit');

  if (dateEl && !dateEl.value) { const d=new Date(); dateEl.value=d.toISOString().slice(0,10); }

  // –§–æ–∫—É—Å –≤ —Å—É–º–º—É –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  if (catEl && amtEl) catEl.addEventListener('change', () => { if (catEl.value) setTimeout(()=>amtEl.focus(),50); });

  // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
  function validate(){
    const ok = !!(dateEl.value && catEl.value && parseFloat(amtEl.value) > 0);
    btn.disabled = !ok;
  }
  ['input','change'].forEach(ev=>{
    dateEl.addEventListener(ev,validate);
    catEl.addEventListener(ev,validate);
    amtEl.addEventListener(ev,validate);
  });
  validate();

  // Enter –≤ —Å—É–º–º–µ/–∫–æ–º–º–µ–Ω—Ç–µ ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞
  [amtEl, noteEl].forEach(el=>{
    el.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); if(!btn.disabled) f.requestSubmit(); }});
  });

  // –∑–∞–ø—Ä–µ—Ç –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∫–æ–ª—ë—Å–∏–∫–æ–º –Ω–∞ number
  if (amtEl) amtEl.addEventListener('wheel',(e)=>{ e.preventDefault(); },{passive:false});
});
</script>
{% endblock %}