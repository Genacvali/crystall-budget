{# templates/dashboard.html #}
{% extends "base.html" %}

{% block title %}Панель управления{% endblock %}

{% block head %}
  {# единый css страницы (в нём есть .pill и всё остальное) #}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}?v=20250921-3">
{% endblock %}

{% block content %}

  {# === Панель баланса (hero) === #}
  {% include "components/_balance_panel.html" %}

  {# === Прогресс по категориям === #}
  {% include "components/_progress_bars.html" %}

  {# === Календарь === #}
  <section class="card-soft mb-4">
    <div class="p-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h5 class="m-0"><i class="bi bi-calendar3 me-2"></i>Календарь</h5>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-secondary" id="calPrev" aria-label="Предыдущий месяц"><i class="bi bi-chevron-left"></i></button>
          <strong id="calTitle" class="mx-2"></strong>
          <button class="btn btn-sm btn-outline-secondary" id="calNext" aria-label="Следующий месяц"><i class="bi bi-chevron-right"></i></button>
        </div>
      </div>
      <div id="miniCalendar"></div>
    </div>
  </section>

  {# === Остальное содержимое дашборда — ваши карточки/таблицы/виджеты ниже === #}
  {# {% include "components/_recent_transactions.html" %} #}
  {# {% include "components/_sources_card.html" %} #}
  {# {% include "components/_goals_widget.html" %} #}

  <!-- Модал добавления расхода -->
  <div class="modal fade" id="expenseModal" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="expenseModalLabel">Добавить расход</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="expenseForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="expenseAmount" class="form-label">Сумма</label>
              <input type="number" class="form-control" id="expenseAmount" name="amount" step="0.01" required>
            </div>
            <div class="mb-3">
              <label for="expenseCategory" class="form-label">Категория</label>
              <select class="form-select" id="expenseCategory" name="category_id" required>
                {% for cat in budget_data %}
                  <option value="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="expenseDate" class="form-label">Дата</label>
              <input type="date" class="form-control" id="expenseDate" name="date" value="{{ today }}" required>
            </div>
            <div class="mb-3">
              <label for="expenseNote" class="form-label">Примечание</label>
              <input type="text" class="form-control" id="expenseNote" name="note" maxlength="500">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-primary">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Модал добавления дохода -->
  <div class="modal fade" id="incomeModal" tabindex="-1" aria-labelledby="incomeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="incomeModalLabel">Добавить доход</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="incomeForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="incomeAmount" class="form-label">Сумма</label>
              <input type="number" class="form-control" id="incomeAmount" name="amount" step="0.01" required>
            </div>
            <div class="mb-3">
              <label for="incomeSource" class="form-label">Источник</label>
              <select class="form-select" id="incomeSource" name="source_id" required>
                <option value="">Выберите источник</option>
                <option value="1">Зарплата</option>
                <option value="2">Фриланс</option>
                <option value="3">Другое</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="incomeDate" class="form-label">Дата</label>
              <input type="date" class="form-control" id="incomeDate" name="date" value="{{ today }}" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-primary">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Модал редактирования категории -->
  <div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="categoryModalLabel">Редактировать категорию</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
        </div>
        <form id="categoryForm">
          <input type="hidden" name="id" id="catId">
          <div class="modal-body">
            <div class="mb-3">
              <label for="catName" class="form-label">Название</label>
              <input type="text" class="form-control" id="catName" name="name" required maxlength="100">
            </div>
            <div class="mb-3">
              <label for="catLimitType" class="form-label">Тип лимита</label>
              <select class="form-select" id="catLimitType" name="limit_type">
                <option value="fixed">Фиксированная сумма</option>
                <option value="percent">Процент от дохода</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="catValue" class="form-label">Значение</label>
              <input type="number" step="0.01" class="form-control" id="catValue" name="value" required>
              <div class="form-text">Для «Процент» укажи 0–100, для «Фикс» — сумму в ₽.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Отмена</button>
            <button class="btn btn-primary" type="submit">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
<script>
// === Календарь месяцев для фильтрации данных ===
document.addEventListener('DOMContentLoaded', function() {
  const calTitle = document.getElementById('calTitle');
  const calPrev = document.getElementById('calPrev');
  const calNext = document.getElementById('calNext');
  const miniCalendar = document.getElementById('miniCalendar');
  
  if (!calTitle || !calPrev || !calNext || !miniCalendar) return;
  
  // Получаем текущий месяц из URL или используем текущий
  const urlParams = new URLSearchParams(window.location.search);
  let currentMonth = urlParams.get('month') || '{{ month }}' || new Date().toISOString().slice(0, 7);
  
  const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                     'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
  
  function updateCalendar() {
    const [year, month] = currentMonth.split('-').map(n => parseInt(n));
    const monthName = monthNames[month - 1];
    calTitle.textContent = `${monthName} ${year}`;
    
    // Очищаем календарь
    miniCalendar.innerHTML = '';
    
    // Создаем простую сетку дней месяца
    const daysInMonth = new Date(year, month, 0).getDate();
    const firstDayOfWeek = (new Date(year, month - 1, 1).getDay() + 6) % 7; // Понедельник = 0
    
    // Заголовки дней недели
    const dayHeaders = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
    const headerRow = document.createElement('div');
    headerRow.className = 'calendar-header d-flex';
    dayHeaders.forEach(day => {
      const cell = document.createElement('div');
      cell.className = 'calendar-day-header text-center p-1 flex-fill text-muted small';
      cell.textContent = day;
      headerRow.appendChild(cell);
    });
    miniCalendar.appendChild(headerRow);
    
    // Дни месяца
    const calendarGrid = document.createElement('div');
    calendarGrid.className = 'calendar-grid';
    calendarGrid.style.cssText = 'display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;';
    
    // Пустые ячейки для выравнивания первого дня
    for (let i = 0; i < firstDayOfWeek; i++) {
      const emptyCell = document.createElement('div');
      emptyCell.className = 'calendar-day-empty p-2';
      calendarGrid.appendChild(emptyCell);
    }
    
    // Дни месяца
    const today = new Date();
    const isCurrentMonth = today.getFullYear() === year && today.getMonth() + 1 === month;
    const todayDate = today.getDate();
    
    for (let day = 1; day <= daysInMonth; day++) {
      const dayCell = document.createElement('div');
      dayCell.className = 'calendar-day text-center p-2 cursor-pointer rounded';
      dayCell.textContent = day;
      dayCell.style.cssText = 'min-height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s;';
      
      if (isCurrentMonth && day === todayDate) {
        dayCell.classList.add('bg-primary', 'text-white');
      } else {
        dayCell.classList.add('hover-bg-light');
        dayCell.addEventListener('mouseenter', () => dayCell.style.backgroundColor = 'var(--bs-light)');
        dayCell.addEventListener('mouseleave', () => dayCell.style.backgroundColor = '');
      }
      
      dayCell.addEventListener('click', () => {
        // При клике на день просто перезагружаем страницу с выбранным месяцем
        updateMonthFilter(currentMonth);
      });
      
      calendarGrid.appendChild(dayCell);
    }
    
    miniCalendar.appendChild(calendarGrid);
  }
  
  function updateMonthFilter(month) {
    const url = new URL(window.location);
    url.searchParams.set('month', month);
    window.location.href = url.toString();
  }
  
  function changeMonth(direction) {
    const [year, month] = currentMonth.split('-').map(n => parseInt(n));
    let newYear = year;
    let newMonth = month + direction;
    
    if (newMonth > 12) {
      newMonth = 1;
      newYear++;
    } else if (newMonth < 1) {
      newMonth = 12;
      newYear--;
    }
    
    currentMonth = `${newYear}-${newMonth.toString().padStart(2, '0')}`;
    updateCalendar();
  }
  
  // События для кнопок навигации
  calPrev.addEventListener('click', () => {
    changeMonth(-1);
    updateMonthFilter(currentMonth);
  });
  
  calNext.addEventListener('click', () => {
    changeMonth(1);
    updateMonthFilter(currentMonth);
  });
  
  // Инициализация
  updateCalendar();
});

// Функция для показа уведомлений
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `alert alert-${type} position-fixed`;
  toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}

// Интеграция форм с офлайн API
document.getElementById('expenseForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const payload = {
    amount: Number(form.amount.value),
    category_id: form.category_id.value,
    date: form.date.value,
    note: form.note.value
  };
  
  try {
    const response = await fetch('/api/expenses', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
    });
    
    if (response.ok) {
      showToast('Расход успешно добавлен', 'success');
      
      // Закрыть модал
      const modal = bootstrap.Modal.getInstance(document.getElementById('expenseModal'));
      if (modal) modal.hide();
      
      // Очистить форму
      form.reset();
      form.date.value = '{{ today }}';
      
      // Обновить страницу
      setTimeout(() => location.reload(), 1000);
    } else {
      throw new Error('Ошибка сервера');
    }
  } catch (error) {
    console.error('Error adding expense:', error);
    showToast('Ошибка при добавлении расхода', 'danger');
  }
});

document.getElementById('incomeForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const payload = {
    amount: Number(form.amount.value),
    source_id: form.source_id.value,
    date: form.date.value
  };
  
  try {
    const response = await fetch('/api/income', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
    });
    
    if (response.ok) {
      showToast('Доход успешно добавлен', 'success');
      
      // Закрыть модал
      const modal = bootstrap.Modal.getInstance(document.getElementById('incomeModal'));
      if (modal) modal.hide();
      
      // Очистить форму
      form.reset();
      form.date.value = '{{ today }}';
      
      // Обновить страницу
      setTimeout(() => location.reload(), 1000);
    } else {
      throw new Error('Ошибка сервера');
    }
  } catch (error) {
    console.error('Error adding income:', error);
    showToast('Ошибка при добавлении дохода', 'danger');
  }
});

// Редактирование категорий в модальном окне
(function(){
  const list = document.getElementById('catList');
  if (!list) return;

  const modalEl = document.getElementById('categoryModal');
  const modal = modalEl ? new bootstrap.Modal(modalEl) : null;
  const form = document.getElementById('categoryForm');

  // Открыть модал по клику «карандаш»
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-action="edit"][data-id]');
    if (!btn) return;

    const id = btn.dataset.id;
    const card = list.querySelector(`article.cat [data-id="${id}"]`)?.closest('article.cat')
              || btn.closest('article.cat');
    if (!card) return;

    // Берём данные из data-атрибутов
    document.getElementById('catId').value = id;
    document.getElementById('catName').value = card.dataset.name || '';
    // если нет явного типа — считаем «fixed»
    document.getElementById('catLimitType').value = card.dataset.limitType || 'fixed';
    document.getElementById('catValue').value = Number(card.dataset.limit || 0);

    modal?.show();
  });

  // Сохранение
  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    const payload = {
      name: (fd.get('name')+'').trim(),
      limit_type: fd.get('limit_type') || 'fixed',
      value: Number(fd.get('value')||0)
    };
    const id = Number(fd.get('id'));

    try{
      const res = await CBOffline.apiSend('PATCH', `/api/categories/${id}`, payload);
      if (res?.queued) {
        showToast('Категория сохранена (офлайн, синхронизируется при сети)', 'warning');
      } else {
        showToast('Категория обновлена', 'success');
      }

      // Обновляем DOM «на лету»
      const card = list.querySelector(`article.cat [data-id="${id}"]`)?.closest('article.cat');
      if (card) {
        card.dataset.name = payload.name;
        card.dataset.limit = String(payload.value);
        card.dataset.limitType = payload.limit_type;

        card.querySelector('.cat-title')?.replaceChildren(document.createTextNode(payload.name));

        // подпись под названием
        const meta = card.querySelector('.cat-meta');
        if (meta) {
          meta.textContent = (payload.limit_type === 'percent'
            ? `Процент ${payload.value.toFixed(2)}%`
            : `Фикс ${payload.value.toFixed(2)} ₽`);
        }

        // правая колонка «/ лимит»
        const limitSpan = card.querySelector('.cat-right .muted.mono');
        if (limitSpan) limitSpan.textContent = `${payload.value.toFixed(2)} ₽`;
      }

      modal?.hide();
    } catch(err){
      console.error(err);
      showToast('Ошибка при сохранении категории', 'danger');
    }
  });

})();

// Обработка удаления категорий
document.addEventListener('DOMContentLoaded', function() {
  document.addEventListener('click', async function(e) {
    if (e.target.matches('[data-action="delete"]') || e.target.closest('[data-action="delete"]')) {
      const btn = e.target.matches('[data-action="delete"]') ? e.target : e.target.closest('[data-action="delete"]');
      const catId = btn.dataset.id;
      
      console.log('Delete button clicked, category ID:', catId); // Для отладки
      
      if (!confirm('Удалить эту категорию? Все связанные расходы также будут удалены.')) {
        return;
      }
      
      try {
        // Получаем CSRF токен из мета-тега
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        const response = await fetch(`/categories/delete/${catId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `csrf_token=${encodeURIComponent(csrfToken)}`
        });
        
        if (response.ok) {
          showToast('Категория успешно удалена', 'success');
          // Перезагружаем страницу
          setTimeout(() => location.reload(), 1000);
        } else {
          throw new Error('Ошибка сервера');
        }
      } catch (error) {
        console.error('Error:', error);
        showToast('Ошибка при удалении категории', 'danger');
      }
    }
  });
});
</script>
<script defer src="{{ url_for('static', filename='js/dashboard-cats.js') }}"></script>
{% endblock %}
