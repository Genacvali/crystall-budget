{% extends "base.html" %}
{% block title %}üìä –î–∞—à–±–æ—Ä–¥ ‚Äî CrystalBudget{% endblock %}

{% block content %}
<style>
/* —Å–µ–ª–µ–∫—Ç—ã –Ω–µ –∫–ª–∏–ø—É—é—Ç—Å—è */
select.form-select,.form-modern{position:relative;overflow:hidden;z-index:1}
select.form-select option,.form-modern option{position:relative;z-index:9999}

/* –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
.header-row{row-gap:.5rem}

/* –∫–Ω–æ–ø–∫–∞ –ø–∏–∫–µ—Ä–∞ –º–µ—Å—è—Ü–∞ */
#month-btn{cursor:pointer}
#month-btn i{pointer-events:none}

/* QUICKBAR */
.quickbar{border:1px solid var(--bs-border-color);border-radius:12px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.03)}
.q-input{position:relative}
.q-input .bi{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.6}
.q-input input.form-control,.q-input select.form-select{padding-left:2rem;height:44px}
.btn-add{height:44px;display:inline-flex;align-items:center;gap:.5rem;justify-content:center}
.btn-col{min-width:170px}

/* –∫–∞—Ä—Ç–æ—á–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ */
.source-card .k{color:#6c757d}
.source-card .v{font-weight:600}

/* —Ç–∞–±–ª–∏—Ü–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (—Å–ø–∏—Å–æ–∫) */
.table-modern{width:100%;border-collapse:separate;border-spacing:0 8px}
.table-modern thead th{font-weight:600;color:#6c757d;border:0;padding:.25rem .75rem}
.table-modern tbody tr{background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04);border-radius:10px}
.table-modern tbody td{border:0;padding:.75rem .75rem;vertical-align:middle}
.table-modern .cell-title{font-weight:700}
.table-modern .progress{height:8px;background:#eef1f4}
.table-modern .progress-bar{transition:width .3s ease}
.badge-soft{border-radius:999px;padding:.35rem .6rem;font-weight:600}
.badge-soft-success{background:#e8f6ee;color:#198754}
.badge-soft-warning{background:#fff3cd;color:#b58100}
.badge-soft-danger{background:#fde2e2;color:#c03a3a}
.currency{white-space:nowrap}
</style>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
<div class="row align-items-center justify-content-between header-row mb-4">
  <div class="col-auto">
    <h1 class="m-0 d-flex align-items-center gap-2">
      <i class="bi bi-speedometer2"></i> –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∞—à–±–æ—Ä–¥
    </h1>
  </div>
  <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –º–µ—Å—è—Ü–∞ –∏ –¥–∞—Ç–∞ -->
  <div class="col-12 col-md-auto">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <!-- –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∏ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ -->
      <div class="text-center">
        <div class="fw-bold text-primary" id="current-date-display"></div>
        <small class="text-muted" id="current-day-display"></small>
      </div>
      
      <div class="d-flex align-items-center gap-2">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º -->
        <div class="btn-group" role="group">
          <a href="?month={{ prev_month }}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-chevron-left"></i>
          </a>
          <span class="btn btn-outline-primary btn-sm disabled d-none d-sm-inline" style="min-width: 120px;">
            {{ current_month_name }}
          </span>
          <span class="btn btn-outline-primary btn-sm disabled d-sm-none" style="min-width: 80px;">
            {{ current_month_name.split()[0][:3] }}
          </span>
          <a href="?month={{ next_month }}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-chevron-right"></i>
          </a>
        </div>
        
        <!-- –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä -->
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-calendar3 d-md-none"></i>
            <span class="d-none d-md-inline"><i class="bi bi-calendar3"></i> –í—ã–±—Ä–∞—Ç—å –º–µ—Å—è—Ü</span>
          </button>
        <div class="dropdown-menu">
          {% for i in range(12) %}
            {% set month_num = (loop.index) %}
            {% set month_val = "2024-%02d"|format(month_num) %}
            <a class="dropdown-item" href="?month={{ month_val }}">
              {{ month_names[month_num - 1] }} 2024
            </a>
          {% endfor %}
          <div class="dropdown-divider"></div>
          {% for i in range(12) %}
            {% set month_num = (loop.index) %}
            {% set month_val = "2025-%02d"|format(month_num) %}
            <a class="dropdown-item" href="?month={{ month_val }}">
              {{ month_names[month_num - 1] }} 2025
            </a>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞ -->
<div class="quickbar p-3 mb-4">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="fw-semibold text-primary d-flex align-items-center gap-2">
      <i class="bi bi-lightning-charge-fill"></i> –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞
    </div>
  </div>

  <form id="quick-expense-form" method="POST" action="/quick-expense">
    <input type="hidden" name="return_month" value="{{ current_month }}">
    <div class="row g-2 align-items-stretch">
      <!-- –¥–∞—Ç–∞ -->
      <div class="col-6 col-md-2 q-input">
        <i class="bi bi-calendar3"></i>
        <input type="date" name="date" id="qe-date" value="{{ today }}" class="form-control" required>
      </div>
      <!-- —Å—É–º–º–∞ -->
      <div class="col-6 col-md-2 q-input">
        <i class="bi bi-123"></i>
        <input type="number" name="amount" id="qe-amount" step="0.01" min="0.01" placeholder="0.00"
               inputmode="decimal" class="form-control" required>
      </div>
      <!-- –∫–∞—Ç–µ–≥–æ—Ä–∏—è -->
      <div class="col-12 col-md-4 q-input">
        <i class="bi bi-tag"></i>
        <select name="category_id" id="qe-category" class="form-select" required>
          <option value="">–ö–∞—Ç–µ–≥–æ—Ä–∏—è‚Ä¶</option>
          {% for cat in categories %}
            <option value="{{ cat.id }}">{{ cat.name }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
      <div class="col-12 col-md-3 q-input">
        <i class="bi bi-chat-dots"></i>
        <input type="text" name="note" id="qe-note" class="form-control" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
      </div>
      <!-- –∫–Ω–æ–ø–∫–∞ -->
      <div class="col-12 col-md-1 btn-col d-grid">
        <button type="submit" id="qe-submit" class="btn btn-success btn-add" disabled>
          <i class="bi bi-plus-lg"></i><span class="d-none d-md-inline">–î–æ–±–∞–≤–∏—Ç—å</span>
        </button>
      </div>
    </div>
  </form>
</div>

<!-- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
{% if source_balances and source_balances|length > 0 %}
<div class="row g-3 mb-4">
  {% for s in source_balances %}
  <div class="col-12 col-sm-6 col-lg-4">
    <div class="card source-card">
      <div class="card-body">
        <h6 class="mb-3">{{ s.source_name }}</h6>
        <div class="d-flex justify-content-between mb-1"><span class="k">–ü—Ä–∏—à–ª–æ</span><span class="v currency">{{ s.income|format_amount }} <span class="currency-display">{{ currency_symbol|default("‚ÇΩ") }}</span></span></div>
        <div class="d-flex justify-content-between mb-1"><span class="k">–£—à–ª–æ</span><span class="v currency">{{ s.spent|format_amount }} <span class="currency-display">{{ currency_symbol|default("‚ÇΩ") }}</span></span></div>
        {% if s.limits_total > 0 %}
        <div class="d-flex justify-content-between mb-1">
          <span class="k text-muted small">–û—Å—Ç–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ª–∏–º–∏—Ç–æ–≤</span>
          <span class="v currency small {% if s.remaining_after_limits < 0 %}text-danger{% else %}text-success{% endif %}">{{ s.remaining_after_limits|format_amount }} <span class="currency-display">{{ currency_symbol|default("‚ÇΩ") }}</span></span>
        </div>
        {% endif %}
        <div class="d-flex justify-content-between">
          <span class="k">–û—Å—Ç–∞—Ç–æ–∫</span>
          <span class="v currency {% if s.rest < 0 %}text-danger{% endif %}">{{ s.rest|format_amount }} <span class="currency-display">{{ currency_symbol|default("‚ÇΩ") }}</span></span>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–ø–∏—Å–∫–æ–º -->
{% if budget_data %}
<div class="modern-card">
  <div class="card-body">
    <table class="table-modern w-100" id="categoriesTable">
      <thead>
        <tr>
          <th class="sortable" data-sort="category">
            –ö–∞—Ç–µ–≥–æ—Ä–∏—è <i class="bi bi-arrow-down-up ms-1 sort-icon"></i>
          </th>
          <th class="text-end sortable" data-sort="limit">
            –õ–∏–º–∏—Ç <i class="bi bi-arrow-down-up ms-1 sort-icon"></i>
          </th>
          <th class="text-end sortable" data-sort="spent">
            –ü–æ—Ç—Ä–∞—á–µ–Ω–æ <i class="bi bi-arrow-down-up ms-1 sort-icon"></i>
          </th>
          <th style="min-width:220px" class="sortable" data-sort="progress">
            –ü—Ä–æ–≥—Ä–µ—Å—Å <i class="bi bi-arrow-down-up ms-1 sort-icon"></i>
          </th>
          <th class="text-end sortable" data-sort="remaining">
            –û—Å—Ç–∞—Ç–æ–∫ <i class="bi bi-arrow-down-up ms-1 sort-icon"></i>
          </th>
          <th class="text-end sortable" data-sort="status">
            –°—Ç–∞—Ç—É—Å <i class="bi bi-arrow-down-up ms-1 sort-icon"></i>
          </th>
        </tr>
      </thead>
      <tbody>
        {% for item in budget_data %}
          {% set progress_percent = (item.limit > 0 and (item.spent / item.limit * 100) or 0) | round(1) %}
          {% set rest = item.limit - item.spent %}
          {% set status_order = 3 if item.spent > item.limit else (2 if item.limit > 0 and (item.spent / item.limit) > 0.8 else 1) %}
          <tr data-category="{{ item.category_name }}" 
              data-limit="{{ item.limit }}" 
              data-spent="{{ item.spent }}" 
              data-progress="{{ progress_percent }}"
              data-remaining="{{ rest }}"
              data-status="{{ status_order }}">
            <td class="cell-title">{{ item.category_name }}</td>
            <td class="text-end currency">{{ item.limit|format_amount }} <span class="currency-display">{{ currency_symbol|default("‚ÇΩ") }}</span></td>
            <td class="text-end currency {{ 'text-danger' if item.spent > item.limit else '' }}">{{ item.spent|format_amount }} <span class="currency-display">{{ currency_symbol|default("‚ÇΩ") }}</span></td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <div class="flex-grow-1">
                  <div class="progress">
                    <div class="progress-bar {% if progress_percent < 50 %}bg-success{% elif progress_percent < 80 %}bg-warning{% else %}bg-danger{% endif %}"
                         role="progressbar"
                         style="width: {{ [progress_percent, 100] | min }}%;">
                    </div>
                  </div>
                </div>
                <small class="text-muted" style="width:48px;text-align:right;">{{ progress_percent }}%</small>
              </div>
            </td>
            <td class="text-end currency {{ 'text-danger' if rest < 0 else 'text-success' }}">{{ rest|format_amount }} <span class="currency-display">{{ currency_symbol|default("‚ÇΩ") }}</span></td>
            <td class="text-end">
              {% if item.spent > item.limit %}
                <span class="badge-soft badge-soft-danger">–ü—Ä–µ–≤—ã—à–µ–Ω</span>
              {% elif item.limit > 0 and (item.spent / item.limit) > 0.8 %}
                <span class="badge-soft badge-soft-warning">–ü–æ—á—Ç–∏ –ø—Ä–µ–¥–µ–ª</span>
              {% else %}
                <span class="badge-soft badge-soft-success">–í –Ω–æ—Ä–º–µ</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // --- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –∏ –¥–Ω—è –Ω–µ–¥–µ–ª–∏ ---
  const dateDisplay = document.getElementById('current-date-display');
  const dayDisplay = document.getElementById('current-day-display');
  if (dateDisplay && dayDisplay) {
    const now = new Date();
    const options = { day: 'numeric', month: 'long' };
    const dateStr = now.toLocaleDateString('ru-RU', options);
    const dayStr = now.toLocaleDateString('ru-RU', { weekday: 'long' });
    
    dateDisplay.textContent = dateStr;
    dayDisplay.textContent = dayStr;
  }

  // --- –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞ ---
  const f = document.getElementById('quick-expense-form');
  const dateEl = document.getElementById('qe-date');
  const catEl  = document.getElementById('qe-category');
  const amtEl  = document.getElementById('qe-amount');
  const noteEl = document.getElementById('qe-note');
  const btn    = document.getElementById('qe-submit');

  if (dateEl && !dateEl.value) { const d=new Date(); dateEl.value=d.toISOString().slice(0,10); }

  if (catEl && amtEl) { catEl.addEventListener('change', () => { if (catEl.value) setTimeout(()=>amtEl.focus(),50); }); }

  function validate(){
    const ok = !!(dateEl.value && catEl.value && parseFloat(amtEl.value) > 0);
    btn.disabled = !ok;
  }
  ['input','change'].forEach(ev=>{
    dateEl.addEventListener(ev,validate);
    catEl.addEventListener(ev,validate);
    amtEl.addEventListener(ev,validate);
  });
  validate();

  [amtEl, noteEl].forEach(el=>{
    el.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); if(!btn.disabled) f.requestSubmit(); }});
  });

  if (amtEl) amtEl.addEventListener('wheel',(e)=>{ e.preventDefault(); },{passive:false});

  // --- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π ---
  document.querySelectorAll('.sortable').forEach(header => {
    header.style.cursor = 'pointer';
    header.style.userSelect = 'none';
    
    header.addEventListener('click', () => {
      const table = document.getElementById('categoriesTable');
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const sortKey = header.dataset.sort;
      const icon = header.querySelector('.sort-icon');
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
      let ascending = true;
      if (header.classList.contains('sort-asc')) {
        ascending = false;
        header.classList.remove('sort-asc');
        header.classList.add('sort-desc');
      } else {
        ascending = true;
        header.classList.remove('sort-desc');
        header.classList.add('sort-asc');
      }
      
      // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å –¥—Ä—É–≥–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
      document.querySelectorAll('.sortable').forEach(h => {
        if (h !== header) {
          h.classList.remove('sort-asc', 'sort-desc');
          h.querySelector('.sort-icon').className = 'bi bi-arrow-down-up ms-1 sort-icon';
        }
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É
      if (ascending) {
        icon.className = 'bi bi-arrow-up ms-1 sort-icon';
      } else {
        icon.className = 'bi bi-arrow-down ms-1 sort-icon';
      }
      
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏
      rows.sort((a, b) => {
        let aVal = a.dataset[sortKey];
        let bVal = b.dataset[sortKey];
        
        // –î–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–∞
        if (['limit', 'spent', 'progress', 'remaining', 'status'].includes(sortKey)) {
          aVal = parseFloat(aVal);
          bVal = parseFloat(bVal);
        }
        
        if (aVal < bVal) return ascending ? -1 : 1;
        if (aVal > bVal) return ascending ? 1 : -1;
        return 0;
      });
      
      // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
      rows.forEach(row => tbody.appendChild(row));
    });
  });
});
</script>

<style>
.sortable {
  transition: background-color 0.2s ease;
}

.sortable:hover {
  background-color: rgba(0,0,0,0.05);
}

.sort-icon {
  font-size: 0.8em;
  opacity: 0.6;
}

.sortable.sort-asc .sort-icon,
.sortable.sort-desc .sort-icon {
  opacity: 1;
}
</style>
{% endblock %}