{% extends "base.html" %}
{% block title %}üìä –î–∞—à–±–æ—Ä–¥ ‚Äî CrystalBudget{% endblock %}

{% block content %}
<style>
/* —Å–µ–ª–µ–∫—Ç—ã –Ω–µ –∫–ª–∏–ø—É—é—Ç—Å—è */
select.form-select,.form-modern{position:relative;overflow:hidden;z-index:1}
select.form-select option,.form-modern option{position:relative;z-index:9999}

/* –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
.header-row{row-gap:.5rem}

/* QUICK ACTIONS */
.quick-actions{display:flex;gap:.5rem;flex-wrap:wrap}
.quick-actions .btn{white-space:nowrap}

/* –∫–Ω–æ–ø–∫–∞ –ø–∏–∫–µ—Ä–∞ –º–µ—Å—è—Ü–∞ */
#month-btn{cursor:pointer}
#month-btn i{pointer-events:none}

/* –∫–∞—Ä—Ç–æ—á–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ */
.source-card .k{color:var(--bs-secondary)}
.source-card .v{font-weight:600;color:var(--bs-body-color)}

/* –ì–ª–∞–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –±–∞–ª–∞–Ω—Å–∞ */
.balance-hero{background:linear-gradient(135deg,var(--bs-primary) 0%,var(--bs-primary-dark,#0d6efd) 100%);border-radius:1rem;color:#fff;position:relative;overflow:hidden;box-shadow:0 8px 32px rgba(13,110,253,.3)}
.balance-hero::before{content:'';position:absolute;top:0;right:0;width:200px;height:200px;background:rgba(255,255,255,.1);border-radius:50%;transform:translate(30%,-30%)}
.balance-amount{font-size:2rem;font-weight:700;line-height:1.2;margin:0}
@media (max-width:576px){.balance-amount{font-size:1.75rem}}
.balance-label{opacity:.9;font-size:1rem;margin-bottom:.5rem}
.balance-actions{display:flex;gap:.5rem;margin-top:0}
@media (max-width:767px){.balance-actions{flex-direction:column;gap:.5rem}}
.btn-balance{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);color:#fff;border-radius:.5rem;padding:.5rem .75rem;font-weight:500;font-size:.875rem;transition:all .2s ease;backdrop-filter:blur(10px);flex:1;text-align:center;white-space:nowrap}
.btn-balance:hover{background:rgba(255,255,255,.3);color:#fff;transform:translateY(-1px)}

/* –ö–æ–ª—å—Ü–µ–≤—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã */
.progress-ring{transform:rotate(-90deg);width:80px;height:80px}
.progress-ring circle{stroke-width:6;fill:transparent;stroke-dasharray:251.3;stroke-dashoffset:251.3;transition:stroke-dashoffset .5s ease-in-out}
.progress-ring .bg{stroke:var(--bs-secondary-bg)}
.progress-ring .progress{stroke-linecap:round}
.progress-success{stroke:var(--bs-success)}
.progress-warning{stroke:var(--bs-warning)}
.progress-danger{stroke:var(--bs-danger)}

/* –¢–∞–±–ª–∏—Ü–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
.table-modern{width:100%;border-collapse:separate;border-spacing:0 8px}
.table-modern thead th{font-weight:600;color:var(--bs-secondary);border:0;padding:.25rem .75rem}
.table-modern tbody tr{background:var(--bs-body-bg);box-shadow:0 1px 2px rgba(0,0,0,.04);border-radius:10px}
.table-modern tbody td{border:0;padding:.75rem .75rem;vertical-align:middle;color:var(--bs-body-color)}
.table-modern .cell-title{font-weight:700;color:var(--bs-body-color)}
.table-modern .progress{height:8px;background:var(--bs-secondary-bg)}
.table-modern .progress-bar{transition:width .3s ease}

/* Dark theme support */
[data-bs-theme="dark"] .table-modern tbody tr{background:var(--bs-dark);box-shadow:0 1px 2px rgba(255,255,255,.04)}

/* –ú–æ–±–∏–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ */
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
.hide-mobile{display:table-cell}
@media (max-width:768px){
  .hide-mobile{display:none!important}
  .table-modern thead th{padding:.25rem .45rem;font-size:.9rem}
  .table-modern tbody td{padding:.5rem .45rem;font-size:.95rem}
  .table-modern .cell-title{max-width:52vw;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .currency{white-space:normal;word-break:break-word}
  .badge-soft{font-size:.75rem;padding:.2rem .4rem}
  .mobile-compact{font-size:.8rem;padding:.25rem .45rem!important}
}
.badge-soft{border-radius:999px;padding:.35rem .6rem;font-weight:600}
.badge-soft-success{background:#e8f6ee;color:#198754}
.badge-soft-warning{background:#fff3cd;color:#b58100}
.badge-soft-danger{background:#fde2e2;color:#c03a3a}
.currency{white-space:nowrap}

/* –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ */
.sortable{transition:background-color .2s ease;cursor:pointer;user-select:none}
.sortable:hover{background-color:rgba(0,0,0,.05)}
.sort-icon{font-size:.8em;opacity:.6}
.sortable.sort-asc .sort-icon,.sortable.sort-desc .sort-icon{opacity:1}
</style>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
<div class="row align-items-center justify-content-between header-row mb-4">
  <div class="col-auto">
    <h1 class="cb-page-title d-flex align-items-center gap-2">
      <i class="bi bi-speedometer2" aria-hidden="true"></i>
      <span>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∞—à–±–æ—Ä–¥</span>
    </h1>
  </div>
  <div class="col-12 col-md-auto">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div class="text-center" aria-live="polite">
        <div class="fw-bold text-primary" id="current-date-display"></div>
        <small class="text-muted" id="current-day-display"></small>
      </div>
      <div class="d-flex align-items-center gap-2">
        <div class="btn-group" role="group" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º">
          <a href="?month={{ prev_month }}" class="btn btn-outline-primary btn-sm" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü">
            <i class="bi bi-chevron-left"></i>
          </a>
          <span class="btn btn-outline-primary btn-sm disabled d-none d-sm-inline" style="min-width:120px" aria-current="date">{{ current_month_name }}</span>
          <span class="btn btn-outline-primary btn-sm disabled d-sm-none" style="min-width:80px" aria-current="date">{{ current_month_name.split()[0][:3] }}</span>
          <a href="?month={{ next_month }}" class="btn btn-outline-primary btn-sm" aria-label="–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü">
            <i class="bi bi-chevron-right"></i>
          </a>
        </div>
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-calendar3 d-md-none" aria-hidden="true"></i>
            <span class="d-none d-md-inline"><i class="bi bi-calendar3"></i> –í—ã–±—Ä–∞—Ç—å –º–µ—Å—è—Ü</span>
          </button>
          <div class="dropdown-menu">
            {% for i in range(12) %}
              {% set month_num = (loop.index) %}
              {% set month_val = "2024-%02d"|format(month_num) %}
              <a class="dropdown-item" href="?month={{ month_val }}">{{ month_names[month_num - 1] }} 2024</a>
            {% endfor %}
            <div class="dropdown-divider"></div>
            {% for i in range(12) %}
              {% set month_num = (loop.index) %}
              {% set month_val = "2025-%02d"|format(month_num) %}
              <a class="dropdown-item" href="?month={{ month_val }}">{{ month_names[month_num - 1] }} 2025</a>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ì–ª–∞–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –±–∞–ª–∞–Ω—Å–∞ -->
<div class="balance-hero p-3 mb-4">
  <div class="row align-items-center">
    <div class="col-md-8">
      <div class="balance-label">–ë–∞–ª–∞–Ω—Å –∑–∞ {{ current_month_name.split()[0] }}</div>
      {% set total_spent = budget_data|map(attribute='spent')|sum %}
      <h2 class="balance-amount mb-2">
        {{ (income - total_spent)|format_amount }} <small class="currency-display" style="font-size:.6em">{{ currency_symbol|default('‚ÇΩ') }}</small>
      </h2>
      <div class="d-flex gap-3 flex-wrap" aria-label="–ò—Ç–æ–≥–∏ –º–µ—Å—è—Ü–∞">
        <div>
          <small class="d-block opacity-75">–î–æ—Ö–æ–¥:</small>
          <strong class="currency">{{ income|format_amount }} <span class="currency-display">{{ currency_symbol|default('‚ÇΩ') }}</span></strong>
        </div>
        <div>
          <small class="d-block opacity-75">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ:</small>
          <strong class="text-warning currency">{{ total_spent|format_amount }} <span class="currency-display">{{ currency_symbol|default('‚ÇΩ') }}</span></strong>
        </div>
        <div class="d-none d-md-block">
          <small class="d-block opacity-75">–õ–∏–º–∏—Ç—ã:</small>
          <strong class="text-info currency">{{ budget_data|map(attribute='limit')|sum|format_amount }} <span class="currency-display">{{ currency_symbol|default('‚ÇΩ') }}</span></strong>
        </div>
      </div>
    </div>
    <div class="col-md-4 text-md-end mt-3 mt-md-0">
      <div class="balance-actions">
        <button type="button" class="btn btn-cb-expense btn-cb-lg cb-scale-in" data-bs-toggle="modal" data-bs-target="#expenseModal">
          <i class="bi bi-dash-circle-fill me-2" aria-hidden="true"></i><span class="d-none d-lg-inline">–î–æ–±–∞–≤–∏—Ç—å </span>–†–∞—Å—Ö–æ–¥
        </button>
        <button type="button" class="btn btn-cb-income btn-cb-lg cb-scale-in" data-bs-toggle="modal" data-bs-target="#incomeModal">
          <i class="bi bi-plus-circle-fill me-2" aria-hidden="true"></i>–î–æ—Ö–æ–¥—ã
        </button>
      </div>
    </div>
  </div>
</div>

<!-- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
{% if source_balances and source_balances|length > 0 %}
<div class="row g-3 mb-4">
  {% for s in source_balances %}
  <div class="col-12 col-sm-6 col-lg-4">
    <div class="card source-card h-100">
      <div class="card-body">
        <h6 class="mb-3">{{ s.source_name }}</h6>
        <div class="d-flex justify-content-between mb-1"><span class="k">–ü—Ä–∏—à–ª–æ</span><span class="v currency">{{ s.income|format_amount }} <span class="currency-display">{{ currency_symbol|default('‚ÇΩ') }}</span></span></div>
        <div class="d-flex justify-content-between mb-1"><span class="k">–£—à–ª–æ</span><span class="v currency">{{ s.spent|format_amount }} <span class="currency-display">{{ currency_symbol|default('‚ÇΩ') }}</span></span></div>
        {% if s.limits_total > 0 %}
        <div class="d-flex justify-content-between mb-1">
          <span class="k text-muted small">–û—Å—Ç–∞—ë—Ç—Å—è –ø–æ—Å–ª–µ –ª–∏–º–∏—Ç–æ–≤</span>
          <span class="v currency small {% if s.remaining_after_limits < 0 %}text-danger{% else %}text-success{% endif %}">{{ s.remaining_after_limits|format_amount }} <span class="currency-display">{{ currency_symbol|default('‚ÇΩ') }}</span></span>
        </div>
        {% endif %}
        <div class="d-flex justify-content-between">
          <span class="k">–û—Å—Ç–∞—Ç–æ–∫</span>
          <span class="v currency {% if s.rest < 0 %}text-danger{% endif %}">{{ s.rest|format_amount }} <span class="currency-display">{{ currency_symbol|default('‚ÇΩ') }}</span></span>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ (–º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è) -->
{% if budget_data %}
<div class="d-md-none mb-4">
  <h2 class="h6 mb-3">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ({{ budget_data|length }})</h2>
  <div class="row g-3">
    {% for item in budget_data %}
      {% set progress_percent = (item.limit > 0 and (item.spent / item.limit * 100) or 0) | round(1) %}
      {% set rest = item.limit - item.spent %}
      {% set color_class = 'success' if progress_percent < 50 else ('warning' if progress_percent < 80 else 'danger') %}
      <div class="col-12">
        <div class="card category-card">
          <div class="category-color bg-{{ color_class }}" aria-hidden="true"></div>
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="category-icon bg-{{ color_class }}-subtle text-{{ color_class }}">
                <i class="bi bi-tag" aria-hidden="true"></i>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1 fw-bold">{{ item.category_name }}</h6>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-muted small">{{ item.spent|format_amount }} / {{ item.limit|format_amount }} {{ currency_symbol|default('‚ÇΩ') }}</span>
                  <span class="badge bg-{{ color_class }}-subtle text-{{ color_class }}">{{ progress_percent }}%</span>
                </div>
              </div>
              <div class="progress-circle-wrapper">
                <svg class="progress-ring" viewBox="0 0 84 84" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
                  <circle class="bg" cx="42" cy="42" r="40"></circle>
                  <circle class="progress progress-{{ color_class }}" cx="42" cy="42" r="40" style="stroke-dashoffset: {{ 251.3 * (1 - progress_percent / 100) }}"></circle>
                </svg>
                <div class="progress-circle-text">{{ progress_percent }}%</div>
              </div>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div>
                <small class="text-muted">–û—Å—Ç–∞–ª–æ—Å—å:</small>
                <div class="fw-semibold {{ 'text-danger' if rest < 0 else 'text-success' }}">{{ rest|format_amount }} {{ currency_symbol|default('‚ÇΩ') }}</div>
              </div>
              {% if item.source_name %}
              <div class="text-end">
                <small class="text-muted">–ò—Å—Ç–æ—á–Ω–∏–∫:</small>
                <div class="text-primary small fw-semibold">{{ item.source_name }}</div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–∞–±–ª–∏—Ü–µ–π (–¥–µ—Å–∫—Ç–æ–ø) -->
<div class="d-none d-md-block modern-card">
  <div class="card-body table-wrap">
    <table class="table-modern w-100" id="categoriesTable">
      <thead>
        <tr>
          <th class="sortable" data-sort="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è <i class="bi bi-arrow-down-up ms-1 sort-icon"></i></th>
          <th class="text-end sortable hide-mobile" data-sort="limit">–õ–∏–º–∏—Ç <i class="bi bi-arrow-down-up ms-1 sort-icon"></i></th>
          <th class="text-end sortable" data-sort="spent"><span class="d-none d-md-inline">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</span><span class="d-md-none">–¢—Ä–∞—Ç</span> <i class="bi bi-arrow-down-up ms-1 sort-icon"></i></th>
          <th class="sortable hide-mobile" data-sort="progress" style="min-width:200px">–ü—Ä–æ–≥—Ä–µ—Å—Å <i class="bi bi-arrow-down-up ms-1 sort-icon"></i></th>
          <th class="text-end sortable" data-sort="remaining"><span class="d-none d-md-inline">–û—Å—Ç–∞—Ç–æ–∫</span><span class="d-md-none">–û—Å—Ç</span> <i class="bi bi-arrow-down-up ms-1 sort-icon"></i></th>
          <th class="text-end sortable mobile-compact" data-sort="source"><span class="d-none d-md-inline">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Ö–æ–¥–∞</span><span class="d-md-none">–ò—Å—Ç–æ—á–Ω–∏–∫</span> <i class="bi bi-arrow-down-up ms-1 sort-icon"></i></th>
        </tr>
      </thead>
      <tbody>
        {% for item in budget_data %}
          {% set progress_percent = (item.limit > 0 and (item.spent / item.limit * 100) or 0) | round(1) %}
          {% set rest = item.limit - item.spent %}
          {% set status_order = 3 if item.spent > item.limit else (2 if item.limit > 0 and (item.spent / item.limit) > 0.8 else 1) %}
          <tr data-category="{{ item.category_name }}" data-limit="{{ item.limit }}" data-spent="{{ item.spent }}" data-progress="{{ progress_percent }}" data-remaining="{{ rest }}" data-status="{{ status_order }}" data-source="{{ item.source_name or '–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ' }}">
            <td class="cell-title">
              {{ item.category_name }}
              <div class="d-md-none small text-muted mt-1">–õ–∏–º–∏—Ç: {{ item.limit|format_amount }} {{ currency_symbol|default('‚ÇΩ') }}</div>
            </td>
            <td class="text-end currency hide-mobile">{{ item.limit|format_amount }} <span class="currency-display">{{ currency_symbol|default('‚ÇΩ') }}</span></td>
            <td class="text-end currency {{ 'text-danger' if item.spent > item.limit else '' }}">
              {{ item.spent|format_amount }} <span class="currency-display">{{ currency_symbol|default('‚ÇΩ') }}</span>
              <div class="d-md-none mt-1">
                <div class="progress" style="height:6px"><div class="progress-bar {% if progress_percent < 50 %}bg-success{% elif progress_percent < 80 %}bg-warning{% else %}bg-danger{% endif %}" role="progressbar" style="width: {{ [progress_percent, 100] | min }}%"></div></div>
                <small class="text-muted">{{ progress_percent }}%</small>
              </div>
            </td>
            <td class="hide-mobile">
              <div class="d-flex align-items-center gap-2">
                <div class="flex-grow-1">
                  <div class="progress"><div class="progress-bar {% if progress_percent < 50 %}bg-success{% elif progress_percent < 80 %}bg-warning{% else %}bg-danger{% endif %}" role="progressbar" style="width: {{ [progress_percent, 100] | min }}%"></div></div>
                </div>
                <small class="text-muted" style="width:48px;text-align:right">{{ progress_percent }}%</small>
              </div>
            </td>
            <td class="text-end currency {{ 'text-danger' if rest < 0 else 'text-success' }}">{{ rest|format_amount }} <span class="currency-display">{{ currency_symbol|default('‚ÇΩ') }}</span></td>
            <td class="text-end mobile-compact">
              {% if item.source_name %}
                <span class="d-none d-md-inline text-primary small">{{ item.source_name }}</span>
                <span class="d-md-none text-primary small">{{ item.source_name[:8] }}{{ '...' if item.source_name|length > 8 else '' }}</span>
              {% else %}
                <span class="text-muted small"><span class="d-none d-md-inline">–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ</span><span class="d-md-none">‚Äî</span></span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <!-- –ë–ª–æ–∫ —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤ -->
  {% set has_recent_expenses = budget_data | selectattr('spent') | selectattr('spent', 'gt', 0) | list %}
  {% set has_income = (total_balance and total_balance > 0) or (source_balances and source_balances|length > 0) %}
  {% set has_goals = False %} <!-- –ë—É–¥–µ–º –ø–æ–ª—É—á–∞—Ç—å –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ -->
  
  {% if not has_recent_expenses or not has_income %}
  <div class="cb-card mt-4">
    <div class="cb-card-header">
      <h3 class="cb-section-title mb-0"><i class="bi bi-lightbulb"></i>–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏</h3>
    </div>
    <div class="cb-card-body">
      <div class="row g-3">
        {% if not has_income %}
        <div class="col-md-6">
          <div class="d-flex align-items-start gap-3 p-3 border rounded-3 bg-light">
            <div class="flex-shrink-0">
              <i class="bi bi-plus-circle-fill cb-text-income" style="font-size: 1.5rem;"></i>
            </div>
            <div>
              <h4 class="h6 mb-1">–î–æ–±–∞–≤—å—Ç–µ –¥–æ—Ö–æ–¥—ã</h4>
              <p class="small text-muted mb-2">–£–∫–∞–∂–∏—Ç–µ –≤–∞—à–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ—Ö–æ–¥–æ–≤ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±—é–¥–∂–µ—Ç–∞</p>
              <a href="{{ url_for('income_page') }}" class="btn btn-cb-income btn-cb-sm">
                <i class="bi bi-arrow-right"></i> –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥—ã
              </a>
            </div>
          </div>
        </div>
        {% endif %}
        
        {% if not has_recent_expenses and has_income %}
        <div class="col-md-6">
          <div class="d-flex align-items-start gap-3 p-3 border rounded-3 bg-light">
            <div class="flex-shrink-0">
              <i class="bi bi-dash-circle-fill cb-text-expense" style="font-size: 1.5rem;"></i>
            </div>
            <div>
              <h4 class="h6 mb-1">–ù–∞—á–Ω–∏—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–¥—ã</h4>
              <p class="small text-muted mb-2">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–µ —Ä–∞—Å—Ö–æ–¥—ã, —á—Ç–æ–±—ã –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –±—é–¥–∂–µ—Ç</p>
              <button class="btn btn-cb-expense btn-cb-sm" data-bs-toggle="modal" data-bs-target="#expenseModal">
                <i class="bi bi-plus-lg"></i> –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥
              </button>
            </div>
          </div>
        </div>
        {% endif %}
        
        {% if has_income and has_recent_expenses %}
        <div class="col-md-6">
          <div class="d-flex align-items-start gap-3 p-3 border rounded-3 bg-light">
            <div class="flex-shrink-0">
              <i class="bi bi-bullseye cb-text-goal" style="font-size: 1.5rem;"></i>
            </div>
            <div>
              <h4 class="h6 mb-1">–ü–æ—Å—Ç–∞–≤—å—Ç–µ —Ü–µ–ª–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π</h4>
              <p class="small text-muted mb-2">–°–æ–∑–¥–∞–π—Ç–µ —Ü–µ–ª–∏, —á—Ç–æ–±—ã –º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–µ–±—è –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å –¥–µ–Ω—å–≥–∏</p>
              <a href="{{ url_for('goals') }}" class="btn btn-cb-goal btn-cb-sm">
                <i class="bi bi-target"></i> –°–æ–∑–¥–∞—Ç—å —Ü–µ–ª–∏
              </a>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% else %}
<!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
<div class="text-center py-5">
  <div class="mb-3"><i class="bi bi-wallet2 display-1 text-muted opacity-50" aria-hidden="true"></i></div>
  <h2 class="h5 mb-2">–ù–∞—á–Ω–∏—Ç–µ —Å —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h2>
  <p class="text-muted">–°–æ–∑–¥–∞–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —É—á—ë—Ç–∞ –≤–∞—à–∏—Ö –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</p>
  <a href="{{ url_for('categories') }}" class="btn btn-cb-primary btn-cb-lg cb-fade-in"><i class="bi bi-tags-fill me-2"></i>–°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
</div>
{% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ ‚Üí –ø–µ—Ä–µ–Ω–æ—Å –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ –ª–æ–≥–∏–∫–µ -->
{{ super() }}

<!-- Toast –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
<div class="toast-container position-fixed top-0 end-0 p-3" aria-live="polite" aria-atomic="true"></div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞/–¥–æ—Ö–æ–¥–∞ (–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–∞–∫ –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–µ) -->
{% include 'partials/modals_dashboard.html' ignore missing %}
{% endblock %}

{% block scripts %}
<script>
// Toast –∏–∑ flash
(function(){
  const alerts = document.querySelectorAll('.alert');
  const container = document.querySelector('.toast-container');
  if(!container) return;
  const typeMap = {success:'check-circle-fill text-success', danger:'x-circle-fill text-danger', warning:'exclamation-triangle-fill text-warning', info:'info-circle-fill text-primary'};
  alerts.forEach(a=>{
    const msg = a.textContent.trim();
    const type = a.classList.contains('alert-success')?'success':a.classList.contains('alert-danger')?'danger':a.classList.contains('alert-warning')?'warning':'info';
    const id = 't-'+Date.now()+Math.random();
    container.insertAdjacentHTML('beforeend',`<div class="toast" id="${id}" role="status" data-bs-delay="4000"><div class="toast-header"><i class="bi ${typeMap[type]} me-2"></i><strong class="me-auto">CrystalBudget</strong><button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button></div><div class="toast-body">${msg}</div></div>`);
    const el = document.getElementById(id); new bootstrap.Toast(el).show(); el.addEventListener('hidden.bs.toast',()=>el.remove()); a.remove();
  });
})();

// –î–∞—Ç–∞ –∏ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
(function(){
  const dEl = document.getElementById('current-date-display');
  const wEl = document.getElementById('current-day-display');
  if(!(dEl&&wEl)) return;
  const now = new Date();
  dEl.textContent = now.toLocaleDateString('ru-RU',{day:'numeric',month:'long'});
  wEl.textContent = now.toLocaleDateString('ru-RU',{weekday:'long'});
})();

// –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π
(function(){
  const table = document.getElementById('categoriesTable');
  if(!table) return;
  const headers = table.querySelectorAll('.sortable');
  headers.forEach(h=>{
    h.addEventListener('click',()=>{
      const key = h.dataset.sort; const tb = table.querySelector('tbody'); const rows=[...tb.querySelectorAll('tr')];
      const asc = !h.classList.contains('sort-asc');
      headers.forEach(x=>x.classList.remove('sort-asc','sort-desc'));
      h.classList.add(asc?'sort-asc':'sort-desc');
      rows.sort((a,b)=>{
        let A=a.dataset[key],B=b.dataset[key];
        if(['limit','spent','progress','remaining','status'].includes(key)){A=parseFloat(A);B=parseFloat(B);} else {A=String(A).toLowerCase();B=String(B).toLowerCase();}
        return asc ? (A>B?1:A<B?-1:0) : (A<B?1:A>B?-1:0);
      }).forEach(r=>tb.appendChild(r));
    });
  });
})();
</script>
{% endblock %}
