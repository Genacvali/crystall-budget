{% extends "base.html" %}
{% block title %}üìä –î–∞—à–±–æ—Ä–¥ ‚Äî CrystalBudget{% endblock %}

{% block content %}
<style>
/* –°–µ–ª–µ–∫—Ç—ã –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤–Ω–∏–∑, –Ω–µ –∫–ª–∏–ø—É–µ–º—Å—è */
select.form-select, .form-modern { position: relative; overflow: hidden; z-index: 1; }
select.form-select option, .form-modern option { position: relative; z-index: 9999; }

/* –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å" */
.quick-add-btn{min-height:42px;display:inline-flex;align-items:center;justify-content:center;white-space:nowrap;}
.quick-add-text{display:none;} @media (min-width:768px){.quick-add-text{display:inline;}}

/* –ò—Å—Ç–æ—á–Ω–∏–∫–∏ */
.source-card .k{color:#6c757d;} .source-card .v{font-weight:600;}

/* –¢–∞–±–ª–∏—Ü–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
.table-modern{width:100%; border-collapse:separate; border-spacing:0 8px;}
.table-modern thead th{font-weight:600; color:#6c757d; border:0; padding:.25rem .75rem;}
.table-modern tbody tr{background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.04); border-radius:10px;}
.table-modern tbody td{border:0; padding:.75rem .75rem; vertical-align:middle;}
.table-modern .cell-title{font-weight:700;}
.table-modern .progress{height:8px; background:#eef1f4;}
.table-modern .progress-bar{transition:width .3s ease;}
.badge-soft{border-radius:999px; padding:.35rem .6rem; font-weight:600;}
.badge-soft-success{background:#e8f6ee;color:#198754;}
.badge-soft-warning{background:#fff3cd;color:#b58100;}
.badge-soft-danger{background:#fde2e2;color:#c03a3a;}
.currency{white-space:nowrap;}
</style>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
  <div>
    <h1 class="m-0 d-flex align-items-center gap-2">
      <i class="bi bi-speedometer2"></i> –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∞—à–±–æ—Ä–¥
    </h1>
    <p class="text-secondary mb-0">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏–º –±—é–¥–∂–µ—Ç–æ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ</p>
  </div>
  <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –º–µ—Å—è—Ü–∞ -->
  <form method="get" class="d-flex align-items-center gap-2">
    <i class="bi bi-calendar3 text-primary"></i>
    <input type="month" name="month" value="{{ current_month }}" class="form-control form-control-sm" style="max-width:160px">
    <button class="btn btn-outline-primary btn-sm">–ü–æ–∫–∞–∑–∞—Ç—å</button>
  </form>
</div>

<!-- –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞ -->
<div class="modern-card mb-4">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h5 class="m-0"><i class="bi bi-plus-circle-fill"></i> –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞</h5>
      <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#quickAddForm">
        <i class="bi bi-chevron-down"></i>
      </button>
    </div>
    <div class="collapse show" id="quickAddForm">
      <form method="POST" action="/quick-expense" class="quick-expense-form">
        <input type="hidden" name="return_month" value="{{ current_month }}">
        <div class="row g-3">
          <div class="col-12 col-md-3">
            <label class="form-label"><i class="bi bi-calendar3"></i> –î–∞—Ç–∞</label>
            <input type="date" name="date" value="{{ today }}" class="form-modern form-control" required>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label"><i class="bi bi-tags-fill"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <div class="d-flex gap-2">
              <select name="category_id" id="quick-category" class="form-modern form-select" required style="flex:1;">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é‚Ä¶</option>
                {% for cat in categories %}<option value="{{ cat.id }}">{{ cat.name }}</option>{% endfor %}
              </select>
              <button type="button" class="btn btn-outline-secondary" style="padding:12px"
                      data-bs-toggle="modal" data-bs-target="#quickCategoryModal" title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é">
                <i class="bi bi-plus"></i>
              </button>
            </div>
          </div>
          <div class="col-12 col-md-2">
            <label class="form-label"><i class="bi bi-123"></i> –°—É–º–º–∞</label>
            <input type="number" id="quick-amount" name="amount" placeholder="0.00" step="0.01" min="0.01"
                   inputmode="decimal" class="form-modern form-control" required>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label"><i class="bi bi-chat-dots-fill"></i> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
            <input type="text" name="note" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" class="form-modern form-control">
          </div>
          <div class="col-12 col-md-auto d-flex align-items-center justify-content-end">
            <button type="submit" class="btn btn-success quick-add-btn w-100 w-md-auto px-3">
              <i class="bi bi-plus-lg me-1"></i><span class="quick-add-text">–î–æ–±–∞–≤–∏—Ç—å</span>
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
{% if source_balances and source_balances|length > 0 %}
<div class="row g-3 mb-4">
  {% for s in source_balances %}
  <div class="col-12 col-md-6 col-lg-4">
    <div class="card source-card">
      <div class="card-body">
        <h6 class="mb-3">{{ s.source_name }}</h6>
        <div class="d-flex justify-content-between mb-1"><span class="k">–ü—Ä–∏—à–ª–æ</span><span class="v currency">{{ s.income|format_amount }}</span></div>
        <div class="d-flex justify-content-between mb-1"><span class="k">–£—à–ª–æ</span><span class="v currency">{{ s.spent|format_amount }}</span></div>
        <div class="d-flex justify-content-between">
          <span class="k">–û—Å—Ç–∞—Ç–æ–∫</span>
          <span class="v currency {% if s.rest < 0 %}text-danger{% endif %}">{{ s.rest|format_amount }}</span>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî –°–ü–ò–°–ö–û–ú -->
{% if budget_data %}
<div class="modern-card">
  <div class="card-body">
    <table class="table-modern w-100">
      <thead>
        <tr>
          <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
          <th class="text-end">–õ–∏–º–∏—Ç</th>
          <th class="text-end">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</th>
          <th style="min-width:220px">–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
          <th class="text-end">–û—Å—Ç–∞—Ç–æ–∫</th>
          <th class="text-end">–°—Ç–∞—Ç—É—Å</th>
        </tr>
      </thead>
      <tbody>
        {% for item in budget_data %}
          {% set progress_percent = (item.limit > 0 and (item.spent / item.limit * 100) or 0) | round(1) %}
          {% set rest = item.limit - item.spent %}
          <tr>
            <td class="cell-title">{{ item.category_name }}</td>
            <td class="text-end currency">{{ item.limit|format_amount }} ‚ÇΩ</td>
            <td class="text-end currency {{ 'text-danger' if item.spent>item.limit else '' }}">{{ item.spent|format_amount }} ‚ÇΩ</td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <div class="flex-grow-1">
                  <div class="progress">
                    <div class="progress-bar
                      {% if progress_percent < 50 %}bg-success{% elif progress_percent < 80 %}bg-warning{% else %}bg-danger{% endif %}"
                      role="progressbar" style="width: {{ [progress_percent, 100] | min }}%;">
                    </div>
                  </div>
                </div>
                <small class="text-muted" style="width:48px; text-align:right;">{{ progress_percent }}%</small>
              </div>
            </td>
            <td class="text-end currency {{ 'text-danger' if rest < 0 else 'text-success' }}">{{ rest|format_amount }} ‚ÇΩ</td>
            <td class="text-end">
              {% if item.spent > item.limit %}
                <span class="badge-soft badge-soft-danger">–ü—Ä–µ–≤—ã—à–µ–Ω</span>
              {% elif item.limit > 0 and (item.spent / item.limit) > 0.8 %}
                <span class="badge-soft badge-soft-warning">–ü–æ—á—Ç–∏ –ø—Ä–µ–¥–µ–ª</span>
              {% else %}
                <span class="badge-soft badge-soft-success">–í –Ω–æ—Ä–º–µ</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const cat = document.getElementById('quick-category');
  const amount = document.getElementById('quick-amount');
  if (cat && amount) { cat.addEventListener('change', () => { if (cat.value) setTimeout(()=>amount.focus(), 50); }); }
});
</script>
{% endblock %}