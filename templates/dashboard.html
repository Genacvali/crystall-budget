{# templates/dashboard.html #}
{% extends "base.html" %}

{% block title %}Панель управления{% endblock %}

{% block head %}
  {# единый css страницы (в нём есть .pill и всё остальное) #}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}?v=9">
{% endblock %}

{% block content %}

  {# === Панель баланса (hero) === #}
  {% include "components/_balance_panel.html" %}

  {# === Прогресс по категориям === #}
  {% include "components/_progress_bars.html" %}

  {# === Остальное содержимое дашборда — ваши карточки/таблицы/виджеты ниже === #}
  {# {% include "components/_recent_transactions.html" %} #}
  {# {% include "components/_sources_card.html" %} #}
  {# {% include "components/_goals_widget.html" %} #}

  <!-- Модал добавления расхода -->
  <div class="modal fade" id="expenseModal" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="expenseModalLabel">Добавить расход</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="expenseForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="expenseAmount" class="form-label">Сумма</label>
              <input type="number" class="form-control" id="expenseAmount" name="amount" step="0.01" required>
            </div>
            <div class="mb-3">
              <label for="expenseCategory" class="form-label">Категория</label>
              <select class="form-select" id="expenseCategory" name="category_id" required>
                {% for cat in budget_data %}
                  <option value="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="expenseDate" class="form-label">Дата</label>
              <input type="date" class="form-control" id="expenseDate" name="date" value="{{ today }}" required>
            </div>
            <div class="mb-3">
              <label for="expenseNote" class="form-label">Примечание</label>
              <input type="text" class="form-control" id="expenseNote" name="note" maxlength="500">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-primary">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Модал добавления дохода -->
  <div class="modal fade" id="incomeModal" tabindex="-1" aria-labelledby="incomeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="incomeModalLabel">Добавить доход</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="incomeForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="incomeAmount" class="form-label">Сумма</label>
              <input type="number" class="form-control" id="incomeAmount" name="amount" step="0.01" required>
            </div>
            <div class="mb-3">
              <label for="incomeSource" class="form-label">Источник</label>
              <select class="form-select" id="incomeSource" name="source_id" required>
                <option value="">Выберите источник</option>
                <option value="1">Зарплата</option>
                <option value="2">Фриланс</option>
                <option value="3">Другое</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="incomeDate" class="form-label">Дата</label>
              <input type="date" class="form-control" id="incomeDate" name="date" value="{{ today }}" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-primary">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
<script>
// Интеграция форм с офлайн API
document.getElementById('expenseForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const payload = {
    amount: Number(form.amount.value),
    category_id: form.category_id.value,
    date: form.date.value,
    note: form.note.value
  };
  
  try {
    const res = await CBOffline.apiSend('POST', '/api/expenses', payload);
    if (res.queued) {
      showToast('Расход сохранен (офлайн, будет отправлен при восстановлении сети)', 'warning');
    } else {
      showToast('Расход успешно добавлен', 'success');
    }
    
    // Закрыть модал
    const modal = bootstrap.Modal.getInstance(document.getElementById('expenseModal'));
    if (modal) modal.hide();
    
    // Очистить форму
    form.reset();
    form.date.value = '{{ today }}';
    
    // Обновить страницу при онлайне
    if (!res.queued) {
      setTimeout(() => location.reload(), 1000);
    }
  } catch (error) {
    console.error('Error adding expense:', error);
    showToast('Ошибка при добавлении расхода', 'danger');
  }
});

document.getElementById('incomeForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const payload = {
    amount: Number(form.amount.value),
    source_id: form.source_id.value,
    date: form.date.value
  };
  
  try {
    const res = await CBOffline.apiSend('POST', '/api/income', payload);
    if (res.queued) {
      showToast('Доход сохранен (офлайн, будет отправлен при восстановлении сети)', 'warning');
    } else {
      showToast('Доход успешно добавлен', 'success');
    }
    
    // Закрыть модал
    const modal = bootstrap.Modal.getInstance(document.getElementById('incomeModal'));
    if (modal) modal.hide();
    
    // Очистить форму
    form.reset();
    form.date.value = '{{ today }}';
    
    // Обновить страницу при онлайне
    if (!res.queued) {
      setTimeout(() => location.reload(), 1000);
    }
  } catch (error) {
    console.error('Error adding income:', error);
    showToast('Ошибка при добавлении дохода', 'danger');
  }
});
</script>
<script defer src="{{ url_for('static', filename='js/progress-bars.js') }}?v=1"></script>
{% endblock %}
