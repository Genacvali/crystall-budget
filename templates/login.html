{% extends "base.html" %}
{% block title %}–í—Ö–æ–¥ - CrystalBudget{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-4">
        <div class="card">
            <div class="card-body">
                <div class="text-center mb-4">
                    <h2 class="card-title">üíé –í—Ö–æ–¥</h2>
                    <p class="text-muted">–í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç CrystalBudget</p>
                </div>
                
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        <div class="alert alert-danger">
                            {% for message in messages %}
                                {{ message }}
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}

                <!-- Telegram Login -->
                <div class="text-center mb-4">
                    <div id="telegram-login-widget">
                        <!-- Fallback button while widget loads -->
                        <button type="button" class="btn btn-info w-100" id="telegram-login-fallback" style="display: none;">
                            <i class="bi bi-telegram"></i> –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram
                        </button>
                    </div>
                </div>
                
                <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
                <div class="text-center my-4">
                    <span class="text-muted">–∏–ª–∏</span>
                </div>
                
                <!-- Email Login -->
                <form method="POST" action="{{ url_for('login') }}">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">–í–æ–π—Ç–∏</button>
                </form>
                
                <div class="text-center">
                    <p class="text-muted mb-0">
                        –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? 
                        <a href="{{ url_for('register') }}" class="text-decoration-none">
                            –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Telegram Login Widget initialization
    function initTelegramWidget() {
        const widgetContainer = document.getElementById('telegram-login-widget');
        const fallbackButton = document.getElementById('telegram-login-fallback');
        const separator = document.getElementById('login-separator');
        
        // Show fallback button initially
        fallbackButton.style.display = 'block';
        
        // Try to load Telegram widget
        const script = document.createElement('script');
        script.async = true;
        script.src = 'https://telegram.org/js/telegram-widget.js?22';
        script.setAttribute('data-telegram-login', 'crystalbudget_bot');
        script.setAttribute('data-size', 'large');
        script.setAttribute('data-auth-url', window.location.origin + '/login');
        script.setAttribute('data-request-access', 'write');
        script.setAttribute('data-lang', 'ru');
        
        // Handle widget load success
        script.onload = function() {
            // Check if widget actually loaded (has iframe)
            setTimeout(() => {
                const iframe = widgetContainer.querySelector('iframe');
                if (iframe) {
                    fallbackButton.style.display = 'none';
                } else {
                    // Widget failed to load, keep fallback
                    console.warn('Telegram widget failed to load, using fallback button');
                }
            }, 1000);
        };
        
        // Handle widget load error
        script.onerror = function() {
            console.warn('Failed to load Telegram widget script');
            fallbackButton.style.display = 'block';
        };
        
        widgetContainer.appendChild(script);
        
        // Fallback button click handler
        fallbackButton.addEventListener('click', function() {
            alert('Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞.\n\n–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω:\n1. –°–æ–∑–¥–∞—Ç—å Telegram –±–æ—Ç–∞\n2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å TELEGRAM_BOT_TOKEN\n3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–æ–º–µ–Ω –≤ @BotFather\n\n–ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Ö–æ–¥ –ø–æ email.');
        });
    }
    
    // Initialize Telegram Widget
    initTelegramWidget();
});
</script>
{% endblock %}