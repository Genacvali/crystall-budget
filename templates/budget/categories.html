{% extends "base.html" %}
{% block title %}Категории — CrystalBudget{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
  <h2 class="h4 m-0"><i class="bi bi-dash-circle text-primary me-2"></i>Категории расходов</h2>
  <button class="btn-hero icon-only" data-bs-toggle="modal" data-bs-target="#addCategoryModal"
          title="Добавить категорию" aria-label="Добавить категорию">
    <i class="bi bi-plus-lg"></i>
    <span class="visually-hidden">Добавить категорию</span>
  </button>
</div>

<!-- Навигация по месяцам -->
{% if month_data %}
<div class="period-filter">
    <div class="period-info">
        <i class="bi bi-calendar3 icon"></i>
        <span class="label">Период:</span>
        <strong class="value">{{ month_data.current_month_name }}</strong>
        {% if not month_data.is_current_month %}
            <span class="period-badge">Архив</span>
        {% endif %}
        {% if spent_by_category %}
            <span class="period-badge">(траты учтены)</span>
        {% endif %}
    </div>
    <div class="period-nav">
        <a href="{{ url_for('budget.categories', month=month_data.prev_month) }}" 
           class="period-btn" title="Предыдущий месяц">
            <i class="bi bi-chevron-left"></i>
        </a>
        <a href="{{ url_for('budget.categories') }}" 
           class="period-btn current" title="Текущий месяц">
            <i class="bi bi-house"></i>
        </a>
        <a href="{{ url_for('budget.categories', month=month_data.next_month) }}" 
           class="period-btn" title="Следующий месяц">
            <i class="bi bi-chevron-right"></i>
        </a>
    </div>
</div>
{% endif %}

<!-- Модальное окно добавления категории -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCategoryModalLabel">
          <i class="bi bi-plus-circle text-primary me-2"></i>Новая категория расходов
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('budget.add_category') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="modal-body">
          <input type="hidden" name="category_type" value="expense">
          
          <div class="mb-3">
            <label class="form-label">Название</label>
            <input type="text" name="name" class="form-control" placeholder="Например, Продукты" required>
          </div>
          
          <div class="row g-3" id="limitFields">
            <div class="col-md-6">
              <label class="form-label">Тип лимита</label>
              <select name="limit_type" class="form-select" required>
                <option value="fixed">Фиксированная сумма</option>
                <option value="percent">Процент от дохода</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Размер лимита</label>
              <input type="number" name="value" step="0.01" min="0.01" inputmode="decimal"
                     class="form-control" placeholder="Лимит" required>
            </div>
          </div>
          
          <div class="form-check form-switch mt-3">
            <input class="form-check-input" type="checkbox" name="multi_source" id="addMultiSource"
                   onchange="toggleNewCategorySourceField(this.checked)">
            <label class="form-check-label" for="addMultiSource">
              <strong>Многоисточниковая категория</strong>
            </label>
            <div class="form-text">Несколько источников дохода</div>
          </div>
          
          <div class="mt-3" id="singleSourceField">
            <label class="form-label">Источник дохода</label>
            <select name="source_id" class="form-select">
              <option value="">— Не привязан —</option>
              {% for source in income_sources %}
                <option value="{{ source.id }}">{{ source.name }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="mt-3" id="multiSourceConfig" style="display: none;">
            <div class="alert alert-info mb-3">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Многоисточниковая категория:</strong> Настройте процентное распределение между источниками дохода.
            </div>
            
            <div id="multiSourceList">
              {% for source in income_sources %}
              <div class="row align-items-center mb-2 multi-source-item">
                <div class="col-1">
                  <input type="checkbox" class="form-check-input multi-source-checkbox" 
                         name="multi_sources" value="{{ source.id }}"
                         onchange="toggleSourcePercentage(this, '{{ source.id }}')">
                </div>
                <div class="col-6">
                  <label class="form-label mb-0">{{ source.name }}</label>
                </div>
                <div class="col-5">
                  <div class="input-group">
                    <input type="number" class="form-control source-percentage" 
                           name="source_percentage_{{ source.id }}" 
                           min="0" max="100" step="0.1" 
                           placeholder="0" disabled>
                    <span class="input-group-text">%</span>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            
            <div class="mt-2">
              <small class="text-muted">Общий процент: <span id="totalPercentage">0</span>% 
                <span id="percentageWarning" class="text-danger" style="display: none;">(должно быть 100%)</span>
              </small>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-plus me-1"></i>Создать категорию
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Категории трат -->
{% if expense_categories %}
<section class="ff-progress-card mb-4" aria-label="Категории расходов">
  <div class="ff-header">
    <i class="bi bi-dash-circle"></i>
    Всего категорий: {{ expense_categories|length }}
  </div>
  <div class="ff-list">
    {% for cat in expense_categories %}
    <div class="category-row">
      <!-- Левая колонка: название и тип -->
      <div class="category-info">
        <div class="category-name">{{ cat.name }}</div>
        {% if cat.is_multi_source %}
        <div class="category-meta">
          <span class="badge-ghost">
            <i class="bi bi-diagram-3 me-1"></i>Мультиисточник
          </span>
        </div>
        {% else %}
        <div class="category-meta">
          {% set source_id = rules_map.get(cat.id) %}
          {% if source_id %}
            {% for source in income_sources %}
              {% if source.id == source_id %}
                <span class="badge-ghost">{{ source.name }}</span>
              {% endif %}
            {% endfor %}
          {% else %}
            <span class="text-muted">Источник не указан</span>
          {% endif %}
        </div>
        {% endif %}
      </div>
      
      <!-- Центральная колонка: детали источников (для мультиисточника) -->
      <div class="category-sources">
        {% if cat.is_multi_source %}
          {% set cat_sources = multi_source_links.get(cat.id, []) %}
          {% if cat_sources and cat_sources|length > 0 %}
            <div class="d-flex flex-wrap gap-1">
              {% for source_info in cat_sources %}
                <span class="badge-ghost" title="{{ source_info.percentage }}% от {{ source_info.source_name }}">
                  {{ source_info.source_name }}: {{ source_info.percentage }}%
                </span>
              {% endfor %}
            </div>
          {% else %}
            <span class="text-warning small">
              <i class="bi bi-exclamation-triangle me-1"></i>Настройте источники
            </span>
          {% endif %}
        {% endif %}
      </div>
      
      <!-- Правая колонка: лимит и действия -->
      <div class="category-limit">
        <div class="limit-value">
          {% if cat.limit_type == 'percent' %}
            {% if cat.is_multi_source %}
              <span class="limit-amount tabular-nums">Процентный</span>
              <span class="limit-type">от источников</span>
            {% else %}
              <span class="limit-amount tabular-nums">{{ cat.value|format_amount }}%</span>
              <span class="limit-type">от дохода</span>
            {% endif %}
          {% else %}
            <span class="limit-amount tabular-nums">{{ cat.value|format_amount }} ₽</span>
            <span class="limit-type">фикс</span>
          {% endif %}
        </div>
        <div class="ff-iconbtn-group" role="group" aria-label="Действия">
          <button type="button" class="ff-iconbtn ff-iconbtn--edit" data-bs-toggle="modal" data-bs-target="#editModal{{ cat.id }}" 
                  aria-label="Редактировать категорию" title="Редактировать">
            <i class="bi bi-pencil"></i>
          </button>
          <form method="POST" action="{{ url_for('budget.delete_category', category_id=cat.id) }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="ff-iconbtn ff-iconbtn--delete" onclick="return confirm('Удалить категорию «{{ cat.name }}»?')" 
                    aria-label="Удалить категорию" title="Удалить">
              <i class="bi bi-trash3"></i>
            </button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

</section>
{% endif %}

{% if not expense_categories %}
<div class="text-center py-5">
  <p class="text-muted mb-3">Категорий пока нет. Используйте кнопку "Добавить категорию" выше для создания первой категории.</p>
</div>
{% endif %}

<!-- Секция управления источниками доходов -->
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2 mt-5">
  <h2 class="h4 m-0"><i class="bi bi-cash-coin text-success me-2"></i>Источники доходов</h2>
  <button class="btn-hero icon-only" data-bs-toggle="modal" data-bs-target="#addIncomeSourceModal"
          title="Добавить источник дохода" aria-label="Добавить источник дохода">
    <i class="bi bi-plus-lg"></i>
    <span class="visually-hidden">Добавить источник дохода</span>
  </button>
</div>

{% if income_sources %}
<section class="ff-progress-card mb-4" aria-label="Источники доходов">
  <div class="ff-header">
    <i class="bi bi-cash-coin"></i>
    Всего источников: {{ income_sources|length }}
  </div>
  <div class="ff-list">
    {% for source in income_sources %}
    <div class="category-row">
      <!-- Левая колонка: название источника -->
      <div class="category-info">
        <div class="category-name">{{ source.name }}</div>
        <div class="category-meta">
          <span class="text-muted">Источник дохода</span>
        </div>
      </div>

      <!-- Правая колонка: действия -->
      <div class="category-actions">
        <div class="ff-iconbtn-group" role="group" aria-label="Действия">
          <form method="POST" action="{{ url_for('budget.delete_income_source', source_id=source.id) }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="ff-iconbtn ff-iconbtn--delete" 
                    onclick="return confirm('Удалить источник дохода «{{ source.name }}»? Это действие нельзя отменить.')" 
                    aria-label="Удалить источник дохода" title="Удалить">
              <i class="bi bi-trash3"></i>
            </button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}

{% if not income_sources %}
<div class="text-center py-5">
  <p class="text-muted mb-3">Источников доходов пока нет. Используйте кнопку "Добавить источник дохода" выше для создания первого источника.</p>
</div>
{% endif %}

<!-- Модальное окно добавления источника дохода -->
<div class="modal fade" id="addIncomeSourceModal" tabindex="-1" aria-labelledby="addIncomeSourceModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addIncomeSourceModalLabel">
          <i class="bi bi-plus-circle text-success me-2"></i>Новый источник дохода
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('budget.add_income_source') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Название источника</label>
            <input type="text" name="name" class="form-control" placeholder="Например, Основная работа" required>
            <div class="form-text">Укажите название источника дохода</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-success">
            <i class="bi bi-plus me-1"></i>Создать источник
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Модальные окна для редактирования категорий -->
{% for cat in expense_categories %}
<div class="modal fade" id="editModal{{ cat.id }}" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Редактировать категорию «{{ cat.name }}»</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('budget.edit_category', category_id=cat.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <input type="hidden" name="is_multi_source" value="{{ '1' if cat.is_multi_source else '0' }}">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Название</label>
            <input type="text" name="name" class="form-control" value="{{ cat.name }}" required>
          </div>
          <div class="row g-3">
            <div class="col-6">
              <label class="form-label">Тип лимита</label>
              <select name="limit_type" class="form-select" required>
                <option value="fixed" {% if cat.limit_type == 'fixed' %}selected{% endif %}>Фиксированная сумма</option>
                <option value="percent" {% if cat.limit_type == 'percent' %}selected{% endif %}>Процент от дохода</option>
              </select>
            </div>
            <div class="col-6" id="editValueField{{ cat.id }}" {% if cat.is_multi_source %}style="display: none;"{% endif %}>
              <label class="form-label">Размер лимита</label>
              <input type="number" name="value" step="0.01" min="0.01" class="form-control" 
                     value="{{ cat.value }}" {% if not cat.is_multi_source %}required{% endif %}>
            </div>
          </div>
          
          <!-- Многоисточниковый режим -->
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="multiSourceSwitch{{ cat.id }}" 
                     {% if cat.is_multi_source %}checked{% endif %}
                     onchange="toggleMultiSourceMode({{ cat.id }}, this.checked)">
              <label class="form-check-label" for="multiSourceSwitch{{ cat.id }}">
                <strong>Многоисточниковая категория</strong>
              </label>
            </div>
            <div class="form-text">
              Позволяет настроить получение лимита из нескольких источников дохода с разными процентами
            </div>
          </div>

          <!-- Источник дохода (только для обычных категорий) -->
          <div class="mb-3" id="singleSourceDiv{{ cat.id }}" {% if cat.is_multi_source %}style="display: none;"{% endif %}>
            <label class="form-label">Источник дохода</label>
            <select name="source_id" class="form-select">
              <option value="">— Не привязан к источнику —</option>
              {% for source in income_sources %}
                <option value="{{ source.id }}" 
                        {% if rules_map.get(cat.id) == source.id %}selected{% endif %}>
                  {{ source.name }}
                </option>
              {% endfor %}
            </select>
            <div class="form-text">Выберите источник дохода, который будет использоваться для финансирования этой категории</div>
          </div>

          <!-- Управление многоисточниковыми связями -->
          <div class="mb-3" id="multiSourceInfo{{ cat.id }}" {% if not cat.is_multi_source %}style="display: none;"{% endif %}>
            <h6 class="mb-3">
              <i class="bi bi-list-ul me-2"></i>Настройка источников:
            </h6>
            
            {% set cat_sources = multi_source_links.get(cat.id, []) %}
            {% if cat_sources %}
            <div class="income-sources-list mb-3">
              {% for source_info in cat_sources %}
              <div class="income-source-item">
                <div class="source-info">
                  <div class="source-title">{{ source_info.source_name }}</div>
                  <div class="source-meta">Источник дохода</div>
                </div>
                
                <div class="source-amount">
                  <form method="POST" action="{{ url_for('budget.update_source_percentage', cat_id=cat.id) }}" class="d-inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="source_id" value="{{ source_info.source_id }}">
                    <div class="percentage-input">
                      <input type="number" name="percentage" value="{{ source_info.percentage }}" 
                             min="0.01" max="100" step="0.01" class="percentage-field tabular-nums" 
                             onchange="this.form.submit()">
                      <span class="percentage-symbol">%</span>
                    </div>
                  </form>
                </div>
                
                <div class="source-actions">
                  <form method="POST" action="{{ url_for('budget.remove_source_from_category', cat_id=cat.id, source_id=source_info.source_id) }}" class="d-inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="action-btn action-btn--delete"
                            onclick="return confirm('Убрать источник {{ source_info.source_name }} из категории?')" 
                            title="Удалить" aria-label="Удалить источник {{ source_info.source_name }}">
                      <i class="bi bi-trash3"></i>
                    </button>
                  </form>
                </div>
              </div>
              {% endfor %}
              
              <!-- Итоговая строка -->
              <div class="income-source-total">
                <div class="source-info">
                  <div class="source-title">Общий процент:</div>
                </div>
                
                <div class="source-amount">
                  {% set total_percent = cat_sources | sum(attribute='percentage') %}
                  <span class="total-amount tabular-nums">{{ "%.1f"|format(total_percent) }}%</span>
                </div>
                
                <div class="source-status">
                  {% if total_percent > 100 %}
                    <small class="text-warning">
                      <i class="bi bi-exclamation-triangle"></i>
                      Превышен лимит 100%
                    </small>
                  {% elif total_percent == 0 %}
                    <small class="text-muted">
                      <i class="bi bi-info-circle"></i>
                      Добавьте источники
                    </small>
                  {% else %}
                    <small class="text-success">
                      <i class="bi bi-check-circle"></i>
                      Корректно
                    </small>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endif %}
            
            <!-- Добавить новый источник -->
            <div class="border-top pt-3">
              <h6 class="mb-3">
                <i class="bi bi-plus-circle me-2"></i>Добавить источник:
              </h6>
              <form method="POST" action="{{ url_for('budget.add_source_to_category', cat_id=cat.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="row g-3 align-items-end">
                  <div class="col-md-6">
                    <label class="form-label">Источник дохода</label>
                    <select name="source_id" class="form-select" required>
                      <option value="">— Выберите источник —</option>
                      {% for source in income_sources %}
                        <!-- Показываем только источники, которые еще не добавлены -->
                        {% set already_added = false %}
                        {% for source_info in cat_sources %}
                          {% if source_info.source_id == source.id %}
                            {% set already_added = true %}
                          {% endif %}
                        {% endfor %}
                        {% if not already_added %}
                          <option value="{{ source.id }}">{{ source.name }}</option>
                        {% endif %}
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Процент</label>
                    <div class="input-group">
                      <input type="number" name="percentage" min="0.01" max="100" step="0.01" 
                             class="form-control" placeholder="0.0" required>
                      <span class="input-group-text">%</span>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <button type="submit" class="btn btn-success w-100">
                      <i class="bi bi-plus"></i>
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary">Сохранить изменения</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}

<!-- Модальные окна для управления многоисточниковыми категориями -->
{% for cat in expense_categories %}
{% if cat.is_multi_source %}
<div class="modal fade" id="multiSourceModal{{ cat.id }}" tabindex="-1">
  <div class="modal-dialog modal-lg modal-sources">
    <div class="modal-content">
      <div class="modal-header sources-header">
        <div class="header-content">
          <i class="bi bi-diagram-3 header-icon"></i>
          <h5 class="modal-title">Настройка источников</h5>
        </div>
        <button type="button" class="btn-close sources-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body">
        
        <!-- Текущие источники -->
        {% set cat_sources = multi_source_links.get(cat.id, []) %}
        {% if cat_sources %}
        <div class="mb-4">
          <h6 class="mb-3">
            <i class="bi bi-list-ul me-2"></i>Текущие источники:
          </h6>
          <div class="income-sources-list">
            {% for source_info in cat_sources %}
            <div class="income-source-item">
              <div class="source-info">
                <div class="source-title">{{ source_info.source_name }}</div>
                <div class="source-meta">Источник дохода</div>
              </div>
              
              <div class="source-amount">
                <form method="POST" action="{{ url_for('budget.update_source_percentage', cat_id=cat.id) }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                  <input type="hidden" name="source_id" value="{{ source_info.source_id }}">
                  <div class="percentage-input">
                    <input type="number" name="percentage" value="{{ source_info.percentage }}" 
                           min="0.01" max="100" step="0.01" class="percentage-field tabular-nums" 
                           onchange="this.form.submit()">
                    <span class="percentage-symbol">%</span>
                  </div>
                </form>
              </div>
              
              <div class="source-actions">
                <form method="POST" action="{{ url_for('budget.remove_source_from_category', cat_id=cat.id, source_id=source_info.source_id) }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                  <button type="submit" class="action-btn action-btn--delete"
                          onclick="return confirm('Убрать источник {{ source_info.source_name }} из категории?')" 
                          title="Удалить" aria-label="Удалить источник {{ source_info.source_name }}">
                    <i class="bi bi-trash3"></i>
                  </button>
                </form>
              </div>
            </div>
            {% endfor %}
            
            <!-- Итоговая строка -->
            <div class="income-source-total">
              <div class="source-info">
                <div class="source-title">Общий процент:</div>
              </div>
              
              <div class="source-amount">
                {% set total_percent = cat_sources | sum(attribute='percentage') %}
                <span class="total-amount tabular-nums">{{ "%.1f"|format(total_percent) }}%</span>
              </div>
              
              <div class="source-status">
                {% if total_percent > 100 %}
                  <small class="text-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    Превышен лимит 100%
                  </small>
                {% elif total_percent == 0 %}
                  <small class="text-muted">
                    <i class="bi bi-info-circle"></i>
                    Добавьте источники
                  </small>
                {% else %}
                  <small class="text-success">
                    <i class="bi bi-check-circle"></i>
                    Корректно
                  </small>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Добавить новый источник -->
        <div class="border-top pt-4">
          <h6 class="mb-3">
            <i class="bi bi-plus-circle me-2"></i>Добавить источник:
          </h6>
          <form method="POST" action="{{ url_for('budget.add_source_to_category', cat_id=cat.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="row g-3 align-items-end">
              <div class="col-md-6">
                <label class="form-label">Источник дохода</label>
                <select name="source_id" class="form-select" required>
                  <option value="">— Выберите источник —</option>
                  {% for source in income_sources %}
                    <!-- Показываем только источники, которые еще не добавлены -->
                    {% set already_added = false %}
                    {% for source_info in cat_sources %}
                      {% if source_info.source_id == source.id %}
                        {% set already_added = true %}
                      {% endif %}
                    {% endfor %}
                    {% if not already_added %}
                      <option value="{{ source.id }}">{{ source.name }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Процент</label>
                <div class="input-group">
                  <input type="number" name="percentage" class="form-control" 
                         min="0.01" max="100" step="0.01" placeholder="15.0" required>
                  <span class="input-group-text">%</span>
                </div>
              </div>
              <div class="col-md-2">
                <div data-bs-toggle="tooltip" data-bs-title="Добавить">
                  <button type="submit" class="btn btn-success btn-sm w-100">
                    <i class="bi bi-plus"></i> <span class="btn-text">Добавить</span>
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>

        {% if not cat_sources %}
        <div class="alert alert-info mt-3">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Совет:</strong> Добавьте источники дохода с процентами для этой категории. 
          Например: ЗП - 70%, Аванс - 30%.
        </div>
        {% endif %}

      </div>
      <div class="modal-footer sources-footer">
        <div class="footer-actions">
          <button type="button" class="btn btn-secondary cb-btn" data-bs-dismiss="modal">
            <i class="bi bi-x me-1"></i>Закрыть
          </button>
          <form method="POST" action="{{ url_for('budget.toggle_multi_source', cat_id=cat.id) }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="btn btn-warning cb-btn" 
                    onclick="return confirm('Отключить многоисточниковый режим? Все связи будут удалены.')"
                    aria-label="Отключить многоисточниковый режим">
              <i class="bi bi-toggle-off me-1"></i>Отключить режим
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endfor %}

{% endblock %}

{% block page_css %}
<style>
/* Стили для списка источников дохода */
.income-sources-list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  max-width: 100%;
}

.income-source-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem 1.25rem;
  background: var(--bs-body-bg);
  border: 1px solid var(--bs-border-color);
  border-radius: 0.75rem;
  min-height: 76px;
  transition: all 0.2s ease;
}

.income-source-item:hover {
  border-color: var(--bs-primary);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.income-source-total {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem 1.25rem;
  background: var(--bs-light);
  border: 1px solid var(--bs-border-color);
  border-radius: 0.75rem;
  min-height: 76px;
  margin-top: 0.5rem;
}

.source-info {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.source-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--bs-body-color);
  line-height: 1.3;
  margin: 0;
}

.source-meta {
  font-size: 0.875rem;
  color: var(--bs-secondary-color);
  line-height: 1.2;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.source-amount {
  flex-shrink: 0;
  text-align: right;
}

.percentage-input {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.percentage-field {
  width: 80px;
  padding: 0.5rem;
  border: 1px solid var(--bs-border-color);
  border-radius: 0.375rem;
  text-align: right;
  font-size: 1rem;
  font-weight: 500;
  background: var(--bs-body-bg);
  color: var(--bs-body-color);
}

.percentage-field:focus {
  border-color: var(--bs-primary);
  box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
  outline: 0;
}

.percentage-symbol {
  font-size: 1rem;
  font-weight: 500;
  color: var(--bs-secondary-color);
}

.total-amount {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--bs-body-color);
}

.source-actions {
  flex-shrink: 0;
  display: flex;
  gap: 0.5rem;
}

.action-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 44px;
  height: 44px;
  padding: 0;
  border: 1px solid var(--bs-border-color);
  border-radius: 0.5rem;
  background: var(--bs-body-bg);
  color: var(--bs-body-color);
  text-decoration: none;
  transition: all 0.2s ease;
  cursor: pointer;
  font-size: 1.125rem;
}

.action-btn:hover {
  background: var(--bs-secondary-bg);
  border-color: var(--bs-secondary);
  color: var(--bs-body-color);
}

.action-btn--delete:hover {
  background: var(--bs-danger);
  border-color: var(--bs-danger);
  color: white;
}

.source-status {
  flex-shrink: 0;
  text-align: right;
  min-width: 120px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .income-source-item,
  .income-source-total {
    flex-direction: column;
    align-items: stretch;
    gap: 0.75rem;
    padding: 1rem;
  }
  
  .source-info {
    text-align: left;
  }
  
  .source-amount,
  .source-status {
    text-align: left;
  }
  
  .source-actions {
    justify-content: flex-end;
  }
  
  .percentage-input {
    justify-content: flex-start;
  }
  
  /* Мобильная оптимизация модальных окон */
  .modal-dialog {
    margin: 0.5rem !important;
    max-width: calc(100vw - 1rem) !important;
  }
  
  .modal-dialog.modal-lg {
    max-width: calc(100vw - 1rem) !important;
  }
  
  .modal-content {
    border-radius: 1rem;
    border: none;
    box-shadow: 0 0.5rem 2rem rgba(0, 0, 0, 0.15);
  }
  
  .modal-header {
    padding: 1rem 1rem 0.5rem;
    border-bottom: none;
  }
  
  .modal-body {
    padding: 0.5rem 1rem;
    max-height: calc(100vh - 200px);
    overflow-y: auto;
  }
  
  .modal-footer {
    padding: 0.5rem 1rem 1rem;
    border-top: none;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  
  .modal-title {
    font-size: 1.1rem;
    line-height: 1.3;
  }
  
  /* Улучшения для форм в модалках */
  .form-label {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.375rem;
  }
  
  .form-control,
  .form-select {
    font-size: 1rem;
    padding: 0.75rem;
  }
  
  .input-group-text {
    font-size: 0.9rem;
  }
  
  /* Кнопки в footer */
  .modal-footer .btn {
    flex: 1;
    min-width: auto;
    font-size: 0.9rem;
    padding: 0.75rem;
  }
  
  .modal-footer .btn:not(:last-child) {
    margin-right: 0;
  }
  
  /* Компактные элементы формы */
  .row.g-3 {
    --bs-gutter-x: 0.75rem;
    --bs-gutter-y: 0.75rem;
  }
  
  .mb-3 {
    margin-bottom: 1rem !important;
  }
  
  /* Улучшения для списка источников в модалке */
  .income-sources-list {
    gap: 0.5rem;
  }
  
  .income-source-item,
  .income-source-total {
    padding: 0.75rem;
    min-height: auto;
  }
  
  .source-title {
    font-size: 1rem;
  }
  
  .source-meta {
    font-size: 0.8rem;
  }
  
  .percentage-field {
    width: 70px;
    padding: 0.375rem;
    font-size: 0.9rem;
  }
  
  .action-btn {
    width: 40px;
    height: 40px;
    font-size: 1rem;
  }
  
  /* Свертывание больших форм */
  .alert {
    padding: 0.75rem;
    font-size: 0.875rem;
  }
  
  .form-text {
    font-size: 0.8rem;
  }
  
  /* Кнопки добавления источника */
  .col-md-6 {
    width: 100%;
    max-width: 100%;
  }
  
  .col-md-4 {
    width: 100%;
    max-width: 100%;
  }
  
  .col-md-2 {
    width: 100%;
    max-width: 100%;
  }
}

/* Дополнительные улучшения для очень маленьких экранов */
@media (max-width: 480px) {
  .modal-dialog {
    margin: 0.25rem !important;
    max-width: calc(100vw - 0.5rem) !important;
  }
  
  .modal-header {
    padding: 0.75rem 0.75rem 0.25rem;
    position: sticky;
    top: 0;
    background: var(--bs-body-bg);
    z-index: 1;
  }
  
  .modal-body {
    padding: 0.25rem 0.75rem;
    max-height: calc(100vh - 140px);
  }
  
  .modal-footer {
    padding: 0.25rem 0.75rem 0.75rem;
    position: sticky;
    bottom: 0;
    background: var(--bs-body-bg);
    z-index: 1;
  }
  
  .modal-title {
    font-size: 1rem;
    line-height: 1.2;
  }
  
  .btn-close {
    padding: 0.25rem;
    margin: 0;
  }
  
  /* Компактные формы */
  .income-source-item,
  .income-source-total {
    padding: 0.5rem;
    border-radius: 0.5rem;
  }
  
  .source-title {
    font-size: 0.95rem;
  }
  
  .source-meta {
    font-size: 0.75rem;
  }
  
  .percentage-field {
    width: 60px;
    padding: 0.25rem;
    font-size: 0.85rem;
  }
  
  .action-btn {
    width: 36px;
    height: 36px;
    font-size: 0.9rem;
  }
  
  .form-control,
  .form-select {
    font-size: 0.9rem;
    padding: 0.5rem;
  }
  
  .modal-footer .btn {
    font-size: 0.85rem;
    padding: 0.5rem;
  }
  
  /* Свертывание отступов */
  .mb-3 {
    margin-bottom: 0.75rem !important;
  }
  
  .alert {
    padding: 0.5rem;
    font-size: 0.8rem;
  }
  
  .form-text {
    font-size: 0.75rem;
    margin-top: 0.25rem;
  }
  
  /* Фиксированная высота для скроллинга */
  .income-sources-list {
    max-height: 40vh;
    overflow-y: auto;
  }
}

/* Ландшафтная ориентация на мобильных */
@media (max-width: 768px) and (orientation: landscape) {
  .modal-body {
    max-height: calc(100vh - 120px);
  }
  
  .income-sources-list {
    max-height: 30vh;
  }
}

/* Dark theme adjustments */
@media (prefers-color-scheme: dark) {
  .income-source-item:hover {
    box-shadow: 0 2px 8px rgba(255,255,255,0.1);
  }
}

[data-bs-theme="dark"] .income-source-item:hover {
  box-shadow: 0 2px 8px rgba(255,255,255,0.1);
}

/* Tabular numbers for better alignment */
.tabular-nums {
  font-feature-settings: "tnum";
  font-variant-numeric: tabular-nums;
}

/* Мобильные стили для модалки источников */
.modal-sources .modal-dialog {
  margin: 0.5rem;
  max-width: calc(100vw - 1rem);
}

.sources-header {
  padding: 1rem 1rem 0.75rem;
  border-bottom: 1px solid var(--bs-border-color);
  position: sticky;
  top: 0;
  background: var(--bs-body-bg);
  z-index: 10;
}

.header-content {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex: 1;
}

.header-icon {
  font-size: 1.25rem;
  color: var(--bs-primary);
}

.sources-close {
  padding: 0.5rem;
  margin: 0;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.sources-footer {
  padding: 0.75rem 1rem 1rem;
  border-top: 1px solid var(--bs-border-color);
  position: sticky;
  bottom: 0;
  background: var(--bs-body-bg);
  z-index: 10;
}

.footer-actions {
  display: flex;
  gap: 0.75rem;
  align-items: center;
  flex-wrap: wrap;
}

.footer-actions .btn {
  flex: 1;
  min-width: 120px;
  height: 44px;
  font-weight: 500;
  border-radius: 0.75rem;
}

.cb-btn {
  transition: all 0.2s ease;
  border-radius: 0.75rem;
}

/* Мобильная адаптация модалки источников */
@media (max-width: 768px) {
  .modal-sources .modal-dialog {
    margin: 0.25rem;
    max-width: calc(100vw - 0.5rem);
    height: calc(100vh - 0.5rem);
  }
  
  .modal-sources .modal-content {
    height: 100%;
    border-radius: 1rem;
    border: none;
    display: flex;
    flex-direction: column;
  }
  
  .modal-sources .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem 1rem;
  }
  
  .sources-header {
    padding: 0.75rem 1rem 0.5rem;
    flex-shrink: 0;
  }
  
  .sources-footer {
    padding: 0.75rem 1rem;
    flex-shrink: 0;
  }
  
  .footer-actions {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .footer-actions .btn {
    width: 100%;
    min-width: auto;
  }
  
  .modal-title {
    font-size: 1.1rem;
    font-weight: 600;
  }
  
  /* Компактные карточки на мобиле */
  .income-sources-list {
    gap: 0.5rem;
  }
  
  .income-source-item {
    padding: 0.75rem;
    border-radius: 0.75rem;
  }
  
  .source-title {
    font-size: 1rem;
    font-weight: 600;
  }
  
  .percentage-field {
    width: 70px;
    font-size: 0.9rem;
  }
  
  .action-btn {
    width: 40px;
    height: 40px;
  }
}

@media (max-width: 480px) {
  .modal-sources .modal-dialog {
    margin: 0;
    max-width: 100vw;
    height: 100vh;
  }
  
  .modal-sources .modal-content {
    border-radius: 0;
  }
  
  .sources-header,
  .sources-footer {
    padding: 0.5rem 0.75rem;
  }
  
  .modal-sources .modal-body {
    padding: 0.5rem 0.75rem;
  }
  
  .modal-title {
    font-size: 1rem;
  }
  
  .header-icon {
    font-size: 1.125rem;
  }
}
</style>
{% endblock %}

{% block page_js %}
<script>
// Переключение полей в форме создания категории
function toggleNewCategorySourceField(enabled) {
  const singleSourceField = document.getElementById('singleSourceField');
  const multiSourceConfig = document.getElementById('multiSourceConfig');
  const limitFields = document.getElementById('limitFields');
  
  if (enabled) {
    singleSourceField.style.display = 'none';
    multiSourceConfig.style.display = 'block';
    limitFields.style.display = 'none';
    // Убираем обязательность полей лимита
    const limitSelect = limitFields.querySelector('select[name="limit_type"]');
    const limitInput = limitFields.querySelector('input[name="value"]');
    if (limitSelect) limitSelect.removeAttribute('required');
    if (limitInput) limitInput.removeAttribute('required');
  } else {
    singleSourceField.style.display = 'block';
    multiSourceConfig.style.display = 'none';
    limitFields.style.display = 'block';
    // Возвращаем обязательность полей лимита
    const limitSelect = limitFields.querySelector('select[name="limit_type"]');
    const limitInput = limitFields.querySelector('input[name="value"]');
    if (limitSelect) limitSelect.setAttribute('required', 'required');
    if (limitInput) limitInput.setAttribute('required', 'required');
    // Сбрасываем все чекбоксы и проценты
    document.querySelectorAll('.multi-source-checkbox').forEach(checkbox => {
      checkbox.checked = false;
    });
    document.querySelectorAll('.source-percentage').forEach(input => {
      input.disabled = true;
      input.value = '';
    });
    updateTotalPercentage();
  }
}

// Включение/отключение поля процента для источника
function toggleSourcePercentage(checkbox, sourceId) {
  const percentageInput = document.querySelector(`input[name="source_percentage_${sourceId}"]`);
  if (percentageInput) {
    percentageInput.disabled = !checkbox.checked;
    if (!checkbox.checked) {
      percentageInput.value = '';
    }
    updateTotalPercentage();
  }
}

// Обновление общего процента
function updateTotalPercentage() {
  let total = 0;
  document.querySelectorAll('.source-percentage:not([disabled])').forEach(input => {
    const value = parseFloat(input.value) || 0;
    total += value;
  });
  
  const totalSpan = document.getElementById('totalPercentage');
  const warningSpan = document.getElementById('percentageWarning');
  
  if (totalSpan) {
    totalSpan.textContent = total.toFixed(1);
  }
  
  if (warningSpan) {
    if (total !== 100 && total > 0) {
      warningSpan.style.display = 'inline';
    } else {
      warningSpan.style.display = 'none';
    }
  }
}

// Добавить слушатели для полей процентов
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.source-percentage').forEach(input => {
    input.addEventListener('input', updateTotalPercentage);
  });
});

let newCategorySourceCounter = 0;

// Добавление источника в форму создания категории
function addSourceToNewCategory() {
  const sourcesList = document.getElementById('sourcesList');
  
  const sourceDiv = document.createElement('div');
  sourceDiv.className = 'row g-2 align-items-center mb-2';
  sourceDiv.id = `newSource${newCategorySourceCounter}`;
  
  // Создаем опции для select из данных, переданных с сервера
  let sourcesOptions = '<option value="">— Выберите источник —</option>';
  {% for source in income_sources %}
    sourcesOptions += '<option value="{{ source.id }}">{{ source.name }}</option>';
  {% endfor %}
  
  sourceDiv.innerHTML = `
    <div class="col-6">
      <select name="multi_sources[${newCategorySourceCounter}][source_id]" class="form-select form-select-sm" required>
        ${sourcesOptions}
      </select>
    </div>
    <div class="col-4">
      <div class="input-group input-group-sm">
        <input type="number" name="multi_sources[${newCategorySourceCounter}][percentage]" 
               class="form-control" min="0.01" max="100" step="0.01" placeholder="15.0" required>
        <span class="input-group-text">%</span>
      </div>
    </div>
    <div class="col-2">
      <button type="button" class="ff-iconbtn ff-iconbtn--delete" 
              onclick="removeSourceFromNew(${newCategorySourceCounter})" title="Удалить">
        <i class="bi bi-trash3"></i>
      </button>
    </div>
  `;
  
  sourcesList.appendChild(sourceDiv);
  newCategorySourceCounter++;
}

// Удаление источника из формы создания
function removeSourceFromNew(index) {
  const sourceDiv = document.getElementById(`newSource${index}`);
  if (sourceDiv) {
    sourceDiv.remove();
  }
}

// Переключение многоисточникового режима
function toggleMultiSourceMode(categoryId, enabled) {
  console.log('Toggle multi-source mode:', categoryId, enabled);
  
  // Показываем/скрываем соответствующие поля в форме
  const singleSourceDiv = document.getElementById(`singleSourceDiv${categoryId}`);
  const multiSourceInfo = document.getElementById(`multiSourceInfo${categoryId}`);
  
  if (enabled) {
    if (singleSourceDiv) singleSourceDiv.style.display = 'none';
    if (multiSourceInfo) multiSourceInfo.style.display = 'block';
  } else {
    if (singleSourceDiv) singleSourceDiv.style.display = 'block';
    if (multiSourceInfo) multiSourceInfo.style.display = 'none';
  }
  
  // НЕ отправляем AJAX запрос сразу - изменения сохранятся при сабмите формы
  // Обновляем скрытое поле с режимом, если оно есть
  const hiddenModeField = document.querySelector(`#editModal${categoryId} input[name="is_multi_source"]`);
  if (hiddenModeField) {
    hiddenModeField.value = enabled ? '1' : '0';
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // Initialize Bootstrap tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
  
  // Prevent double-click submissions
  function preventDoubleSubmit() {
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
      form.addEventListener('submit', function(e) {
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn && !submitBtn.disabled) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<i class="bi bi-hourglass"></i> Обработка...';
          // Re-enable after 3 seconds as fallback
          setTimeout(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = submitBtn.getAttribute('data-original-text') || 'Отправить';
          }, 3000);
        }
      });
      
      // Store original button text
      const submitBtn = form.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.setAttribute('data-original-text', submitBtn.innerHTML);
      }
    });
  }
  
  preventDoubleSubmit();
});
</script>
{% endblock %}