{% extends "base.html" %}
{% block title %}Категории — CrystalBudget{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
  <h2 class="h4 m-0"><i class="bi bi-dash-circle text-primary me-2"></i>Категории расходов</h2>
  <button type="button" class="btn-hero icon-only"
          data-modal-url="{{ url_for('budget.category_add_modal') }}"
          data-modal-title="Добавить категорию"
          data-modal-size="md"
          title="Добавить категорию" aria-label="Добавить категорию">
    <i class="bi bi-plus-lg"></i>
    <span class="visually-hidden">Добавить категорию</span>
  </button>
</div>

<!-- Навигация по месяцам -->
{% if month_data %}
<div class="period-filter">
    <div class="period-info">
        <i class="bi bi-calendar3 icon"></i>
        <span class="label">Период:</span>
        <strong class="value">{{ month_data.current_month_name }}</strong>
        {% if not month_data.is_current_month %}
            <span class="period-badge">Архив</span>
        {% endif %}
        {% if spent_by_category %}
            <span class="period-badge">(траты учтены)</span>
        {% endif %}
    </div>
    <div class="period-nav">
        <a href="{{ url_for('budget.categories', month=month_data.prev_month) }}"
           class="period-btn" title="Предыдущий месяц">
            <i class="bi bi-chevron-left"></i>
        </a>
        <a href="{{ url_for('budget.categories') }}"
           class="period-btn current" title="Текущий месяц">
            <i class="bi bi-house"></i>
        </a>
        <a href="{{ url_for('budget.categories', month=month_data.next_month) }}"
           class="period-btn" title="Следующий месяц">
            <i class="bi bi-chevron-right"></i>
        </a>
    </div>
</div>
{% endif %}

<!-- Категории трат -->
{% if expense_categories %}
<section class="ff-progress-card mb-4" aria-label="Категории расходов">
  <div class="ff-header">
    <i class="bi bi-dash-circle"></i>
    Всего категорий: {{ expense_categories|length }}
  </div>
  <div class="ff-list">
    {% for cat in expense_categories %}
    <div class="category-row">
      <!-- Левая колонка: название и тип -->
      <div class="category-info">
        <div class="category-name">{{ cat.name }}</div>
        {% if cat.is_multi_source %}
        <div class="category-meta">
          <span class="badge-ghost">
            <i class="bi bi-diagram-3 me-1"></i>Мультиисточник
          </span>
        </div>
        {% else %}
        <div class="category-meta">
          {% set source_id = rules_map.get(cat.id) %}
          {% if source_id %}
            {% for source in income_sources %}
              {% if source.id == source_id %}
                <span class="badge-ghost">{{ source.name }}</span>
              {% endif %}
            {% endfor %}
          {% else %}
            <span class="text-muted">Источник не указан</span>
          {% endif %}
        </div>
        {% endif %}
      </div>
      
      <!-- Центральная колонка: детали источников (для мультиисточника) -->
      <div class="category-sources">
        {% if cat.is_multi_source %}
          {% set cat_sources = multi_source_links.get(cat.id, []) %}
          {% if cat_sources and cat_sources|length > 0 %}
            <div class="d-flex flex-wrap gap-1">
              {% for source_info in cat_sources %}
                <span class="badge-ghost" title="{{ source_info.percentage }}% от {{ source_info.source_name }}">
                  {{ source_info.source_name }}: {{ source_info.percentage }}%
                </span>
              {% endfor %}
            </div>
          {% else %}
            <span class="text-warning small">
              <i class="bi bi-exclamation-triangle me-1"></i>Настройте источники
            </span>
          {% endif %}
        {% endif %}
      </div>
      
      <!-- Правая колонка: лимит и действия -->
      <div class="category-limit">
        <div class="limit-value">
          {% if cat.limit_type == 'percent' %}
            {% if cat.is_multi_source %}
              <span class="limit-amount tabular-nums">Процентный</span>
              <span class="limit-type">от источников</span>
            {% else %}
              <span class="limit-amount tabular-nums">{{ cat.value|format_amount }}%</span>
              <span class="limit-type">от дохода</span>
            {% endif %}
          {% else %}
            <span class="limit-amount tabular-nums">{{ cat.value|format_amount }} ₽</span>
            <span class="limit-type">фикс</span>
          {% endif %}
        </div>
        <div class="ff-iconbtn-group" role="group" aria-label="Действия">
          <button type="button" class="ff-iconbtn ff-iconbtn--edit"
                  data-modal-url="{{ url_for('budget.category_edit_modal', category_id=cat.id) }}"
                  data-modal-title="Редактировать категорию"
                  data-modal-size="md"
                  aria-label="Редактировать категорию" title="Редактировать">
            <i class="bi bi-pencil"></i>
          </button>
          <form method="POST" action="{{ url_for('budget.delete_category', category_id=cat.id) }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="ff-iconbtn ff-iconbtn--delete"
                    data-confirm-delete="Удалить категорию «{{ cat.name }}»? Все расходы в этой категории также будут удалены."
                    aria-label="Удалить категорию" title="Удалить">
              <i class="bi bi-trash3"></i>
            </button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

</section>
{% endif %}

{% if not expense_categories %}
<div class="text-center py-5">
  <p class="text-muted mb-3">Категорий пока нет. Используйте кнопку "Добавить категорию" выше для создания первой категории.</p>
</div>
{% endif %}

{% endblock %}

{% block page_css %}
<style>
/* Компактная структура модалок */
.section-block {
  border-bottom: 1px solid var(--bs-border-color-translucent);
  padding-bottom: 1rem;
}

.section-block:last-child {
  border-bottom: none;
  padding-bottom: 0;
}

.section-title {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--bs-secondary-color);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 1rem;
}

/* Компактные поля формы */
.form-label {
  font-size: 0.875rem;
  font-weight: 500;
  margin-bottom: 0.375rem;
}

/* Переключатели-кнопки */
.btn-toggle-group {
  display: flex;
  border-radius: 0.5rem;
  overflow: hidden;
  border: 1px solid var(--bs-border-color);
}

.btn-toggle-group .btn-check {
  display: none;
}

.btn-toggle-group .btn {
  flex: 1;
  border: none;
  border-radius: 0;
  padding: 0.5rem 0.75rem;
  font-size: 0.875rem;
  font-weight: 500;
  background: var(--bs-body-bg);
  color: var(--bs-body-color);
  border-right: 1px solid var(--bs-border-color);
  transition: all 0.15s ease;
}

.btn-toggle-group .btn:last-child {
  border-right: none;
}

.btn-toggle-group .btn-check:checked + .btn {
  background: var(--bs-primary);
  color: white;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
}

.btn-toggle-group .btn:hover {
  background: var(--bs-primary-bg-subtle);
}

.btn-toggle-group .btn-check:checked + .btn:hover {
  background: var(--bs-primary);
}

/* Маленькие переключатели */
.btn-toggle-sm .btn {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
}

/* Компактная таблица источников */
.compact-sources-table {
  background: var(--bs-body-bg);
  border: 1px solid var(--bs-border-color);
  border-radius: 0.75rem;
  overflow: hidden;
}

.compact-sources-table .table {
  margin: 0;
}

.compact-sources-table th {
  background: var(--bs-secondary-bg);
  border: none;
  padding: 0.75rem;
  font-size: 0.875rem;
  color: var(--bs-secondary-color);
}

.compact-sources-table td {
  border: none;
  padding: 0.75rem;
  border-bottom: 1px solid var(--bs-border-color-translucent);
}

.compact-sources-table tfoot td {
  background: var(--bs-light);
  font-weight: 600;
}

/* Стики заголовок и футер */
.sticky-top {
  position: sticky;
  top: 0;
  z-index: 1020;
}

.sticky-bottom {
  position: sticky;
  bottom: 0;
  z-index: 1020;
}

/* Улучшенные модальные окна */
.modal-lg {
  max-width: 600px;
}

.modal-header {
  padding: 1.25rem 1.25rem 1rem;
}

.modal-body {
  padding: 0 1.25rem 1rem;
  max-height: calc(100vh - 200px);
  overflow-y: auto;
}

.modal-footer {
  padding: 1rem 1.25rem 1.25rem;
}

/* Стили для списка источников дохода */
.income-sources-list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  max-width: 100%;
}

.income-source-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem 1.25rem;
  background: var(--bs-body-bg);
  border: 1px solid var(--bs-border-color);
  border-radius: 0.75rem;
  min-height: 76px;
  transition: all 0.2s ease;
}

.income-source-item:hover {
  border-color: var(--bs-primary);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.income-source-total {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem 1.25rem;
  background: var(--bs-light);
  border: 1px solid var(--bs-border-color);
  border-radius: 0.75rem;
  min-height: 76px;
  margin-top: 0.5rem;
}

.source-info {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.source-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--bs-body-color);
  line-height: 1.3;
  margin: 0;
}

.source-meta {
  font-size: 0.875rem;
  color: var(--bs-secondary-color);
  line-height: 1.2;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.source-amount {
  flex-shrink: 0;
  text-align: right;
}

.percentage-input {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.percentage-field {
  width: 80px;
  padding: 0.5rem;
  border: 1px solid var(--bs-border-color);
  border-radius: 0.375rem;
  text-align: right;
  font-size: 1rem;
  font-weight: 500;
  background: var(--bs-body-bg);
  color: var(--bs-body-color);
}

.percentage-field:focus {
  border-color: var(--bs-primary);
  box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
  outline: 0;
}

.percentage-symbol {
  font-size: 1rem;
  font-weight: 500;
  color: var(--bs-secondary-color);
}

.total-amount {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--bs-body-color);
}

.source-actions {
  flex-shrink: 0;
  display: flex;
  gap: 0.5rem;
}

.action-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 44px;
  height: 44px;
  padding: 0;
  border: 1px solid var(--bs-border-color);
  border-radius: 0.5rem;
  background: var(--bs-body-bg);
  color: var(--bs-body-color);
  text-decoration: none;
  transition: all 0.2s ease;
  cursor: pointer;
  font-size: 1.125rem;
}

.action-btn:hover {
  background: var(--bs-secondary-bg);
  border-color: var(--bs-secondary);
  color: var(--bs-body-color);
}

.action-btn--delete:hover {
  background: var(--bs-danger);
  border-color: var(--bs-danger);
  color: white;
}

.source-status {
  flex-shrink: 0;
  text-align: right;
  min-width: 120px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .income-source-item,
  .income-source-total {
    flex-direction: column;
    align-items: stretch;
    gap: 0.75rem;
    padding: 1rem;
  }
  
  .source-info {
    text-align: left;
  }
  
  .source-amount,
  .source-status {
    text-align: left;
  }
  
  .source-actions {
    justify-content: flex-end;
  }
  
  .percentage-input {
    justify-content: flex-start;
  }
  
  /* Мобильная оптимизация */
  .modal-dialog {
    margin: 0.5rem !important;
    max-width: calc(100vw - 1rem) !important;
  }
  
  .modal-dialog.modal-lg {
    max-width: calc(100vw - 1rem) !important;
  }
  
  .modal-content {
    border-radius: 1rem;
    border: none;
    box-shadow: 0 0.5rem 2rem rgba(0, 0, 0, 0.15);
    max-height: calc(100vh - 1rem);
    display: flex;
    flex-direction: column;
  }
  
  .modal-header {
    padding: 1rem 1rem 0.75rem;
    border-bottom: 1px solid var(--bs-border-color);
    flex-shrink: 0;
  }
  
  .modal-body {
    padding: 0.75rem 1rem;
    overflow-y: auto;
    flex: 1;
  }
  
  .modal-footer {
    padding: 0.75rem 1rem;
    border-top: 1px solid var(--bs-border-color);
    gap: 0.5rem;
    flex-shrink: 0;
  }
  
  .modal-title {
    font-size: 1.1rem;
    line-height: 1.3;
  }
  
  /* Полная ширина на мобиле */
  .col-lg-6 {
    width: 100%;
    max-width: 100%;
  }
  
  /* Компактные элементы управления */
  .btn-toggle-group .btn {
    padding: 0.375rem 0.5rem;
    font-size: 0.8rem;
  }
  
  .section-title {
    font-size: 0.8rem;
    margin-bottom: 0.75rem;
  }
  
  .section-block {
    padding-bottom: 0.75rem;
  }
  
  /* Компактная таблица источников */
  .compact-sources-table th,
  .compact-sources-table td {
    padding: 0.5rem 0.25rem;
    font-size: 0.8rem;
  }
  
  .compact-sources-table th:first-child,
  .compact-sources-table td:first-child {
    padding-left: 0.75rem;
  }
  
  .compact-sources-table th:last-child,
  .compact-sources-table td:last-child {
    padding-right: 0.75rem;
  }
  
  /* Строка добавления источника */
  .row.g-2 {
    --bs-gutter-x: 0.5rem;
    --bs-gutter-y: 0.5rem;
  }
  
  .input-group-sm .form-control,
  .input-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
  }
  
  /* Улучшения для форм в модалках */
  .form-label {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.375rem;
  }
  
  .form-control,
  .form-select {
    font-size: 1rem;
    padding: 0.75rem;
  }
  
  .input-group-text {
    font-size: 0.9rem;
  }
  
  /* Кнопки в footer */
  .modal-footer .btn {
    flex: 1;
    min-width: auto;
    font-size: 0.9rem;
    padding: 0.75rem;
  }
  
  .modal-footer .btn:not(:last-child) {
    margin-right: 0;
  }
  
  /* Компактные элементы формы */
  .row.g-3 {
    --bs-gutter-x: 0.75rem;
    --bs-gutter-y: 0.75rem;
  }
  
  .mb-3 {
    margin-bottom: 1rem !important;
  }
  
  /* Улучшения для списка источников в модалке */
  .income-sources-list {
    gap: 0.5rem;
  }
  
  .income-source-item,
  .income-source-total {
    padding: 0.75rem;
    min-height: auto;
  }
  
  .source-title {
    font-size: 1rem;
  }
  
  .source-meta {
    font-size: 0.8rem;
  }
  
  .percentage-field {
    width: 70px;
    padding: 0.375rem;
    font-size: 0.9rem;
  }
  
  .action-btn {
    width: 40px;
    height: 40px;
    font-size: 1rem;
  }
  
  /* Свертывание больших форм */
  .alert {
    padding: 0.75rem;
    font-size: 0.875rem;
  }
  
  .form-text {
    font-size: 0.8rem;
  }
  
  /* Кнопки добавления источника */
  .col-md-6 {
    width: 100%;
    max-width: 100%;
  }
  
  .col-md-4 {
    width: 100%;
    max-width: 100%;
  }
  
  .col-md-2,
  .col-md-3,
  .col-md-5,
  .col-md-1 {
    width: 100%;
    max-width: 100%;
  }
}

/* Дополнительные улучшения для очень маленьких экранов */
@media (max-width: 480px) {
  .modal-dialog {
    margin: 0.25rem !important;
    max-width: calc(100vw - 0.5rem) !important;
  }
  
  .modal-header {
    padding: 0.75rem 0.75rem 0.25rem;
    position: sticky;
    top: 0;
    background: var(--bs-body-bg);
    z-index: 1;
  }
  
  .modal-body {
    padding: 0.25rem 0.75rem;
    max-height: calc(100vh - 140px);
  }
  
  .modal-footer {
    padding: 0.25rem 0.75rem 0.75rem;
    position: sticky;
    bottom: 0;
    background: var(--bs-body-bg);
    z-index: 1;
  }
  
  .modal-title {
    font-size: 1rem;
    line-height: 1.2;
  }
  
  .btn-close {
    padding: 0.25rem;
    margin: 0;
  }
  
  /* Компактные формы */
  .income-source-item,
  .income-source-total {
    padding: 0.5rem;
    border-radius: 0.5rem;
  }
  
  .source-title {
    font-size: 0.95rem;
  }
  
  .source-meta {
    font-size: 0.75rem;
  }
  
  .percentage-field {
    width: 60px;
    padding: 0.25rem;
    font-size: 0.85rem;
  }
  
  .action-btn {
    width: 36px;
    height: 36px;
    font-size: 0.9rem;
  }
  
  .form-control,
  .form-select {
    font-size: 0.9rem;
    padding: 0.5rem;
  }
  
  .modal-footer .btn {
    font-size: 0.85rem;
    padding: 0.5rem;
  }
  
  /* Свертывание отступов */
  .mb-3 {
    margin-bottom: 0.75rem !important;
  }
  
  .alert {
    padding: 0.5rem;
    font-size: 0.8rem;
  }
  
  .form-text {
    font-size: 0.75rem;
    margin-top: 0.25rem;
  }
  
  /* Фиксированная высота для скроллинга */
  .income-sources-list {
    max-height: 40vh;
    overflow-y: auto;
  }
}

/* Ландшафтная ориентация на мобильных */
@media (max-width: 768px) and (orientation: landscape) {
  .modal-body {
    max-height: calc(100vh - 120px);
  }
  
  .income-sources-list {
    max-height: 30vh;
  }
}

/* Dark theme adjustments */
@media (prefers-color-scheme: dark) {
  .income-source-item:hover {
    box-shadow: 0 2px 8px rgba(255,255,255,0.1);
  }
}

[data-bs-theme="dark"] .income-source-item:hover {
  box-shadow: 0 2px 8px rgba(255,255,255,0.1);
}

/* Tabular numbers for better alignment */
.tabular-nums {
  font-feature-settings: "tnum";
  font-variant-numeric: tabular-nums;
}

/* Мобильные стили для модалки источников */
.modal-sources .modal-dialog {
  margin: 0.5rem;
  max-width: calc(100vw - 1rem);
}

.sources-header {
  padding: 1rem 1rem 0.75rem;
  border-bottom: 1px solid var(--bs-border-color);
  position: sticky;
  top: 0;
  background: var(--bs-body-bg);
  z-index: 10;
}

.header-content {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex: 1;
}

.header-icon {
  font-size: 1.25rem;
  color: var(--bs-primary);
}

.sources-close {
  padding: 0.5rem;
  margin: 0;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.sources-footer {
  padding: 0.75rem 1rem 1rem;
  border-top: 1px solid var(--bs-border-color);
  position: sticky;
  bottom: 0;
  background: var(--bs-body-bg);
  z-index: 10;
}

.footer-actions {
  display: flex;
  gap: 0.75rem;
  align-items: center;
  flex-wrap: wrap;
}

.footer-actions .btn {
  flex: 1;
  min-width: 120px;
  height: 44px;
  font-weight: 500;
  border-radius: 0.75rem;
}

.cb-btn {
  transition: all 0.2s ease;
  border-radius: 0.75rem;
}

/* Мобильная адаптация модалки источников */
@media (max-width: 768px) {
  .modal-sources .modal-dialog {
    margin: 0.25rem;
    max-width: calc(100vw - 0.5rem);
    height: calc(100vh - 0.5rem);
  }
  
  .modal-sources .modal-content {
    height: 100%;
    border-radius: 1rem;
    border: none;
    display: flex;
    flex-direction: column;
  }
  
  .modal-sources .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem 1rem;
  }
  
  .sources-header {
    padding: 0.75rem 1rem 0.5rem;
    flex-shrink: 0;
  }
  
  .sources-footer {
    padding: 0.75rem 1rem;
    flex-shrink: 0;
  }
  
  .footer-actions {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .footer-actions .btn {
    width: 100%;
    min-width: auto;
  }
  
  .modal-title {
    font-size: 1.1rem;
    font-weight: 600;
  }
  
  /* Компактные карточки на мобиле */
  .income-sources-list {
    gap: 0.5rem;
  }
  
  .income-source-item {
    padding: 0.75rem;
    border-radius: 0.75rem;
  }
  
  .source-title {
    font-size: 1rem;
    font-weight: 600;
  }
  
  .percentage-field {
    width: 70px;
    font-size: 0.9rem;
  }
  
  .action-btn {
    width: 40px;
    height: 40px;
  }
}

@media (max-width: 480px) {
  .modal-sources .modal-dialog {
    margin: 0;
    max-width: 100vw;
    height: 100vh;
  }
  
  .modal-sources .modal-content {
    border-radius: 0;
  }
  
  .sources-header,
  .sources-footer {
    padding: 0.5rem 0.75rem;
  }
  
  .modal-sources .modal-body {
    padding: 0.5rem 0.75rem;
  }
  
  .modal-title {
    font-size: 1rem;
  }
  
  .header-icon {
    font-size: 1.125rem;
  }
}
</style>
{% endblock %}

{% block page_js %}
<script>
// Инициализация модальной системы
document.addEventListener('DOMContentLoaded', () => {
  // ModalManager уже инициализирован автоматически, не нужно вызывать init()

  // Initialize confirm delete buttons
  document.querySelectorAll('[data-confirm-delete]').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const confirmText = this.getAttribute('data-confirm-delete');

      if (window.ModalManager) {
        window.ModalManager.confirm({
          title: 'Подтверждение удаления',
          message: confirmText,
          confirmText: 'Удалить',
          cancelText: 'Отмена'
        }).then(() => {
          // User confirmed, submit the form
          const form = this.closest('form');
          if (form) {
            form.submit();
          }
        });
      } else {
        // Fallback to native confirm
        if (confirm(confirmText)) {
          const form = this.closest('form');
          if (form) {
            form.submit();
          }
        }
      }
    });
  });
});

// Переключение полей в форме создания категории
function toggleNewCategorySourceField(enabled) {
  try {
    const singleSourceField = document.getElementById('singleSourceField');
    const multiSourceConfig = document.getElementById('multiSourceConfig');
    const limitTypeField = document.getElementById('limitTypeField');
    const addValueField = document.getElementById('addValueField'); // Исправленный ID
    
    if (enabled) {
      // Показываем многоисточниковые поля
      if (singleSourceField) singleSourceField.style.display = 'none';
      if (multiSourceConfig) multiSourceConfig.style.display = 'block';
      if (limitTypeField) limitTypeField.style.display = 'none';
      if (addValueField) addValueField.style.display = 'none';
      
      // Убираем обязательность полей лимита
      const valueInput = addValueField?.querySelector('input[name="value"]');
      const sourceSelect = singleSourceField?.querySelector('select[name="source_id"]');
      if (valueInput) {
        valueInput.removeAttribute('required');
        valueInput.disabled = true;
      }
      if (sourceSelect) {
        sourceSelect.disabled = true;
      }
    } else {
      // Показываем обычные поля
      if (singleSourceField) singleSourceField.style.display = 'block';
      if (multiSourceConfig) multiSourceConfig.style.display = 'none';
      if (limitTypeField) limitTypeField.style.display = 'block';
      if (addValueField) addValueField.style.display = 'block';
      
      // Возвращаем обязательность полей лимита
      const valueInput = addValueField?.querySelector('input[name="value"]');
      const sourceSelect = singleSourceField?.querySelector('select[name="source_id"]');
      if (valueInput) {
        valueInput.setAttribute('required', 'required');
        valueInput.disabled = false;
      }
      if (sourceSelect) {
        sourceSelect.disabled = false;
      }
      
      // Очищаем многоисточниковые данные
      clearMultiSourceList();
    }
  } catch (error) {
    console.error('Error in toggleNewCategorySourceField:', error);
  }
}

// Очистка списка многоисточниковых данных
function clearMultiSourceList() {
  try {
    const list = document.getElementById('multiSourceList');
    if (list) {
      list.innerHTML = '';
      updateMultiSourceTotal();
    }
  } catch (error) {
    console.error('Error in clearMultiSourceList:', error);
  }
}

// Включение/отключение поля процента для источника
function toggleSourcePercentage(checkbox, sourceId) {
  const percentageInput = document.querySelector(`input[name="source_percentage_${sourceId}"]`);
  if (percentageInput) {
    percentageInput.disabled = !checkbox.checked;
    if (!checkbox.checked) {
      percentageInput.value = '';
    }
    updateTotalPercentage();
  }
}

// Обновление общего процента
function updateTotalPercentage() {
  let total = 0;
  document.querySelectorAll('.source-percentage:not([disabled])').forEach(input => {
    const value = parseFloat(input.value) || 0;
    total += value;
  });
  
  const totalSpan = document.getElementById('totalPercentage');
  const warningSpan = document.getElementById('percentageWarning');
  
  if (totalSpan) {
    totalSpan.textContent = total.toFixed(1);
  }
  
  if (warningSpan) {
    if (total !== 100 && total > 0) {
      warningSpan.style.display = 'inline';
    } else {
      warningSpan.style.display = 'none';
    }
  }
}

// Добавить слушатели для полей процентов
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.source-percentage').forEach(input => {
    input.addEventListener('input', updateTotalPercentage);
  });
});

let newCategorySourceCounter = 0;

// Добавление источника в форму создания категории
function addSourceToNewCategory() {
  const sourcesList = document.getElementById('sourcesList');
  
  const sourceDiv = document.createElement('div');
  sourceDiv.className = 'row g-2 align-items-center mb-2';
  sourceDiv.id = `newSource${newCategorySourceCounter}`;
  
  // Создаем опции для select из данных, переданных с сервера
  const sourcesSelect = document.getElementById('newSourceSelect');
  let sourcesOptions = '<option value="">— Выберите источник —</option>';
  if (sourcesSelect) {
    const options = sourcesSelect.querySelectorAll('option');
    options.forEach(option => {
      if (option.value) {
        sourcesOptions += `<option value="${option.value}">${option.textContent}</option>`;
      }
    });
  }
  
  sourceDiv.innerHTML = `
    <div class="col-6">
      <select name="multi_sources[${newCategorySourceCounter}][source_id]" class="form-select form-select-sm" required>
        ${sourcesOptions}
      </select>
    </div>
    <div class="col-4">
      <div class="input-group input-group-sm">
        <input type="number" name="multi_sources[${newCategorySourceCounter}][percentage]" 
               class="form-control" min="0.01" max="100" step="0.01" placeholder="15.0" required>
        <span class="input-group-text">%</span>
      </div>
    </div>
    <div class="col-2">
      <button type="button" class="ff-iconbtn ff-iconbtn--delete" 
              onclick="removeSourceFromNew(${newCategorySourceCounter})" title="Удалить">
        <i class="bi bi-trash3"></i>
      </button>
    </div>
  `;
  
  sourcesList.appendChild(sourceDiv);
  newCategorySourceCounter++;
}

// Удаление источника из формы создания
function removeSourceFromNew(index) {
  const sourceDiv = document.getElementById(`newSource${index}`);
  if (sourceDiv) {
    sourceDiv.remove();
  }
}

// Переключение многоисточникового режима (только UI, сохранение через форму)
function toggleMultiSourceMode(categoryId, enabled) {
  try {
    console.log('Toggle multi-source mode:', categoryId, enabled);
    
    // Получаем элементы формы
    const singleSourceDiv = document.getElementById(`singleSourceDiv${categoryId}`);
    const multiSourceInfo = document.getElementById(`multiSourceInfo${categoryId}`);
    const limitTypeField = document.getElementById(`editLimitTypeField${categoryId}`);
    const limitValueField = document.getElementById(`editValueField${categoryId}`);
    
    if (enabled) {
      // Включаем многоисточниковый режим
      if (singleSourceDiv) singleSourceDiv.style.display = 'none';
      if (multiSourceInfo) multiSourceInfo.style.display = 'block';
      if (limitTypeField) limitTypeField.style.display = 'none';
      if (limitValueField) limitValueField.style.display = 'none';
      
      // Отключаем валидацию обычных полей
      const valueInput = limitValueField?.querySelector('input[name="value"]');
      const sourceSelect = singleSourceDiv?.querySelector('select[name="source_id"]');
      if (valueInput) {
        valueInput.removeAttribute('required');
        valueInput.disabled = true;
      }
      if (sourceSelect) {
        sourceSelect.disabled = true;
      }
    } else {
      // Отключаем многоисточниковый режим
      if (singleSourceDiv) singleSourceDiv.style.display = 'block';
      if (multiSourceInfo) multiSourceInfo.style.display = 'none';
      if (limitTypeField) limitTypeField.style.display = 'block';
      if (limitValueField) limitValueField.style.display = 'block';
      
      // Включаем валидацию обычных полей
      const valueInput = limitValueField?.querySelector('input[name="value"]');
      const sourceSelect = singleSourceDiv?.querySelector('select[name="source_id"]');
      if (valueInput) {
        valueInput.setAttribute('required', 'required');
        valueInput.disabled = false;
      }
      if (sourceSelect) {
        sourceSelect.disabled = false;
      }
    }
    
    // Обновляем скрытое поле с режимом (сохранение произойдет при сабмите формы)
    const hiddenModeField = document.querySelector(`#editModal${categoryId} input[name="is_multi_source"]`);
    if (hiddenModeField) {
      hiddenModeField.value = enabled ? '1' : '0';
    }
  } catch (error) {
    console.error('Error in toggleMultiSourceMode:', error);
  }
}

// Авто-переключение суффиксов в модалках
function setupLimitTypeToggle(modalId) {
  try {
    const modal = document.getElementById(modalId);
    if (!modal) {
      console.warn(`Modal with id "${modalId}" not found`);
      return;
    }
    
    const limitTypeRadios = modal.querySelectorAll('input[name="limit_type"]');
    const valueInput = modal.querySelector('input[name="value"]');
    const valueSuffix = modal.querySelector('.input-group-text');
    
    limitTypeRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        try {
          if (valueSuffix) {
            valueSuffix.textContent = this.value === 'percent' ? '%' : '₽';
          }
          if (valueInput) {
            valueInput.placeholder = this.value === 'percent' ? '15.0' : '15000';
            valueInput.step = this.value === 'percent' ? '0.1' : '0.01';
            valueInput.max = this.value === 'percent' ? '100' : '';
          }
        } catch (error) {
          console.error('Error in limit type toggle:', error);
        }
      });
    });
  } catch (error) {
    console.error('Error in setupLimitTypeToggle:', error);
  }
}

// Форматирование чисел с тысячными разделителями
function formatNumberInput(input) {
  let value = input.value.replace(/[^\d.,]/g, '').replace(',', '.');
  const parts = value.split('.');
  if (parts[0]) {
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
  }
  input.value = parts.join('.');
}

// Валидация процентов для многоисточников
function validateMultiSourceTotal(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return true;
  
  const percentInputs = container.querySelectorAll('input[type="number"][name*="percentage"]');
  let total = 0;
  
  percentInputs.forEach(input => {
    if (input.value && !input.disabled) {
      total += parseFloat(input.value) || 0;
    }
  });
  
  const totalDisplay = container.querySelector('#totalDisplay');
  const totalStatus = container.querySelector('#totalStatus');
  
  if (totalDisplay) {
    totalDisplay.textContent = total.toFixed(1) + '%';
  }
  
  if (totalStatus) {
    totalStatus.innerHTML = '';
    if (total > 100) {
      totalStatus.innerHTML = '<i class="bi bi-exclamation-triangle text-warning" title="Превышен лимит 100%"></i>';
      return false;
    } else if (total === 0) {
      totalStatus.innerHTML = '<i class="bi bi-info-circle text-muted" title="Добавьте источники"></i>';
    } else {
      totalStatus.innerHTML = '<i class="bi bi-check-circle text-success" title="Корректно"></i>';
    }
  }
  
  return total <= 100;
}

// Добавление многоисточника в модалке создания
function addMultiSource() {
  try {
    const sourceSelect = document.getElementById('newSourceSelect');
    const typeRadios = document.querySelectorAll('input[name="new_limit_type"]');
    const valueInput = document.getElementById('newSourceValue');
    const list = document.getElementById('multiSourceList');
    
    if (!sourceSelect || !valueInput || !list) {
      console.error('Required elements not found for addMultiSource');
      return;
    }
    
    if (!sourceSelect.value || !valueInput.value) {
      alert('Выберите источник и укажите значение');
      return;
    }
    
    const selectedOption = sourceSelect.options[sourceSelect.selectedIndex];
    if (!selectedOption) {
      alert('Выберите источник');
      return;
    }
    
    const sourceName = selectedOption.text;
    const sourceId = selectedOption.value;
    const limitType = [...typeRadios].find(r => r.checked)?.value || 'percent';
    const value = parseFloat(valueInput.value);
    const suffix = limitType === 'percent' ? '%' : '₽';
    
    // Проверка на дубликаты
    if (list.querySelector(`tr[data-source-id="${sourceId}"]`)) {
      alert('Источник уже добавлен');
      return;
    }
    
    const row = document.createElement('tr');
    row.setAttribute('data-source-id', sourceId);
    row.innerHTML = `
      <td>
        <div class="fw-semibold">${sourceName}</div>
        <input type="hidden" name="multi_sources[]" value="${sourceId}">
        <input type="hidden" name="multi_limit_types[]" value="${limitType}">
      </td>
      <td>
        <span class="badge bg-light text-dark">${limitType === 'percent' ? 'Процент' : 'Фикс.'}</span>
      </td>
      <td class="text-end">
        <div class="input-group input-group-sm" style="width: 100px; margin-left: auto;">
          <input type="number" name="multi_values[]" value="${value}" 
                 min="0.01" step="${limitType === 'percent' ? '0.1' : '0.01'}" 
                 ${limitType === 'percent' ? 'max="100"' : ''} 
                 class="form-control text-end tabular-nums" 
                 onchange="updateMultiSourceTotal()">
          <span class="input-group-text">${suffix}</span>
        </div>
      </td>
      <td class="text-center">
        <button type="button" class="btn btn-link btn-sm text-danger p-1" 
                onclick="removeMultiSourceRow(this)" title="Удалить">
          <i class="bi bi-trash3"></i>
        </button>
      </td>
    `;
    
    list.appendChild(row);
    
    // Очистка формы
    sourceSelect.selectedIndex = 0;
    valueInput.value = '';
    
    // Удаление источника из списка
    selectedOption.remove();
    
    updateMultiSourceTotal();
  } catch (error) {
    console.error('Error in addMultiSource:', error);
    alert('Произошла ошибка при добавлении источника');
  }
}

// Удаление строки многоисточника
function removeMultiSourceRow(button) {
  const row = button.closest('tr');
  const sourceId = row.getAttribute('data-source-id');
  const sourceName = row.querySelector('.fw-semibold').textContent;
  
  // Возвращаем в список
  const sourceSelect = document.getElementById('newSourceSelect');
  const option = document.createElement('option');
  option.value = sourceId;
  option.textContent = sourceName;
  sourceSelect.appendChild(option);
  
  row.remove();
  updateMultiSourceTotal();
}

// Обновление итогов многоисточников
function updateMultiSourceTotal() {
  try {
    validateMultiSourceTotal('multiSourceConfig');
  } catch (error) {
    console.error('Error in updateMultiSourceTotal:', error);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // Initialize Bootstrap tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
  
  // Настройка переключателей для модалок
  // Модалки теперь загружаются динамически, setupLimitTypeToggle вызывается в самих модалках
  
  // Настройка переключателей для многоисточников в модалке создания
  const newLimitTypeRadios = document.querySelectorAll('input[name="new_limit_type"]');
  const newSourceValue = document.getElementById('newSourceValue');
  const newSourceSuffix = document.getElementById('newSourceSuffix');
  
  newLimitTypeRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      if (newSourceSuffix) {
        newSourceSuffix.textContent = this.value === 'percent' ? '%' : '₽';
      }
      if (newSourceValue) {
        newSourceValue.placeholder = this.value === 'percent' ? '15.0' : '5000';
        newSourceValue.step = this.value === 'percent' ? '0.1' : '0.01';
        newSourceValue.max = this.value === 'percent' ? '100' : '';
      }
    });
  });
  
  // Настройка переключателей для всех форм добавления источников
  document.querySelectorAll('input[name="limit_type"]').forEach(radio => {
    radio.addEventListener('change', function() {
      toggleLimitInputs(this);
    });
  });
  
  // Улучшенное переключение между процентами и фиксированными суммами
  function toggleLimitInputs(radioElement) {
    const container = radioElement.closest('form') || radioElement.closest('.row');
    if (!container) return;
    
    const percentageInput = container.querySelector('input[name="percentage"]');
    const percentageSymbol = container.querySelector('.percentage-symbol');
    const fixedInput = container.querySelector('input[name="fixed_amount"]');
    const fixedSymbol = container.querySelector('.fixed-symbol');
    
    if (radioElement.value === 'percent') {
      // Показываем поля процентов
      if (percentageInput) {
        percentageInput.style.display = '';
        percentageInput.disabled = false;
        percentageInput.required = true;
      }
      if (percentageSymbol) {
        percentageSymbol.style.display = '';
      }
      
      // Скрываем поля фиксированной суммы
      if (fixedInput) {
        fixedInput.style.display = 'none';
        fixedInput.disabled = true;
        fixedInput.required = false;
        fixedInput.value = '';
      }
      if (fixedSymbol) {
        fixedSymbol.style.display = 'none';
      }
    } else {
      // Показываем поля фиксированной суммы
      if (fixedInput) {
        fixedInput.style.display = '';
        fixedInput.disabled = false;
        fixedInput.required = true;
      }
      if (fixedSymbol) {
        fixedSymbol.style.display = '';
      }
      
      // Скрываем поля процентов
      if (percentageInput) {
        percentageInput.style.display = 'none';
        percentageInput.disabled = true;
        percentageInput.required = false;
        percentageInput.value = '';
      }
      if (percentageSymbol) {
        percentageSymbol.style.display = 'none';
      }
    }
  }
  
  // Prevent double-click submissions
  function preventDoubleSubmit() {
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
      form.addEventListener('submit', function(e) {
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn && !submitBtn.disabled) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<i class="bi bi-hourglass"></i> Обработка...';
          // Re-enable after 3 seconds as fallback
          setTimeout(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = submitBtn.getAttribute('data-original-text') || 'Отправить';
          }, 3000);
        }
      });
      
      // Store original button text
      const submitBtn = form.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.setAttribute('data-original-text', submitBtn.innerHTML);
      }
    });
  }
  
  
  // Форматирование числовых полей
  document.querySelectorAll('input[type="number"]').forEach(input => {
    if (input.step === '0.01' && !input.max) { // Только для сумм
      input.addEventListener('blur', function() {
        formatNumberInput(this);
      });
    }
  });
  
  // Ensure global for legacy inline handlers if any scripts still reference it
  try { window.addMultiSource = window.addMultiSource || addMultiSource; } catch (e) {}
  
  // Initialize all toggle inputs for limit types
  document.querySelectorAll('input[name="limit_type"]').forEach(radio => {
    radio.addEventListener('change', function() {
      if (typeof toggleLimitInputs === 'function') {
        toggleLimitInputs(this);
      }
    });
  });
 
  // Delegate clicks to avoid relying on global function names
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('[data-action="add-multi-source"]');
    if (btn) {
      e.preventDefault();
      try {
        if (typeof addMultiSource === 'function') {
          addMultiSource();
        } else if (typeof window.addMultiSource === 'function') {
          window.addMultiSource();
        } else {
          console.error('addMultiSource handler not found');
        }
      } catch (err) {
        console.error('Error executing addMultiSource:', err);
      }
    }
  });
 
  // Before submitting any form, remove `required` from controls that are not visible/focusable.
  // This prevents "An invalid form control ... is not focusable" errors when hidden inputs retain `required`.
  document.addEventListener('submit', function (e) {
    try {
      const form = e.target;
      if (!(form && form.tagName === 'FORM')) return;
 
      // Find inputs with required attribute that are invisible (display:none, visibility:hidden, or not in document flow)
      const requiredEls = Array.from(form.querySelectorAll('[required]'));
      requiredEls.forEach(el => {
        // Check if element or any parent has display:none
        let currentEl = el;
        let isHidden = false;
        while (currentEl && currentEl !== document.body) {
          const style = window.getComputedStyle(currentEl);
          if (style.display === 'none' || style.visibility === 'hidden') {
            isHidden = true;
            break;
          }
          currentEl = currentEl.parentElement;
        }
        
        // Also check if element is disabled
        if (isHidden || el.disabled) {
          // remove required to avoid native validation blocking submission
          el.removeAttribute('required');
          // also disable to be extra safe
          el.disabled = true;
        }
      });
    } catch (err) {
      // If anything fails, don't block the submit — log for debugging.
      console.error('Error sanitizing hidden required inputs on submit:', err);
    }
  }, true); // capture phase to sanitize before validation runs
 
  // AJAX обработка добавления источников в модалках редактирования
  document.addEventListener('click', function(e) {
    const button = e.target.closest('.ajax-add-source-btn');
    if (button) {
      e.preventDefault();
      const form = button.closest('.ajax-add-source-form');
      
      if (!form) return;
      
      // Валидация формы
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      // Показать состояние загрузки
      const originalContent = button.innerHTML;
      button.disabled = true;
      
      // Разное содержимое для разных кнопок
      if (button.querySelector('.btn-text')) {
        button.innerHTML = '<i class="bi bi-hourglass"></i> Добавление...';
      } else {
        button.innerHTML = '<i class="bi bi-hourglass"></i>';
      }
      
      // Получить данные формы
      const formData = new FormData(form);
      
      // AJAX запрос
      fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (response.ok) {
          // Успешно добавлен - перезагрузить страницу для обновления данных
          window.location.reload();
        } else {
          throw new Error('Ошибка при добавлении источника');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при добавлении источника');
        // Восстановить кнопку
        button.disabled = false;
        button.innerHTML = originalContent;
      });
    }
  });

  preventDoubleSubmit();
  
  // Страховочный обработчик для кнопки добавления категории
  const addCategoryBtn = document.getElementById('openAddCategoryBtn');
  if (addCategoryBtn) {
    addCategoryBtn.addEventListener('click', function(e) {
      // Проверяем, что Bootstrap Modal доступен
      if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        // Bootstrap должен обработать это сам, ничего не делаем
        return;
      }
      
      // Если Bootstrap не работает, открываем модалку вручную
      e.preventDefault();
      const modal = document.getElementById('addCategoryModal');
      if (modal) {
        try {
          const bsModal = new bootstrap.Modal(modal);
          bsModal.show();
        } catch (error) {
          console.error('Error opening modal manually:', error);
          // Fallback: просто показываем модалку через CSS
          modal.style.display = 'block';
          modal.classList.add('show');
          document.body.classList.add('modal-open');
          
          // Добавляем backdrop
          const backdrop = document.createElement('div');
          backdrop.className = 'modal-backdrop fade show';
          document.body.appendChild(backdrop);
        }
      }
    });
  }
});
</script>
{% endblock %}