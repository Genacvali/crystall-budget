{% extends "base.html" %}
{% block title %}{{ budget.name }} ‚Äî –°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç{% endblock %}

{% block content %}
<style>
.kpi-card{border:none;box-shadow:0 6px 18px rgba(0,0,0,.06);border-radius:12px}
.kpi-value{font-weight:800;font-size:1.35rem}
.kpi-label{color:var(--bs-secondary)}
.avatar{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--bs-primary);color:#fff}
.avatar-sm{width:32px;height:32px;background:var(--bs-secondary)}
.badge-role{border-radius:999px}
</style>

<!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('shared_budgets') }}"><i class="bi bi-people"></i> –°–µ–º–µ–π–Ω—ã–µ –±—é–¥–∂–µ—Ç—ã</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ budget.name }}</li>
  </ol>
</nav>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 m-0">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ {{ budget.name }}</h1>
    <small class="text-muted">
      {% if budget.role == 'admin' %}–í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä{% else %}–£—á–∞—Å—Ç–Ω–∏–∫{% endif %} ‚Ä¢ —Å–æ–∑–¥–∞–Ω {{ budget.created_at|default('') }}
    </small>
  </div>
  {% if budget.role == 'admin' %}
  <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#inviteModal">
    <i class="bi bi-person-plus"></i> –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å
  </button>
  {% endif %}
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ 'danger' if category=='error' else category }} alert-dismissible fade show" role="alert">
        {{ message }} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

{# ==== KPI –±–ª–æ–∫–∏ ==== #}
{% set total_sum = recent_expenses|map(attribute='amount')|sum %}
{% set my_sum = (recent_expenses|selectattr('username','equalto', session.name)|map(attribute='amount')|sum) if session.name else 0 %}
{% set others_sum = total_sum - my_sum %}

<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card kpi-card">
      <div class="card-body">
        <div class="kpi-label mb-1">–ò—Ç–æ–≥–æ –∑–∞ –º–µ—Å—è—Ü</div>
        <div class="kpi-value">
          {{ total_sum|format_amount }} <span class="currency-display">{{ currency_symbol }}</span>
        </div>
        <small class="text-muted">–°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card kpi-card">
      <div class="card-body">
        <div class="kpi-label mb-1">–í–∞—à —Ä–∞—Å—Ö–æ–¥</div>
        <div class="kpi-value text-primary">
          {{ my_sum|format_amount }} <span class="currency-display">{{ currency_symbol }}</span>
        </div>
        <small class="text-muted">–¢—Ä–∞—Ç—ã, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –≤–∞–º–∏</small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card kpi-card">
      <div class="card-body">
        <div class="kpi-label mb-1">–û—Å—Ç–∞–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏</div>
        <div class="kpi-value {{ 'text-danger' if others_sum>my_sum else 'text-success' }}">
          {{ others_sum|format_amount }} <span class="currency-display">{{ currency_symbol }}</span>
        </div>
        <small class="text-muted">–°—É–º–º–∞ —Ç—Ä–∞—Ç –¥—Ä—É–≥–∏—Ö</small>
      </div>
    </div>
  </div>
</div>

{# ==== –ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ —Ä–∞—Å—Ö–æ–¥–∞ –≤–Ω—É—Ç—Ä–∏ –±—é–¥–∂–µ—Ç–∞ ==== #}
<div class="card mb-4">
  <div class="card-header">
    <div class="d-flex align-items-center justify-content-between">
      <h5 class="m-0"><i class="bi bi-plus-circle me-2"></i>–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</h5>
      <small class="text-muted">–†–∞—Å—Ö–æ–¥ –ø—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ ‚Äî –æ–Ω —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ñ–∞–∫—Ç—É —É—á–∞—Å—Ç–∏—è</small>
    </div>
  </div>
  <div class="card-body">
    {% if categories and categories|length %}
    <form method="POST" action="{{ url_for('expenses') }}">
      <input type="hidden" name="next" value="{{ url_for('shared_budget_detail', budget_id=budget.id) }}">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">–î–∞—Ç–∞</label>
          <input type="date" name="date" class="form-control" value="{{ today }}" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select name="category_id" class="form-select" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>
            {% for c in categories %}<option value="{{ c.id }}">{{ c.name }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">–°—É–º–º–∞</label>
          <input type="number" name="amount" step="0.01" min="0.01" inputmode="decimal" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <input type="text" name="note" class="form-control" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ">
        </div>
        <div class="col-md-1 d-grid">
          <button class="btn btn-success"><i class="bi bi-check-lg me-1"></i>OK</button>
        </div>
      </div>
    </form>
    {% else %}
      <div class="alert alert-info mb-0">
        –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π. –°–æ–∑–¥–∞–π—Ç–µ –∏—Ö –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ <a class="alert-link" href="{{ url_for('categories') }}">¬´–ö–∞—Ç–µ–≥–æ—Ä–∏–∏¬ª</a>.
      </div>
    {% endif %}
  </div>
</div>

{# ==== –£—á–∞—Å—Ç–Ω–∏–∫–∏ ==== #}
<div class="card mb-4">
  <div class="card-header"><h5 class="m-0"><i class="bi bi-people me-2"></i>–£—á–∞—Å—Ç–Ω–∏–∫–∏ ({{ members|length }})</h5></div>
  <div class="card-body">
    <div class="row g-3">
      {% for m in members %}
      <div class="col-md-6 col-lg-4">
        <div class="d-flex align-items-center gap-3">
          <div class="avatar"><i class="bi bi-person"></i></div>
          <div>
            <div class="fw-semibold">{{ m.username }}</div>
            <div class="small text-muted">
              <span class="badge badge-role {% if m.role=='admin' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                {{ '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' if m.role=='admin' else '–£—á–∞—Å—Ç–Ω–∏–∫' }}
              </span>
              ¬∑ —Å {{ m.joined_at|format_date_with_day }}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

{# ==== –û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã ==== #}
<div class="card">
  <div class="card-header"><h5 class="m-0"><i class="bi bi-list-ul me-2"></i>–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã (—Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü)</h5></div>
  <div class="card-body">
    {% if recent_expenses and recent_expenses|length %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead><tr>
          <th>–£—á–∞—Å—Ç–Ω–∏–∫</th><th>–î–∞—Ç–∞</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
          <th class="text-end">–°—É–º–º–∞</th>
        </tr></thead>
        <tbody>
          {% for e in recent_expenses %}
          <tr>
            <td>
              <div class="d-flex align-items-center gap-2">
                <div class="avatar avatar-sm"><i class="bi bi-person"></i></div>
                {{ e.username }}
              </div>
            </td>
            <td>{{ e.date|format_date_with_day }}</td>
            <td><span class="badge bg-secondary">{{ e.category_name }}</span></td>
            <td>{{ e.description or '-' }}</td>
            <td class="text-end fw-semibold">
              {% if e.currency %}
                <span data-amount="{{ e.amount }}" data-currency="{{ e.currency }}">{{ e.amount|format_amount }}</span>
                <span class="currency-display">{{ currency_symbol }}</span>
              {% else %}
                {{ e.amount|format_amount }} <span class="currency-display">{{ currency_symbol }}</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="4" class="text-end">–ò—Ç–æ–≥–æ</th>
            <th class="text-end">
              {{ total_sum|format_amount }} <span class="currency-display">{{ currency_symbol }}</span>
            </th>
          </tr>
        </tfoot>
      </table>
    </div>
    {% else %}
      <div class="text-center py-4">
        <i class="bi bi-inbox display-1 text-muted opacity-50"></i>
        <h5 class="text-muted mt-3">–ü–æ–∫–∞ –Ω–µ—Ç –æ–±—â–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤</h5>
        <p class="text-muted">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Ä–∞—Å—Ö–æ–¥ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –≤—ã—à–µ</p>
      </div>
    {% endif %}
  </div>
</div>

{# ==== –ú–æ–¥–∞–ª –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è ==== #}
{% if budget.role == 'admin' %}
<div class="modal fade" id="inviteModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title"><i class="bi bi-person-plus me-1"></i>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <p>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º –∫–æ–¥–æ–º:</p>
      <div class="input-group">
        <input type="text" class="form-control" value="{{ budget.invite_code }}" readonly id="inviteCode">
        <button class="btn btn-outline-secondary" type="button" id="copyInvite"><i class="bi bi-clipboard"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <div class="alert alert-info mt-3">
        <i class="bi bi-info-circle me-1"></i>
        –ö–æ–¥ –≤–≤–æ–¥–∏—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ¬´–°–µ–º–µ–π–Ω—ã–µ –±—é–¥–∂–µ—Ç—ã¬ª ‚Üí ¬´–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è¬ª.
      </div>
    </div>
    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  </div></div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function(){
  const btn = document.getElementById('copyInvite');
  if(btn){
    btn.addEventListener('click', async ()=>{
      const val = document.getElementById('inviteCode').value;
      try{
        await navigator.clipboard.writeText(val);
        const orig = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
        btn.classList.remove('btn-outline-secondary'); btn.classList.add('btn-success');
        setTimeout(()=>{ btn.innerHTML = orig; btn.classList.add('btn-outline-secondary'); btn.classList.remove('btn-success');}, 1800);
      }catch(e){}
    });
  }
});
</script>
{% endblock %}
