{% extends "base.html" %}
{% block title %}–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è - CrystalBudget{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-4">
        <div class="card">
            <div class="card-body">
                <div class="text-center mb-4">
                    <h2 class="card-title">üíé –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                    <p class="text-muted">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç CrystalBudget</p>
                </div>
                
                <!-- Telegram Registration -->
                <div class="text-center mb-4">
                    <div id="telegram-login-widget">
                        <!-- Fallback button while widget loads -->
                        <button type="button" class="btn btn-success w-100" id="telegram-login-fallback" style="display: none;">
                            <i class="bi bi-telegram"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram
                        </button>
                    </div>
                </div>
                
                
                <div class="text-center">
                    <p class="text-muted mb-0">
                        –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? 
                        <a href="{{ url_for('login') }}" class="text-decoration-none">
                            –í–æ–π—Ç–∏
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Telegram Login Widget initialization
    function initTelegramWidget() {
        const widgetContainer = document.getElementById('telegram-login-widget');
        const fallbackButton = document.getElementById('telegram-login-fallback');
        
        // Show fallback button initially
        fallbackButton.style.display = 'block';
        
        // Try to load Telegram widget
        const script = document.createElement('script');
        script.async = true;
        script.src = 'https://telegram.org/js/telegram-widget.js?22';
        script.setAttribute('data-telegram-login', 'crystalbudget_bot');
        script.setAttribute('data-size', 'large');
        script.setAttribute('data-auth-url', window.location.origin + '/register');
        script.setAttribute('data-request-access', 'write');
        script.setAttribute('data-lang', 'ru');
        
        // Handle widget load success
        script.onload = function() {
            // Check if widget actually loaded (has iframe)
            setTimeout(() => {
                const iframe = widgetContainer.querySelector('iframe');
                if (iframe) {
                    fallbackButton.style.display = 'none';
                } else {
                    // Widget failed to load, keep fallback
                    console.warn('Telegram widget failed to load, using fallback button');
                }
            }, 1000);
        };
        
        // Handle widget load error
        script.onerror = function() {
            console.warn('Failed to load Telegram widget script');
            fallbackButton.style.display = 'block';
        };
        
        widgetContainer.appendChild(script);
        
        // Fallback button click handler
        fallbackButton.addEventListener('click', function() {
            alert('Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞.\n\n–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω:\n1. –°–æ–∑–¥–∞—Ç—å Telegram –±–æ—Ç–∞\n2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å TELEGRAM_BOT_TOKEN\n3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–æ–º–µ–Ω –≤ @BotFather\n\n–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–º. TELEGRAM_AUTH_SETUP.md');
        });
    }
    
    // Initialize Telegram Widget
    initTelegramWidget();
});
</script>
{% endblock %}