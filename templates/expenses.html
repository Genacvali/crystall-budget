{% extends "base.html" %}
{% block title %}Расходы — CrystalBudget{% endblock %}

{% block content %}
<style>
  .btn-col{ min-width:160px; }
  .btn-col .btn{ white-space:nowrap; }

  /* Empty state */
  .empty-state{ text-align:center; padding:3rem 1rem; color:var(--bs-secondary); }
  .empty-state-icon{ font-size:4rem; opacity:.3; margin-bottom:1rem; }

  /* Mobile cards */
  .expense-card{ border-radius:.75rem; border:none; transition:.2s; position:relative; overflow:hidden; }
  .expense-card:hover{ transform:translateY(-2px); box-shadow:0 8px 25px rgba(0,0,0,.1); }
  .expense-amount{ font-size:1.25rem; font-weight:700; }
  .expense-category{ font-weight:600; color:var(--bs-primary); }
  .expense-date{ color:var(--bs-secondary); font-size:.875rem; }
  .expense-note{ color:var(--bs-body-color); font-style:italic; }

  /* Swipe scaffold */
  .swipe-card{ position:relative; overflow:hidden; border-radius:12px; }
  .swipe-actions{ position:absolute; inset:0 auto 0 0; width:100%; display:flex; justify-content:space-between; align-items:stretch; pointer-events:none; }
  .swipe-actions .lane{ width:82px; display:flex; align-items:center; justify-content:center; }
  .swipe-actions .lane.edit{ background:linear-gradient(90deg,#0d6efd,#0b5ed7); }
  .swipe-actions .lane.delete{ background:linear-gradient(270deg,#dc3545,#c82333); }
  .swipe-actions .action-btn{ pointer-events:auto; background:transparent; border:none; color:#fff; font-size:1.25rem; width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
  .swipe-content{ position:relative; z-index:2; background:var(--bs-body-bg); transition:transform .25s ease; }
  .swipe-card.swipe-left-active .swipe-content{ transform:translateX(82px); }
  .swipe-card.swipe-right-active .swipe-content{ transform:translateX(-82px); }
  .swipe-hint{ text-align:center; opacity:.65; font-size:.8rem; margin-top:.25rem; }

  /* Desktop table */
  .table-actions .btn{ white-space:nowrap; }
  .table td, .table th{ vertical-align:middle; }

  /* Add form niceties */
  .input-group-lg .input-group-text{ min-width:2.25rem; justify-content:center; }
</style>

<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
  <h1 class="zen-title"><i class="bi bi-wallet2 me-2" aria-hidden="true"></i>Расходы</h1>
  <button class="zen-btn zen-btn-expense zen-btn-sm" data-bs-toggle="collapse" data-bs-target="#addExpenseForm" aria-controls="addExpenseForm" aria-expanded="false">
    <i class="bi bi-dash-circle-fill me-1"></i><span class="d-none d-sm-inline">Добавить </span>Расход
  </button>
</div>

<!-- Add expense form -->
<div class="collapse mb-3" id="addExpenseForm">
  <div class="zen-card zen-card-expense">
    <form method="POST" action="/expenses" id="add-expense-form" novalidate>
      <div class="row g-2 g-md-3 align-items-end">
        <div class="col-6 col-md-3">
          <label for="date" class="form-label">Дата</label>
          <input type="date" id="date" name="date" value="{{ today }}" class="form-control" required>
          <div class="invalid-feedback">Укажите дату.</div>
        </div>
        <div class="col-6 col-md-2">
          <label for="amount" class="form-label">Сумма</label>
          <div class="input-group input-group-lg">
            <span class="input-group-text currency-display">{{ currency_symbol|default('₽') }}</span>
            <input type="number" id="amount" name="amount" step="0.01" min="0.01" inputmode="decimal" class="form-control" required>
          </div>
          <div class="invalid-feedback">Введите сумму больше 0.</div>
        </div>
        <div class="col-12 col-md-3">
          <label for="category_id" class="form-label">Категория</label>
          <select id="category_id" name="category_id" class="form-select" required>
            <option value="">Выберите категорию</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
          </select>
          <div class="invalid-feedback">Выберите категорию.</div>
        </div>
        <div class="col-12 col-md-3">
          <label for="note" class="form-label">Комментарий</label>
          <input type="text" id="note" name="note" class="form-control" placeholder="Необязательно">
        </div>
        <div class="col-12 col-md-auto d-grid btn-col">
          <label class="form-label d-none d-md-block" aria-hidden="true">&nbsp;</label>
          <button type="submit" class="zen-btn zen-btn-expense">
            <i class="bi bi-check-lg me-1"></i> Добавить
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Mobile list with swipe -->
<div class="d-block d-md-none">
  {% for expense in expenses %}
  <div class="swipe-card mb-3" data-expense-id="{{ expense.id }}">
    <div class="swipe-actions">
      <div class="lane edit">
        <button class="action-btn swipe-action edit" type="button" data-url="{{ url_for('edit_expense', expense_id=expense.id) }}" aria-label="Редактировать">
          <i class="bi bi-pencil"></i>
        </button>
      </div>
      <div class="lane delete">
        <button class="action-btn swipe-action delete" type="button"
                data-expense-id="{{ expense.id }}"
                data-name="{{ expense.category_name }}"
                data-date="{{ expense.date|format_date_with_day }}"
                data-amount="{{ expense.amount|format_amount }}"
                data-action="{{ url_for('delete_expense', expense_id=expense.id) }}"
                aria-label="Удалить">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </div>
    <div class="swipe-content">
      <div class="zen-card expense-card m-0">
          <div class="row align-items-center">
            <div class="col-9">
              <div class="expense-amount text-danger">{{ expense.amount|format_amount }} <span class="currency-display">{{ currency_symbol|default('₽') }}</span></div>
              <div class="expense-category">{{ expense.category_name }}</div>
              <div class="expense-date"><i class="bi bi-calendar3 me-1"></i>{{ expense.date|format_date_with_day }}</div>
              {% if expense.note %}
              <div class="expense-note mt-1"><i class="bi bi-chat-dots me-1"></i>{{ expense.note }}</div>
              {% endif %}
            </div>
            <div class="col-3 text-end">
              <div class="btn-group-vertical" role="group" aria-label="Действия">
                <a href="{{ url_for('edit_expense', expense_id=expense.id) }}" class="zen-btn zen-btn-sm zen-btn-primary"><i class="bi bi-pencil"></i></a>
                <button type="button" class="zen-btn zen-btn-sm zen-btn-danger btn-delete-inline" data-expense-id="{{ expense.id }}" data-name="{{ expense.category_name }}" data-date="{{ expense.date|format_date_with_day }}" data-amount="{{ expense.amount|format_amount }}" data-action="{{ url_for('delete_expense', expense_id=expense.id) }}">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="swipe-hint">Свайп вправо — редактировать, влево — удалить</div>
  </div>
  {% endfor %}
</div>

<!-- Desktop table -->
<div class="table-responsive d-none d-md-block">
  <table class="zen-table">
    <thead class="table-light">
      <tr>
        <th>Дата</th>
        <th>Категория</th>
        <th class="text-end">Сумма</th>
        <th>Комментарий</th>
        <th class="text-end">Действия</th>
      </tr>
    </thead>
    <tbody>
      {% for expense in expenses %}
      <tr>
        <td>{{ expense.date|format_date_with_day }}</td>
        <td>{{ expense.category_name }}</td>
        <td class="text-end fw-bold">{{ expense.amount|format_amount }} <span class="currency-display">{{ currency_symbol|default('₽') }}</span></td>
        <td>{{ expense.note or '' }}</td>
        <td class="text-end table-actions">
          <a href="{{ url_for('edit_expense', expense_id=expense.id) }}" class="zen-btn zen-btn-sm zen-btn-primary me-1"><i class="bi bi-pencil"></i> Изменить</a>
          <button type="button" class="zen-btn zen-btn-sm zen-btn-danger btn-delete-inline" data-expense-id="{{ expense.id }}" data-name="{{ expense.category_name }}" data-date="{{ expense.date|format_date_with_day }}" data-amount="{{ expense.amount|format_amount }}" data-action="{{ url_for('delete_expense', expense_id=expense.id) }}">
            <i class="bi bi-trash"></i> Удалить
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if not expenses %}
<div class="zen-empty-state">
  <div class="mb-4"><i class="bi bi-wallet2 display-1 text-muted opacity-50" aria-hidden="true"></i></div>
  <h2 class="h5 text-muted mb-3">Пока что расходов нет</h2>
  <p class="text-muted">Начните отслеживать свои траты, добавив первый расход</p>
  <button class="zen-btn zen-btn-expense zen-btn-lg" data-bs-toggle="collapse" data-bs-target="#addExpenseForm"><i class="bi bi-dash-circle-fill me-2"></i>Добавить первый расход</button>
</div>
{% endif %}

<!-- Unified delete modal -->
<div class="modal fade" id="deleteExpenseModal" tabindex="-1" aria-labelledby="deleteExpenseLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteExpenseLabel">Удалить расход</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <form id="deleteExpenseForm" method="POST" action="#">
        <div class="modal-body">
          <p class="mb-0">Удалить расход <strong id="delAmount"></strong> по категории <strong id="delName"></strong> от <strong id="delDate"></strong>?
            <br><small class="text-muted">Действие необратимо.</small>
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="zen-btn zen-btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="zen-btn zen-btn-danger"><i class="bi bi-trash"></i> Удалить</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Add form: simple validation & UX
(function(){
  const form = document.getElementById('add-expense-form');
  if(!form) return;
  const date = document.getElementById('date');
  const amount = document.getElementById('amount');
  const category = document.getElementById('category_id');
  // today fallback
  if(date && !date.value){ date.value = new Date().toISOString().slice(0,10); }
  amount?.addEventListener('wheel', e=>{ e.preventDefault(); }, {passive:false});
  function validate(){ form.classList.remove('was-validated'); }
  ['input','change'].forEach(ev=>[date,amount,category].forEach(el=>el&&el.addEventListener(ev,validate)));
  form.addEventListener('submit', (e)=>{
    if(!form.checkValidity()){ e.preventDefault(); e.stopPropagation(); form.classList.add('was-validated'); }
  });
  // Focus amount after category picked
  if(category && amount){ category.addEventListener('change', ()=>{ if(category.value) setTimeout(()=>amount.focus(), 60); }); }
})();

// Unified delete modal hookup
(function(){
  const modalEl = document.getElementById('deleteExpenseModal');
  if(!modalEl) return;
  const form = document.getElementById('deleteExpenseForm');
  const nameEl = document.getElementById('delName');
  const dateEl = document.getElementById('delDate');
  const amountEl = document.getElementById('delAmount');
  const bsModal = new bootstrap.Modal(modalEl);
  function openModalFromBtn(btn){
    const action = btn.getAttribute('data-action');
    const name = btn.getAttribute('data-name') || '';
    const date = btn.getAttribute('data-date') || '';
    const amount = btn.getAttribute('data-amount') || '';
    if(form && action) form.setAttribute('action', action);
    if(nameEl) nameEl.textContent = '«'+name+'»';
    if(dateEl) dateEl.textContent = date;
    if(amountEl) amountEl.textContent = amount + ' ' + (document.querySelector('.currency-display')?.textContent?.trim()||'');
    bsModal.show();
  }
  document.querySelectorAll('.btn-delete-inline').forEach(btn=>{
    btn.addEventListener('click', ()=> openModalFromBtn(btn));
  });
  // Also wire swipe delete buttons
  document.querySelectorAll('.swipe-action.delete').forEach(btn=>{
    btn.addEventListener('click', ()=> openModalFromBtn(btn));
  });
})();

// Swipe interactions (touch & mouse)
(function(){
  const cards = document.querySelectorAll('.swipe-card');
  const MAX = 96; const THRESH = 54; // px
  cards.forEach(card=>{
    const content = card.querySelector('.swipe-content');
    let startX=0,startY=0,dx=0,dy=0,drag=false,dir=null; // dir: 'x' or 'y'
    function start(e){
      const p = e.touches? e.touches[0] : e; startX=p.clientX; startY=p.clientY; dx=0; dy=0; drag=true; dir=null; content.style.transition='none'; card.classList.add('swiping'); }
    function move(e){ if(!drag) return; const p = e.touches? e.touches[0] : e; dx=p.clientX-startX; dy=p.clientY-startY; if(!dir){ dir = Math.abs(dx)>Math.abs(dy)?'x':'y'; }
      if(dir==='x'){ e.preventDefault(); const clamped = Math.max(-MAX, Math.min(MAX, dx)); content.style.transform=`translateX(${clamped}px)`; }
    }
    function end(){ if(!drag) return; drag=false; content.style.transition='transform .25s ease'; card.classList.remove('swiping');
      if(Math.abs(dx)>=THRESH){ if(dx>0){ card.classList.add('swipe-left-active'); card.classList.remove('swipe-right-active'); }
        else { card.classList.add('swipe-right-active'); card.classList.remove('swipe-left-active'); }
      } else { content.style.transform='translateX(0)'; card.classList.remove('swipe-left-active','swipe-right-active'); }
      dx=dy=0; dir=null; }
    card.addEventListener('touchstart', start, {passive:true});
    card.addEventListener('touchmove', move, {passive:false});
    card.addEventListener('touchend', end, {passive:true});
    card.addEventListener('mousedown', start);
    card.addEventListener('mousemove', move);
    card.addEventListener('mouseup', end);
    card.addEventListener('mouseleave', end);
  });
})();
</script>
{% endblock %}
