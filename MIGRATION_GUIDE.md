# Database Migration Guide

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –≤ —Ç–µ–∫—É—â—É—é —Å—Ö–µ–º—É.

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# 1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä–æ–¥–∞–∫—à–Ω –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
cp /path/to/prod/budget.db instance/budget.db

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
python migrate_prod_db.py

# 3. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ
```

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏?

–°–∫—Ä–∏–ø—Ç `migrate_prod_db.py` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

1. ‚úÖ **–°–æ–∑–¥–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é** –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π
2. ‚úÖ **–ú–∏–≥—Ä–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ** –∏–∑ —É—Å—Ç–∞—Ä–µ–≤—à–µ–π –∫–æ–ª–æ–Ω–∫–∏ `currency` –≤ `default_currency`
3. ‚úÖ **–°–æ–∑–¥–∞–µ—Ç –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã**:
   - `budget_rollover` - –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ –±—é–¥–∂–µ—Ç–∞
   - `password_reset_tokens` - –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª–µ–π
   - `income_backup_monthly` - —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –º–µ—Å—è—á–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞
   - `income_daily` - –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –¥–æ—Ö–æ–¥
   - `source_category_rules` - –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–æ—Ö–æ–¥–æ–≤
4. ‚úÖ **–°–æ–∑–¥–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã** –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
5. ‚úÖ **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ** - –Ω–∏–∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:

```bash
python migrate_prod_db.py
```

–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç –Ω–∞–π–¥–µ–Ω–∞ –ø–æ –ø—É—Ç–∏:
- `$BUDGET_DB` (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è)
- `instance/budget.db` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

### –í–∞—Ä–∏–∞–Ω—Ç 2: –£–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

```bash
python migrate_prod_db.py /path/to/your/budget.db
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ú–∏–≥—Ä–∞—Ü–∏—è —Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
export BUDGET_DB="sqlite:////opt/crystall-budget/instance/budget.db"
python migrate_prod_db.py
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚ö†Ô∏è **–í–∞–∂–Ω–æ!** –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π:

```
instance/budget.db.backup_20251002_123456
```

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫, –≤—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ:

```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
cp instance/budget.db.backup_20251002_123456 instance/budget.db
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
python app.py

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç—Ä–∞—Ç
```

## –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ —É—Å–ø–µ—à–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

```
============================================================
DATABASE MIGRATION SCRIPT
============================================================
Database: instance/budget.db

Creating backup: instance/budget.db.backup_20251002_000417
‚úì Backup created successfully

Found 14 tables in database

============================================================
1. Checking USERS table...
============================================================
   Current columns: [...]
   ‚ö† Found deprecated 'currency' column
   ‚Üí Migrating data to 'default_currency'...

============================================================
MIGRATION SUMMARY
============================================================

‚úÖ Migration completed successfully!

Changes made (5):
   1. Created table budget_rollover
   2. Created table password_reset_tokens
   3. Created table income_backup_monthly
   4. Created table income_daily
   5. Created table source_category_rules

üì¶ Backup saved to: instance/budget.db.backup_20251002_000417

‚úÖ All done! Your database is ready to use.
```

## Troubleshooting

### –û—à–∏–±–∫–∞: "Database not found"

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∫—Ä–∏–ø—Ç –Ω–µ –º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ:** –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —è–≤–Ω–æ:
```bash
python migrate_prod_db.py instance/budget.db
```

### –û—à–∏–±–∫–∞: "Permission denied"

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:
```bash
chmod 644 instance/budget.db
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞

–ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–∞—Ä—É–∂–∏—Ç, —á—Ç–æ –±–∞–∑–∞ —É–∂–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞, –æ–Ω –ø–æ–∫–∞–∂–µ—Ç:

```
‚úì Database is already up to date, no changes needed
```

–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –∏ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

## –ß—Ç–æ –ù–ï –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç

‚ùå –°–∫—Ä–∏–ø—Ç –ù–ï —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã (`issues`, `issue_comments`, `category_rules`)
‚ùå –°–∫—Ä–∏–ø—Ç –ù–ï —É–¥–∞–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É `currency` (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
‚ùå –°–∫—Ä–∏–ø—Ç –ù–ï –∏–∑–º–µ–Ω—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ (–∫—Ä–æ–º–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è `currency` ‚Üí `default_currency`)

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤–∞—à–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å:

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
- `users` - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- `categories` - –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—é–¥–∂–µ—Ç–∞
- `expenses` - –†–∞—Å—Ö–æ–¥—ã
- `income` - –î–æ—Ö–æ–¥—ã
- `income_sources` - –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ—Ö–æ–¥–æ–≤
- `savings_goals` - –¶–µ–ª–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π
- `shared_budgets` - –°–µ–º–µ–π–Ω—ã–µ –±—é–¥–∂–µ—Ç—ã
- `shared_budget_members` - –£—á–∞—Å—Ç–Ω–∏–∫–∏ —Å–µ–º–µ–π–Ω—ã—Ö –±—é–¥–∂–µ—Ç–æ–≤

**–ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
- `budget_rollover` - –ü–µ—Ä–µ–Ω–æ—Å—ã –±—é–¥–∂–µ—Ç–∞ –º–µ–∂–¥—É –º–µ—Å—è—Ü–∞–º–∏
- `password_reset_tokens` - –¢–æ–∫–µ–Ω—ã –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
- `income_backup_monthly` - –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –º–µ—Å—è—á–Ω—ã—Ö –¥–æ—Ö–æ–¥–æ–≤
- `income_daily` - –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –¥–æ—Ö–æ–¥—ã
- `source_category_rules` - –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º

**–°–ª—É–∂–µ–±–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
- `exchange_rates` - –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç
- `alembic_version` - –í–µ—Ä—Å–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

### –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–∫—Ä–∏–ø—Ç–∞
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –Ω–∞ –∫–æ–ø–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–∞
4. –°–æ–æ–±—â–∏—Ç–µ –æ–± –æ—à–∏–±–∫–µ —Å –ø–æ–ª–Ω—ã–º –≤—ã–≤–æ–¥–æ–º —Å–∫—Ä–∏–ø—Ç–∞
