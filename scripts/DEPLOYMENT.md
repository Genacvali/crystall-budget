# Production Deployment Guide

## –°–∫—Ä–∏–ø—Ç—ã –¥–µ–ø–ª–æ—è

### 0. `sync_migrations.sh` - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ë–î ‚ö†Ô∏è –í–ê–ñ–ù–û –î–õ–Ø –ü–ï–†–í–û–ì–û –î–ï–ü–õ–û–Ø

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ü–ï–†–í–´–ú –î–ï–õ–û–ú**, –µ—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å —Ä–∞–±–æ—á–∞—è –ë–î –Ω–∞ –ø—Ä–æ–¥–µ, –Ω–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã.

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–î —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–∞–±–ª–∏—Ü—ã, –Ω–æ `alembic_version` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–ª–∞.

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. üîç –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã
2. üîç –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—Ö–µ–º—ã (–∫–∞–∫–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –µ—Å—Ç—å)
3. üéØ –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–µ–∫—É—â—É—é –º–∏–≥—Ä–∞—Ü–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. ‚úÖ "–®—Ç–∞–º–ø—É–µ—Ç" –ë–î –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏
5. üìù –ì–æ–≤–æ—Ä–∏—Ç, –Ω—É–∂–µ–Ω –ª–∏ –¥–∞–ª—å–Ω–µ–π—à–∏–π upgrade

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
cd /opt/crystall-budget
export BUDGET_DB="sqlite:////var/lib/crystalbudget/budget.db"
./scripts/sync_migrations.sh
```

**–í–ê–ñ–ù–û:** –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ü–ï–†–ï–î `deploy_prod.sh`, –µ—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫—É "table already exists"!

---

### 1. `deploy_prod.sh` - –û—Å–Ω–æ–≤–Ω–æ–π –¥–µ–ø–ª–æ–π

–ü—Ä–∏–º–µ–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
3. ‚úÖ –°–æ–∑–¥–∞—ë—Ç –±—ç–∫–∞–ø –ë–î (–≤ `backups/`)
4. ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é –º–∏–≥—Ä–∞—Ü–∏—é
5. ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ SQL-–∏–∑–º–µ–Ω–µ–Ω–∏—è
6. ‚úÖ –°–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
7. ‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (`flask db upgrade`)
8. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –ë–î

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
cd /opt/crystall-budget
./scripts/deploy_prod.sh
```

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –≤ `.venv/`
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—É—Ç–∏ `BUDGET_DB` (–∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—É—Ç—å)
- –ü—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ `backups/`

---

### 2. `rollback_prod.sh` - –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

–û—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –ë–î –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é –∏–∑ –±—ç–∫–∞–ø–∞.

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. üìã –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –±—ç–∫–∞–ø–æ–≤
2. ‚ö†Ô∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
3. üíæ –°–æ–∑–¥–∞—ë—Ç emergency-–±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
4. üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π –±—ç–∫–∞–ø
5. ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
cd /opt/crystall-budget
sudo ./scripts/rollback_prod.sh
```

**–í–ù–ò–ú–ê–ù–ò–ï:** –¢—Ä–µ–±—É–µ—Ç `sudo` –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏/–∑–∞–ø—É—Å–∫–∞ systemd-—Å–µ—Ä–≤–∏—Å–∞!

---

## –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–µ–ø–ª–æ—è

### –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

1. **–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω:**
   ```bash
   cd /opt/crystall-budget
   git pull origin main
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ:**
   ```bash
   source .venv/bin/activate
   ```

3. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ):**
   ```bash
   pip install -r requirements.txt
   ```

### –î–µ–ø–ª–æ–π

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è:**
   ```bash
   ./scripts/deploy_prod.sh
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–≤–æ–¥:**
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–∫–∞–∑–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SQL-–∏–∑–º–µ–Ω–µ–Ω–∏—è
   - –í–≤–µ–¥–∏—Ç–µ `yes` –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è

3. **–î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**

### –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**
   ```bash
   sudo systemctl restart crystalbudget
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:**
   ```bash
   sudo journalctl -u crystalbudget -f
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ–º–µ–π–Ω—ã–π –¥–æ—Å—Ç—É–ø (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±—ç–∫–∞–ø–æ–≤

```
backups/
‚îú‚îÄ‚îÄ budget_20251004_120530.db    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
‚îú‚îÄ‚îÄ budget_20251004_145612.db
‚îî‚îÄ‚îÄ emergency_20251004_153045.db # Emergency-–±—ç–∫–∞–ø –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ
```

**–§–æ—Ä–º–∞—Ç –∏–º–µ–Ω–∏:** `budget_YYYYMMDD_HHMMSS.db`

---

## –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ

### –¢–µ–∫—É—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏:

1. **1b77062a812f** - Initial migration (–±–∞–∑–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã)
2. **d06c52a8b6a7** - Add IncomeSource model
3. **add_date_to_income** - Add date to income
4. **515954c99c28** - Add shared budget support
5. **add_shared_budget_to_users** - Add shared_budget_id to users (HEAD)

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –º–∏–≥—Ä–∞—Ü–∏—é:
```bash
flask db current
```

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é:
```bash
flask db history
```

---

## –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π

### –í–∞—Ä–∏–∞–Ω—Ç 1: –û—Ç–∫–∞—Ç —á–µ—Ä–µ–∑ –±—ç–∫–∞–ø (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)
```bash
sudo ./scripts/rollback_prod.sh
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Ç–∫–∞—Ç —á–µ—Ä–µ–∑ Alembic (—Å–ª–æ–∂–Ω–µ–µ)
```bash
# –û—Ç–∫–∞—Ç–∏—Ç—å –æ–¥–Ω—É –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞–∑–∞–¥
flask db downgrade -1

# –û—Ç–∫–∞—Ç–∏—Ç—å –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
flask db downgrade 515954c99c28
```

‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï:** –ü—Ä–∏ –æ—Ç–∫–∞—Ç–µ —á–µ—Ä–µ–∑ Alembic –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω—ã!

---

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: "No such column"
**–ü—Ä–∏—á–∏–Ω–∞:** –ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —á–∞—Å—Ç–∏—á–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ:**
```bash
flask db upgrade
sudo systemctl restart crystalbudget
```

### –ü—Ä–æ–±–ª–µ–º–∞: "Database is locked"
**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ë–î.

**–†–µ—à–µ–Ω–∏–µ:**
```bash
sudo systemctl stop crystalbudget
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏—é
sudo systemctl start crystalbudget
```

### –ü—Ä–æ–±–ª–µ–º–∞: "Migration failed"
**–ü—Ä–∏—á–∏–Ω–∞:** –û—à–∏–±–∫–∞ –≤ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å—Ö–µ–º—ã.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏: `flask db upgrade`
2. –û—Ç–∫–∞—Ç–∏—Ç–µ—Å—å –∫ –±—ç–∫–∞–ø—É: `sudo ./scripts/rollback_prod.sh`
3. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –≤ –∫–æ–¥–µ
4. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –¥–µ–ø–ª–æ–π

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –ë–î

```bash
# –ß–µ—Ä–µ–∑ SQLite
sqlite3 /opt/crystall-budget/instance/budget.db "PRAGMA integrity_check;"

# –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ)
./scripts/deploy_prod.sh
```

---

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

- `BUDGET_DB` - –ø—É—Ç—å –∫ –ë–î (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `sqlite:////opt/crystall-budget/instance/budget.db`)
- `SECRET_KEY` - —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ!)
- `HTTPS_MODE` - –≤–∫–ª—é—á–∏—Ç—å HTTPS-—Ä–µ–∂–∏–º (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: `true`)
- `TELEGRAM_BOT_TOKEN` - —Ç–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞

---

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç –¥–µ–ø–ª–æ—è

- [ ] –ö–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω (`git pull`)
- [ ] –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã (`pip install -r requirements.txt`)
- [ ] –ó–∞–ø—É—â–µ–Ω —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è (`./scripts/deploy_prod.sh`)
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
- [ ] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ (`sudo systemctl restart crystalbudget`)
- [ ] –õ–æ–≥–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã (`journalctl -u crystalbudget`)
- [ ] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
- [ ] –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ `backups/`)

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –¥–µ–ø–ª–æ–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `sudo journalctl -u crystalbudget -n 100`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: `sudo systemctl status crystalbudget`
3. –û—Ç–∫–∞—Ç–∏—Ç–µ—Å—å –∫ –±—ç–∫–∞–ø—É –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
