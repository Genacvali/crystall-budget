# üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ CrystalBudget —Å nginx –∏ HTTPS

## –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫

### üÜï –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Å –Ω–æ–≤—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏)

```bash
cd /root/crystall-budget

# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å
sudo systemctl stop crystalbudget

# 2. –°–¥–µ–ª–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
cp budget.db budget_backup_$(date +%Y%m%d_%H%M%S).db

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü
python3 migrate_new_tables.py

# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
sudo systemctl start crystalbudget

# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
sudo systemctl status crystalbudget
```

### –ü–µ—Ä–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

–ï—Å–ª–∏ –≤–∞—à –ø—Ä–æ–µ–∫—Ç —É–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `/root/crystall-budget`, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
cd /root/crystall-budget

# –°–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏
chmod +x deploy.sh setup-https.sh

# 1. –ë–∞–∑–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ (nginx, systemd, Flask app)
./deploy.sh

# 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ HTTPS (–ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ DNS)
./setup-https.sh
```

## –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### 1. –ë–∞–∑–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

–°–∫—Ä–∏–ø—Ç `deploy.sh` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç nginx, certbot, Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –°–æ–∑–¥–∞–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç requirements
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç systemd —Å–µ—Ä–≤–∏—Å –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç nginx –∫–∞–∫ reverse proxy
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è Flask
- –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã

```bash
./deploy.sh
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ–º–µ–Ω–∞ –∏ DNS

–ü–µ—Ä–µ–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π HTTPS:
1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –¥–æ–º–µ–Ω
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ DNS A-–∑–∞–ø–∏—Å—å: `your-domain.com` ‚Üí IP –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
3. –î–æ–∂–¥–∏—Ç–µ—Å—å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è DNS (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 24 —á–∞—Å–æ–≤)

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å DNS: `nslookup your-domain.com`

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ HTTPS

–°–∫—Ä–∏–ø—Ç `setup-https.sh` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –û–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx —Å –≤–∞—à–∏–º –¥–æ–º–µ–Ω–æ–º
- –ü–æ–ª—É—á–∞–µ—Ç SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —á–µ—Ä–µ–∑ Let's Encrypt
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç —Ñ–∞–π—Ä–≤–æ–ª
- –¢–µ—Å—Ç–∏—Ä—É–µ—Ç HTTPS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

```bash
./setup-https.sh
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

–ü–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

```bash
# –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
systemctl status crystalbudget nginx

# –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
journalctl -u crystalbudget -f

# Health check
curl https://your-domain.com/health

# –¢–µ—Å—Ç SSL
curl -I https://your-domain.com
```

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–º

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
systemctl restart crystalbudget

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
journalctl -u crystalbudget -n 50

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx
systemctl reload nginx

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
certbot renew
```

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```bash
cd /root/crystall-budget

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
systemctl stop crystalbudget

# –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ (git pull –∏–ª–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤)
git pull

# –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
.venv/bin/pip install -r requirements.txt

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
systemctl start crystalbudget
```

## –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
cp /root/crystall-budget/budget.db /backup/budget.db.$(date +%Y%m%d)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
tar -czf /backup/crystalbudget-config.$(date +%Y%m%d).tar.gz \
    /etc/nginx/sites-available/crystalbudget \
    /etc/systemd/system/crystalbudget.service \
    /root/crystall-budget/.secret_key
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: `/var/log/crystalbudget/` –∏ `journalctl -u crystalbudget`
- Nginx: `/var/log/nginx/crystalbudget.*.log`
- CrystalBudget: `/root/crystall-budget/logs/crystalbudget.log`

### Health Check
- URL: `https://your-domain.com/health`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º

### SSL –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
```bash
# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞—Ö
certbot certificates

# –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
certbot renew --dry-run

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞ SSL
# https://www.ssllabs.com/ssltest/analyze.html?d=your-domain.com
```

## Troubleshooting

### –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
systemctl status crystalbudget

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏
journalctl -u crystalbudget -n 50

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ—Ä—Ç 5000 –Ω–µ –∑–∞–Ω—è—Ç
ss -tlnp | grep :5000
```

### Nginx –æ—à–∏–±–∫–∏
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
nginx -t

# –õ–æ–≥–∏ –æ—à–∏–±–æ–∫
tail -f /var/log/nginx/error.log
```

### SSL –ø—Ä–æ–±–ª–µ–º—ã
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
certbot certificates

# –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
certbot renew --dry-run

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω
nslookup your-domain.com
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª –±–∞–∑—ã
ls -la /root/crystall-budget/budget.db

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
chmod 644 /root/crystall-budget/budget.db
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **–§–∞–π—Ä–≤–æ–ª**: –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –æ—Ç–∫—Ä—ã—Ç—ã —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ—Ä—Ç—ã (22, 80, 443)
2. **SSL**: –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ cron)
3. **–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á**: –•—Ä–∞–Ω–∏—Ç–µ `/root/crystall-budget/.secret_key` –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è**: –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
5. **–õ–æ–≥–∏**: –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏