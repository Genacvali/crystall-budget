{% extends "base.html" %}
{% block title %}üí∏ –†–∞—Å—Ö–æ–¥—ã ‚Äî CrystalBudget{% endblock %}

{% block content %}
<style>
  /* Page Header */
  .page-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 20px;
    padding: 16px;
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
  }

  .page-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
  }

  .page-icon {
    font-size: 1.5rem;
    color: var(--danger);
    margin-right: 8px;
  }

  /* Quick Add Form (Mobile Hidden, Desktop Visible) */
  .quick-form-desktop {
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    margin-bottom: 20px;
    overflow: hidden;
  }

  @media (max-width: 768px) {
    .quick-form-desktop {
      display: none;
    }
  }

  /* Expense Cards - Mobile First */
  .expense-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .expense-card {
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    border: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .expense-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
  }

  .expense-card.swipeable-card {
    touch-action: pan-y;
    user-select: none;
  }

  /* Card Content */
  .expense-content {
    padding: 16px;
  }

  .expense-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
  }

  .expense-amount {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--danger);
    margin: 0;
  }

  .expense-date {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 500;
  }

  .expense-body {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
  }

  .expense-category {
    display: inline-flex;
    align-items: center;
    padding: 4px 12px;
    background: rgba(79, 70, 229, 0.1);
    border-radius: 16px;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--primary);
    border-left: 3px solid var(--primary);
  }

  .expense-category.food { 
    background: rgba(16, 185, 129, 0.1); 
    color: var(--success); 
    border-left-color: var(--success);
  }
  
  .expense-category.transport { 
    background: rgba(245, 158, 11, 0.1); 
    color: var(--warning); 
    border-left-color: var(--warning);
  }
  
  .expense-category.entertainment { 
    background: rgba(239, 68, 68, 0.1); 
    color: var(--danger); 
    border-left-color: var(--danger);
  }

  .expense-note {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-style: italic;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border);
  }

  /* Swipe Actions */
  .expense-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border);
  }

  @media (max-width: 768px) {
    .expense-actions {
      display: none; /* Hidden on mobile, use swipe instead */
    }
  }

  .expense-actions .btn {
    flex: 1;
    border-radius: 8px;
    font-size: 0.875rem;
    padding: 8px 16px;
  }

  /* Swipe Indicators (Mobile Only) */
  .swipe-indicator {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .swipe-indicator.left {
    left: 16px;
    color: var(--primary);
  }

  .swipe-indicator.right {
    right: 16px;
    color: var(--danger);
  }

  .expense-card.swiping .swipe-indicator {
    opacity: 0.7;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-secondary);
  }

  .empty-state-icon {
    font-size: 4rem;
    opacity: 0.3;
    margin-bottom: 16px;
    color: var(--text-secondary);
  }

  .empty-state h3 {
    margin-bottom: 8px;
    color: var(--text-primary);
  }

  .empty-state p {
    margin-bottom: 24px;
    color: var(--text-secondary);
  }

  /* Desktop Table View */
  .desktop-table {
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  @media (max-width: 768px) {
    .desktop-table {
      display: none !important;
    }
  }

  /* Mobile Optimizations */
  @media (max-width: 768px) {
    .page-header {
      padding: 12px 16px;
      margin-bottom: 16px;
    }
    
    .page-title {
      font-size: 1.25rem;
    }
    
    .expense-content {
      padding: 14px;
    }
    
    .expense-amount {
      font-size: 1.1rem;
    }
  }

  /* Currency Symbols */
  .currency-symbol {
    opacity: 0.8;
    margin-left: 2px;
  }
</style>

<!-- Page Header -->
<div class="page-header">
  <h1 class="page-title">
    <i class="bi bi-credit-card page-icon"></i>
    –ú–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã
  </h1>
</div>

<!-- Desktop Quick Add Form -->
<div class="quick-form-desktop d-none d-md-block">
  <div class="p-3">
    <h5 class="mb-3">
      <i class="bi bi-plus-circle text-primary me-2"></i>
      –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥
    </h5>
    <form method="POST" action="/expenses">
      <div class="row g-3 align-items-end">
        <div class="col-md-2">
          <label class="form-label fw-semibold">–î–∞—Ç–∞</label>
          <input type="date" name="date" value="{{ today }}" class="form-control" required>
        </div>
        <div class="col-md-2">
          <label class="form-label fw-semibold">–°—É–º–º–∞</label>
          <input type="number" name="amount" step="0.01" min="0.01"
                 class="form-control" placeholder="0.00"
                 inputmode="decimal" required>
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select name="category_id" class="form-select" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <input type="text" name="note" class="form-control" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ">
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-check-lg me-1"></i> –î–æ–±–∞–≤–∏—Ç—å
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Expense Cards List -->
<div class="expense-list">
  {% for expense in expenses %}
    <div class="expense-card swipeable-card" data-expense-id="{{ expense.id }}">
      <!-- Swipe Indicators (Mobile Only) -->
      <div class="swipe-indicator left d-md-none">
        <i class="bi bi-pencil" style="font-size: 1.5rem;"></i>
      </div>
      <div class="swipe-indicator right d-md-none">
        <i class="bi bi-trash" style="font-size: 1.5rem;"></i>
      </div>

      <div class="expense-content">
        <!-- Header with Amount and Date -->
        <div class="expense-header">
          <div class="expense-amount">
            {{ expense.amount|format_amount }}
            <span class="currency-symbol">{{ currency_symbol|default('‚ÇΩ') }}</span>
          </div>
          <div class="expense-date">
            <i class="bi bi-calendar3 me-1"></i>
            {{ expense.date|format_date_with_day }}
          </div>
        </div>

        <!-- Body with Category -->
        <div class="expense-body">
          {% set cat_class = '' %}
          {% if '–ø—Ä–æ–¥—É–∫—Ç' in expense.category_name.lower() or '–µ–¥–∞' in expense.category_name.lower() %}
            {% set cat_class = 'food' %}
          {% elif '—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç' in expense.category_name.lower() %}
            {% set cat_class = 'transport' %}
          {% elif '—Ä–∞–∑–≤–ª–µ—á' in expense.category_name.lower() %}
            {% set cat_class = 'entertainment' %}
          {% endif %}
          
          <div class="expense-category {{ cat_class }}">
            <i class="bi bi-tag-fill me-1"></i>
            {{ expense.category_name }}
          </div>
        </div>

        <!-- Note (if exists) -->
        {% if expense.note %}
          <div class="expense-note">
            <i class="bi bi-chat-dots me-1"></i>
            {{ expense.note }}
          </div>
        {% endif %}

        <!-- Actions (Desktop Only) -->
        <div class="expense-actions d-none d-md-flex">
          <a href="{{ url_for('expenses.edit_expense', expense_id=expense.id) }}" 
             class="btn btn-outline-primary swipe-edit">
            <i class="bi bi-pencil me-1"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
          </a>
          <button type="button" class="btn btn-outline-danger swipe-delete"
                  onclick="deleteExpense({{ expense.id }}, '{{ expense.category_name }}', '{{ expense.amount|format_amount }}', '{{ expense.date|format_date_with_day }}', '{{ expense.note }}')">
            <i class="bi bi-trash me-1"></i> –£–¥–∞–ª–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
  {% endfor %}
</div>


<!-- Empty State -->
{% if not expenses %}
<div class="empty-state">
    <div class="empty-state-icon">
        <i class="bi bi-wallet2"></i>
    </div>
    <h3>–ü–æ–∫–∞ —á—Ç–æ —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–µ—Ç</h3>
    <p>–ù–∞—á–Ω–∏—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–≤–æ–∏ —Ç—Ä–∞—Ç—ã, –¥–æ–±–∞–≤–∏–≤ –ø–µ—Ä–≤—ã–π —Ä–∞—Å—Ö–æ–¥</p>
    <button class="btn btn-primary btn-lg" onclick="openQuickAdd()">
        <i class="bi bi-plus-circle me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —Ä–∞—Å—Ö–æ–¥
    </button>
</div>
{% else %}
<!-- Quick Stats -->
<div class="row g-3 mt-3">
  <div class="col-6 col-md-3">
    <div class="stat-card">
      <div class="stat-value">{{ expenses|length }}</div>
      <div class="stat-label">—Ä–∞—Å—Ö–æ–¥–æ–≤</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="stat-card">
      <div class="stat-value">{{ total_amount|format_amount if total_amount else '0' }}</div>
      <div class="stat-label">–≤—Å–µ–≥–æ {{ currency_symbol|default('‚ÇΩ') }}</div>
    </div>
  </div>
</div>
{% endif %}

<style>
/* Quick Stats */
.stat-card {
  background: var(--bg-secondary);
  padding: 12px 16px;
  border-radius: var(--border-radius);
  text-align: center;
  box-shadow: var(--shadow);
}

.stat-value {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 4px;
}

.stat-label {
  font-size: 0.75rem;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Swipe Visual Feedback */
.expense-card.swipe-left-feedback {
  background: linear-gradient(90deg, rgba(79, 70, 229, 0.1) 0%, var(--bg-secondary) 100px);
}

.expense-card.swipe-right-feedback {
  background: linear-gradient(270deg, rgba(239, 68, 68, 0.1) 0%, var(--bg-secondary) 100px);
}

.expense-card.swipe-left-feedback .swipe-indicator.left {
  opacity: 1;
  transform: translateY(-50%) scale(1.1);
}

.expense-card.swipe-right-feedback .swipe-indicator.right {
  opacity: 1;
  transform: translateY(-50%) scale(1.1);
}
</style>

<script>
// Enhanced Mobile Swipe Functionality
document.addEventListener('DOMContentLoaded', function() {
    const swipeCards = document.querySelectorAll('.swipeable-card');
    
    swipeCards.forEach(card => {
        let startX = 0;
        let currentX = 0;
        let isDragging = false;
        const threshold = 60;
        const expenseId = card.dataset.expenseId;
        
        // Touch events
        card.addEventListener('touchstart', handleStart, { passive: true });
        card.addEventListener('touchmove', handleMove, { passive: false });
        card.addEventListener('touchend', handleEnd, { passive: true });
        
        function handleStart(e) {
            isDragging = true;
            startX = e.touches[0].clientX;
            card.classList.add('swiping');
        }
        
        function handleMove(e) {
            if (!isDragging) return;
            
            currentX = e.touches[0].clientX - startX;
            const maxSwipe = 80;
            currentX = Math.max(-maxSwipe, Math.min(maxSwipe, currentX));
            
            // Visual feedback
            if (currentX > threshold) {
                card.classList.add('swipe-left-feedback');
                card.classList.remove('swipe-right-feedback');
            } else if (currentX < -threshold) {
                card.classList.add('swipe-right-feedback');
                card.classList.remove('swipe-left-feedback');
            } else {
                card.classList.remove('swipe-left-feedback', 'swipe-right-feedback');
            }
        }
        
        function handleEnd(e) {
            if (!isDragging) return;
            
            isDragging = false;
            card.classList.remove('swiping', 'swipe-left-feedback', 'swipe-right-feedback');
            
            if (currentX > threshold) {
                // Swipe right - edit
                window.location.href = `/expenses/edit/${expenseId}`;
            } else if (currentX < -threshold) {
                // Swipe left - delete
                const expenseData = {
                    category: card.querySelector('.expense-category').textContent.trim(),
                    amount: card.querySelector('.expense-amount').textContent.trim(),
                    date: card.querySelector('.expense-date').textContent.trim(),
                    note: card.querySelector('.expense-note')?.textContent.trim() || '–ù–µ—Ç'
                };
                
                if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ö–æ–¥?\n–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${expenseData.category}\n–°—É–º–º–∞: ${expenseData.amount}\n–î–∞—Ç–∞: ${expenseData.date}\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${expenseData.note}`)) {
                    // Create and submit delete form
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `/expenses/delete/${expenseId}`;
                    document.body.appendChild(form);
                    form.submit();
                }
            }
            
            currentX = 0;
        }
    });
});

// Delete function for desktop buttons
function deleteExpense(id, category, amount, date, note) {
    const noteText = note ? note : '–ù–µ—Ç';
    const confirmMsg = `–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ö–æ–¥?\n–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${category}\n–°—É–º–º–∞: ${amount}\n–î–∞—Ç–∞: ${date}\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${noteText}`;
    
    if (confirm(confirmMsg)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/expenses/delete/${id}`;
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
