{% extends "base.html" %}
{% block title %}üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî CrystalBudget{% endblock %}

{% block content %}
<style>
/* Modern Page Layout */
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
}

.page-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.page-icon {
  font-size: 1.5rem;
  color: var(--primary);
}

/* Enhanced Add Forms */
.add-category-card {
  border: 2px solid;
  border-radius: 12px;
  transition: all 0.3s ease;
  background: var(--bg-secondary);
  box-shadow: var(--shadow);
  margin-bottom: 20px;
}

.add-category-card.expense {
  border-color: var(--danger);
}

.add-category-card.income {
  border-color: var(--success);
}

.card-header-modern {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 16px;
  border-bottom: 1px solid var(--border);
}

.card-title-modern {
  font-size: 1.1rem;
  font-weight: 600;
  margin: 0;
}

/* Modern Category Cards */
.category-section {
  margin-bottom: 32px;
}

.category-cards {
  display: grid;
  gap: 16px;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
}

.category-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  transition: all 0.3s ease;
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
}

.category-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.category-card.expense {
  border-left: 4px solid var(--danger);
}

.category-card.income {
  border-left: 4px solid var(--success);
}

.category-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.category-name {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
}

.category-type-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
}

.badge-fixed {
  background: rgba(13, 110, 253, 0.1);
  color: var(--primary);
}

.badge-percent {
  background: rgba(25, 135, 84, 0.1);
  color: var(--success);
}

.category-value {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.category-source {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.875rem;
  color: var(--text-secondary);
  margin-bottom: 16px;
}

.category-actions {
  display: flex;
  gap: 8px;
}

.btn-card {
  flex: 1;
  padding: 8px 12px;
  font-size: 0.875rem;
  border-radius: 8px;
  transition: all 0.2s ease;
}

/* Desktop Table (Hidden on Mobile) */
.desktop-table {
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  overflow: hidden;
}

@media (max-width: 768px) {
  .desktop-table {
    display: none !important;
  }
  
  .category-cards {
    grid-template-columns: 1fr;
  }
  
  .page-header {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }
  
  .page-title {
    font-size: 1.25rem;
  }
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}

.empty-state-icon {
  font-size: 4rem;
  opacity: 0.3;
  margin-bottom: 16px;
  color: var(--text-secondary);
}

.empty-state h3 {
  margin-bottom: 8px;
  color: var(--text-primary);
}

.empty-state p {
  margin-bottom: 24px;
  color: var(--text-secondary);
}

/* Enhanced Forms */
.form-modern {
  background: var(--bg-primary);
  padding: 20px;
  border-radius: 12px;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  align-items: end;
}

.form-group {
  margin-bottom: 0;
}

.form-label-modern {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
  display: block;
}

/* Improved Button Group */
.btn-group-modern {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

@media (max-width: 576px) {
  .btn-group-modern {
    flex-direction: column;
  }
  
  .btn-group-modern .btn {
    width: 100%;
  }
}

/* Legacy table styling for desktop */
.table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
.btn, .btn * { white-space: nowrap; }
.btn-col{ min-width: 160px; }
.btn-col .btn{ white-space: nowrap; }
</style>

<!-- Page Header -->
<div class="page-header">
  <h1 class="page-title">
    <i class="bi bi-tags page-icon"></i>
    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
  </h1>
  <div class="btn-group-modern">
    <button class="btn btn-danger" data-bs-toggle="collapse" data-bs-target="#addExpenseCategoryForm">
      <i class="bi bi-dash-circle me-1"></i>
      <span class="d-none d-sm-inline">–ö–∞—Ç–µ–≥–æ—Ä–∏—è </span>–¢—Ä–∞—Ç
    </button>
    <button class="btn btn-success" data-bs-toggle="collapse" data-bs-target="#addIncomeCategoryForm">
      <i class="bi bi-plus-circle me-1"></i>
      <span class="d-none d-sm-inline">–ö–∞—Ç–µ–≥–æ—Ä–∏—è </span>–î–æ—Ö–æ–¥–æ–≤
    </button>
  </div>
</div>

<!-- –§–æ—Ä–º–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ç—Ä–∞—Ç -->
<div class="collapse" id="addExpenseCategoryForm">
  <div class="add-category-card expense">
    <div class="card-header-modern">
      <i class="bi bi-dash-circle text-danger"></i>
      <h5 class="card-title-modern text-danger">–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Ç—Ä–∞—Ç</h5>
    </div>
    <div class="form-modern">
      <form method="POST" action="{{ url_for('categories.add') }}">
        <input type="hidden" name="category_type" value="expense">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label-modern">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" name="name" class="form-control" placeholder="–ü—Ä–æ–¥—É–∫—Ç—ã, –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç..." required>
          </div>

          <div class="form-group">
            <label class="form-label-modern">–¢–∏–ø –ª–∏–º–∏—Ç–∞</label>
            <select name="limit_type" class="form-select" required>
              <option value="fixed">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞</option>
              <option value="percent">–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –¥–æ—Ö–æ–¥–∞</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label-modern">–ó–Ω–∞—á–µ–Ω–∏–µ</label>
            <input type="number" name="value" step="0.01" min="0.01" inputmode="decimal"
                   class="form-control" placeholder="5000 –∏–ª–∏ 15" required>
          </div>

          <div class="form-group">
            <label class="form-label-modern">–ò—Å—Ç–æ—á–Ω–∏–∫</label>
            <select name="source_id" class="form-select">
              <option value="">(–Ω–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å)</option>
              {% for s in income_sources %}
                <option value="{{ s.id }}">{{ s.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <button class="btn btn-danger w-100">
              <i class="bi bi-check-lg me-1"></i> –î–æ–±–∞–≤–∏—Ç—å
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- –§–æ—Ä–º–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–æ—Ö–æ–¥–æ–≤ -->
<div class="collapse mb-4" id="addIncomeCategoryForm">
  <div class="add-category-card income">
    <div class="card-header-modern">
      <i class="bi bi-plus-circle text-success"></i>
      <h5 class="card-title-modern text-success">–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ—Ö–æ–¥–æ–≤</h5>
    </div>
    <div class="form-modern">
      <form method="POST" action="{{ url_for('categories.add') }}">
        <input type="hidden" name="category_type" value="income">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label-modern">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" name="name" class="form-control" placeholder="–ó–∞—Ä–ø–ª–∞—Ç–∞, –ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞..." required>
          </div>

          <div class="form-group">
            <label class="form-label-modern">–ò—Å—Ç–æ—á–Ω–∏–∫</label>
            <select name="source_id" class="form-select">
              <option value="">(–Ω–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å)</option>
              {% for s in income_sources %}
                <option value="{{ s.id }}">{{ s.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label class="form-label-modern">–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞</label>
            <input type="number" name="value" step="0.01" min="0.01" inputmode="decimal"
                   class="form-control" placeholder="50000" required>
            <input type="hidden" name="limit_type" value="fixed">
          </div>

          <div class="form-group">
            <button class="btn btn-success w-100">
              <i class="bi bi-check-lg me-1"></i> –î–æ–±–∞–≤–∏—Ç—å
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

{% if not income_sources or income_sources|length == 0 %}
<div class="alert alert-info mb-3">
  –ß—Ç–æ–±—ã –ø—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É –¥–æ—Ö–æ–¥–∞, —Å–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
  <a href="{{ url_for('sources.list') }}" class="alert-link">¬´–ò—Å—Ç–æ—á–Ω–∏–∫–∏¬ª</a>.
</div>
{% endif %}

<!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç—Ä–∞—Ç -->
{% if expense_categories %}
<div class="category-section">
  <h5 class="text-danger mb-3 d-flex align-items-center gap-2">
    <i class="bi bi-dash-circle"></i>
    –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç—Ä–∞—Ç
    <span class="badge bg-danger-subtle text-danger">{{ expense_categories|length }}</span>
  </h5>
  
  <!-- Mobile Card View -->
  <div class="category-cards d-md-none">
    {% for cat in expense_categories %}
    <div class="category-card expense">
      <div class="category-card-header">
        <h6 class="category-name">{{ cat.name }}</h6>
        {% if cat.limit_type == 'fixed' %}
          <span class="category-type-badge badge-fixed">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</span>
        {% else %}
          <span class="category-type-badge badge-percent">–ü—Ä–æ—Ü–µ–Ω—Ç</span>
        {% endif %}
      </div>
      
      <div class="category-value">
        {% if cat.limit_type == 'percent' %}
          {{ cat.value|format_percent }}%
        {% else %}
          {{ cat.value|format_amount }} {{ currency_symbol|default('‚ÇΩ') }}
        {% endif %}
      </div>
      
      <div class="category-source">
        <i class="bi bi-link-45deg"></i>
        {% set source_id = rules_map.get(cat.id) %}
        {% if source_id %}
          {% set source_found = income_sources|selectattr('id', 'equalto', source_id)|list %}
          {% if source_found %}
            <span class="text-primary">{{ source_found[0].name }}</span>
          {% else %}
            <span class="text-warning">–ò—Å—Ç–æ—á–Ω–∏–∫ —É–¥–∞–ª–µ–Ω</span>
          {% endif %}
        {% else %}
          <span class="text-muted">–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ</span>
        {% endif %}
      </div>
      
      <div class="category-actions">
        <button class="btn btn-outline-primary btn-card" data-bs-toggle="modal" data-bs-target="#editModal{{ cat.id }}">
          <i class="bi bi-pencil"></i> –ò–∑–º–µ–Ω–∏—Ç—å
        </button>
        <form method="POST" action="{{ url_for('categories.delete', cat_id=cat.id) }}" class="d-inline" style="flex: 1;">
          <button type="submit" class="btn btn-outline-danger btn-card w-100"
                  onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é ¬´{{ cat.name }}¬ª?')">
            <i class="bi bi-trash3"></i> –£–¥–∞–ª–∏—Ç—å
          </button>
        </form>
      </div>
    </div>
    {% endfor %}
  </div>
  
  <!-- Desktop Table View -->
  <div class="desktop-table d-none d-md-block">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–¢–∏–ø –ª–∏–º–∏—Ç–∞</th>
            <th class="text-end">–ó–Ω–∞—á–µ–Ω–∏–µ</th>
            <th>–ü—Ä–∏–≤—è–∑–∞–Ω –∫ –¥–æ—Ö–æ–¥—É</th>
            <th class="text-end">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          {% for cat in expense_categories %}
          <tr>
            <td class="fw-semibold">{{ cat.name }}</td>
            <td>
              {% if cat.limit_type == 'fixed' %}
                <span class="badge bg-primary">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</span>
              {% else %}
                <span class="badge bg-success">–ü—Ä–æ—Ü–µ–Ω—Ç</span>
              {% endif %}
            </td>
            <td class="text-end">
              {% if cat.limit_type == 'percent' %}
                <strong>{{ cat.value|format_percent }}%</strong>
              {% else %}
                <strong>{{ cat.value|format_amount }} <span class="currency-display">{{ currency_symbol|default('‚ÇΩ') }}</span></strong>
              {% endif %}
            </td>
            <td>
              {% set source_id = rules_map.get(cat.id) %}
              {% if source_id %}
                {% set source_found = income_sources|selectattr('id', 'equalto', source_id)|list %}
                {% if source_found %}
                  <span class="badge bg-info">{{ source_found[0].name }}</span>
                {% else %}
                  <span class="text-warning small">–∏—Å—Ç–æ—á–Ω–∏–∫ —É–¥–∞–ª–µ–Ω</span>
                {% endif %}
              {% else %}
                <span class="text-muted small">–Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ</span>
              {% endif %}
            </td>
            <td class="text-end">
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editModal{{ cat.id }}">
                  <i class="bi bi-pencil"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <form method="POST" action="{{ url_for('categories.delete', cat_id=cat.id) }}" class="d-inline">
                  <button type="submit" class="btn btn-outline-danger"
                          onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é ¬´{{ cat.name }}¬ª?')">
                    <i class="bi bi-trash3"></i> –£–¥–∞–ª–∏—Ç—å
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

<!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ—Ö–æ–¥–æ–≤ -->
{% if income_categories %}
<div class="category-section">
  <h5 class="text-success mb-3 d-flex align-items-center gap-2">
    <i class="bi bi-plus-circle"></i>
    –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ—Ö–æ–¥–æ–≤
    <span class="badge bg-success-subtle text-success">{{ income_categories|length }}</span>
  </h5>
  
  <!-- Mobile Card View -->
  <div class="category-cards d-md-none">
    {% for cat in income_categories %}
    <div class="category-card income">
      <div class="category-card-header">
        <h6 class="category-name">{{ cat.name }}</h6>
        <span class="category-type-badge badge-fixed">–¶–µ–ª–µ–≤–∞—è</span>
      </div>
      
      <div class="category-value">
        {{ cat.value|format_amount }} {{ currency_symbol|default('‚ÇΩ') }}
      </div>
      
      <div class="category-source">
        <i class="bi bi-link-45deg"></i>
        {% set source_id = rules_map.get(cat.id) %}
        {% if source_id %}
          {% set source_found = income_sources|selectattr('id', 'equalto', source_id)|list %}
          {% if source_found %}
            <span class="text-primary">{{ source_found[0].name }}</span>
          {% else %}
            <span class="text-warning">–ò—Å—Ç–æ—á–Ω–∏–∫ —É–¥–∞–ª–µ–Ω</span>
          {% endif %}
        {% else %}
          <span class="text-muted">–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ</span>
        {% endif %}
      </div>
      
      <div class="category-actions">
        <button class="btn btn-outline-success btn-card" data-bs-toggle="modal" data-bs-target="#editModal{{ cat.id }}">
          <i class="bi bi-pencil"></i> –ò–∑–º–µ–Ω–∏—Ç—å
        </button>
        <form method="POST" action="{{ url_for('categories.delete', cat_id=cat.id) }}" class="d-inline" style="flex: 1;">
          <button type="submit" class="btn btn-outline-danger btn-card w-100"
                  onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é ¬´{{ cat.name }}¬ª?')">
            <i class="bi bi-trash3"></i> –£–¥–∞–ª–∏—Ç—å
          </button>
        </form>
      </div>
    </div>
    {% endfor %}
  </div>
  
  <!-- Desktop Table View -->
  <div class="desktop-table d-none d-md-block">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th class="text-end">–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞</th>
            <th>–ü—Ä–∏–≤—è–∑–∞–Ω –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É</th>
            <th class="text-end">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          {% for cat in income_categories %}
          <tr>
            <td class="fw-semibold">{{ cat.name }}</td>
            <td class="text-end">
              <strong>{{ cat.value|format_amount }} <span class="currency-display">{{ currency_symbol|default('‚ÇΩ') }}</span></strong>
            </td>
            <td>
              {% set source_id = rules_map.get(cat.id) %}
              {% if source_id %}
                {% set source_found = income_sources|selectattr('id', 'equalto', source_id)|list %}
                {% if source_found %}
                  <span class="badge bg-info">{{ source_found[0].name }}</span>
                {% else %}
                  <span class="text-warning small">–∏—Å—Ç–æ—á–Ω–∏–∫ —É–¥–∞–ª–µ–Ω</span>
                {% endif %}
              {% else %}
                <span class="text-muted small">–Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ</span>
              {% endif %}
            </td>
            <td class="text-end">
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#editModal{{ cat.id }}">
                  <i class="bi bi-pencil"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <form method="POST" action="{{ url_for('categories.delete', cat_id=cat.id) }}" class="d-inline">
                  <button type="submit" class="btn btn-outline-danger"
                          onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é ¬´{{ cat.name }}¬ª?')">
                    <i class="bi bi-trash3"></i> –£–¥–∞–ª–∏—Ç—å
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

{% if not expense_categories and not income_categories %}
<div class="empty-state">
  <div class="empty-state-icon">
    <i class="bi bi-tags"></i>
  </div>
  <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</h3>
  <p>–°–æ–∑–¥–∞–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —É—á—ë—Ç–∞ –≤–∞—à–∏—Ö –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</p>
  <div class="btn-group-modern">
    <button class="btn btn-danger btn-lg" data-bs-toggle="collapse" data-bs-target="#addExpenseCategoryForm">
      <i class="bi bi-dash-circle me-1"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏—é —Ç—Ä–∞—Ç
    </button>
    <button class="btn btn-success btn-lg" data-bs-toggle="collapse" data-bs-target="#addIncomeCategoryForm">
      <i class="bi bi-plus-circle me-1"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏—é –¥–æ—Ö–æ–¥–æ–≤
    </button>
  </div>
</div>
{% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
{% for cat in categories %}
<div class="modal fade" id="editModal{{ cat.id }}" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é ¬´{{ cat.name }}¬ª</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('categories.update', cat_id=cat.id) }}">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" name="name" class="form-control" value="{{ cat.name }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">–¢–∏–ø –ª–∏–º–∏—Ç–∞</label>
            <select name="limit_type" class="form-select" required>
              <option value="fixed" {% if cat.limit_type == 'fixed' %}selected{% endif %}>–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞</option>
              <option value="percent" {% if cat.limit_type == 'percent' %}selected{% endif %}>–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –¥–æ—Ö–æ–¥–∞</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">–ó–Ω–∞—á–µ–Ω–∏–µ</label>
            <input type="number" name="value" step="0.01" min="0.01" class="form-control" value="{{ cat.value }}" required>
          </div>
          {% if income_sources and income_sources|length %}
          <div class="mb-3">
            <label class="form-label">–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É –¥–æ—Ö–æ–¥–∞</label>
            <select name="source_id" class="form-select">
              <option value="">(–Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ)</option>
              {% for s in income_sources %}
                <option value="{{ s.id }}" {% if rules_map.get(cat.id)==s.id %}selected{% endif %}>{{ s.name }}</option>
              {% endfor %}
            </select>
          </div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}{% endblock %}