# Инструкции по тестированию семейного бюджета

## Предварительные требования

1. Два пользователя в системе (или возможность создать двух пользователей)
2. Запущенное приложение
3. База данных с примененными миграциями

## Сценарий 1: Создание семейного бюджета

### Шаги:
1. Войдите под первым пользователем (Пользователь A - Owner)
2. Перейдите в раздел "Цели" → "Семейные бюджеты"
3. Нажмите "Создать семейный бюджет"
4. Введите название (например, "Семейный бюджет Ивановых")
5. Сохраните бюджет
6. Скопируйте код приглашения (отображается на странице деталей бюджета)

### Ожидаемый результат:
- ✅ Бюджет создан успешно
- ✅ Отображается код приглашения
- ✅ Пользователь A имеет роль "owner"

## Сценарий 2: Присоединение к семейному бюджету

### Шаги:
1. Выйдите из аккаунта Пользователя A
2. Войдите под вторым пользователем (Пользователь B)
3. Перейдите в раздел "Цели" → "Семейные бюджеты"
4. Нажмите "Присоединиться к бюджету"
5. Введите код приглашения, полученный на шаге 1
6. Подтвердите присоединение

### Ожидаемый результат:
- ✅ Пользователь B успешно присоединился
- ✅ Бюджет отображается в списке семейных бюджетов Пользователя B
- ✅ Пользователь B имеет роль "member" по умолчанию

## Сценарий 3: Добавление расходов (Owner)

### Шаги:
1. Войдите под Пользователем A (Owner)
2. Перейдите на страницу семейного бюджета (`/budget/shared/<budget_id>/expenses`)
3. Нажмите "Добавить расход"
4. Заполните форму:
   - Категория: выберите существующую или создайте новую
   - Сумма: 1500
   - Описание: "Продукты в супермаркете"
   - Дата: сегодня
5. Сохраните расход

### Ожидаемый результат:
- ✅ Расход добавлен успешно
- ✅ Расход отображается в списке семейных расходов
- ✅ В колонке "Кто добавил" отображается имя Пользователя A

## Сценарий 4: Просмотр расходов (Member)

### Шаги:
1. Выйдите из аккаунта и войдите под Пользователем B (Member)
2. Перейдите на страницу семейного бюджета
3. Проверьте список расходов

### Ожидаемый результат:
- ✅ Пользователь B видит расход, добавленный Пользователем A
- ✅ Отображается автор расхода (Пользователь A)
- ✅ Кнопки "Редактировать" и "Удалить" доступны (так как B - member)

## Сценарий 5: Добавление расходов (Member)

### Шаги:
1. Под Пользователем B (Member) на странице семейного бюджета
2. Нажмите "Добавить расход"
3. Заполните форму:
   - Категория: выберите категорию
   - Сумма: 800
   - Описание: "Бензин"
   - Дата: сегодня
4. Сохраните расход

### Ожидаемый результат:
- ✅ Расход добавлен успешно
- ✅ Расход отображается в списке
- ✅ В колонке "Кто добавил" отображается имя Пользователя B

## Сценарий 6: Редактирование расходов

### Шаги:
1. Под Пользователем B попробуйте отредактировать расход, добавленный Пользователем A
2. Нажмите кнопку "Редактировать" рядом с расходом
3. Измените сумму на 1600
4. Сохраните изменения

### Ожидаемый результат:
- ✅ Member может редактировать расходы других участников
- ✅ Изменения сохраняются успешно
- ✅ Обновленная сумма отображается корректно

## Сценарий 7: Удаление расходов

### Шаги:
1. Под Пользователем B попробуйте удалить расход, добавленный Пользователем A
2. Нажмите кнопку "Удалить"
3. Подтвердите удаление

### Ожидаемый результат:
- ✅ Member может удалять расходы других участников
- ✅ Расход удален из списка

## Сценарий 8: Изменение роли на Viewer

### Шаги:
1. Войдите под Пользователем A (Owner)
2. Перейдите на страницу деталей семейного бюджета
3. Найдите Пользователя B в списке участников
4. Измените роль с "member" на "viewer"
5. Сохраните изменения

### Ожидаемый результат:
- ✅ Роль изменена успешно
- ✅ Пользователь B теперь имеет роль "viewer"

## Сценарий 9: Ограничения для Viewer

### Шаги:
1. Выйдите и войдите под Пользователем B (теперь Viewer)
2. Перейдите на страницу семейного бюджета
3. Проверьте доступные действия

### Ожидаемый результат:
- ✅ Пользователь B видит все расходы
- ✅ Кнопка "Добавить расход" отсутствует или неактивна
- ✅ Кнопки "Редактировать" и "Удалить" отсутствуют или неактивны
- ✅ Вместо кнопок действий отображается текст "Только просмотр"

## Сценарий 10: Попытка добавить расход через API (Viewer)

### Шаги:
1. Под Пользователем B (Viewer) попробуйте отправить POST-запрос на:
   ```
   POST /budget/shared/<budget_id>/expenses/add
   ```
2. Передайте данные о расходе

### Ожидаемый результат:
- ✅ Запрос отклонен с ошибкой "Нет прав на добавление расходов"
- ✅ Расход не создается в базе данных

## Сценарий 11: Инвалидация кэша

### Шаги:
1. Войдите под Пользователем A
2. Откройте страницу семейного бюджета
3. Под Пользователем B (в другом браузере/окне инкогнито) добавьте новый расход
4. Обновите страницу Пользователя A

### Ожидаемый результат:
- ✅ Новый расход виден обоим пользователям
- ✅ Кэш инвалидируется для всех участников бюджета

## Сценарий 12: Личные vs Семейные расходы

### Шаги:
1. Под Пользователем A добавьте личный расход (не в семейный бюджет)
2. Под Пользователем B проверьте список расходов в семейном бюджете
3. Под Пользователем B проверьте список личных расходов

### Ожидаемый результат:
- ✅ Личный расход Пользователя A виден только ему
- ✅ Личный расход не отображается в семейном бюджете
- ✅ Семейные расходы не отображаются в личных расходах
- ✅ Данные корректно разделены по `shared_budget_id`

## Сценарий 13: Фильтрация по месяцам

### Шаги:
1. Под Пользователем A добавьте несколько расходов с разными датами:
   - Расход 1: текущий месяц
   - Расход 2: предыдущий месяц
2. Используйте фильтр по дате на странице семейного бюджета
3. Выберите предыдущий месяц

### Ожидаемый результат:
- ✅ Отображаются только расходы выбранного месяца
- ✅ Фильтр работает корректно для обоих пользователей

## Сценарий 14: Мобильная версия

### Шаги:
1. Откройте приложение на мобильном устройстве или используйте DevTools (Mobile View)
2. Войдите под любым пользователем
3. Перейдите на страницу семейного бюджета
4. Проверьте функционал swipe actions

### Ожидаемый результат:
- ✅ Мобильные карточки расходов отображаются корректно
- ✅ Отображается автор каждого расхода
- ✅ Swipe actions работают (редактирование/удаление)
- ✅ Для Viewer swipe actions недоступны

## Проверка базы данных

### SQL-запросы для проверки:

```sql
-- Проверить расходы с привязкой к семейному бюджету
SELECT id, user_id, shared_budget_id, amount, description, date
FROM expenses
WHERE shared_budget_id IS NOT NULL;

-- Проверить участников бюджета
SELECT sb.name, sbm.user_id, sbm.role
FROM shared_budgets sb
JOIN shared_budget_members sbm ON sb.id = sbm.budget_id;

-- Проверить категории семейного бюджета
SELECT id, user_id, shared_budget_id, name
FROM categories
WHERE shared_budget_id IS NOT NULL;
```

## Контрольный список (Checklist)

- [ ] Создание семейного бюджета работает
- [ ] Присоединение по коду работает
- [ ] Owner может добавлять расходы
- [ ] Member может добавлять расходы
- [ ] Member может редактировать любые расходы
- [ ] Member может удалять любые расходы
- [ ] Viewer может только просматривать
- [ ] Viewer не может добавлять расходы
- [ ] Viewer не может редактировать расходы
- [ ] Viewer не может удалять расходы
- [ ] Отображается автор каждого расхода
- [ ] Кэш инвалидируется для всех участников
- [ ] Личные и семейные расходы разделены
- [ ] Фильтрация по месяцам работает
- [ ] Мобильная версия работает корректно
- [ ] API защищен от несанкционированного доступа

## Известные ограничения

1. **Удаление бюджета**: При удалении семейного бюджета все связанные расходы и категории также удаляются (CASCADE)
2. **Язык**: Интерфейс на русском языке
3. **Валюта**: По умолчанию используется RUB (рубли)

## Что делать при обнаружении ошибок

1. Проверьте логи приложения: `sudo journalctl -u crystalbudget -f`
2. Проверьте миграции: `flask db current`
3. Убедитесь, что миграция `515954c99c28` применена
4. Проверьте права доступа в базе данных
5. Очистите кэш: перезапустите приложение

## Дополнительные проверки

### Производительность:
- Измерьте время загрузки страницы с 100+ расходами
- Проверьте количество SQL-запросов (должно быть оптимизировано)

### Безопасность:
- Попробуйте получить доступ к чужому семейному бюджету напрямую через URL
- Попробуйте отредактировать расход без прав через API
- Проверьте CSRF-защиту на формах

### Граничные случаи:
- Что происходит, если последний Owner покидает бюджет?
- Что происходит при удалении пользователя, который является Owner?
- Как работает система при большом количестве участников (10+)?
